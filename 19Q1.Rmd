---
title: "19Q1"
author: "Sally Claridge"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: cerulean
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
    code_folding: hide
    pandoc_args: [
      "+RTS", "-K2048m",
      "-RTS"
    ]
---

Analysis of the [Broad's Avana CRISPR](https://depmap.org/portal/download/) (Broad Institute Cancer Dependency Map 2018, Meyers et al. 2017), the [Cancer Therapeutics Response Portal](https://ocg.cancer.gov/programs/ctd2/data-portal) (CTRP) drug screen dataset (v2) (Basu et al., 2013; M. G. Rees et al., 2016; B. Seashore-Ludlow et al., 2015), the [Genomics of Drug Sensitivity in Cancer](https://www.cancerrxgene.org/downloads) (GDSC) drug screen dataset (Garnett et al., 2012; Yang et al., 2012) , and the [Cancer Cell Line Encyclopedia](https://portals.broadinstitute.org/ccle) (CCLE) drug screen dataset (J. Barretina et al., 2012; T. C. C. L. E. Consortium & Consortium, 2015).

The Avana screen produced results using [CERES](https://depmap.org/ceres/) (Meyers et al. 2017) ([GitHub](https://github.com/cancerdatasci/ceres)), which generates gene dependency scores from sgRNA depletion scores from gene essentiality screens and eliminates bias arising from the effect of copy number variation on Cas9 DNA cleavage. The lower the CERES score, the higher the likelihood that the gene is essential in the associated cell line. Scores are scaled per cell line such that a score of 0 is the median effect of nonessential genes and -1 is the median effect of common core essential genes.

Annotation files for mutation status, copy number, and gene expression of the CCLE and CTRP datasets (Consortium and Consortium 2015, Barretina et al. 2012) were downloaded from the [DepMap Data Portal](https://depmap.org/portal/download/). Note that the group that conducted the GDSC screen also collected their own genomic annotation information for mutation status, copy number, and gene expression, but we did not use it.

# SET UP

--------------------------------------------------------------------------------

```{r setup, include=FALSE}
set.seed(1234)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# num_cores <- parallel::detectCores()
options(mc.cores = parallel::detectCores(), expressions = 5e5)
```

Edited `.Renviron` to avoid "Error: memory exhausted (limit reached?)" when melting the GE dataset, as per the suggestion from [StackOverflow](https://stackoverflow.com/questions/51295402/r-on-macos-error-vector-memory-exhausted-limit-reached):Ã¥
```
cd ~
touch .Renviron
open .Renviron
# Added following line to .Renviron:
R_MAX_VSIZE=100Gb
```

```{r}
library(crunch)
library(ggpubr)
library(ggrepel)
library(ggsignif)
library(kableExtra)
library(naniar)
library(reshape2)
library(tidyverse)
library(VennDiagram)
theme_set(theme_light())
```

# DATA MANAGEMENT {.tabset .tabset-fade .tabset-pills}

--------------------------------------------------------------------------------

Note that the new DepMap 19Q1 release made multiple changes to variable names:

- For their universal ccancer cell line nomenclature, they reverted back to `Broad_ID` from 18Q3 rather than `DepMap_ID` that was used in 18Q4
- The `Primary.Disease` column of the cell line metadata file is more consistently named (`Subtype.Disease` now has the specific disease annotations), though there are a couple capitalization inconsistencies
- MAF file no longer has `CCLE_Name` column and has a duplicate column of the Broad IDs (i.e. `DepMap_ID` and `Tumor_Sample_Barcode`)

And changes to the data processing pipelines (the following is taken verbatim from the [DepMap data portal](https://depmap.org/portal/download/)):

- **Expression**: We use the GTEx pipeline. Since last release, there have been some updates to the versions of different components of the pipeline and minor bug fixes on GTEx's end.
- **Mutation**: In this release, we additionally process DepMap WES samples through the CGA mutation calling pipeline adapted for cell lines and available on FireCloud. We have added a column for the allele counts from this pipeline run (CGA_WES_AC). Previously, the WES_AC column was generated from running the Van Allen mutation calling pipeline for SNPs + Mutect2 for INDELs. This column is now named VA_WES_AC.
- **Copy Number**: We have moved to using the newest version of the GATK pipeline.

## D. Charytonowicz cell line converter

This comprehensive cancer cell line information was curated by both Daniel Charytonowicz and myself.
```{r}
ccl_converter <- read.delim("./data_munging/cell_line_database_v1_20180911.tsv", row.names = 1, sep = "\t", header = TRUE)
lineage_converter <- unique(ccl_converter[, c("grouped_general_doid", "group_general_lineage_name")])
```

## DepMap cell line metadata

19Q1 update fixed almost all of the inconsistencies of the Primary.Disease column, though there were come capitalization inconsistencies.
```{r}
ccl_info <- read.delim("./data_munging/19Q1/DepMap-2019q1-celllines_v2_20190305.csv", sep = ",", header = TRUE, na.strings = c("", NA))
ccl_info$source <- "CCLE"
ccl_info$source_ccl_name <- strsplit(as.character(ccl_info$CCLE_Name), split = "_")
ccl_info$source_ccl_name <- as.character(lapply(ccl_info$source_ccl_name, function(x) ifelse("[MERGED" %in% x || "NORMAL" %in% x, NA, x[1])))
ccl_info$source_ccl_name[ccl_info$source_ccl_name == "NA"] <- NA
ccl_info$source_histology <- tolower(gsub("^[a-z0-9]*_", "", ccl_info$CCLE_Name, ignore.case = TRUE))
ccl_info$source_histology <- ifelse(ccl_info$CCLE_Name == ccl_info$source_ccl_name, NA, ccl_info$source_histology)
ccl_info$sample_ID <- with(ccl_info, paste(source, source_ccl_name, source_histology, sep = "_"))
# This CCL had a histology of "primary": Looking at the DepMap reference, this is an immortalize epithelial line from the CNS (https://depmap.org/portal/cell_line/NHAHTDD_PRIMARY), so I chanegd the histology accordingly
ccl_info$source_histology[ccl_info$source_ccl_name == "NHAHTDD"] <- "central_nervous_system"
# Convert Primary.Disease entries to all lower case to fix factorization issue
ccl_info$Primary.Disease <- as.factor(tolower(ccl_info$Primary.Disease))
# Harmonize ID column name and rename CCLE_Name column to fit with dataframe style
colnames(ccl_info)[colnames(ccl_info) == "CCLE_Name"] <- "CCLE_ccl_name"
colnames(ccl_info)[colnames(ccl_info) == "DepMap_ID"] <- "Broad_ID"

# Sample info from figshare
crispr_meta <- read.delim("./data_munging/19Q1/sample_info_20190306.csv", sep = ",", header = TRUE, na.strings = c("", NA))
colnames(crispr_meta)[colnames(crispr_meta) == "CCLE_name"] <- "CCLE_Name"
```

## CCLE genomic annotations

### Mutation status (Mut)

For mutation calling, get paired gene name and cell line fields in a data frame. For this analysis, we don't care about how many mutations there are per gene or what type of mutations there are, so I didn't save more information. I took unique gene-cell line combinations since we only cared about mutation presence/absence. Add a `Mutation_Status` column denoting all entries in MAF files as mutations present in the associated cell lines.

Mutation calls (coding region, germline filtered):
```{r, eval=FALSE}
maf_raw <- read.delim("./data_munging/19Q1/depmap_19Q1_mutation_calls_20190305.csv.gz", header = TRUE, sep = ",", row.names = 1)
# Harmonize ID column name
colnames(maf_raw)[colnames(maf_raw) == "DepMap_ID"] <- "Broad_ID"
# Select columns
maf_df <- subset(maf_raw, select = c("Hugo_Symbol", "Broad_ID", "Variant_Classification", "Reference_Allele", "Tumor_Seq_Allele1", "Genome_Change"))
maf_df$Reference_Allele <- ifelse(maf_df$Reference_Allele == "-", 0, nchar(as.character(maf_df$Reference_Allele)))
maf_df$Tumor_Seq_Allele1 <- nchar(as.character(maf_df$Tumor_Seq_Allele1))
maf_df <- maf_df[maf_df$Variant_Classification != "Silent",]
# Add Mutation_Status column
maf_df$Mutation_Status_Nonsilent <- "Mutant"

saveRDS(maf_df, "./data_munging/19Q1/maf_df_19Q1.rds", compress = "xz")
```

### Copy number (CN)

DepMap WES CN Data:
```{r, eval=FALSE}
cn <- read.delim("./data_munging/19Q1/public_19Q1_gene_cn_20190305.csv.gz", sep = ",", check.names = FALSE, header = TRUE)
# Remove Entrez gene IDs from colnames, format is "Hugo_Symbol (Entrez ID)"
colnames(cn) <- gsub(" .*", "", colnames(cn))
colnames(cn)[1] <- "Broad_ID"
# Melt
cn_melt <- melt(data = cn, id.vars = "Broad_ID", measure.vars = colnames(cn[2:ncol(cn)]), variable.name = "Hugo_Symbol", value.name = "CN")
saveRDS(cn_melt, "./data_munging/19Q1/cn_melt_19Q1.rds", compress = "xz")
```

### Gene expression (GE)

19Q1, CCLE RNAseq gene expression data (log2(TPM+1)):
```{r, eval=FALSE}
ge_19Q1 <- read.delim("./../htscreens_giant_files/CCLE_depMap_19Q1_TPM_20190305.csv.gz", header = TRUE, sep = ",", check.names = FALSE)
# Remove Entrez gene IDs from colnames, format is "Hugo_Symbol (Entrez ID)"
colnames(ge_19Q1) <- gsub(" .*", "", colnames(ge_19Q1))
colnames(ge_19Q1)[1] <- "Broad_ID"

# For Denise's GCN
pgx_ccle_ge <- merge(select(ccl_info, source, source_ccl_name, source_histology, sample_ID, CCLE_ccl_name, Broad_ID), ge_19Q1, by = "Broad_ID", all = TRUE)
saveRDS(pgx_ccle_ge, "./data_munging/19Q1/pgx_ccle_ge.rds", compress = "xz")

# Melt
ge_melt_19Q1 <- melt(ge_19Q1, id.vars = "Broad_ID", measure.vars = colnames(ge_19Q1)[2:ncol(ge_19Q1)], variable.name = "Hugo_Symbol", value.name = "TPM")
# ge_melt_19Q1 <- unique(ge_melt_19Q1_all)
saveRDS(ge_melt_19Q1, "./data_munging/19Q1/ge_melt_19Q1.rds", compress = "xz")
```

## Denise's GCN dataframes

Code for Denise's graph convolutional networks analyses (see meeting notes from 6 March 2019).
- Convert drug/compound names to all capitalized for harmonization.
- Convert all cell line histologies to lower case with words separated by an underscore
- Maintain same rows across all four data frames, filling with NAs as necessary
- For each dataframe, maintain same columns for all three source datasets
- Columns in final dataframes: `source`, `source_ccl_name`, `source_histology`, `sample_ID`, and `genes/compounds/mutations[p]`

### AUC

Column descriptions for `pgx_all_auc`:

- `source`: the dataset from which the data comes from (either CCLE, CTRP, or GDSC)
- `source_ccl_name`: the name of the cancer cell line (CCL) included in the source dataset
    - Note that all CCLs (excluding matched normal tissues and "merged" CCLs) from the CCLE dataset (N = 1,645) were included in `pgx_all_auc` for imputation
- `source_histology`: the general histology/tissue type of the CCL
- `sample_ID`: custom identifiers for our datasets that are concatenations of the `source`, `source_ccl_name`, and `source_histology`
- `CCLE_ccl_name`: the cell line name using CCLE nomenclature, which is a concatenation of the cell line name with the CCLE-annotated histology in all caps, separated by underscores
- `Broad_ID`: the custom identifiers (formatted as ACH-######) used by the Broad's Cancer Dependency Map project to ease cell line name harmonization efforts 
- All other columns: compound and drug names that were screened in at least one CCL in at least one source dataset
    - NA values indictate that compound wasn't screened in the respective CCL in the respective source dataset

```{r, eval=TRUE}
ccle <- read.delim("./data_munging/pharmacogenomics_raw_files/CCLE_NP24.2009_Drug_data_2015.02.24_20190307.csv", sep = ",", header  = TRUE, check.names = FALSE)
ctrp <- read.delim("./data_munging/pharmacogenomics_raw_files/CTRP_v20.data.curves_post_qc.txt.gz", sep = "\t", header  = TRUE, check.names = FALSE)
gdsc <- read.delim("./data_munging/pharmacogenomics_raw_files/GDSC_v17.3_fitted_dose_response_20190306.csv.gz", sep = ",", header  = TRUE, check.names = FALSE)

# CCLE
## Note that ActArea is NOT an AUC value
ccle_filt <- ccle[, c("CCLE Cell Line Name", "ActArea", "Compound")]
ccle_filt$source_ccl_name <- sapply(strsplit(as.character(ccle_filt$`CCLE Cell Line Name`), split = "_"), function(x) x[1])
ccle_filt$source_histology <- tolower(gsub("^[a-z0-9]*_", "", ccle_filt$`CCLE Cell Line Name`, ignore.case = TRUE))
ccle_filt$source_histology <- ifelse(ccle_filt$`CCLE Cell Line Name` == ccle_filt$source_ccl_name, NA, ccle_filt$source_histology)
colnames(ccle_filt)[colnames(ccle_filt) == "CCLE Cell Line Name"] <- "CCLE_ccl_name"
ccle_filt <- merge(select(ccl_info, source, source_ccl_name, source_histology, sample_ID, CCLE_ccl_name, Broad_ID), ccle_filt, by = c("source_ccl_name", "source_histology", "CCLE_ccl_name"), all = TRUE)
ccle_filt$compound_name <- toupper(ccle_filt$Compound)
colnames(ccle_filt)[colnames(ccle_filt) == "ActArea"] <- "AUC"
ccle_auc_long <- select(ccle_filt, source, source_ccl_name, source_histology, sample_ID, CCLE_ccl_name, Broad_ID, compound_name, AUC)
ccle_auc <- dcast(ccle_auc_long, source + source_ccl_name + source_histology + sample_ID + CCLE_ccl_name + Broad_ID ~ compound_name, value.var = "AUC", fun.aggregate = mean, fill = 10000)
ccle_auc[, 7:ncol(ccle_auc)] <- ccle_auc[, 7:ncol(ccle_auc)] %>% replace_with_na_all(condition = ~.x == 10000)

# CTRP
## area_under_curve: integrated area under the sigmoid-fit concentration-response curve
ctrp_filt <- ctrp[, c("experiment_id", "area_under_curve", "master_cpd_id")]
ctrp_meta_ccl <- select(read.delim("./data_munging/pharmacogenomics_raw_files/CTRP_v20.meta.per_cell_line_20190306.txt"), master_ccl_id, ccl_name, ccle_primary_site)
ctrp_meta_exp <- select(read.delim("./data_munging/pharmacogenomics_raw_files/CTRP_v20.meta.per_experiment_20190306.txt"), experiment_id, master_ccl_id)
ctrp_meta_cpd <- select(read.delim("./data_munging/pharmacogenomics_raw_files/CTRP_v20.meta.per_compound_20190306.txt"), master_cpd_id, cpd_name)
ctrp_keep <- merge(merge(ctrp_meta_ccl, ctrp_meta_exp, by = "master_ccl_id", all = TRUE), merge(ctrp_meta_cpd, ctrp_filt, by = "master_cpd_id", all = TRUE), by = "experiment_id", all = TRUE)
ctrp_keep$ccl_name <- gsub("-", "", ctrp_keep$ccl_name, ignore.case = TRUE)
ctrp_keep$cpd_name <- toupper(ctrp_keep$cpd_name)
ctrp_keep$ccle_primary_site <- ifelse(as.character(ctrp_keep$ccle_primary_site) == "", NA, as.character(ctrp_keep$ccle_primary_site))
ctrp_auc_long <- select(ctrp_keep, ccl_name, ccle_primary_site, cpd_name, area_under_curve)
colnames(ctrp_auc_long) <- c("source_ccl_name", "source_histology", "compound_name", "AUC")
ctrp_auc_long$source <- "CTRP"
ctrp_auc_long$sample_ID <- with(ctrp_auc_long, paste(source, source_ccl_name, source_histology, sep = "_"))
ctrp_auc_long <- merge(ctrp_auc_long, select(ccl_info, source_ccl_name, source_histology, CCLE_ccl_name, Broad_ID), by = c("source_ccl_name", "source_histology"), all.x = TRUE)
ctrp_auc_long_div <- ctrp_auc_long
ctrp_auc_long_div$AUC <- ctrp_auc_long_div$AUC / 100
ctrp_auc <- dcast(ctrp_auc_long, source + source_ccl_name + source_histology + sample_ID + CCLE_ccl_name + Broad_ID ~ compound_name, value.var = "AUC", fun.aggregate = mean, fill = 10000)
ctrp_auc[, 7:ncol(ctrp_auc)] <- ctrp_auc[, 7:ncol(ctrp_auc)] %>% replace_with_na_all(condition = ~.x == 10000)
                                                                                       
# GDSC
gdsc_meta_ccl <- select(read.delim("./data_munging/pharmacogenomics_raw_files/GDSC_Cell_Lines_Details.csv", sep = ","), Line, Site)
## For following 4 Lines, Site == "NS"
## Assigned new Sites by looking up cell lines in GDSC cell line portal (https://www.cancerrxgene.org/translation/CellLine#t-all)
gdsc_meta_ccl$Site[gdsc_meta_ccl$Line == "COR-L321"] <- "lung"
gdsc_meta_ccl$Site[gdsc_meta_ccl$Line == "SU-DHL-8"] <- "haematopoietic_and_lymphoid_tissue"
gdsc_meta_ccl$Site[gdsc_meta_ccl$Line == "CRO-AP3"] <- "haematopoietic_and_lymphoid_tissue"
gdsc_meta_ccl$Site[gdsc_meta_ccl$Line == "Hep_3B2_1-7"] <- "liver"
## For tollowing line, Site did not match CCLE notation, so I changed it to CCLE notation
gdsc_meta_ccl$Site[gdsc_meta_ccl$Line == "SW13"] <- "adrenal_cortex"
gdsc_filt <- gdsc[, c("CELL_LINE_NAME", "DRUG_NAME", "AUC")]
gdsc_filt$DRUG_NAME <- toupper(gdsc_filt$DRUG_NAME)
colnames(gdsc_filt)[colnames(gdsc_filt) ==  "CELL_LINE_NAME"] <- "Line"
gdsc_filt <- merge(gdsc_filt, gdsc_meta_ccl, by = "Line", all = TRUE)
gdsc_filt$Line <- gsub("-", "", gdsc_filt$Line, ignore.case = TRUE)
gdsc_auc_long <- select(gdsc_filt, Line, Site, DRUG_NAME, AUC)
colnames(gdsc_auc_long) <- c("source_ccl_name", "source_histology", "compound_name", "AUC")
gdsc_auc_long$source <- "GDSC"
gdsc_auc_long$sample_ID <- with(gdsc_auc_long, paste(source, source_ccl_name, source_histology, sep = "_"))
gdsc_auc_long$source_histology <- as.character(gdsc_auc_long$source_histology)
gdsc_auc_long <- merge(gdsc_auc_long, select(ccl_info, source_ccl_name, source_histology, CCLE_ccl_name, Broad_ID), by = c("source_ccl_name", "source_histology"), all.x = TRUE)
gdsc_auc <- dcast(gdsc_auc_long, source + source_ccl_name + source_histology + sample_ID + CCLE_ccl_name + Broad_ID ~ compound_name, value.var = "AUC", fun.aggregate = mean, fill = 10000)
gdsc_auc[, 7:ncol(gdsc_auc)] <- gdsc_auc[, 7:ncol(gdsc_auc)] %>% replace_with_na_all(condition = ~.x == 10000)

# Bind all AUC
pgx_auc_list <- list(ccle_auc, ctrp_auc, gdsc_auc)
pgx_auc_names <- unique(unlist(lapply(pgx_auc_list, names)))
pgx_all_auc <- do.call(rbind, c(lapply(pgx_auc_list, function(x) data.frame(c(x, sapply(setdiff(pgx_auc_names, names(x)), function(y) NA)), check.names = FALSE))))
# saveRDS(pgx_all_auc, "./data_munging/19Q1/pgx_all_auc.rds", compress = "xz")
# write.csv.gz(pgx_all_auc, "./data_munging/19Q1/pgx_all_auc.csv.gz", row.names = FALSE)
```

Compare histology representation for CCLE, CTRP, and GDSC:
```{r}
sort(unique(na.omit(ccle_auc_long$source_histology)))
sort(unique(na.omit(ctrp_auc_long$source_histology)))
sort(unique(na.omit(gdsc_auc_long$source_histology)))

setdiff(unique(na.omit(ccle_auc_long$source_histology)), unique(na.omit(gdsc_auc_long$source_histology)))
setdiff(unique(na.omit(gdsc_auc_long$source_histology)), unique(na.omit(ctrp_auc_long$source_histology)))
```

### Summary figures

```{r, eval=FALSE}
hist_auc_ccle <- ggplot(data = ccle_auc_long) +
  geom_histogram(mapping = aes(x = AUC, fill = source), color = "black", binwidth = 0.25, boundary = 0, closed = "left") +
  scale_x_continuous(breaks = seq(0, 8, by = 1), labels = seq(0, 8, by = 1)) +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  labs(title = "Distributions of AUC/ActArea values for all drug-cell line combinations", subtitle = "CCLE", y = "Frequency", x = "ActArea") +
  guides(fill = FALSE)
hist_auc_ctrp <- ggplot(data = ctrp_auc_long_div) +
  geom_histogram(mapping = aes(x = AUC, fill = source), color = "black", binwidth = 0.0125, boundary = 0, closed = "left") +
  scale_x_continuous(breaks = seq(0, 0.3, by = 0.025), labels = seq(0, 0.3, by = 0.025)) +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  labs(y = "Frequency", x = "AUC", subtitle = "CTRP", caption = "CTRP AUC values were divided by 100 prior to plotting.") +
  guides(fill = FALSE)
hist_auc_gdsc <- ggplot(data = gdsc_auc_long) +
  geom_histogram(mapping = aes(x = AUC, fill = source), color = "black", binwidth = 0.025, boundary = 0, closed = "left") +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1), labels = seq(0, 1, by = 0.1)) +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  labs(y = "Frequency", x = "AUC", subtitle = "GDSC") +
  guides(fill = FALSE)
hist_auc_ccle <- ggplot_gtable(ggplot_build(hist_auc_ccle))
hist_auc_ctrp <- ggplot_gtable(ggplot_build(hist_auc_ctrp))
hist_auc_gdsc <- ggplot_gtable(ggplot_build(hist_auc_gdsc))
p_maxWidth <-  grid::unit.pmax(hist_auc_ccle$widths[2:3], hist_auc_ctrp$widths[2:3], hist_auc_gdsc$widths[2:3])
hist_auc_ccle$widths[2:3] <- p_maxWidth
hist_auc_ctrp$widths[2:3] <- p_maxWidth
hist_auc_gdsc$widths[2:3] <- p_maxWidth
hist_auc_all <- cowplot::plot_grid(hist_auc_ccle, hist_auc_ctrp, hist_auc_gdsc, nrow = 3, rel_heights = c(9, 9, 8))
hist_auc_all
# ggsave("./gcn_denise/hist_auc_all.png", hist_auc_all, device = "png", dpi = 450, width = 12, height = 8, units = "in")

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn_ccl <- venn.diagram(list("CCLE" = unique(na.omit(ccl_info$source_ccl_name)), "CTRP" = unique(ctrp_auc_long$source_ccl_name), "GDSC" = unique(gdsc_auc_long$source_ccl_name)), resolution = 5000, main = "Overlap of cancer cell lines (CCLs) screened in each dataset", main.fontface = "bold", lty = rep("blank", 3), fill = c("springgreen4", "steelblue4", "turquoise4"), alpha = c(0.5, 0.5, 0.5), cat.pos = c(-30, 30, 0), cat.dist = c(0.01, 0.001, 0.001), cat.cex = 1.5, cex = 1, filename = NULL)
# png("./gcn_denise/venn_ccl.png")
# grid.newpage()
# grid.draw(venn_ccl)
# dev.off()

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn_histology <- venn.diagram(list("CCLE" = unique(na.omit(ccle_auc_long$source_histology)), "CTRP" = unique(na.omit(ctrp_auc_long$source_histology)), "GDSC" = unique(na.omit(gdsc_auc_long$source_histology))), resolution = 5000, main = "Overlap of cancer cell line histologies screened in each dataset", main.fontface = "bold", lty = rep("blank", 3), fill = c("springgreen4", "steelblue4", "turquoise4"), alpha = c(0.5, 0.5, 0.5), cat.pos = c(0, 0, 0), cat.dist = c(0.001, 0.001, -0.01), cat.cex = 1.5, cex = 1, filename = NULL)
# png("./gcn_denise/venn_histology.png")
# grid.newpage()
# grid.draw(venn_histology)
# dev.off()

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn_compound <- venn.diagram(list("CCLE" = unique(na.omit(ccle_auc_long$compound_name)), "CTRP" = unique(na.omit(ctrp_auc_long$compound_name)), "GDSC" = unique(na.omit(gdsc_auc_long$compound_name))), resolution = 5000, main = "Overlap of compounds screened in each dataset", main.fontface = "bold", lty = rep("blank", 3), fill = c("springgreen4", "steelblue4", "turquoise4"), alpha = c(0.5, 0.5, 0.5), cat.pos = c(-30, 30, 180), cat.dist = c(0.001, 0.001, 0.001), cat.cex = 1.5, cex = 1, filename = NULL)
# png("./gcn_denise/venn_compound.png")
# grid.newpage()
# grid.draw(venn_compound)
# dev.off()
```


# Pozdeyev et al. (2016) summary

--------------------------------------------------------------------------------

## Matched data

```{r}
ccl_histologies <- select(ccl_info, source_ccl_name, source_histology) %>% drop_na(source_ccl_name)
colnames(ccl_histologies)[colnames(ccl_histologies) == "source_ccl_name"] <- "Cell_line" 
auc <- read.delim("./data_munging/pharmacogenomics_raw_files/celline_stack.csv.gz", sep = ",")
auc <- merge(ccl_histologies, auc, by = "Cell_line", all.y = TRUE)
num_auc_per_db <- auc %>% count(Database)
ccl_per_db <- unique(select(auc, Database, Cell_line))
num_ccl_per_db <- unique(select(auc, Database, Cell_line)) %>% count(Database)
# only CCLs represetented in 2 or 3 databases were included
num_db_per_ccl <- unique(select(auc, Database, Cell_line)) %>% count(Cell_line)
```

There were `r length(setdiff(unique(ccl_histologies$Cell_line), unique(auc$Cell_line)))` cell lines not represented in the Pozdeyev et al. harmonized dataset.

## Unmatched data

```{r}
CCLE_drug_response_metrics <- as.data.frame(get(load("./../../../Desktop/Drug_Sensitvity_Metrics/data/CCLE_drug_response_metrics.RData")))
CTRP_drug_response_metrics <- as.data.frame(get(load("./../../../Desktop/Drug_Sensitvity_Metrics/data/CTRP_drug_response_metrics.RData")))
GDSC_drug_response_metrics <- as.data.frame(get(load("./../../../Desktop/Drug_Sensitvity_Metrics/data/GDSC_drug_response_metrics.RData")))

ccle_test <- merge(select(CCLE_drug_response_metrics, Drug_name, Cell_line, AUC_IC50), select(filter(auc, Database == "CCLE"), Drug_name, Cell_line, AUC_IC50), by = c("Drug_name", "Cell_line"), suffixes = c("_unmatched", "_matched_all_pairs"), all = TRUE)

ctrp_test <- merge(select(CTRP_drug_response_metrics, Drug_name, Cell_line, AUC_IC50), select(filter(auc, Database == "CTRP"), Drug_name, Cell_line, AUC_IC50), by = c("Drug_name", "Cell_line"), suffixes = c("_unmatched", "_matched_all_pairs"), all = TRUE)

gdsc_test <- merge(select(GDSC_drug_response_metrics, Drug_name, Cell_line, AUC_IC50), select(filter(auc, Database == "GDSC"), Drug_name, Cell_line, AUC_IC50), by = c("Drug_name", "Cell_line"), suffixes = c("_unmatched", "_matched_all_pairs"), all = TRUE)

auc_unmatched <- rbind(CCLE_drug_response_metrics, CTRP_drug_response_metrics, GDSC_drug_response_metrics)
auc_unmatched$AUC_EC50 <- as.numeric(as.character(auc_unmatched$AUC_EC50))
auc_unmatched$AUC_IC50 <- as.numeric(as.character(auc_unmatched$AUC_IC50))
num_auc_unmatched_per_db <- auc_unmatched %>% count(Database)
```

## Plots

Unmatched: 
```{r}
futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn_all_ccl_pozdeyev <- venn.diagram(list("CCLE" = unique(ccle_test$Cell_line), "CTRP" = unique(ctrp_test$Cell_line), "GDSC" = unique(gdsc_test$Cell_line)), resolution = 5000, main = "Overlap of cancer cell lines (CCLs) screened in each dataset", main.fontface = "bold", lty = rep("blank", 3), fill = c("springgreen4", "steelblue4", "turquoise4"), alpha = c(0.5, 0.5, 0.5), cat.pos = c(-30, 30, 180), cat.dist = c(0.01, 0.001, 0.001), cat.cex = 1.5, cex = 1, filename = NULL)
# png("./gcn_denise/pozdeyev_venn_all_ccl.png", res = 500, units = "in", width = 6, height = 6)
# grid.newpage()
# grid.draw(venn_all_ccl_pozdeyev)
# dev.off()

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn_all_drugs_pozdeyev <- venn.diagram(list("CCLE" = unique(ccle_test$Drug_name), "CTRP" = unique(ctrp_test$Drug_name), "GDSC" = unique(gdsc_test$Drug_name)), resolution = 5000, main = "Overlap of cancer cell lines (CCLs) screened in each dataset", main.fontface = "bold", lty = rep("blank", 3), fill = c("springgreen4", "steelblue4", "turquoise4"), alpha = c(0.5, 0.5, 0.5), cat.pos = c(-30, 30, 180), cat.dist = c(0.01, 0.001, 0.001), cat.cex = 1.5, cex = 1, filename = NULL)
# png("./gcn_denise/pozdeyev_venn_all_drugs.png", res = 500, units = "in", width = 6, height = 6)
# grid.newpage()
# grid.draw(venn_all_drugs_pozdeyev)
# dev.off()

aucic50_unmatched_per_db_dist <- ggplot(data = auc_unmatched) +
  facet_wrap(~ Database, scales = "free_y") +
  geom_histogram(aes(x = AUC_IC50, fill = Database), color = "black", alpha = 0.7, binwidth = 0.025, boundary = 0, closed = "left") +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  guides(fill = "none") +
  labs(x = "AUC IC50", y = "Frequency", title = "Distributions of AUC IC50 values for all drugs in each dataset (unmatched)")
aucic50_unmatched_per_db_dist
# ggsave("./gcn_denise/pozdeyev_aucic50_unmatched_per_db_dist.png", aucic50_unmatched_per_db_dist, device = "png", dpi = 450, width = 12, height = 6, units = "in")

aucec50_unmatched_per_db_dist <- ggplot(data = auc_unmatched) +
  facet_wrap(~ Database, scale = "free_y") +
  geom_histogram(aes(x = AUC_EC50, fill = Database), color = "black", alpha = 0.7, binwidth = 0.025, boundary = 0, closed = "left") +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  guides(fill = "none") +
  labs(x = "AUC EC50", y = "Frequency", title = "Distributions of AUC EC50 values for all drugs in each dataset (unmatched)")
aucec50_unmatched_per_db_dist
# ggsave("./gcn_denise/pozdeyev_aucec50_unmatched_per_db_dist.png", aucec50_unmatched_per_db_dist, device = "png", dpi = 450, width = 12, height = 6, units = "in")
```

Matched:
```{r}
futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn_ccl_pozdeyev <- venn.diagram(list("CCLE" = unique(filter(ccl_per_db, Database == "CCLE"))$Cell_line, "CTRP" = unique(filter(ccl_per_db, Database == "CTRP"))$Cell_line, "GDSC" = unique(filter(ccl_per_db, Database == "GDSC"))$Cell_line), resolution = 5000, main = "Overlap of cancer cell lines (CCLs) screened in matched_all_pairs dataset", main.fontface = "bold", lty = rep("blank", 3), fill = c("springgreen4", "steelblue4", "turquoise4"), alpha = c(0.5, 0.5, 0.5), cat.pos = c(-30, 30, 180), cat.dist = c(0.01, 0.001, 0.001), cat.cex = 1.5, cex = 1, filename = NULL)
# png("./gcn_denise/pozdeyev_venn_ccl.png", res = 500, units = "in", width = 6, height = 6)
# grid.newpage()
# grid.draw(venn_ccl_pozdeyev)
# dev.off()

num_ccl_per_db_bar <- ggplot(data = unique(select(auc, Database, Cell_line))) +
  geom_bar(aes(x = Database, fill = Database), alpha = 0.7) +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) + 
  guides(fill = "none") +
  scale_y_continuous(breaks = seq(0, 700, by = 50), labels = seq(0, 700, by = 50)) +
  geom_text(data = num_ccl_per_db, aes(x = Database, y = n + 20, label = n)) +
  labs(y = "Number of cell lines", title = "Number of unique cell lines per dataset")
num_ccl_per_db_bar
# ggsave("./gcn_denise/pozdeyev_ccl_per_db.png", num_ccl_per_db_bar, device = "png", dpi = 450, width = 12, height = 8, units = "in")

num_ccl_per_hist_per_db_bar <- ggplot(data = unique(select(auc, Database, Cell_line, source_histology))) +
  facet_wrap(~ Database, scales = "free_y") +
  geom_bar(aes(x = source_histology, fill = source_histology), alpha = 0.7) +
  guides(fill = "none") +
  coord_cartesian(ylim = c(0, 130)) +
  scale_y_continuous(breaks = seq(0, 130, by = 10), labels = seq(0, 130, by = 10)) +
  labs(x = "Histology", y = "Number of cell lines", title = "Number of unique cell lines per histology, grouped by database") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
num_ccl_per_hist_per_db_bar
# ggsave("./gcn_denise/pozdeyev_ccl_per_histology_per_db.png", num_ccl_per_hist_per_db_bar, device = "png", dpi = 450, width = 12, height = 8, units = "in")

num_ccl_per_hist_bar <- ggplot(data = unique(select(auc, Cell_line, source_histology))) +
  geom_bar(aes(x = source_histology, fill = source_histology), alpha = 0.7) +
  guides(fill = "none") +
  coord_cartesian(ylim = c(0, 130)) +
  scale_y_continuous(breaks = seq(0, 130, by = 10), labels = seq(0, 130, by = 10)) +
  labs(x = "Histology", y = "Number of cell lines", title = "Number of unique cell lines per histology across all three databases") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
num_ccl_per_hist_bar
# ggsave("./gcn_denise/pozdeyev_ccl_per_histology.png", num_ccl_per_hist_bar, device = "png", dpi = 450, width = 12, height = 8, units = "in")

aucic50_per_db_dist <- ggplot(data = auc) +
  facet_wrap(~ Database) +
  geom_histogram(aes(x = AUC_IC50, fill = Database), color = "black", alpha = 0.7, binwidth = 0.025, boundary = 0, closed = "left") +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  guides(fill = "none") +
  geom_text(data = num_auc_per_db, aes(x = 0.5, y = 4750, label = paste0("n = ", formatC(n, format = "d", big.mark = ",")))) +
  scale_y_continuous(breaks = seq(0, 5000, by = 500), labels = seq(0, 5000, by = 500)) +
  labs(x = "AUC IC50", y = "Frequency", title = "Distributions of AUC IC50 values for all drugs in each dataset (filtered by matching)")
aucic50_per_db_dist
# ggsave("./gcn_denise/pozdeyev_aucic50_per_db_dist.png", aucic50_per_db_dist, device = "png", dpi = 450, width = 12, height = 6, units = "in")

aucec50_per_db_dist <- ggplot(data = auc) +
  facet_wrap(~ Database) +
  geom_histogram(aes(x = AUC_EC50, fill = Database), color = "black", alpha = 0.7, binwidth = 0.025, boundary = 0, closed = "left") +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  guides(fill = "none") +
  geom_text(data = num_auc_per_db, aes(x = 0.5, y = 4750, label = paste0("n = ", formatC(n, format = "d", big.mark = ",")))) +
  scale_y_continuous(breaks = seq(0, 5000, by = 500), labels = seq(0, 5000, by = 500)) +
  labs(x = "AUC EC50", y = "Frequency", title = "Distributions of AUC EC50 values for all drugs in each dataset (filtered by matching)")
aucec50_per_db_dist
# ggsave("./gcn_denise/pozdeyev_aucec50_per_db_dist.png", aucec50_per_db_dist, device = "png", dpi = 450, width = 12, height = 6, units = "in")
```



