---
title: "19Q1"
author: "Sally Claridge"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: cerulean
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
    code_folding: hide
    pandoc_args: [
      "+RTS", "-K2048m",
      "-RTS"
    ]
---

Analysis of the [Broad's Avana CRISPR](https://depmap.org/portal/download/) (Broad Institute Cancer Dependency Map 2018, Meyers et al. 2017), the [Cancer Therapeutics Response Portal](https://ocg.cancer.gov/programs/ctd2/data-portal) (CTRP) drug screen dataset (v2) (Basu et al., 2013; M. G. Rees et al., 2016; B. Seashore-Ludlow et al., 2015), the [Genomics of Drug Sensitivity in Cancer](https://www.cancerrxgene.org/downloads) (GDSC) drug screen dataset (Garnett et al., 2012; Yang et al., 2012) , and the [Cancer Cell Line Encyclopedia](https://portals.broadinstitute.org/ccle) (CCLE) drug screen dataset (J. Barretina et al., 2012; T. C. C. L. E. Consortium & Consortium, 2015).

The Avana screen produced results using [CERES](https://depmap.org/ceres/) (Meyers et al. 2017) ([GitHub](https://github.com/cancerdatasci/ceres)), which generates gene dependency scores from sgRNA depletion scores from gene essentiality screens and eliminates bias arising from the effect of copy number variation on Cas9 DNA cleavage. The lower the CERES score, the higher the likelihood that the gene is essential in the associated cell line. Scores are scaled per cell line such that a score of 0 is the median effect of nonessential genes and -1 is the median effect of common core essential genes.

Annotation files for mutation status, copy number, and gene expression of the CCLE and CTRP datasets (Consortium and Consortium 2015, Barretina et al. 2012) were downloaded from the [DepMap Data Portal](https://depmap.org/portal/download/). Note that the group that conducted the GDSC screen also collected their own genomic annotation information for mutation status, copy number, and gene expression, but we did not use it.

# SET UP

--------------------------------------------------------------------------------

```{r setup, include=FALSE}
set.seed(1234)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# num_cores <- parallel::detectCores()
options(mc.cores = parallel::detectCores(), expressions = 5e5)
```

```{r libraries}
library(circlize)
library(ComplexHeatmap)
library(cowplot)
library(crunch)
library(ggpubr)
library(ggrepel)
library(ggsignif)
library(kableExtra)
library(naniar)
library(openxlsx)
library(reshape2)
library(scales)
library(tidyverse)
library(VennDiagram)

theme_set(theme_light())
```

```{r general_functions}
unfactorize <- function(df){
  for(i in which(sapply(df, class) == "factor")) {
    df[[i]] = as.character(df[[i]])
  }
  return(df)
}
```

# DATA

--------------------------------------------------------------------------------

Note that the new DepMap 19Q1 release made multiple changes to variable names:

- For their universal ccancer cell line nomenclature, they reverted back to `Broad_ID` from 18Q3 rather than `DepMap_ID` that was used in 19Q1
- The `Primary.Disease` column of the cell line metadata file is more consistently named (`Subtype.Disease` now has the specific disease annotations), though there are a couple capitalization inconsistencies
- MAF file no longer has `CCLE_Name` column and has a duplicate column of the Broad IDs (i.e. `DepMap_ID` and `Tumor_Sample_Barcode`)

And changes to the data processing pipelines (the following is taken verbatim from the [DepMap data portal](https://depmap.org/portal/download/)):

- **Expression**: We use the GTEx pipeline. Since last release, there have been some updates to the versions of different components of the pipeline and minor bug fixes on GTEx's end.
- **Mutation**: In this release, we additionally process DepMap WES samples through the CGA mutation calling pipeline adapted for cell lines and available on FireCloud. We have added a column for the allele counts from this pipeline run (CGA_WES_AC). Previously, the WES_AC column was generated from running the Van Allen mutation calling pipeline for SNPs + Mutect2 for INDELs. This column is now named VA_WES_AC.
- **Copy Number**: We have moved to using the newest version of the GATK pipeline.

## Cell line metadata

**D. Charytonowicz cell line converter**

This comprehensive cancer cell line information was curated by both Daniel Charytonowicz and myself.
```{r dan_ccl_database}
ccl_converter <- read.delim("./data_munging/cell_line_database_v1_20180911.tsv", row.names = 1, sep = "\t", header = TRUE)
ccl_lineage_converter <- unique(ccl_converter[, c("Broad_ID", "grouped_general_doid", "group_general_lineage_name")])
lineage_converter <- unique(select(ccl_lineage_converter, grouped_general_doid, group_general_lineage_name))
ccl_histologies <- read.delim("./data_munging/ccl_histologies_metadata.csv", sep = ",", header = TRUE, row.names = 1)
```

**DepMap metadata**

DepMap 19Q1 update fixed almost all of the inconsistencies of the Primary.Disease column, though there were come capitalization inconsistencies.
```{r depmap_metadata}
ccl_meta <- read.delim("./data_munging/19Q1/DepMap-2019q1-celllines_v2_20190305.csv", sep = ",", header = TRUE, na.strings = c("", NA))
ccl_meta$Primary.Disease <- tolower(ccl_meta$Primary.Disease)
ccl_meta$Primary.Disease <- with(ccl_meta, ifelse(Primary.Disease == "colon/colorectal cancer", "colorectal cancer", Primary.Disease))
ccl_meta <- subset(ccl_meta, Primary.Disease != "unknown" & Primary.Disease != "primary cells" & !grepl("MERGED", CCLE_Name, fixed = TRUE))
ccl_meta$Cell_line <- as.character(lapply(ccl_meta$CCLE_Name, function(x) strsplit(as.character(x), split = "_")[[1]][1]))
ccl_meta$Histology <- tolower(gsub("^[a-z0-9]*_", "", ccl_meta$CCLE_Name, ignore.case = TRUE))
# Convert Primary.Disease entries to all lower case to fix factorization issue
ccl_meta$Primary.Disease <- as.factor(tolower(ccl_meta$Primary.Disease))
# Harmonize ID column name
colnames(ccl_meta)[colnames(ccl_meta) == "DepMap_ID"] <- "Broad_ID"

# Remove two rows that contain cell lines with two different histologies
# The histologies that are kept are verified through matching in Cellosaurus and Cell Model Passports
# KMH2, haematopoietic_and_lymphoid: https://web.expasy.org/cellosaurus/CVCL_1330, https://cellmodelpassports.sanger.ac.uk/passports/SIDM01018
# MS1, lung: https://web.expasy.org/cellosaurus/CVCL_1429, https://cellmodelpassports.sanger.ac.uk/passports/SIDM00245
ccl_meta <- subset(ccl_meta, CCLE_Name != "KMH2_THYROID" & CCLE_Name != "MS1_SKIN")
```

## G2P

```{r g2p_interpretations}
g2p <- read.delim("./data_munging/g2p_full_level_A_dataset_NEW_DEC_2_2018_withGroupedLineages.csv", sep = "\t", header = TRUE)
g2p[, 1:2] <- NULL
g2p$Drug <- tolower(g2p$Drug)
g2p[g2p == -1] <- NA
g2p$Ref[g2p$Ref == "None"] <- NA
g2p$Alt[g2p$Alt == "None"] <- NA
g2p <- subset(g2p, grepl("^CID", g2p$DrugID))
g2p$Drug_Gene <- ifelse(is.na(g2p$Drug) | is.na(g2p$Gene), NA, paste0(g2p$Drug, "_", g2p$Gene))
g2p$position <- paste0("g.chr", g2p$Chromosome, ":", g2p$End, g2p$Ref, ">", g2p$Alt)
g2p$position <- ifelse(grepl("NA", g2p$position), NA, g2p$position)
g2p <- merge(g2p, lineage_converter, by = "grouped_general_doid", all.x = TRUE)
g2p$Drug_Gene_Lin <- ifelse(is.na(g2p$Drug) | is.na(g2p$Gene) | is.na(g2p$group_general_lineage_name), NA, paste0(g2p$Drug, "_", g2p$Gene, "_", g2p$group_general_lineage_name))

g2p_dgls <-  unique(g2p$Drug_Gene_Lin[!is.na(g2p$Drug_Gene_Lin)])
g2p_druggenes <- unique(g2p$Drug_Gene[!is.na(g2p$Drug_Gene)])
g2p_drugs <- unique(sapply(strsplit(g2p_dgls, "_", fixed = TRUE), function(x) x[1]))
g2p_genes <- unique(sapply(strsplit(g2p_dgls, "_", fixed = TRUE), function(x) x[2]))
g2p_lins <- unique(sapply(strsplit(g2p_dgls, "_", fixed = TRUE), function(x) x[3]))
g2p_druggenes
g2p_drugs
g2p_genes
g2p_lins

# Order and genes taken from pink heatmap from Daniel's analyses
# g2p_genes <- c("EGFR", "KRAS", "ERBB2", "ERBB3", "MET", "ALK", "ROS1", "PDGFRA", "ABL1", "KIT", "PDGFRB", "PDGFB", "BRAF", "G6PD", "RET", "BRCA1", "BRCA2", "UGT1A1", "TSC1", "TSC2", "AKT1", "IDH2", "DPYD", "ESR1", "CYP19A1", "TPMT", "FLT3", "NPM1", "DNMT3A", "PML", "PTCH1", "JAK2", "MYD88", "MGMT")
```

```{r testing, eval=FALSE}
unique(g2p$group_general_lineage_name)
levels(g2p$group_general_lineage_name)

g2p_nonCID <- subset(g2p, !grepl("^CID", g2p$DrugID))
summ <- g2p_nonCID %>% group_by(Drug, DrugID) %>% tally() %>% summarize(DrugID = DrugID, n = n, percent = formatC(n / 402 * 100, digits = 6, format = "f"))
summ
```

## Omics

For mutation calling, get paired gene name and cell line fields in a data frame. For this analysis, we don't care about how many mutations there are per gene or what type of mutations there are, so I didn't save more information. I took unique gene-cell line combinations since we only cared about mutation presence/absence. Add a `Mutation_Status` column denoting all entries in MAF files as mutations present in the associated cell lines.

Mutation calls (coding region, germline filtered):
```{r mutation_status, eval=FALSE}
maf_raw <- read.delim("./data_munging/19Q1/depmap_19Q1_mutation_calls_20190305.csv.gz", header = TRUE, sep = ",", row.names = 1)
# Harmonize ID column name
colnames(maf_raw)[colnames(maf_raw) == "DepMap_ID"] <- "Broad_ID"
colnames(maf_raw)[colnames(maf_raw) == "Hugo_Symbol"] <- "Gene"
# Select columns
maf_df <- subset(maf_raw, select = c("Gene", "Broad_ID", "Variant_Classification", "Reference_Allele", "Tumor_Seq_Allele1"))
maf_df$Reference_Allele <- ifelse(maf_df$Reference_Allele == "-", 0, nchar(as.character(maf_df$Reference_Allele)))
maf_df$Tumor_Seq_Allele1 <- nchar(as.character(maf_df$Tumor_Seq_Allele1))
maf_df <- maf_df[maf_df$Variant_Classification != "Silent",]
# Add Mutation_Status column
maf_df$Mutation_Status <- 1
maf_df$PointMutation <- with(maf_df, ifelse(Reference_Allele == 1 | is.na(Reference_Allele), TRUE, ifelse(Reference_Allele == 0 & Tumor_Seq_Allele1 == 1, 1, 0)))
maf_df <- unfactorize(maf_df)

saveRDS(maf_df, "./data_munging/19Q1/maf_df_19Q1.rds", compress = "xz")
```

DepMap WES CN Data:
```{r copy_number, eval=FALSE}
cn <- read.delim("./data_munging/19Q1/public_19Q1_gene_cn_20190305.csv.gz", sep = ",", check.names = FALSE, header = TRUE)
# Remove Entrez gene IDs from colnames, format is "Gene (Entrez ID)"
colnames(cn) <- gsub(" .*", "", colnames(cn))
colnames(cn)[1] <- "Broad_ID"
# Melt
cn_melt <- melt(data = cn, id.vars = "Broad_ID", measure.vars = colnames(cn[2:ncol(cn)]), variable.name = "Gene", value.name = "CN")
cn_melt <- unfactorize(cn_melt)

saveRDS(cn_melt, "./data_munging/19Q1/cn_melt_19Q1.rds", compress = "xz")
```

19Q1, CCLE RNAseq gene expression data (log2(TPM+1)):
```{r gene_expression, eval=FALSE}
ge <- read.delim("./../htscreens_giant_files/CCLE_depMap_19Q1_TPM_20190305.csv.gz", header = TRUE, sep = ",", check.names = FALSE)
# Remove Entrez gene IDs from colnames, format is "Gene (Entrez ID)"
colnames(ge) <- gsub(" .*", "", colnames(ge))
colnames(ge)[1] <- "Broad_ID"
# Melt
ge_melt <- melt(ge, id.vars = "Broad_ID", measure.vars = colnames(ge)[2:ncol(ge)], variable.name = "Gene", value.name = "TPM")
ge_melt$TPM <- log2(ge_melt$TPM + 1)
ge_melt <- unfactorize(ge_melt)

saveRDS(ge_melt, "./data_munging/19Q1/ge_melt_19Q1.rds", compress = "xz")
```

Load Rds:
```{r load_omics_rds}
maf_df <- readRDS("./data_munging/19Q1/maf_df_19Q1.rds")
cn_melt <- readRDS("./data_munging/19Q1/cn_melt_19Q1.rds")
ge_melt <- readRDS("./data_munging/19Q1/ge_melt_19Q1.rds")
```

```{r omics_testing, eval=FALSE}
test <- filter(maf_df, Gene %in% g2p_genes) %>% count(Gene, Broad_ID)
test <- test[order(test$n, decreasing = TRUE),]
```

# MERGE OMICS

--------------------------------------------------------------------------------

```{r omics_functions}
MergeOmicsG2P <- function(database, outfile) {
  # Merge mutation status, CN, and GE omics data with drugscreen results and metadata
  if(database %in% c("CCLE", "CTRP", "GDSC")) {
    filt <- auc %>% filter(Database == database) %>% select(Cell_line, Histology, TCGA_classification, CCLE_Name, Broad_ID, Drug, AUC_IC50)
    print(paste0("Processing ", database, " data."))
    colnames(filt)[colnames(filt) == "AUC_IC50"] <- "Score"

    # Get all G2P gene-cell line combinations
    grid <- expand.grid("Cell_line" = unique(filt$Cell_line), "Gene" = g2p_genes)
    data <-  merge(filt, grid, by = "Cell_line", all.y = TRUE)
    print("Merged grid.")
    # Merge metadata
    data <-  merge(data, select(ccl_meta, Cell_line, Histology, CCLE_Name, Broad_ID, Primary.Disease), by = c("Cell_line", "Histology", "CCLE_Name", "Broad_ID"), all.y = TRUE)
    ## Add columns for G2P drug-gene and drug-gene-lineage sorting
    data$Drug_Gene <- paste0(data$Drug, "_", data$Gene)
    data$G2P_Drug_Gene <- ifelse(data$Drug_Gene %in% g2p_druggenes, "Yes", "No")
    data$Drug_Gene_Lin <- paste0(data$Drug, "_", data$Gene, "_", data$Primary.Disease)
    data$G2P_Drug_Gene_Lin <- ifelse(data$Drug_Gene_Lin %in% g2p_dgls, "Yes", "No")
    print("Merged metadata.")
  }
  if(database == "CRISPR") {
    print(paste0("Processing ", database, " data."))
    # Melt CRISPR dataset for merging
    data <- melt(crispr_all, id.vars = "Broad_ID", measure.vars = colnames(crispr_all)[2:ncol(crispr_all)], variable.name = "Gene", value.name = "Score")
    # Get all G2P gene-cell line combinations
    data <-  filter(data, Gene %in% g2p_genes)
    # Merge cell line metadata
    data <- merge(data, select(ccl_meta, Cell_line, Histology, CCLE_Name, Broad_ID, Primary.Disease), by = "Broad_ID", all.y = TRUE)
    data$Drug_Gene <- paste0(data$Drug, "_", data$Gene)
    data$Drug_Gene_Lin <- paste0(data$Drug, "_", data$Gene, "_", data$Primary.Disease)
    print("Merged metadata.")
  }
  
  # Merge mutation calls
  data <- unfactorize(data)
  data <- merge(data, maf_df_ptmuts, by = c("Gene", "Broad_ID"), all.x = TRUE)
  data$Mutation_Status <- ifelse(is.na(data$Mutation_Status), 0, data$Mutation_Status)
  ## Identify point mutations
  # data$PointMutation <- ifelse(is.na(data$PointMutation), 1, data$PointMutation)
  ## Summarize number of mutant and Wildtype cell lines
  data_muts_summ <- data %>% group_by(Gene) %>% summarize(N_Wildtype = length(Mutation_Status) - sum(Mutation_Status == 1), N_Mutant = sum(Mutation_Status == 1))
  ## Merge test results back into full dataset, which restores information lost in the summarization
  data <- merge(data_muts_summ, data, by = "Gene")
  print("Merged mutation calls.")

  # Merge GE data
  data <- merge(data, ge_filt, by = c("Gene", "Broad_ID"), all.x = TRUE)
  print("Merged gene expression data.")
  
  # Merge CN data
  data <- merge(data, cn_filt, by = c("Gene", "Broad_ID"), all.x = TRUE)
  print("Merged copy number data.")
  
  # Drop cell lines not in DepMap
  data <- filter(data, !is.na(Broad_ID) & !(Broad_ID %in% c("ACH-001182", "ACH-001451")))
  
  # Factorize gene
  data$Gene <- factor(data$Gene)
  
  # Save and return dataframe
  saveRDS(data, outfile, compress = "xz")
  return(data)
}

# FilterForPointMuts <- function(dataframe, outfile) {
#   # Filter for point mutations
#   ptmuts <- filter(dataframe, PointMutation == 1)
#   # Remove columns that lead to duplicate mutation entries
#   ptmuts <- subset(ptmuts, select = -c(Variant_Classification, Reference_Allele, Tumor_Seq_Allele1, PointMutation))
#   ptmuts$Gene <- ordered(ptmuts$Gene, levels = g2p_genes)
#   ptmuts <- unique(ptmuts)
#   saveRDS(ptmuts, outfile, compress = "xz")
#   return(ptmuts)
# }
```

## Drug screens

`r nrow(filter(test, n != 1))`/`r nrow(test)` gene-cell line combinations have more than one mutation in the MAF file. This is corrected in the point mutation filtering done below.

**RE-FILTER FOR PTMUTS**
```{r merge_filter_drug_data, eval=FALSE}
# Load in Pozdeyev et al. (2016) data
ccle_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/CCLE_drug_response_metrics.csv.gz", sep = ",")
ctrp_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/CTRP_drug_response_metrics.csv.gz", sep = ",")
gdsc_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/GDSC_drug_response_metrics.csv.gz", sep = ",")

auc <- bind_rows(ccle_all, ctrp_all, gdsc_all)

# Harmonize Pozdeyev cell line names with DepMap
auc$Drug <- tolower(auc$Drug_name)
auc$Cell_line <- toupper(gsub("-", "", auc$Cell_line))
auc$Cell_line <- ifelse(auc$Cell_line == "K052", "KO52", auc$Cell_line)
auc$Cell_line <- ifelse(auc$Cell_line == "OVCAR3", "NIHOVCAR3", auc$Cell_line)
auc$Cell_line <- ifelse(auc$Cell_line == "OVCAR3", "NIHOVCAR3", auc$Cell_line)
auc$Cell_line <- ifelse(auc$Cell_line == "TI73", "T173", auc$Cell_line)
auc <- merge(ccl_histologies, auc, by = "Cell_line", all.y = TRUE)

# Omics metadata
maf_df_ptmuts <- unique(filter(maf_df, Gene %in% g2p_genes & PointMutation == 1) %>% select(-c(Variant_Classification, Reference_Allele, Tumor_Seq_Allele1, PointMutation)))
ge_filt <- filter(ge_melt, Gene %in% g2p_genes)
cn_filt <- filter(cn_melt, Gene %in% g2p_genes)

ccle_ptmuts <- MergeOmicsG2P(database = "CCLE", outfile = "./data_munging/rds/ccle_data_19Q1_g2pgenes_ptmuts.rds")
ctrp_ptmuts <- MergeOmicsG2P(database = "CTRP", outfile = "./../htscreens_giant_files/ctrp_data_19Q1_g2pgenes_ptmuts.rds")
gdsc_ptmuts <- MergeOmicsG2P(database = "GDSC", outfile = "./data_munging/rds/gdsc_data_19Q1_g2pgenes_ptmuts.rds")
```

```{r load_drug_rds, eval=TRUE}
ccle_ptmuts <- readRDS("./data_munging/rds/ccle_data_19Q1_g2pgenes_ptmuts.rds")
ctrp_ptmuts <- readRDS("./../htscreens_giant_files/ctrp_data_19Q1_g2pgenes_ptmuts.rds")
gdsc_ptmuts <- readRDS("./data_munging/rds/gdsc_data_19Q1_g2pgenes_ptmuts.rds")

# Testing
test_ccle <- ccle_ptmuts %>% count(Gene, Mutation_Status)
test_ctrp <- ctrp_ptmuts %>% count(Gene, Mutation_Status)
test_gdsc <- gdsc_ptmuts %>% count(Gene, Mutation_Status)
```

How many datasets screen each G2P drug?
```{r drug_testing, eval=FALSE}
drug_summ <- data.frame(Drug = character(), Dataset_Count = integer(), stringsAsFactors = FALSE)

for(drug in g2p_drugs) {
  counter = 0
  if(drug %in% as.character(unique(ccle$Drug))) { counter <- counter + 1 }
  if(drug %in% as.character(unique(ctrp$Drug))) { counter <- counter + 1 }
  if(drug %in% as.character(unique(gdsc$Drug))) { counter <- counter + 1 }
  drug_summ <- rbind(drug_summ, data.frame(Drug = drug, Dataset_Count = counter))
}
```

## CRISPR

Merge all CRISPR genes:
```{r merge_crispr_data, eval=TRUE}
crispr_all <- read.delim("./data_munging/19Q1/gene_effect_corrected_20190305.csv.gz", sep = ",", header  = TRUE, check.names = FALSE)
# Remove Entrez gene IDs from colnames
colnames(crispr_all) <- gsub(" .*", "", colnames(crispr_all))
colnames(crispr_all)[1] <- "Broad_ID"

# Melt CRISPR dataset for merging
crispr_melt <- melt(crispr_all, id.vars = "Broad_ID", measure.vars = colnames(crispr_all)[2:ncol(crispr_all)], variable.name = "Gene", value.name = "Score")

# Merge cell line metadata
crispr_melt <- merge(crispr_melt, ccl_meta, by = "Broad_ID", all.x = TRUE)

# Merge mutation annotations
maf_filt_crispr <- unique(filter(maf_df, Gene %in% as.character(unique(crispr_melt$Gene)) & PointMutation == 1) %>% select(-c(Variant_Classification, Reference_Allele, Tumor_Seq_Allele1, PointMutation)))
crispr_muts <- merge(crispr_melt, maf_filt_crispr, by = c("Gene","Broad_ID"), all.x = TRUE)
crispr_muts$Mutation_Status <- ifelse(is.na(crispr_muts$Mutation_Status), 0, crispr_muts$Mutation_Status)

# Summarize number of mutant and Wildtype cell lines
crispr_muts_summ <- crispr_muts %>% group_by(Gene) %>% summarize(N_Wildtype = length(Mutation_Status) - sum(Mutation_Status == 1), N_Mutant = sum(Mutation_Status == 1))
## Merge test results back into full dataset, which restores information lost in the summarization
crispr_data <- merge(crispr_muts_summ, crispr_muts, by = "Gene")
crispr_ptmuts$Mutation_Status <- factor(crispr_ptmuts$Mutation_Status)
## Add Color column
crispr_data$Color <- ifelse(crispr_data$Mutation_Status == 0, "thistle", "darkorchid")
crispr_data$Color <- factor(crispr_data$Color)

# Cell line lineages
crispr_data <- merge(crispr_data, cn_melt, by = c("Gene", "Broad_ID"), all.x = TRUE)

# Gene expression (RPKM)
ge_crispr <- filter(ge_melt, Gene %in% as.character(unique(crispr_melt$Gene)))
crispr_data <- merge(crispr_data, ge_crispr, by = c("Gene", "Broad_ID"), all.x = TRUE)

saveRDS(crispr_data, "./data_munging/rds/crispr_data_19Q1_ptmuts.rds", compress = "xz")

# Filter G2P CRISPR for point mutations
# crispr_ptmuts <- filter(crispr_data, PointMutation == 1)
# crispr_ptmuts <- subset(crispr_ptmuts, select = -c(PointMutation))
# crispr_ptmuts <- filter(crispr_ptmuts, Gene %in% g2p_genes)
# crispr_ptmuts$Primary.Disease <- factor(crispr_ptmuts$Primary.Disease)
# crispr_ptmuts$Mutation_Status <- factor(crispr_ptmuts$Mutation_Status)
# saveRDS(crispr_ptmuts, "./data_munging/rds/crispr_data_19Q1_g2pgenes_ptmuts.rds", compress = "xz")
```

```{r load_crispr_filter, eval=TRUE}
# crispr_data <- readRDS("./data_munging/rds/crispr_data_19Q1.rds")
crispr_ptmuts <- readRDS("./data_munging/rds/crispr_data_19Q1_ptmuts.rds")
```

# DATA SUMMARY FIGURES

--------------------------------------------------------------------------------

## Mutation

## Cell line and drug overlaps

```{r ccl_venn, eval=TRUE}
ccle_ccls <- unique(ccle_ptmuts$Broad_ID)
ctrp_ccls <- unique(ctrp_ptmuts$Broad_ID)
gdsc_ccls <- unique(gdsc_ptmuts$Broad_ID)
crispr_ccls <- unique(crispr_ptmuts$Broad_ID)

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn.diagram(x = list(ccle_ccls, ctrp_ccls, gdsc_ccls, crispr_ccls),
             filename = "./plots/manuscript/all_venn_ccls.png",
             output = TRUE, imagetype = "png",
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1,
             category.names = c("CCLE", "CTRP", "GDSC", "CRISPR"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             # cat.dist = c(0.06, 0.06, 0.035),
             fill = c("springgreen4", "steelblue4", "turquoise4", "darkorchid"))

venn.diagram(x = list(ccle_ccls, ctrp_ccls, gdsc_ccls),
             filename = "./plots/manuscript/drug_venn_ccls.png",
             output = TRUE, imagetype = "png",
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1.4,
             category.names = c("CCLE", "CTRP", "GDSC"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             cat.dist = c(0.06, 0.06, 0.035),
             fill = c("springgreen4", "steelblue4", "turquoise4"))
```

```{r drug_venn, eval=TRUE}
ccle_drugs <- unique(ccle_ptmuts$Drug)
ctrp_drugs <- unique(ctrp_ptmuts$Drug)
gdsc_drugs <- unique(gdsc_ptmuts$Drug)

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn.diagram(x = list(ccle_drugs, ctrp_drugs, gdsc_drugs),
             filename = "./plots/manuscript/drug_venn_drugs.png",
             output = TRUE, imagetype = "png",
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1.4,
             category.names = c("CCLE", "CTRP", "GDSC"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             cat.dist = c(0.06, 0.06, 0.035),
             fill = c("palegreen3", "slategray3", "paleturquoise3"))
```

## Histology distributions

```{r histology_dists_data, eval=TRUE}
ccle_hists <- unique(select(ccle_ptmuts, Broad_ID, Primary.Disease)) %>% count(Primary.Disease)
ccle_hists$Perc <- ccle_hists$n / sum(ccle_hists$n) * 100
ccle_hists$Dataset <- "CCLE"
ctrp_hists <- unique(select(ctrp_ptmuts, Broad_ID, Primary.Disease)) %>% count(Primary.Disease)
ctrp_hists$Perc <- ctrp_hists$n / sum(ctrp_hists$n) * 100
ctrp_hists$Dataset <- "CTRP"
gdsc_hists <- unique(select(gdsc_ptmuts, Broad_ID, Primary.Disease)) %>% count(Primary.Disease)
gdsc_hists$Perc <- gdsc_hists$n / sum(gdsc_hists$n) * 100
gdsc_hists$Dataset <- "GDSC"
crispr_hists <- unique(select(crispr_ptmuts, Broad_ID, Primary.Disease)) %>% count(Primary.Disease)
crispr_hists$Perc <- crispr_hists$n / sum(crispr_hists$n) * 100
crispr_hists$Dataset <- "CRISPR"

drug_hists <- rbind(ccle_hists, ctrp_hists, gdsc_hists, crispr_hists) %>% drop_na(Primary.Disease)
drug_hists$Dataset <- factor(drug_hists$Dataset, levels = c("CCLE", "CTRP", "GDSC", "CRISPR"))
drug_hists$Primary.Disease <- as.character(drug_hists$Primary.Disease)
drug_hists$Primary.Disease <- gsub(" cancer", "", drug_hists$Primary.Disease)
saveRDS(drug_hists, "./data_munging/rds/histology_distributions.rds")
```

```{r histology_dists, fig.height=4.5, fig.width=4}
drug_hists <- readRDS("./data_munging/rds/histology_distributions.rds")
png(filename = "./plots/manuscript/all_histology_distributions.png", width = 8, height = 9, units = "in", res = 500)
ggplot(drug_hists, aes(x = Dataset, y = n, fill = Primary.Disease)) +
  geom_bar(stat = "identity", color = "black") +
  scale_y_continuous(breaks = seq(0, 850, by = 50), labels = seq(0, 850, by = 50)) +
  guides(fill = guide_legend(title = "Histology", ncol = 1)) +
  labs(y = "Count")
dev.off()
```

```{r, eval=TRUE}
ccle_ccls <- unique(ccle_ptmuts$Broad_ID)
ctrp_ccls <- unique(ctrp_ptmuts$Broad_ID)
gdsc_ccls <- unique(gdsc_ptmuts$Broad_ID)
crispr_ccls <- unique(crispr_ptmuts$Broad_ID)

ccls <- data.frame(Broad_ID = union(ccle_ccls, union(ctrp_ccls, gdsc_ccls)))
all_ccls <- merge(ccls, ccl_meta, by = "Broad_ID")
all_ccls$Primary.Disease <- gsub(" cancer", "", all_ccls$Primary.Disease)


png(filename = "./plots/manuscript/drug_histology_distributions.png", width = 8, height = 4, units = "in", res = 500)
ggplot(all_ccls, aes(x = fct_infreq(factor(Primary.Disease)), fill = Primary.Disease)) +
  geom_bar(color = "black") +
  scale_y_continuous(breaks = seq(0, 220, by = 40), labels = seq(0, 220, by = 40)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(y = "Number of Cell Lines", x = "Histology", caption = paste0(formatC(nrow(all_ccls), format = "d", big.mark = ","), " cell lines represented."))
dev.off()
```


## G2P summary heatmap

```{r dg_heatmap, fig.height=6, fig.width=8, warning=FALSE}
g2p_dg_counts <- g2p %>% count(Drug, Gene) %>% filter(!is.na(Drug), !is.na(Gene))
g2p_dg_counts <- dcast(g2p_dg_counts, Drug ~ Gene, value.var = "n", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Drug)
g2p_dg_counts <- g2p_dg_counts[order(rowSums(-g2p_dg_counts)), order(colSums(-g2p_dg_counts))]
g2p_dg_counts[g2p_dg_counts == 0] <- NA

g2p_gene_order <- colnames(g2p_dg_counts)
g2p_drug_order <- rownames(g2p_dg_counts)

# Create annotation layer
hta_data <- data.frame(Drug = rownames(g2p_dg_counts), CCLE = NA, CTRP = NA, GDSC = NA)
hta_data$CCLE <- ifelse(hta_data$Drug %in% unique(ccle_ptmuts$Drug), "Screened", "Not screened")
hta_data$CTRP <- ifelse(hta_data$Drug %in% unique(ctrp_ptmuts$Drug), "Screened", "Not screened")
hta_data$GDSC <- ifelse(hta_data$Drug %in% unique(gdsc_ptmuts$Drug), "Screened", "Not screened")
rownames(hta_data) <- hta_data$Drug
hta_data$Drug <- NULL

hta_annot <- HeatmapAnnotation(text = anno_text(colnames(hta_data), offset = unit(0.1, "in"), gp = gpar(fontsize = 10)))
hta_legend_list <- list(legend_direction = "horizontal", border = "gray70", nrow = 2)
hta <- Heatmap(hta_data,
               name = "Functional screen status           ",
               col = c("Screened" = "purple4", "Not screened" = "gray97"), 
               rect_gp = gpar(col = "gray70"),
               top_annotation = hta_annot,
               heatmap_legend_param = hta_legend_list,
               row_names_side = "left",
               row_names_gp = gpar(fontsize = 10),
               column_names_side = "top",
               column_names_gp = gpar(fontsize = 10),
               show_column_names = FALSE,
               cluster_rows = FALSE, 
               cluster_columns = FALSE,
               row_title = "Drugs",
               row_title_gp = gpar(fontface = "bold", fontsize = 14),
               column_title = "Dataset",
               column_title_gp = gpar(fontface = "bold", fontsize = 14),
               width = unit(1.5, "in"))

# Define color scale
col_fun <- colorRamp2(c(0, 100), c("mistyrose", "purple4"))
# Legend properties list
ht_legend_list <- list(legend_direction = "horizontal", legend_width = unit(2.5, "in"), border = "gray70")
ht <- Heatmap(g2p_dg_counts, 
              name = "Number of G2P interpretations",
              col = col_fun,
              na_col = "gray97",
              rect_gp = gpar(col = "gray70"),
              heatmap_legend_param = ht_legend_list,
              cluster_rows = FALSE, 
              cluster_columns = FALSE, 
              show_row_names = FALSE,
              row_names_side = "left",
              row_names_gp = gpar(fontsize = 10),
              column_names_side = "bottom",
              column_names_gp = gpar(fontsize = 10),
              show_column_names = FALSE,
              bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(g2p_dg_counts),
                                   rot = 45,
                                   gp = gpar(fontsize = 10),
                                   offset = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.45, "in")),
              row_title = "Drugs",
              row_title_gp = gpar(fontface = "bold", fontsize = 14),
              column_title = "Genes", 
              column_title_gp = gpar(fontface = "bold", fontsize = 14),
              column_title_side = "bottom")

png(filename = "./plots/manuscript/g2p_summary_heatmap.png", width = 10, height = 9, units = "in", res = 500)
draw(hta + ht, gap = unit(5, "mm"), heatmap_legend_side = "top")
dev.off()
```


# WILCOXON (MUT)

--------------------------------------------------------------------------------

```{r wilcoxon_functions}
adj_signif <- function(df, alpha) {
  # Takes df from compare_means and creates a signif code column for FDR-adjusted p-vals
  df$p.signif.adj <- ifelse(df$p.adj <= alpha, "*", NA)
  df$p.signif <- ifelse(df$p.signif == "ns", NA, df$p.signif)
  df$p.short <- formatC(df$p, format = "g", digits =  2)
  df$p.adj.short <- formatC(df$p.adj, format = "g", digits =  2)
  return(df)
}

WilcoxonTestDF <- function(dataframe, grouping, outfile) {
  require(ggpubr)
  if("Drug_Gene_Lin" %in% grouping) {
    # Filter out DGLs with too few samples in at least one mutation status category
    count_mut_n <- dataframe %>% count(Drug_Gene_Lin, Mutation_Status) %>% filter(n >= 3)
    count_mut_category <- count_mut_n %>% count(Drug_Gene_Lin) %>% filter(n == 2)
    dgl_keep <- intersect(count_mut_n$Drug_Gene_Lin, count_mut_category$Drug_Gene_Lin)
    dataframe <- filter(dataframe, Drug_Gene_Lin %in% dgl_keep)
    dataframe$Drug_Gene_Lin <- as.character(dataframe$Drug_Gene_Lin)
  }
  signif <- compare_means(Score ~ Mutation_Status, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
  signif <- adj_signif(signif, alpha = 0.05)
  signif <- signif[order(signif$p),]
  if("Drug_Gene" %in% grouping) {
    signif$InG2P <- ifelse(signif$Drug_Gene %in% g2p_druggenes, "Yes", "No")
  }
  if("Drug_Gene_Lin" %in% grouping) {
    signif$InG2P <- ifelse(signif$Drug_Gene_Lin %in% g2p_dgls, "Yes", "No")
  }
  saveRDS(signif, outfile)
  return(signif)
}
```

```{r wilcoxon_tests, eval=TRUE}
crispr_ptmuts <- unfactorize(crispr_ptmuts)
crispr_signif_gene <- WilcoxonTestDF(dataframe = crispr_ptmuts, grouping = "Gene", outfile = "./data_munging/rds/crispr_signif_g2p_gene.rds")
crispr_signif_lineage <- WilcoxonTestDF(dataframe = crispr_ptmuts, grouping = c("Gene", "Primary.Disease"), outfile = "./data_munging/rds/crispr_signif_g2p_lineage.rds")

ccle_ptmuts_filt <- filter(ccle_ptmuts, Drug %in% g2p_drugs)
ccle_ptmuts_filt$Gene <- factor(ccle_ptmuts_filt$Gene, ordered = FALSE)
ccle_ptmuts_filt <- unfactorize(ccle_ptmuts_filt)
ccle_signif_gene <- WilcoxonTestDF(dataframe = ccle_ptmuts, grouping = c("Drug", "Gene", "Drug_Gene"), outfile = "./data_munging/rds/ccle_signif_g2p_gene.rds")
ccle_signif_g2p_druggene <- WilcoxonTestDF(dataframe = filter(ccle_ptmuts, Drug %in% g2p_drugs & Gene %in% g2p_genes), grouping = c("Drug", "Gene", "Drug_Gene"), outfile = "./data_munging/rds/ccle_signif_g2p_druggene.rds")
ccle_signif_lineage <- WilcoxonTestDF(dataframe = ccle_ptmuts_filt, grouping = c("Drug", "Gene", "Primary.Disease", "Drug_Gene_Lin"), outfile = "./data_munging/rds/ccle_signif_g2p_lineage.rds")

ctrp_ptmuts_filt <- filter(ctrp_ptmuts, Drug %in% g2p_drugs)
ctrp_ptmuts_filt$Gene <- factor(ctrp_ptmuts_filt$Gene, ordered = FALSE)
ctrp_ptmuts_filt <- unfactorize(ctrp_ptmuts_filt)
ctrp_signif_gene <- WilcoxonTestDF(dataframe = ctrp_ptmuts, grouping = c("Drug", "Gene", "Drug_Gene"), outfile = "./data_munging/rds/ctrp_signif_g2p_gene.rds")
ctrp_signif_g2p_druggene <- WilcoxonTestDF(dataframe = filter(ctrp_ptmuts, Drug %in% g2p_drugs & Gene %in% g2p_genes), grouping = c("Drug", "Gene", "Drug_Gene"), outfile = "./data_munging/rds/ctrp_signif_g2p_druggene.rds")
ctrp_signif_lineage <- WilcoxonTestDF(dataframe = ctrp_ptmuts_filt, grouping = c("Drug", "Gene", "Primary.Disease", "Drug_Gene_Lin"), outfile = "./data_munging/rds/ctrp_signif_g2p_lineage.rds")

gdsc_ptmuts_filt <- filter(gdsc_ptmuts, Drug %in% g2p_drugs)
gdsc_ptmuts_filt$Gene <- factor(gdsc_ptmuts_filt$Gene, ordered = FALSE)
gdsc_ptmuts_filt <- unfactorize(gdsc_ptmuts_filt)
gdsc_signif_gene <- WilcoxonTestDF(dataframe = gdsc_ptmuts, grouping = c("Drug", "Gene", "Drug_Gene"), outfile = "./data_munging/rds/gdsc_signif_g2p_gene.rds")
gdsc_signsif_g2p_druggene <- WilcoxonTestDF(dataframe = filter(gdsc_ptmuts, Drug %in% g2p_drugs & Gene %in% g2p_genes), grouping = c("Drug", "Gene", "Drug_Gene"), outfile = "./data_munging/rds/gdsc_signif_g2p_druggene.rds")
gdsc_signif_lineage <- WilcoxonTestDF(dataframe = gdsc_ptmuts_filt, grouping = c("Drug", "Gene", "Primary.Disease", "Drug_Gene_Lin"), outfile = "./data_munging/rds/gdsc_signif_g2p_lineage.rds")
```

```{r load_wilcoxon_rds}
crispr_signif_gene <- readRDS("./data_munging/rds/crispr_signif_g2p_gene.rds")
crispr_signif_lineage <- readRDS("./data_munging/rds/crispr_signif_g2p_lineage.rds")

ccle_signif_gene <- readRDS("./data_munging/rds/ccle_signif_g2p_gene.rds")
ccle_signif_g2p_druggene <- readRDS("./data_munging/rds/ccle_signif_g2p_druggene.rds")
ccle_signif_lineage <- readRDS("./data_munging/rds/ccle_signif_g2p_lineage.rds")

ctrp_signif_gene <- readRDS("./data_munging/rds/ctrp_signif_g2p_gene.rds")
ctrp_signif_g2p_druggene <- readRDS("./data_munging/rds/ctrp_signif_g2p_druggene.rds")
ctrp_signif_lineage <- readRDS("./data_munging/rds/ctrp_signif_g2p_lineage.rds")

gdsc_signif_gene <- readRDS("./data_munging/rds/gdsc_signif_g2p_gene.rds")
gdsc_signif_g2p_druggene <- readRDS("./data_munging/rds/gdsc_signif_g2p_druggene.rds")
gdsc_signif_lineage <- readRDS("./data_munging/rds/gdsc_signif_g2p_lineage.rds")
```

## Plots

```{r crispr_mut_gene_plot, fig.height=4, fig.width=8}
crispr_signif_gene$Gene <- factor(crispr_signif_gene$Gene, levels = g2p_genes)
crispr_ptmuts$Gene <- factor(crispr_ptmuts$Gene, levels = g2p_genes)

crispr_gene_mut_plot <- ggplot(data = crispr_ptmuts) +
  facet_wrap(~ Gene, nrow = 2, drop = FALSE) +
  scale_color_manual(name = "Mutation Status", labels = c("Wildtype", "Mutant"), values = c("1" = "darkorchid", "0" = "thistle")) +
  scale_x_discrete(name = "Mutation Status", labels = c("0" = "WT", "1" = "Mut")) +
  geom_jitter(aes(x = Mutation_Status, y = Score, color = Mutation_Status), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_boxplot(aes(x = Mutation_Status, y = Score), fill = "transparent", outlier.shape = NA, lwd = 0.3) +
  geom_text(data = crispr_signif_gene, aes(x = 1.5, y = 1.75, label = p.signif)) +
  geom_hline(yintercept = 0, lty = 2, color = "darkgray") +
  theme(legend.position = "top", legend.direction = "horizontal") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y = "CERES Score")
crispr_gene_mut_plot

ggsave("./plots/manuscript/crispr_gene_mut_plot.png", crispr_gene_mut_plot, width = 12, height = 6, units = "in")
```

```{r crispr_mut_lin_plot}
crispr_signif_lineage$Gene <- factor(crispr_signif_lineage$Gene, levels = g2p_genes)

crispr_gene_lin_plot <- ggplot(data = crispr_ptmuts) +
  facet_wrap(~ Primary.Disease, nrow = 6, scales = "free_x") +
  scale_color_manual(name = "Mutation Status", labels = c("Wildtype", "Mutant"), values = c("1" = "darkorchid", "0" = "thistle")) +
  geom_point(aes(x = Gene, y = Score, color = Mutation_Status), alpha = 0.5, size = 0.6) +
  geom_text(data = crispr_signif_lineage, aes(x = Gene, y = 1.6, label = p.signif), angle = 90, vjust = 0.8, nudge_y = 0.1, size = 3) +
  geom_hline(yintercept = 0, lty = 2, color = "darkgray") +
  theme(legend.position = "top", legend.direction = "horizontal", axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4, size = 7)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  ylab("CERES Score") +
  scale_x_discrete(name = "Mutation Status", labels = c("0" = "WT", "1" = "Mut"))
crispr_gene_lin_plot

ggsave("./plots/manuscript/crispr_gene_lineage_plot.png", crispr_gene_lin_plot, width = 16, height = 18, units = "in")
```

```{r mut_heatmap_function}
MakeMutHeatmap <- function(signif_g2p_druggene, row_names, col_title, color, legend_title) {
  # signif_g2p_druggene$Drug <- sapply(strsplit(signif_g2p_druggene$Drug_Gene, "_", fixed = TRUE), function(x) x[1])
  # signif_g2p_druggene$Gene <- sapply(strsplit(signif_g2p_druggene$Drug_Gene, "_", fixed = TRUE), function(x) x[2])
  
  signif_grid <- dcast(signif_g2p_druggene, Gene ~ Drug, value.var = "p", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
  signif_grid <- signif_grid[g2p_gene_order, intersect(g2p_drug_order, colnames(signif_grid))]
  signif_grid <- signif_grid[complete.cases(signif_grid), ]
  signif_grid[signif_grid > 0.05] <- NA
  
  signif_grid_annot <- dcast(signif_g2p_druggene, Gene ~ Drug, value.var = "InG2P", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
  signif_grid_annot <- signif_grid_annot[g2p_gene_order, intersect(g2p_drug_order, colnames(signif_grid))]
  signif_grid_annot <- signif_grid_annot[complete.cases(signif_grid_annot), ]
  signif_grid_annot[signif_grid_annot == "No"] <- ""
  signif_grid_annot[signif_grid_annot == "Yes"] <- "*"
  
  col_fun <- colorRamp2(c(0, 0.05), c(color, "gray97"))
  # Legend properties list
  ht_legend_list <- list(title = legend_title, title_position = "topleft", legend_direction = "horizontal", legend_width = unit(2, "in"), border = "gray70",   at = seq(0, 0.05, by = 0.01), labels = seq(0, 0.05, by = 0.01))
  ht <- Heatmap(signif_grid,
                col = col_fun,
                na_col = "gray97",
                rect_gp = gpar(col = "gray70"),
                heatmap_legend_param = ht_legend_list,
                cluster_rows = FALSE, 
                cluster_columns = FALSE, 
                show_row_names = as.logical(row_names),
                row_names_side = "left",
                row_names_gp = gpar(fontsize = 10),
                column_names_side = "bottom",
                column_names_gp = gpar(fontsize = 10),
                show_column_names = FALSE,
                bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(signif_grid),
                                   rot = 45,
                                   gp = gpar(fontsize = 11),
                                   offset = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.85, "in")),
                  # annotation_height = max_text_width(colnames(signif_grid))),
                row_title = "Genes",
                row_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title = col_title, 
                column_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title_side = "bottom",
                cell_fun = function(j, i, x, y, width, height, fill) { grid.text(signif_grid_annot[i, j], x, y, gp = gpar(fontsize = 20)) })
  return(ht)
}
```

```{r mut_heatmaps, eval=TRUE}
ht_ccle <- MakeMutHeatmap(signif_g2p_druggene = ccle_signif_g2p_druggene, legend_title = "P-value", row_names = TRUE, color = "darkgreen", col_title = "Drugs")
png(filename = "./plots/manuscript/ccle_mut_heatmap.png", width = 3, height = 10, units = "in", res = 500)
draw(ht_ccle, heatmap_legend_side = "top")
dev.off()

ht_ctrp <- MakeMutHeatmap(signif_g2p_druggene = ctrp_signif_g2p_druggene, legend_title = "P-value", row_names = TRUE, color = "steelblue4", col_title = "Drugs")
png(filename = "./plots/manuscript/ctrp_mut_heatmap.png", width = 9.5, height = 10, units = "in", res = 500)
draw(ht_ctrp, heatmap_legend_side = "top")
dev.off()

ht_gdsc <- MakeMutHeatmap(signif_g2p_druggene = gdsc_signif_g2p_druggene, legend_title = "P-value", row_names = TRUE, color = "turquoise4", col_title = "Drugs")
png(filename = "./plots/manuscript/gdsc_mut_heatmap.png", width = 5, height = 10, units = "in", res = 500)
draw(ht_gdsc, heatmap_legend_side = "top")
dev.off()

ht_ccle2 <- MakeMutHeatmap(signif_g2p_druggene = ccle_signif_g2p_druggene, legend_title = "CCLE p-value                                                                               ", row_names = TRUE, color = "darkgreen", col_title = "")
ht_ctrp2 <- MakeMutHeatmap(signif_g2p_druggene = ctrp_signif_g2p_druggene, legend_title = "CTRP p-value                                                                              ", row_names = FALSE, color = "steelblue4", col_title = "Drugs")
ht_gdsc2 <- MakeMutHeatmap(signif_g2p_druggene = gdsc_signif_g2p_druggene, legend_title = "GDSC p-value", row_names = FALSE, color = "turquoise4", col_title = "")
png(filename = "./plots/manuscript/drug_mut_heatmap.png", width = 13, height = 10, units = "in", res = 500)
draw(ht_ccle2 + ht_ctrp2 + ht_gdsc2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```

# SPEARMAN (CN, GE)

--------------------------------------------------------------------------------

```{r drug_spear_calc, warning=FALSE, eval=TRUE}
g2p_druggene_tally <- g2p %>% group_by(Drug_Gene) %>% tally() %>% drop_na()

# CCLE
ccle_cor_res <- ccle_ptmuts %>% group_by(Drug, Gene, Drug_Gene) %>% summarize(
                GE_r = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$estimate,
                GE_p = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$p.value,
                CN_r = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$estimate,
                CN_p = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$p.value)
ccle_cor_res <- merge(g2p_druggene_tally, ccle_cor_res, by = "Drug_Gene", all.y = TRUE)
ccle_cor_res$n <- ifelse(is.na(ccle_cor_res$n), 0, ccle_cor_res$n)
ccle_cor_res$InG2P <- ifelse(ccle_cor_res$n != 0, "Yes", "No")
ccle_cor_res$Dataset <- "CCLE"

# CTRP
ctrp_cor_res <- ctrp_ptmuts %>% group_by(Drug, Gene, Drug_Gene) %>% summarize(
                GE_r = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$estimate,
                GE_p = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$p.value,
                CN_r = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$estimate,
                CN_p = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$p.value)
ctrp_cor_res <- merge(g2p_druggene_tally, ctrp_cor_res, by = "Drug_Gene", all.y = TRUE)
ctrp_cor_res$n <- ifelse(is.na(ctrp_cor_res$n), 0, ctrp_cor_res$n)
ctrp_cor_res$InG2P <- ifelse(ctrp_cor_res$n != 0, "Yes", "No")
ctrp_cor_res$Dataset <- "CTRP"

# GDSC
gdsc_cor_res <- gdsc_ptmuts %>% group_by(Drug, Gene, Drug_Gene) %>% summarize(
                GE_r = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$estimate,
                GE_p = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$p.value,
                CN_r = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$estimate,
                CN_p = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$p.value)
gdsc_cor_res <- merge(g2p_druggene_tally, gdsc_cor_res, by = "Drug_Gene", all.y = TRUE)
gdsc_cor_res$n <- ifelse(is.na(gdsc_cor_res$n), 0, gdsc_cor_res$n)
gdsc_cor_res$InG2P <- ifelse(gdsc_cor_res$n != 0, "Yes", "No")
gdsc_cor_res$Dataset <- "GDSC"

# All
g2p_cor <- rbind(ccle_cor_res, ctrp_cor_res, gdsc_cor_res)

saveRDS(g2p_cor, "./data_munging/rds/drug_cor.rds")
```

```{r load_drug_spear}
g2p_cor <- readRDS("./data_munging/rds/drug_cor.rds")
```

Spearman correlations for gene expression and copy number:
```{r crispr_spear_calc, warning=FALSE}
crispr_spear_ge <- transform(crispr_ptmuts %>% group_by(Gene) %>% summarize(p = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$p.value, p_log10 = -log10(p), corr = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$estimate, Metric = "Gene Expression"), Gene = reorder(Gene, corr))
crispr_spear_cn <- transform(crispr_ptmuts %>% group_by(Gene) %>% summarize(p = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$p.value, p_log10 = -log10(p), corr = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$estimate, Metric = "Copy Number"), Gene = reorder(Gene, corr))
```

## Plots

Create CRISPR two-column, KRAS-inset plot for CN and GE:
```{r crispr_spear_plot, fig.height=6, fig.width=12}
spearman_KRAS <- rbind(filter(crispr_ptmuts, Gene == "KRAS") %>% summarize(p = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$p.value, corr = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$estimate, Metric = "Gene Expression"), filter(crispr_ptmuts, Gene == "KRAS") %>% summarize(p = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$p.value, corr = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$estimate, Metric = "Copy Number"))

crispr_ge_spearman_corr_inset <- ggplot(filter(crispr_ptmuts, Gene == "KRAS"), aes(x = TPM, y = Score)) +
  geom_point(pch = 21, fill = "cadetblue3", alpha = 0.6) +
  labs(x = "KRAS Gene Expression (TPM)", y = "CERES Score", subtitle = paste0("Spearman correlation coefficient = ", round(spearman_KRAS$corr[1], 2), " (p = ", formatC(as.numeric(spearman_KRAS$p[1]), format = "e", digits = 1), ")"))

crispr_cn_spearman_corr_inset <- ggplot(filter(crispr_ptmuts, Gene == "KRAS"), aes(x = CN, y = Score)) +
  geom_point(pch = 21, fill = "palegreen2", alpha = 0.6) +
  labs(x = expression("KRAS Copy Number"~(log[2]-ratio)), y = "CERES Score", subtitle = paste0("Spearman correlation coefficient = ", round(spearman_KRAS$corr[2], 2), " (p = ", formatC(as.numeric(spearman_KRAS$p[2]), format = "e", digits = 1), ")"))

crispr_ge_spearman_corr_plot <- ggplot(data = crispr_spear_ge, aes(x = Gene, y = corr)) +
  geom_point(aes(fill = p_log10), pch = 21, size = 5) +
  scale_fill_gradientn(colours = c("white", "deepskyblue4"),
                       breaks = c(0, 3, 6, 9, 12, 15),
                       labels = c(0, 3, 6, 9, 12, 15),
                       limits = c(0, 15)) +
  coord_cartesian(ylim = c(-0.325, 0.325)) +
  scale_y_continuous(breaks = seq(-0.4, 0.4, by = 0.05),
                     labels = seq(-0.4, 0.4, by = 0.05)) +
  theme(legend.position = c(0.15, 0.95),
        legend.direction = "horizontal",
        legend.key.size = unit(0.05, "npc"),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10)) +
  labs(title = "Gene Expression",
       fill = expression(-log[10](p)),
       x = "Gene",
       y = expression("Spearman Correlation Coefficient"~(r[s]))) +
  annotation_custom(ggplotGrob(crispr_ge_spearman_corr_inset),
                    xmin = 12, xmax = 32, ymin = -0.325, ymax = -0.1) +
  geom_curve(aes(x = 2, y = -0.262, xend = 13.7, yend = -0.112),
             color = "lightgray", curvature = -0.45,
             arrow = arrow(length = unit(0.03, "npc")))

crispr_cn_spearman_corr_plot <- ggplot(data = crispr_spear_cn, aes(x = Gene, y = corr)) +
  geom_point(aes(fill = p_log10), pch = 21, size = 5) +
  scale_fill_gradientn(colours = c("white", "green4"),
                       breaks = c(0, 3, 6, 9, 12, 15),
                       labels = c(0, 3, 6, 9, 12, 15),
                       limits = c(0, 15)) +
  coord_cartesian(ylim = c(-0.325, 0.325)) +
  scale_y_continuous(breaks = seq(-0.4, 0.4, by = 0.05),
                     labels = seq(-0.4, 0.4, by = 0.05)) +
  theme(legend.position = c(0.15, 0.95),
        legend.direction = "horizontal",
        legend.key.size = unit(0.05, "npc"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10)) +
  labs(title = "Copy Number",
       fill = expression(-log[10](p)),
       x = "Gene",
       y = expression("Spearman Correlation Coefficient"~(r[s]))) +
  annotation_custom(ggplotGrob(crispr_cn_spearman_corr_inset),
                    xmin = 12, xmax = 32, ymin = -0.325, ymax = -0.1) +
  geom_curve(aes(x = 2, y = -0.255, xend = 13.7, yend = -0.112),
             color = "lightgray", curvature = -0.2,
             arrow = arrow(length = unit(0.03, "npc")))

crispr_spearman_corr_plot <- plot_grid(crispr_ge_spearman_corr_plot, crispr_cn_spearman_corr_plot, align = "h")
crispr_spearman_corr_plot

ggsave("./plots/manuscript/crispr_spearman_corr_plot.png", crispr_spearman_corr_plot, device = "png", dpi = 450, width = 20, height = 10, units = "in")
```

```{r corr_heatmap_function}
MakeCorrHeatmap <- function(drug_cor_res, row_names, col_title, color_range, legend_title, metric) {
  # drug_cor_res$Drug <- sapply(strsplit(signif_g2p_druggene$Drug_Gene, "_", fixed = TRUE), function(x) x[1])
  # drug_cor_res$Gene <- sapply(strsplit(signif_g2p_druggene$Drug_Gene, "_", fixed = TRUE), function(x) x[2])
  if(toupper(metric) == "CN" | toupper(metric) == "COPY NUMBER") {
    signif_grid <- dcast(drug_cor_res, Gene ~ Drug, value.var = "CN_p", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    signif_grid <- signif_grid[g2p_gene_order, intersect(g2p_drug_order, colnames(signif_grid))]
    signif_grid <- signif_grid[complete.cases(signif_grid), ]
    signif_grid[signif_grid >= 0.05] <- ""
    signif_grid[signif_grid != ""] <- "*"
    
    corr_grid <- dcast(drug_cor_res, Gene ~ Drug, value.var = "CN_r", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    corr_grid <- corr_grid[g2p_gene_order, intersect(g2p_drug_order, colnames(corr_grid))]
    corr_grid <- corr_grid[complete.cases(corr_grid), ]
  }
  
  if(toupper(metric) == "GE" | toupper(metric) == "GENE EXPRESSION") {
    signif_grid <- dcast(drug_cor_res, Gene ~ Drug, value.var = "GE_p", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    signif_grid <- signif_grid[g2p_gene_order, intersect(g2p_drug_order, colnames(signif_grid))]
    signif_grid <- signif_grid[complete.cases(signif_grid), ]
    signif_grid[signif_grid >= 0.05] <- ""
    signif_grid[signif_grid != ""] <- "*"
    
    corr_grid <- dcast(drug_cor_res, Gene ~ Drug, value.var = "GE_r", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    corr_grid <- corr_grid[g2p_gene_order, intersect(g2p_drug_order, colnames(corr_grid))]
    corr_grid <- corr_grid[complete.cases(corr_grid), ]
  }
  
  annot_grid <- dcast(drug_cor_res, Gene ~ Drug, value.var = "InG2P", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
  annot_grid <- annot_grid[g2p_gene_order, intersect(g2p_drug_order, colnames(signif_grid))]
  annot_grid <- annot_grid[complete.cases(annot_grid), ]
  annot_grid[annot_grid == "No"] <- ""
  annot_grid[annot_grid == "Yes"] <- "*"
  
  col_fun <- colorRamp2(color_range, c("red3", "white", "green4"))
  
  # Legend properties list
  ht_legend_list <- list(title_position = "topleft", legend_direction = "horizontal", legend_width = unit(2, "in"), border = "gray70", at = seq(color_range[1], color_range[3], by = 0.2), labels = seq(color_range[1], color_range[3], by = 0.2))
  ht <- Heatmap(corr_grid,
                col = col_fun,
                name = legend_title,
                na_col = "gray97",
                rect_gp = gpar(col = "gray70"),
                heatmap_legend_param = ht_legend_list,
                cluster_rows = FALSE, 
                cluster_columns = FALSE, 
                show_row_names = as.logical(row_names),
                row_names_side = "left",
                row_names_gp = gpar(fontsize = 10),
                column_names_side = "bottom",
                column_names_gp = gpar(fontsize = 10),
                show_column_names = FALSE,
                bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(signif_grid),
                                   rot = 45,
                                   gp = gpar(fontsize = 11),
                                   offset = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.85, "in")),
                  # annotation_height = max_text_width(colnames(signif_grid))),
                row_title = "Genes",
                row_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title = col_title, 
                column_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title_side = "top",
                cell_fun = function(j, i, x, y, width, height, fill) { grid.text(signif_grid[i, j], x, y, gp = gpar(fontsize = 20)) }
                )
  return(ht)
}
```

```{r drug_spear_plots, eval=TRUE}
# Copy number
ccle_cor <- unfactorize(filter(g2p_cor, Dataset == "CCLE"))
ccle_cn_ht <- MakeCorrHeatmap(drug_cor_res = ccle_cor, row_names = TRUE, col_title = "CCLE", color_range = c(-0.25, 0, 0.25), legend_title = "CCLE Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/ccle_cn_heatmap.png", width = 3, height = 10, units = "in", res = 500)
draw(ccle_cn_ht, heatmap_legend_side = "top")
dev.off()

ctrp_cor <- unfactorize(filter(g2p_cor, Dataset == "CTRP"))
ctrp_cn_ht <- MakeCorrHeatmap(drug_cor_res = ctrp_cor, row_names = TRUE, col_title = "CTRP", color_range = c(-0.35, 0, 0.35), legend_title = "CTRP Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/ctrp_cn_heatmap.png", width = 9.5, height = 10, units = "in", res = 500)
draw(ctrp_cn_ht, heatmap_legend_side = "top")
dev.off()

gdsc_cor <- unfactorize(filter(g2p_cor, Dataset == "GDSC"))
gdsc_cn_ht <- MakeCorrHeatmap(drug_cor_res = gdsc_cor, row_names = TRUE, col_title = "GDSC", color_range = c(-0.25, 0, 0.25), legend_title = "GDSC Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/gdsc_cn_heatmap.png", width = 5, height = 10, units = "in", res = 500)
draw(gdsc_cn_ht, heatmap_legend_side = "top")
dev.off()

ccle_cn_ht2 <- MakeCorrHeatmap(drug_cor_res = ccle_cor, row_names = TRUE, col_title = "CCLE", color_range = c(-0.35, 0, 0.35), legend_title = "Copy num. Spearman correlation", metric = "CN")
ctrp_cn_ht2 <- MakeCorrHeatmap(drug_cor_res = ctrp_cor, row_names = FALSE, col_title = "CTRP", color_range = c(-0.35, 0, 0.35), legend_title = "Copy num. Spearman correlation", metric = "CN")
gdsc_cn_ht2 <- MakeCorrHeatmap(drug_cor_res = gdsc_cor, row_names = FALSE, col_title = "GDSC", color_range = c(-0.35, 0, 0.35), legend_title = "Copy num. Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/drug_cn_heatmap.png", width = 13, height = 10, units = "in", res = 500)
draw(ccle_cn_ht2 + ctrp_cn_ht2 + gdsc_cn_ht2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()

# Gene expression
ccle_ge_ht <- MakeCorrHeatmap(drug_cor_res = ccle_cor, row_names = TRUE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), legend_title = "CCLE Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/ccle_ge_heatmap.png", width = 3, height = 10, units = "in", res = 500)
draw(ccle_ge_ht, heatmap_legend_side = "top")
dev.off()

ctrp_ge_ht <- MakeCorrHeatmap(drug_cor_res = ctrp_cor, row_names = TRUE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), legend_title = "CTRP Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/ctrp_ge_heatmap.png", width = 9.5, height = 10, units = "in", res = 500)
draw(ctrp_ge_ht, heatmap_legend_side = "top")
dev.off()

gdsc_ge_ht <- MakeCorrHeatmap(drug_cor_res = gdsc_cor, row_names = TRUE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), legend_title = "GDSC Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/gdsc_ge_heatmap.png", width = 5, height = 10, units = "in", res = 500)
draw(gdsc_ge_ht, heatmap_legend_side = "top")
dev.off()

ccle_ge_ht2 <- MakeCorrHeatmap(drug_cor_res = ccle_cor, row_names = TRUE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), legend_title = "Gene expr. Spearman correlation", metric = "GE")
ctrp_ge_ht2 <- MakeCorrHeatmap(druwg_cor_res = ctrp_cor, row_names = FALSE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), legend_title = "Gene expr. Spearman correlation", metric = "GE")
gdsc_ge_ht2 <- MakeCorrHeatmap(drug_cor_res = gdsc_cor, row_names = FALSE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), legend_title = "Gene expr. Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/drug_ge_heatmap.png", width = 13, height = 10, units = "in", res = 500)
draw(ccle_ge_ht2 + ctrp_ge_ht2 + gdsc_ge_ht2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```



# DGL KS TESTS

--------------------------------------------------------------------------------

```{r KS_functions}
MakeCorrResSummaryTable <- function(df_list, dataset_name) {
  # Input: list of dataframes corresponding to Drug_Gene groupings in the drugscreen datasets filtered for point mutations
  CorrResSummaryTable <- data.frame(matrix(ncol = 7, nrow = 0))
  for(i in 1:length(df_list)) {
    corr_res <- df_list[[i]] %>% group_by(G2P_Drug_Gene_Lin) %>% summarize(
                Dataset = dataset_name,
                Drug_Gene = names(df_list)[i],
                G2P_Drug_Gene = ifelse(Drug_Gene %in% g2p_druggenes, "Yes", "No"),
                Lineages = paste(as.character(unique(Primary.Disease)), collapse = ", "),
                N_Lineages = length(as.character(unique(Primary.Disease))),
                Spearman_Corr_GE = cor.test(y = Score, x = TPM, method = "spearman", use = "complete.obs")$estimate,
                Spearman_Corr_CN = cor.test(y = Score, x = CN, method = "spearman", use = "complete.obs")$estimate)
    # print(names(df_list)[i])
    
    if(length(unique(df_list[[i]]$Mutation_Status)) == 2) {
      dgl_signif <- compare_means(Score ~ Mutation_Status, data = df_list[[i]], group.by = "G2P_Drug_Gene_Lin", method = "wilcox.test")[, c("G2P_Drug_Gene_Lin", "p")]
    }
    if(length(unique(df_list[[i]]$Mutation_Status)) == 1) {
      dgl_signif <- data.frame("G2P_Drug_Gene_Lin" = NA, "p" = NA)
    }
    
    corr_res <- merge(corr_res, dgl_signif, by = "G2P_Drug_Gene_Lin", all = TRUE)
    corr_res$Mut_Signif <- ifelse(corr_res$p < 0.05, 1, 0)
    CorrResSummaryTable <- rbind(CorrResSummaryTable, corr_res)
  }
  CorrResSummaryTable <- CorrResSummaryTable[!is.na(CorrResSummaryTable$G2P_Drug_Gene_Lin), ]
  return(CorrResSummaryTable)
}

G2PCorrKStest <- function(dataset, dataset_name) {
  # Input: CorrResSummaryTable created by the MakeCorrResSummaryTable function
  Metric <- colnames(dataset)[7:8]
  D_stat <- NULL
  pval <- NULL
  signif <- NULL
  
  yes <- dataset[dataset$G2P_Drug_Gene_Lin == "Yes",]
  no <- dataset[dataset$G2P_Drug_Gene_Lin == "No",]
  
  for(i in 7:8) {
    test <- ks.test(yes[[colnames(yes)[i]]], no[[colnames(no)[i]]])
    D_stat <- c(D_stat, test$statistic)
    pval <- c(pval, test$p.value)
    signif <- c(signif, ifelse(test$p.value < 0.001, "***", ifelse(test$p.value < 0.01, "**", ifelse(test$p.value < 0.05, "*", NA))))
  }
  df <- data.frame(Metric, D_stat, pval, signif)
  df$Dataset <- dataset_name
  return(df)
}

G2PCorrTable <- function(ccle_ptmuts_df, ctrp_ptmuts_df, gdsc_ptmuts_df) {
  # CCLE
  ccle_split <- split(ccle_ptmuts_df, f = ccle_ptmuts_df$Drug_Gene)
  ccle_corr_all <- MakeCorrResSummaryTable(ccle_split, dataset_name = "CCLE")
  print("CCLE correlations: Complete.")
  # CTRP
  ctrp_split <- split(ctrp_ptmuts_df, f = ctrp_ptmuts_df$Drug_Gene)
  ctrp_corr_all <- MakeCorrResSummaryTable(ctrp_split, dataset_name = "CTRP")
  print("CTRP correlations: Complete.")
  # GDSC
  gdsc_split <- split(gdsc_ptmuts_df, f = gdsc_ptmuts_df$Drug_Gene)
  gdsc_corr_all <- MakeCorrResSummaryTable(gdsc_split, dataset_name = "GDSC")
  print("GDSC correlations: Complete.")
  
  g2p_corr_all <- rbind(ccle_corr_all, ctrp_corr_all, gdsc_corr_all)
  
  return(g2p_corr_all)
} 
  
G2PCorrStatsTables<- function(corr_df, table_type) {  
  if(table_type == "mutation" | table_type == "mut" ) {
    mut_stats <- corr_df %>% group_by(G2P_Drug_Gene_Lin, Dataset) %>% drop_na(Mut_Signif) %>% summarize(N_Signif_Muts = sum(Mut_Signif), Total_Tests = length(Mut_Signif), Perc_Signif = N_Signif_Muts / Total_Tests * 100)
    print("Returning mutation statistics.")
    return(mut_stats)
  }
  if(table_type == "KS" | table_type == "ks") {
    ccle_corr_stats <- G2PCorrKStest(filter(corr_df, Dataset == "CCLE"), "CCLE")
    ctrp_corr_stats <- G2PCorrKStest(filter(corr_df, Dataset == "CTRP"), "CTRP")
    gdsc_corr_stats <- G2PCorrKStest(filter(corr_df, Dataset == "GDSC"), "GDSC")
    corr_stats <- rbind(ccle_corr_stats, ctrp_corr_stats, gdsc_corr_stats)
    corr_stats <- corr_stats %>% separate(col = Metric, into = c("Correlation_Method", "corr", "Metric"), sep = "_")
    corr_stats$Metric <- ifelse(corr_stats$Metric == "GE", "Gene Expression", "Copy Number")
    print("Returning KS test results.")
    return(corr_stats)
  }
}
```

Kolmogorov-Smirnov tests comparing DGLs that are in a G2P DGL and not.
```{r drug_KS_tests, eval=TRUE, warning=FALSE, fig.height=6, fig.width=12}
g2p_dgl_corr <- G2PCorrTable(ccle_ptmuts_df = ccle_ptmuts, ctrp_ptmuts_df = ctrp_ptmuts, gdsc_ptmuts_df = gdsc_ptmuts)
saveRDS(g2p_dgl_corr, "./data_munging/rds/g2p_dgl_corr.rds")
g2p_dgl_corr <- readRDS("./data_munging/rds/g2p_dgl_corr.rds")
g2p_mut_stats <- G2PCorrStatsTables(corr_df = g2p_dgl_corr, table_type = "mutation")

g2p_corr_4plot <- filter(g2p_corr_all, G2P_Drug_Gene == "Yes")
g2p_corr_stats <- G2PCorrStatsTables(corr_df = g2p_corr_4plot, table_type = "KS")
g2p_corr_4plot$p <- NULL
g2p_corr_4plot$Mut_Signif <- NULL
g2p_corr_4plot <- melt(g2p_corr_4plot, id.vars = colnames(g2p_corr_4plot)[1:6], measure.vars = colnames(g2p_corr_4plot)[7:8], value.name = "Correlation")
g2p_corr_4plot <- g2p_corr_4plot %>% separate(col = variable, into = c("Correlation_Method", "corr", "Metric"), sep = "_", remove = FALSE)
g2p_corr_4plot$Metric <- ifelse(g2p_corr_4plot$Metric == "GE", "Gene Expression", "Copy Number")

g2p_ks_res_plot_spearman <- ggplot(data = filter(g2p_corr_4plot, Correlation_Method == "Spearman")) +
  facet_grid(Metric ~ Dataset, labeller = labeller(yfacet = c('CN' = "Copy Number", 'GE' = "Gene Expression"))) +
  geom_violin(aes(y = Correlation, x = G2P_Drug_Gene_Lin, fill = Dataset, color = Dataset, alpha = G2P_Drug_Gene_Lin)) +
  geom_boxplot(width = 0.075, aes(y = Correlation, x = G2P_Drug_Gene_Lin, color = Dataset)) +
  geom_jitter(width = 0.3, alpha = 0.8, aes(y = Correlation, x = G2P_Drug_Gene_Lin, color = Dataset)) +
  theme(legend.position = "none") +
  scale_alpha_manual(values = c("Yes" = 0.6, "No" = 0.2)) +
  scale_fill_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  scale_color_manual(values = c("CCLE" = "springgreen4", "CTRP" = "steelblue4", "GDSC" = "turquoise4")) +
  coord_cartesian(ylim = c(-1, 1)) +
  geom_text(data = filter(g2p_corr_stats, Correlation_Method == "Spearman"),
            aes(x = 1.5, y = 0.8,
                label = paste0("D = ", formatC(D_stat, digits = 2, format = "f"),
                               ", p = ", ifelse(pval > 0.1, round(pval, 2), ifelse(pval < 0.001, formatC(pval, digits = 1, format = "e"), round(pval, 3))),
                               "\n", ifelse(is.na(signif), "", signif)))) +
  labs(x = "Is the lineage in a G2P DGL?",
       y = expression("Spearman Correlation Coefficient"~(r[s])))
g2p_ks_res_plot_spearman

ggsave("./plots/manuscript/g2p_spearman_ks_res_plot.png", g2p_ks_res_plot_spearman, device = "png", dpi = 500, width = 12, height = 6, units = "in")
```

# SANDBOX

--------------------------------------------------------------------------------

Filter for BRCA1/2 mutations to see if we catch non-germline mutations/CN variants:
```{r brca_test, eval=FALSE}
test <- filter(maf_df, Gene == "BRCA1" | Gene == "BRCA2")
test2 <- filter(cn_melt, Gene == "BRCA1" | Gene == "BRCA2")
```

Test filtering CRISPR data for G2P genes using function:
```{r crispr_fnx_test, eval=FALSE}
crispr_all <- read.delim("./data_munging/19Q1/gene_effect_corrected_20190305.csv.gz", sep = ",", header  = TRUE, check.names = FALSE)
# Remove Entrez gene IDs from colnames
colnames(crispr_all) <- gsub(" .*", "", colnames(crispr_all))
colnames(crispr_all)[1] <- "Broad_ID"

# Omics metadata
maf_df_filt <- filter(maf_df, Gene %in% g2p_genes)
ge_filt <- filter(ge_melt, Gene %in% g2p_genes)
cn_filt <- filter(cn_melt, Gene %in% g2p_genes)

crispr_fxn <- MergeOmicsG2P(database = "CRISPR", outfile = "./../htscreens_giant_files/crispr_data_19Q1_g2pgenes_fxn.rds")
crispr_ptmuts_fxn <- FilterForPointMuts(dataframe = crispr_fxn, outfile = "./../htscreens_giant_files/crispr_data_19Q1_g2pgenes_ptmuts_fxn.rds")
```

```{r load_crispr_fnx_test_rds, eval=FALSE}
crispr_fxn <- readRDS("./../htscreens_giant_files/crispr_data_19Q1_g2pgenes_fxn.rds")
crispr_ptmuts_fxn <- readRDS("./../htscreens_giant_files/crispr_data_19Q1_g2pgenes_ptmuts_fxn.rds")
```

Test out standardization/normalization methods on Pozdeyev data. This yields evidence that the AUC values are already normalized.
```{r pozdeyev_norm_testing, eval=FALSE}
ccle_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/CCLE_drug_response_metrics.csv.gz", sep = ",")
ccle_all$AUC_IC50_standardized <- scale(ccle_all$AUC_IC50, center = TRUE, scale = TRUE)
ccle_all$AUC_IC50_normalized <- scale(ccle_all$AUC_IC50, center = min(ccle_all$AUC_IC50[!is.na(ccle_all$AUC_IC50)]), scale = max(ccle_all$AUC_IC50[!is.na(ccle_all$AUC_IC50)]) - min(ccle_all$AUC_IC50[!is.na(ccle_all$AUC_IC50)]))
ctrp_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/CTRP_drug_response_metrics.csv.gz", sep = ",")
ctrp_all$AUC_IC50_standardized <- scale(ctrp_all$AUC_IC50, center = TRUE, scale = TRUE)
ctrp_all$AUC_IC50_normalized <- scale(ctrp_all$AUC_IC50, center = min(ctrp_all$AUC_IC50[!is.na(ctrp_all$AUC_IC50)]), scale = max(ctrp_all$AUC_IC50[!is.na(ctrp_all$AUC_IC50)]) - min(ctrp_all$AUC_IC50[!is.na(ctrp_all$AUC_IC50)]))
gdsc_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/GDSC_drug_response_metrics.csv.gz", sep = ",")
gdsc_all$AUC_IC50_standardized <- scale(gdsc_all$AUC_IC50, center = TRUE, scale = TRUE)
gdsc_all$AUC_IC50_normalized <- scale(gdsc_all$AUC_IC50, center = min(gdsc_all$AUC_IC50[!is.na(gdsc_all$AUC_IC50)]), scale = max(gdsc_all$AUC_IC50[!is.na(gdsc_all$AUC_IC50)]) - min(gdsc_all$AUC_IC50[!is.na(gdsc_all$AUC_IC50)]))

auc_test <- bind_rows(ccle_all, ctrp_all, gdsc_all)

ggplot(data = auc_test) +
  geom_histogram(aes(x = AUC_IC50)) +
  facet_wrap(~ Database, ncol = 3, scales = "free_y")
ggplot(data = auc_test) +
  geom_histogram(aes(x = AUC_IC50_normalized)) +
  facet_wrap(~ Database, ncol = 3, scales = "free_y")
ggplot(data = auc_test) +
  geom_histogram(aes(x = AUC_IC50_standardized)) +
  facet_wrap(~ Database, ncol = 3, scales = "free_y")
```

# SESSION INFORMATION

--------------------------------------------------------------------------------

```{r session_info}
print(sessionInfo())
```