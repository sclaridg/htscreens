---
title: "Lineage Analysis of CRISPR and shRNA Screens"
author: "Sally Claridge"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: cerulean
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
    code_folding: hide
---

Analysis of the Broad's Avana CRISPR (Broad Institute Cancer Dependency Map 2018, Meyers et al. 2017) and the Broad and Dana-Farber Cancer Institite's Achilles shRNA (MacFarland et al. 2018, Data Science 2018).

The Avana screen produced results using [CERES](https://depmap.org/ceres/) (Meyers et al. 2017) ([GitHub](https://github.com/cancerdatasci/ceres)), which generates gene dependency scores from sgRNA depletion scores from gene essentiality screens and eliminates bias arising from the effect of copy number variation on Cas9 DNA cleavage. The lower the CERES score, the higher the likelihood that the gene is essential in the associated cell line. Scores are scaled per cell line such that a score of 0 is the median effect of nonessential genes and -1 is the median effect of common core essential genes.

In a previous version of the shRNA screen, DEMETER ([GitHub](https://github.com/cancerdatasci/demeter)) was used to compute a dependency score for each gene by using the depletion values from each shRNA to infer the effect of target knockdown (on-target) and of expressing a given miRNA seed (off-target) in each cell line. More negative values indicate increased dependency, while more positive values indicate lower dependency. Zero represents the avergae dependency across all cell lines.

In the new data release, [DEMETER2](https://depmap.org/R2-D2/) ([GitHub repository](https://github.com/cancerdatasci/demeter2)), developed by McFarland et al. (2018) was used to analyze the Achilles screen. DEMETER2 expands on DEMETER by including parameters for cell-line-specific screen effects and noisy data, correcting for global differences in shRNA levels across cell lines, pooling data acorss cell lines via hierarchical modeling, and using Bayesian inference to compute uncertainty estimates. Now, a score of zero represents no dependency.

All annotation files (copy number, mutation status, and gene expression) (Consortium and Consortium 2015, Barretina et al. 2012) were downloaded from the [DepMap Data Portal](https://depmap.org/portal/download/).

# Set up

--------------------------------------------------------------------------------

```{r setup, include=FALSE}
set.seed(1234)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

num_cores <- parallel::detectCores()
options(mc.cores = num_cores)
```

Load libraries.
```{r}
library(NMF)
library(ggpubr)
library(ggsignif)
library(rowr)
library(data.table)
library(CePa)
library(plyr)
library(tidyverse)
library(magrittr)
library(matrixStats)
library(parallel)
library(kableExtra)
library(gridExtra)
library(broom)
library(glmnet)
library(devtools)
library(reshape2)
library(caret)
library(bsselectR)
library(ComplexHeatmap)
library(circlize)
```

## Functions {.tabset .tabset-fade .tabset-pills}

### Significance thresholding

```{r}
adj_signif <- function(df) {
  # Takes df from compare_means and creates a signif code column for adjusted p-vals
  df$p.signif <- ifelse(df$p.signif == "ns", NA, df$p.signif)
  df$p.signif.adj <- ifelse(df$p.adj <= 0.0001, "****",
                     ifelse(df$p.adj <= 0.001, "***",
                     ifelse(df$p.adj <= 0.01, "**",
                     ifelse(df$p.adj <= 0.05, "*", NA))))
  df$p.short <- formatC(df$p, format = "g", digits =  2)
  df$p.adj.short <- formatC(df$p.adj, format = "g", digits =  2)
  
  return(df)
}
```

### Make CRISPR grobs

```{r}
makeCRISPRgrob <- function(g) {
  
  gene <- filter(crispr_data, Hugo_Symbol == g)
  
  # Mutation status
  crispr_color <- as.character(gene$Color)
  names(crispr_color) <- gene$Mutation_Status
  sig <- filter(crispr_signif, Hugo_Symbol == g)
  plot_mut <- ggplot(data = gene, aes(x = Mutation_Status, y = Score, color = Mutation_Status)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(alpha = 0.3, size = 0.7, position = position_jitter(w = 0.05)) +
    scale_color_manual(values = crispr_color) +
    geom_hline(yintercept = 0, linetype = 2, lwd = 0.3) +
    theme_light() +
    theme(legend.position = "none") +
    labs(x = paste0(g, " Mutation Status"), y = "CERES Score",
         title = "Mutation Status",
         subtitle = paste0("Wilcoxon test:\n- BH-corrected p-value: ", sig$p.adj.short, "\n- Uncorrected p-value: ", sig$p.short))
  
  # Copy number
  lo_cn <- range(gene$Copy_Number[!is.na(gene$Copy_Number)])[1]
  hi_cn <- range(gene$Copy_Number[!is.na(gene$Copy_Number)])[2]
  mid_cn <- (hi_cn - lo_cn) / 2
  plot_cn <- ggplot(data = gene, aes(x = Copy_Number, y = Score, color = Mutation_Status)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(method = "lm", size = 0.5) +
    geom_hline(yintercept = 0, linetype = 2, lwd = 0.3) +
    scale_color_manual(values = crispr_color) +
    stat_cor(method = "pearson", show.legend = FALSE, label.x = c((lo_cn + mid_cn) / 2, (hi_cn - mid_cn) / 2 + mid_cn), label.y = max(gene$Score)) +
    theme(legend.position = "none") +
    labs(y = "CERES Score", color = "Mutation Status",
         x = paste0(g, " Theoretical Copy number"), title = "Copy Number",
         subtitle = "r: Pearson correlation coeffcient")
  
  # Gene expression
  lo_ge <- range(gene$RPKM_log2[!is.na(gene$RPKM_log2)])[1]
  hi_ge <- range(gene$RPKM_log2[!is.na(gene$RPKM_log2)])[2]
  mid_ge <- (hi_ge - lo_ge) / 2
  plot_ge <- ggplot(data = gene, aes(x = RPKM_log2, y = Score, color = Mutation_Status)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(method = "lm", size = 0.5) +
    geom_hline(yintercept = 0, linetype = 2, lwd = 0.3) +
    scale_color_manual(values = crispr_color) +
    stat_cor(method = "pearson", show.legend = FALSE, label.x = c((lo_ge + mid_ge) / 2, (hi_ge - mid_ge) / 2 + mid_ge), label.y = max(gene$Score)) +
    theme(legend.position = "none") +
    labs(y = "CERES Score", color = "Mutation Status",
         x = paste0(g, " Gene Expression [log2(RPKM)]"),
         title = "Gene Expression",
         subtitle = "r: Pearson correlation coeffcient")
  
  # Cell line lineage
  plot_lin <- ggplot(data = gene, aes(x = lineage_name, y = Score, color = Mutation_Status)) +
    geom_point(alpha = 0.5) +
    scale_color_manual(values = crispr_color) +
    geom_hline(yintercept = 0, linetype = 2, lwd = 0.3) +
    scale_y_continuous(sec.axis = sec_axis(~ .)) +
    coord_flip() +
    theme(legend.position = "none") +
    labs(y = "CERES Score", x = "Cell Line Lineage",
         color = "Mutation Status", title = g)
  
  # Arrange plots
  plot <- ggarrange(ggarrange(plot_lin, nrow = 1, labels = c("A")),
                    ggarrange(plot_mut, plot_cn, plot_ge, nrow = 3,
                              labels = c("B", "C", "D"), heights = c(2, 3, 3)),
                    font.label = list(size = 30, face = "bold"),
                    nrow = 1, ncol = 2, widths = c(3, 2))
  return(plot)
}
```

### Make lineage plot

```{r}
makeCRISPRlinplot <- function(g) {
  sig <- filter(crispr_signif_lineage, Hugo_Symbol == g)
  if(nrow(sig) == 0) {
    return(NULL)
  }
  else {
    gene <- filter(crispr_data, Hugo_Symbol == g)
    gene <- merge(gene, sig, by = c("Hugo_Symbol", "lineage_name"))
    gene <- mutate(gene, lineage_name = reorder(lineage_name, p, mean))
    crispr_color <- as.character(gene$Color)
    names(crispr_color) <- gene$Mutation_Status
    score_range <- abs(range(gene$Score)[2] - range(gene$Score)[1])
    round_accuracy <- ifelse(score_range <= 2, 0.25,
                             ifelse(score_range <= 3, 0.5, 1.0))
    
    plot <- ggplot(data = gene, aes(x = lineage_name, y = Score)) +
      geom_point(alpha = 0.5, mapping = aes(color = Mutation_Status)) +
      scale_color_manual(values = crispr_color) +
      coord_cartesian(y = c(min(gene$Score), round_any(x = max(gene$Score), accuracy = round_accuracy, f = ceiling))) +
      geom_signif(data = gene, mapping = aes(xmin = lineage_name, xmax = lineage_name, annotations = paste(p.short, "\n", p.adj.short), y_position = max(gene$Score)), manual = TRUE, tip_length   = 0, size = 0, textsize = 3) +
      theme(legend.position = "top", axis.text.x = element_text(angle = 70, hjust = 1, size = 10)) +
      labs(y = "CERES Score",
           x = "Lineage",
           color = "Mutation Status",
           title = paste0(g, ": CERES score by cell line lineage"),
           subtitle = "Lineages sorted by increasing p-value; labels indicate unadjusted p-value / BH-corrected p-value.")
    return(plot)
  }
}
```

### Make tissue plot

```{r}
makeCRISPRtissueplot <- function(g) {
  sig <- filter(crispr_signif_tissue, Hugo_Symbol == g)
  if(nrow(sig) == 0) {
    return(NULL)
  }
  else {
    gene <- filter(crispr_data, Hugo_Symbol == g)
    gene <- merge(gene, sig, by = c("Hugo_Symbol", "primary_tissue"))
    gene <- mutate(gene, primary_tissue = reorder(primary_tissue, p, mean))
    crispr_color <- as.character(gene$Color)
    names(crispr_color) <- gene$Mutation_Status
    score_range <- abs(range(gene$Score)[2] - range(gene$Score)[1])
    round_accuracy <- ifelse(score_range <= 2, 0.25,
                             ifelse(score_range <= 3, 0.5, 1.0))
    
    plot <- ggplot(data = gene, aes(x = primary_tissue, y = Score)) +
      geom_point(alpha = 0.5, mapping = aes(color = Mutation_Status)) +
      scale_color_manual(values = crispr_color) +
      coord_cartesian(y = c(min(gene$Score), round_any(x = max(gene$Score), accuracy = round_accuracy, f = ceiling))) +
      geom_signif(data = gene, mapping = aes(xmin = primary_tissue, xmax = primary_tissue, annotations = paste(p.short, "\n", p.adj.short), y_position = max(gene$Score)), manual = TRUE, tip_length   = 0, size = 0, textsize = 3) +
      theme(legend.position = "top", axis.text.x = element_text(angle = 70, hjust = 1, size = 10)) +
      labs(y = "CERES Score",
           x = "Primary Tissue",
           color = "Mutation Status",
           title = paste0(g, ": CERES score by cell line primary tissue"),
           subtitle = "Primary tissues sorted by increasing p-value; labels indicate unadjusted p-value / BH-corrected p-value.")
    return(plot)
  }
}
```

### Make individual heatmaps per cluster

Take in a sorted gene list from a larger heatmap and produce smaller, individual heatmaps:
```{r, eval=FALSE}
makeHeatmaps <- function(clust_obj, clust_num) {
  chm_plot_cols <- colnames(clust_obj)
  chm_plot_rows <- rownames(clust_obj)
  
  chm_plot <- Heatmap(clust_obj, name = "CERES Score",
          bottom_annotation = HeatmapAnnotation(df = chm_annot),
          bottom_annotation_height = unit(5, "in"),
          row_title = "Genes", column_title = "Cancer Cell Lines (Broad IDs)",
          col = colorRamp2(c(min(chm_scores), 0, max(chm_scores)), c("purple4", "white", "seagreen4")),
          na_col = "black",
          column_title_gp = gpar(fontsize = 60, fontface = "bold"),
          show_column_names = FALSE,
          row_title_gp = gpar(fontsize = 60, fontface = "bold"),
          show_row_names = FALSE,
          row_dend_reorder = TRUE,
          column_dend_reorder = TRUE,
          column_order = chm_plot_cols,
          row_order = chm_plot_rows,
          column_dend_height = unit(4, "in"),
          row_dend_width = unit(4, "in"),
          width = 3)
  
  chm_ge_plot <- Heatmap(chm_ge[row_order(chm_scores_draw)[[clust_num]],], name = "Gene Expression (RPKM)",
          col = colorRamp2(c(min(chm_ge[!is.na(chm_ge)]), 0.25, max(chm_ge[!is.na(chm_ge)])), c("dodgerblue4", "white", "firebrick4")),
          na_col = "black",
          cluster_rows = FALSE, cluster_columns = FALSE,
          show_row_names = FALSE, show_column_names = FALSE,
          column_title = "Gene Expression",
          column_title_gp = gpar(fontsize = 60, fontface = "bold"),
          column_order = chm_plot_cols,
          row_order = chm_plot_rows,
          width = 1)
  chm_cn_plot <- Heatmap(chm_cn[row_order(chm_scores_draw)[[clust_num]],], name = "Copy Number",
          col = colorRamp2(c(min(chm_cn[!is.na(chm_cn)]), 2, max(chm_cn[!is.na(chm_cn)])), c("dodgerblue4", "white", "firebrick4")),
          na_col = "black",
          cluster_rows = FALSE, cluster_columns = FALSE,
          show_row_names = FALSE, show_column_names = FALSE,
          column_title = "Copy Number",
          column_title_gp = gpar(fontsize = 60, fontface = "bold"),
          column_order = chm_plot_cols,
          row_order = chm_plot_rows,
          width = 1)
  chm_mut_plot <- Heatmap(chm_mut[row_order(chm_scores_draw)[[clust_num]],], name = "Mutation Status",
          na_col = "black",
          col = c("cyan3", "darkorchid"),
          cluster_rows = FALSE, cluster_columns = FALSE,
          show_row_names = FALSE, show_column_names = FALSE,
          column_title = "Mutation Status",
          column_title_gp = gpar(fontsize = 60, fontface = "bold"),
          column_order = chm_plot_cols,
          row_order = chm_plot_rows,
          width = 1)
  
  chm_all_plot <- chm_plot + chm_ge_plot + chm_cn_plot + chm_mut_plot
  
  pdf(paste0("./plots_18Q3/crispr_heatmap_clustered/crispr_heatmap_all_c", clust_num, ".pdf"), width = 100, height = 100, paper = "special")
  draw(chm_all_plot, heatmap_legend_side = "right", annotation_legend_side = "right")
  seekViewport("annotation_Cell_Line_SSMD")
  grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Cas9_Activity")
  grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Culture_Type")
  grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Tissue")
  grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Disease")
  grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Gender")
  grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Source")
  grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  dev.off()
  
  pdf(paste0("./plots_18Q3/crispr_heatmap_ge_c", clust_num, ".pdf"), width = 100, height = 100, paper = "special")
  draw(chm_plot + chm_ge_plot, heatmap_legend_side = "right", annotation_legend_side = "right")
  seekViewport("annotation_Cell_Line_SSMD")
  grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Cas9_Activity")
  grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Culture_Type")
  grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Tissue")
  grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Disease")
  grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Gender")
  grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Source")
  grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  dev.off()
  
  pdf(paste0("./plots_18Q3/crispr_heatmap_mut_c", clust_num, ".pdf"), width = 100, height = 100, paper = "special") 
  draw(chm_plot + chm_mut_plot, heatmap_legend_side = "right", annotation_legend_side = "right")
  seekViewport("annotation_Cell_Line_SSMD")
  grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Cas9_Activity")
  grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Culture_Type")
  grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Tissue")
  grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Disease")
  grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Gender")
  grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Source")
  grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  dev.off()
  
  pdf(paste0("./plots_18Q3/crispr_heatmap_cn_c", clust_num, ".pdf"), width = 100, height = 100, paper = "special") 
  draw(chm_plot + chm_cn_plot, heatmap_legend_side = "right", annotation_legend_side = "right")
  seekViewport("annotation_Cell_Line_SSMD")
  grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Cas9_Activity")
  grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Culture_Type")
  grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Tissue")
  grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Primary_Disease")
  grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Gender")
  grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  seekViewport("annotation_Source")
  grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
  dev.off()
}
```

## Cell line converter

This comprehensive cancer cell line information curated by Daniel Charytonowicz.
```{r}
ccl_converter <- read.delim("./data_munging/cell_line_database_FINAL_MASTER.tsv", sep = "\t", row.names = 1, header = TRUE)
colnames(ccl_converter)[colnames(ccl_converter) == "ccle_cell_line_name"] <- "CCLE_Name"
colnames(ccl_converter)[colnames(ccl_converter) == "broad_id"] <- "Broad_ID"
```

## Cell line metadata

```{r}
ccl_info <- read.delim("./data_munging/DepMap-2018q3-celllines.csv", sep = ",", header = TRUE, na.strings = c("", NA))
ccl_info$Primary.Disease <- gsub("\\\\", "", ccl_info$Primary.Disease)
ccl_info$Primary.Disease <- gsub("Ewings", "Ewing's", ccl_info$Primary.Disease)

crispr_meta <- read.delim("./data_munging/sample_info_18Q3_crispr.csv", sep = ",", header = TRUE, na.strings = c("", NA))
colnames(crispr_meta)[7] <- "CCLE_Name"

shrna_meta <- read.delim("./data_munging/sample_info_18Q3_shrna.csv", sep = ",", header = TRUE, na.strings = c("", NA))
colnames(shrna_meta)[1] <- "CCLE_Name"
```

```{r}
dan_test <- select(ccl_converter, CCLE_Name, Broad_ID, cell_line_name)
dan_test <- dan_test[-which(dan_test$CCLE_Name == ""), ]
ccl_test <- select(ccl_info, CCLE_Name, Broad_ID)

test <- merge(ccl_test, dan_test, by = "CCLE_Name", all = TRUE, suffixes = c("_DepMap", "_Daniel"))
test$BroadIDs_match <- ifelse(as.character(test$Broad_ID_DepMap) == as.character(test$Broad_ID_Daniel), TRUE, FALSE)
```

## Cancer Gene Census (CGC) gene list

Select genes from the Cancer Gene Census (CGC). The list was pulled from the [International Cancer Genome Consortium (ICGC) data portal](https://dcc.icgc.org/search/g?filters=%7B%22gene%22:%7B%22curatedSetId%22:%7B%22is%22:%5B%22GS1%22%5D%7D%7D%7D) (Advaced Search > Genes > Curated Gene Set > Cancer Gene Census).
```{r}
cgc <- data_frame("Hugo_Symbol" = read.delim("./data_munging/gene-ids-for-set-Cancer Gene Census.tsv", header = FALSE, sep = "\t")[, 2])
```

## MAF file

For mutation calling, get paired gene name and cell line fields in a data frame. For this analysis, we don't care about how many mutations there are per gene or what type of mutations there are, so I didn't save more information. I took unique gene-cell line combinations since we only cared about mutation presence/absence. Add a `Mutation_Status` column denoting all entries in MAF files as mutations present in the associated cell lines.
```{r}
maf_raw <- read.delim("./data_munging/CCLE_DepMap_18q3_maf_20180718.txt.gz", header = TRUE, sep = "\t")
# Filter for cell lines in CRISPR screen
maf_raw <- filter(maf_raw, Broad_ID %in% unique(crispr_meta$Broad_ID))

# Select columns
maf_df <- subset(maf_raw, select = c("Hugo_Symbol", "Tumor_Sample_Barcode", "Broad_ID", "Variant_Classification", "isDeleterious"))
colnames(maf_df)[colnames(maf_df) == "Tumor_Sample_Barcode"] <- "CCLE_Name"
# Add Mutation_Status column
maf_df$Mutation_Status <- ifelse(maf_df$Variant_Classification == "Missense_Mutation" | maf_df$isDeleterious == TRUE, "Mutant", "Other")
maf_df <- unique(subset(maf_df, select = c("Hugo_Symbol", "CCLE_Name", "Broad_ID", "Mutation_Status")))

# Whole MAF summary table
maf_summ <- maf_raw[, c("Variant_Classification", "isDeleterious")] %>% group_by(Variant_Classification, isDeleterious) %>% tally()
maf_summ$Percent <- format(round(maf_summ$n / sum(maf_summ$n) * 100, 4), nsmall = 2)
maf_summ$isDeleterious <- ifelse(maf_summ$isDeleterious == "TRUE", "Yes", "No")
knitr::kable(maf_summ, caption = "Distribution of variant classifications in the MAF file") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


## Copy number file

```{r, eval=FALSE}
cn <- read.delim("./data_munging/public_18Q3_gene_cn.csv.gz", sep = ",", check.names = FALSE, header = TRUE)

# Convert log2 ratios (log2(CN/2)) to CN
cn[2:ncol(cn)] <- lapply(cn[2:ncol(cn)], function(x) 2 * (2 ^ x))

# Remove Entrez gene IDs from colnames
colnames(cn) <- gsub(" .*", "", colnames(cn))
colnames(cn)[1] <- "Broad_ID"

# Melt
cn_melt <- melt(data = cn, id.vars = "Broad_ID", measure.vars = colnames(cn[2:ncol(cn)]), variable.name = "Hugo_Symbol", value.name = "Copy_Number")

saveRDS(cn_melt, "./data_munging/rds/cn_melt_18Q3.rds", compress = "xz")
```

```{r}
cn_melt <- readRDS("./data_munging/rds/cn_melt_18Q3.rds")
```

## Gene expression file

Gene expression data (Reads Per Kilobase of transcript, per Million mapped reads, RPKM).
```{r, eval=FALSE}
ge <- read.delim("./../crispr_lineages_giant_files/CCLE_DepMap_18q3_RNAseq_RPKM_20180718.gct.gz", skip = 2, header = TRUE, sep = "\t", check.names = FALSE)

# Edit columns
ge$Name <- NULL
colnames(ge)[1] <- "Hugo_Symbol"

# Melt
ge_melt <- melt(data = ge, id.vars = "Hugo_Symbol", measure.vars = colnames(ge[2:ncol(ge)]), value.name = "RPKM")
## Split variable column
ge_melt <- with(ge_melt, cbind(Hugo_Symbol, colsplit(variable, pattern = " ", names = c("CCLE_Name", "Broad_ID")), RPKM))
## Remove parentheses around Broad IDs
ge_melt$Broad_ID <- gsub("\\(|\\)", "", ge_melt$Broad_ID)

saveRDS(ge_melt, "./../crispr_lineages_giant_files/ge_melt_18Q3.rds", compress = "xz")
```

```{r}
ge_melt <- readRDS("./../crispr_lineages_giant_files/ge_melt_18Q3.rds")
```

## CRISPR dependency probabilities

```{r}
dep <- read.delim("./data_munging/gene_dependency_18Q3.csv.gz", sep = ",", header  = TRUE, check.names = FALSE)
# Remove Entrez gene IDs from colnames
colnames(dep) <- gsub(" .*", "", colnames(dep))
```


## CRISPR data and annotations

The latest CRISPR CERES score data (18Q3, August 2018) was pulled from the [DepMap Data Portal](https://depmap.org/portal/download/) (Broad Institute Cancer Dependency Map 2018, Meyers et al. 2017).
```{r, eval=TRUE}
crispr <- read.delim("./data_munging/gene_effect_18Q3.csv.gz", sep = ",", header  = TRUE, check.names = FALSE)
# Remove Entrez gene IDs from colnames
colnames(crispr) <- gsub(" .*", "", colnames(crispr))
```

Merge annotation data:
```{r, eval=FALSE}
# Melt CRISPR dataset for merging
crispr_melt <- melt(crispr, id.vars = "Broad_ID", measure.vars = colnames(crispr)[2:ncol(crispr)], variable.name = "Hugo_Symbol", value.name = "Score")

# Melt dependency probabilities dataset for merging
dep_melt <- melt(dep, id.vars = "Broad_ID", measure.vars = colnames(dep)[2:ncol(dep)], variable.name = "Hugo_Symbol", value.name = "Dep_Prob")

# Merge dependency probabilities
crispr_melt <- merge(crispr_melt, dep_melt, by = c("Broad_ID", "Hugo_Symbol"), all.x = TRUE)

# Merge cell line metadata
crispr_melt <- merge(crispr_melt, ccl_info, by = "Broad_ID", all.x = TRUE)
crispr_melt <- merge(crispr_melt, crispr_meta, by = c("CCLE_Name", "Broad_ID"), all.x = TRUE)

# Merge mutation annotations
crispr_muts <- merge(crispr_melt, maf_df, by = c("Hugo_Symbol", "CCLE_Name", "Broad_ID"), all.x = TRUE)
crispr_muts <- crispr_muts %>% mutate(Mutation_Status = if_else(is.na(Mutation_Status), "Other", Mutation_Status))
crispr_muts$Hugo_Symbol <- factor(crispr_muts$Hugo_Symbol)

# Summarize number of mutant and Other cell lines
crispr_muts_summ <- crispr_muts %>% group_by(Hugo_Symbol) %>%
  summarize(N_Other = sum(Mutation_Status == "Other"),
            N_Mutant = sum(Mutation_Status == "Mutant"))

# Merge test results back into full dataset, which restores information lost in the summarization
crispr_data <- merge(crispr_muts_summ, crispr_muts, by = "Hugo_Symbol")

# Add Color column
crispr_data$Color <- ifelse(crispr_data$Mutation_Status == "Other", "cyan3", "darkorchid")
crispr_data$Color <- factor(crispr_data$Color)

# Cell line lineages
crispr_data <- merge(crispr_data, ccl_converter, by = c("CCLE_Name", "Broad_ID"), all.x = TRUE)
levels(crispr_data$lineage_name) <- sort(levels(crispr_data$lineage_name), decreasing = TRUE)

# Copy number
crispr_data <- merge(crispr_data, cn_melt, by = c("Hugo_Symbol", "Broad_ID"), all.x = TRUE)

# Gene expression (RPKM)
ge_filt <- filter(ge_melt, Hugo_Symbol %in% unique(crispr_data$Hugo_Symbol))
crispr_data <- merge(crispr_data, ge_filt, by = c("Hugo_Symbol", "Broad_ID", "CCLE_Name"), all.x = TRUE)
crispr_data$RPKM_log2 <- log2(crispr_data$RPKM + 0.0001)

saveRDS(crispr_data, "./../crispr_lineages_giant_files/crispr_data_18Q3.rds", compress = "xz")
```

```{r}
crispr_data <- readRDS("./../crispr_lineages_giant_files/crispr_data_18Q3.rds")
crispr_ccl <- data.frame("Broad_ID" = crispr_data$Broad_ID)
# write.table(crispr_data[, c("Hugo_Symbol", "Broad_ID", "Score", "Primary.Disease", "primary_tissue", "Mutation_Status")], file = "~/Desktop/crispr_data_select.tsv", quote = FALSE, sep = "\t")
```

```{r, include=FALSE, eval=FALSE}
length(intersect(unique(crispr_data$Hugo_Symbol), unique(maf_df$Hugo_Symbol)))
length(intersect(unique(crispr_data$Hugo_Symbol), unique(cn_melt$Hugo_Symbol)))
length(intersect(unique(crispr_data$Hugo_Symbol), unique(ge_melt$Hugo_Symbol)))

length(intersect(unique(crispr_data$Broad_ID), unique(maf_df$Broad_ID)))
length(intersect(unique(crispr_data$Broad_ID), unique(cn_melt$Broad_ID)))
length(intersect(unique(crispr_data$Broad_ID), unique(ge_melt$Broad_ID)))

setdiff(unique(crispr_data$Broad_ID), unique(maf_df$Broad_ID))
setdiff(unique(crispr_data$Broad_ID), unique(cn_melt$Broad_ID))
setdiff(unique(crispr_data$Broad_ID), unique(ge_melt$Broad_ID))

length(intersect(intersect(unique(crispr_data$Broad_ID), unique(cn_melt$Broad_ID)), unique(ge_melt$Broad_ID)))
setdiff(crispr_data$Broad_ID, intersect(intersect(unique(crispr_data$Broad_ID), unique(cn_melt$Broad_ID)), unique(ge_melt$Broad_ID)))
```

## shRNA data and annotations

The Achilles shRNA DEMETER score data was pulled from the [CTD^2^ Data Portal](https://ocg.cancer.gov/programs/ctd2/data-portal) (Tsherniak et al 2017).
```{r, eval=FALSE}
shrna <- read.table("./data_munging/D2_combined_gene_dep_scores.csv.gz", sep = ",", header = TRUE, check.names = FALSE)
colnames(shrna)[1] <- "Hugo_Symbol"
# Remove Entrez gene IDs from gene names
shrna$Hugo_Symbol <- gsub(" .*", "", shrna$Hugo_Symbol)

# Melt shRNA dataset for merging
shrna_melt <- melt(shrna , id.vars = "Hugo_Symbol", measure.vars = colnames(shrna)[2:ncol(shrna)], variable.name = "CCLE_Name", value.name = "Score")
shrna_melt <- drop_na(shrna_melt)
```

Merge annotation data:
```{r, eval=FALSE}
# Merge cell line metadata
shrna_melt <- merge(shrna_melt, ccl_info, by = "CCLE_Name", all.x = TRUE)
shrna_melt <- merge(shrna_melt, shrna_meta, by = "CCLE_Name", all.x = TRUE)

# Merge mutation annotations
shrna_muts <- merge(shrna_melt, maf_df, by = c("Hugo_Symbol", "CCLE_Name", "Broad_ID"), all.x = TRUE)
shrna_muts <- shrna_muts %>% mutate(Mutation_Status = if_else(is.na(Mutation_Status), "Other", Mutation_Status))
shrna_muts$Hugo_Symbol <- factor(shrna_muts$Hugo_Symbol)

# Summarize number of mutant and Other cell lines
shrna_muts_summ <- shrna_muts %>% group_by(Hugo_Symbol) %>%
  summarize(N_Other = sum(Mutation_Status == "Other"),
            N_Mutant = sum(Mutation_Status == "Mutant"))

# Merge test results back into full dataset, which restores information lost in the summarization
shrna_data <- merge(shrna_muts_summ, shrna_muts, by = "Hugo_Symbol")

# Add Color column
shrna_data$Color <- ifelse(shrna_data$Mutation_Status == "Other", "cyan3", "darkorchid")
shrna_data$Color <- factor(shrna_data$Color)

# Cell line lineages
shrna_data <- merge(shrna_data, ccl_converter, by = c("CCLE_Name", "Broad_ID"), all.x = TRUE)
levels(shrna_data$lineage_name) <- sort(levels(shrna_data$lineage_name), decreasing = TRUE)

# Copy number
shrna_data <- merge(shrna_data, cn_melt, by = c("Hugo_Symbol", "Broad_ID"), all.x = TRUE)

# Gene expression (RPKM)
ge_filt <- filter(ge_melt, Hugo_Symbol %in% unique(shrna_data$Hugo_Symbol))
shrna_data <- merge(shrna_data, ge_filt, by = c("Hugo_Symbol", "Broad_ID", "CCLE_Name"), all.x = TRUE)

saveRDS(shrna_data, "./../crispr_lineages_giant_files/shrna_data_18Q3.rds", compress = "xz")
```

```{r}
shrna_data <- readRDS("./../crispr_lineages_giant_files/shrna_data_18Q3.rds")
shrna_ccl <- data.frame("Broad_ID" = shrna_data$Broad_ID)
```

```{r, eval=FALSE}
write(union(as.character(distinct(crispr_data[which(is.na(crispr_data$lineage_name)), c("CCLE_Name", "lineage_name")])$CCLE_Name), as.character(distinct(shrna_data[which(is.na(shrna_data$lineage_name)), c("CCLE_Name", "lineage_name")])$CCLE_Name)), file = "./data_munging//na_ccl_in_converter.txt")
```


# Exploration

--------------------------------------------------------------------------------

##  Metadata

```{r}
tissue_summ <- crispr_meta %>% group_by(primary_tissue) %>% tally()
disease_summ <- ccl_info %>% group_by(Primary.Disease) %>% tally()
```

```{r fig.height=12, fig.width=3}
ggplot(data = tissue_summ) + 
  aes(x = 0, y = n, fill = primary_tissue, label = primary_tissue) +
  geom_histogram(color = "black", stat = "identity") +
  geom_text(position = position_stack(vjust = 0.5)) +
  scale_y_continuous(breaks = seq(0, 500, by = 25), labels = seq(0, 500, by = 25)) +
  coord_cartesian(ylim = c(0, 500)) +
  theme(legend.position = "none", axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.title.x = element_blank()) +
  labs(y = "Count")
```

## Mutations

```{r}
maf_df_filt <- filter(maf_df, Hugo_Symbol %in% unique(crispr_data$Hugo_Symbol))
maf_summ_filt <- maf_df_filt %>% group_by(Mutation_Status) %>% tally()
maf_summ_filt$Percent <- format(round(maf_summ_filt$n / sum(maf_summ_filt$n) * 100, 4), nsmall = 2)
maf_summ_filt$Percent <- as.numeric(as.character(maf_summ_filt$Percent))
```

Distribution of mutations across cell lines and primary tissues. Each data point represents a single cell line.
```{r fig.height=4, fig.width=10}
maf_ccl_annot <- merge(maf_df %>% group_by(Broad_ID) %>% tally(), crispr_meta, by = "Broad_ID", all.y = TRUE)

maf_ccl_annot_plot <- ggplot(data = maf_ccl_annot, aes(x = primary_tissue, y = n, color = primary_tissue)) +
  geom_jitter(alpha = 0.8, size = 1, position = position_jitter(w = 0.25)) +
  scale_y_continuous(breaks = seq(0, 9000, by = 1000), labels = seq(0, 9000, by = 1000)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1), legend.position = "none") +
  labs(x = "Primary Tissue", y = "Number of Mutations")

ggsave(filename = "./plots_18Q3/crispr/maf_ccl_annot_plot.pdf", plot = maf_ccl_annot_plot, width = 12, height = 5, device = "pdf")
```

```{r fig.height=6, fig.width=12}
maf_gene_annot <- maf_df_filt %>% group_by(Hugo_Symbol) %>% tally()

ggplot(data = maf_gene_annot, aes(x = n)) +
  geom_histogram(breaks = seq(0, 600, by = 20), fill = "darkslategray3", color = "black", alpha = 0.7) +
  coord_cartesian(ylim = c(0, 13000)) +
  scale_y_continuous(breaks = seq(0, 13500, by = 500), labels = formatC(seq(0, 13500, by = 500), format = "d")) +
  scale_x_continuous(breaks = seq(0, 600, by = 20), labels = seq(0, 600, by = 20)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  stat_bin(breaks = seq(0, 600, by = 20), geom = "text", colour = "black", size = 2.5, aes(label = ..count..), vjust = -0.2, angle = 45, hjust = -0.1) +
  labs(x = "Number of Mutations", y = "Frequency", title = paste0("Distribution of mutational load for ", length(unique(maf_gene_annot$Hugo_Symbol)), " genes in the CCLE MAF file across all ", length(unique(crispr_ccl$Broad_ID)), " cell lines in the CRISPR screen"))
```

## Dependency probabilities

```{r fig.height=6, fig.width=12}
drop_prob_100 <- ggplot(data = crispr_data, aes(x = Dep_Prob)) +
  geom_histogram(breaks = seq(0, 1, by = 0.05), fill = "darkslategray3", color = "black", alpha = 0.7) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05), labels = seq(0, 1, by = 0.05)) +
  scale_y_continuous(breaks = seq(0, 5500000, by = 500000), labels = formatC(seq(0, 5500000, by = 500000), format = "d")) +
  stat_bin(breaks = seq(0, 1, by = 0.05), geom = "text", colour = "black", size = 3.5, aes(label = ..count..), vjust = -1) +
  labs(title = "Distribution of all dependency probabilities", x = "Probability of Real Dependency", y = "Frequency")

dep_prob_5 <- ggplot(data = filter(crispr_data, Dep_Prob >= 0.95), aes(x = Dep_Prob)) +
  geom_histogram(mapping = aes(fill = primary_tissue), breaks = seq(0.95, 1, by = 0.005), color = "black") +
  scale_y_continuous(breaks = seq(0, 60000, by = 10000), labels = formatC(seq(0, 60000, by = 10000), format = "d")) +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 4, byrow = FALSE)) +
  stat_bin(breaks = seq(0.95, 1, by = 0.005), geom = "text", color = "black", size = 3.5, aes(label = ..count..), vjust = -1) +
  labs(title = "Distribution of all dependency probabilities > 0.95", x = "Probability of Real Dependency", y = "Frequency", fill = "Primary Tissue")

dep_prob_inset <- dep_prob_100 + annotation_custom(ggplotGrob(dep_prob_5), xmin = 0.49, xmax = 0.99, ymin = 2500000, ymax = 5000000)

ggsave("./../crispr_lineages_giant_files/dependency_probability_inset.pdf", plot = dep_prob_inset, width = 12, height = 6, units = "in", device = "pdf")
```


# Wilcoxon tests

--------------------------------------------------------------------------------

## CRISPR

### Grouped by gene

```{r, eval=FALSE}
crispr_signif <- compare_means(Score ~ Mutation_Status, group.by = c("Hugo_Symbol"), data = crispr_data, method = "wilcox.test", p.adjust.method = "BH")
crispr_signif <- adj_signif(crispr_signif)
crispr_signif <- crispr_signif[order(crispr_signif$p),]
saveRDS(crispr_signif, "./data_munging/rds/crispr_signif.rds")
```

```{r}
crispr_signif <- readRDS("./data_munging/rds/crispr_signif.rds")

knitr::kable(filter(crispr_signif, p < 0.05)[, c("Hugo_Symbol", "p", "p.adj", "p.format", "p.signif", "p.signif.adj")], caption = "CRISPR Screen: Wilcoxon Test Results Comparing Mutant and Other Cell Lines, p < 0.1 (Benjamini-Hochberg-corrected p-values: * p <= 0.05, ** p <= 0.01, *** p <= 0.001, **** p <= 0.0001)") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Wilcoxon test Benjamini-Hochberg-corrected p-values:\n*: p <= 0.05\n**: p <= 0.01\n***: p <= 0.001\n****: p <= 0.0001") %>% scroll_box(width = "900px", height = "450px")
```

### Grouped by gene and lineage

```{r, eval=FALSE}
crispr_signif_lineage <- compare_means(Score ~ Mutation_Status, group.by = c("Hugo_Symbol", "lineage_name"), data = crispr_data, method = "wilcox.test", p.adjust.method = "BH")
crispr_signif_lineage <- adj_signif(crispr_signif_lineage)
crispr_signif_lineage <- crispr_signif_lineage[order(crispr_signif_lineage$p),]
saveRDS(crispr_signif_lineage, "./data_munging/rds/crispr_signif_lineage.rds")
```

```{r}
crispr_signif_lineage <- readRDS("./data_munging/rds/crispr_signif_lineage.rds")

knitr::kable(filter(crispr_signif_lineage, p < 0.05)[, c("Hugo_Symbol", "lineage_name", "p", "p.adj", "p.format", "p.signif", "p.signif.adj")], caption = "CRISPR Screen: Wilcoxon Test Results Comparing Mutant and Other Cell Lines by Lineage, p < 0.1 (Benjamini-Hochberg-corrected p-values: * p <= 0.05, ** p <= 0.01, *** p <= 0.001, **** p <= 0.0001)") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Wilcoxon test Benjamini-Hochberg-corrected p-values:\n*: p <= 0.05\n**: p <= 0.01\n***: p <= 0.001\n****: p <= 0.0001") %>% scroll_box(width = "900px", height = "450px")
```

### Grouped by gene and tissue

```{r, eval=FALSE}
crispr_signif_tissue <- compare_means(Score ~ Mutation_Status, group.by = c("Hugo_Symbol", "primary_tissue"), data = crispr_data, method = "wilcox.test", p.adjust.method = "BH")
crispr_signif_tissue <- adj_signif(crispr_signif_tissue)
crispr_signif_tissue <- crispr_signif_tissue[order(crispr_signif_tissue$p),]
saveRDS(crispr_signif_tissue, "./data_munging/rds/crispr_signif_tissue.rds")
```

```{r}
crispr_signif_tissue <- readRDS("./data_munging/rds/crispr_signif_tissue.rds")

knitr::kable(filter(crispr_signif_tissue, p < 0.05)[, c("Hugo_Symbol", "primary_tissue", "p", "p.adj", "p.format", "p.signif", "p.signif.adj")], caption = "CRISPR Screen: Wilcoxon Test Results Comparing Mutant and Other Cell Lines by Primary Tissue, p < 0.1 (Benjamini-Hochberg-corrected p-values: * p <= 0.05, ** p <= 0.01, *** p <= 0.001, **** p <= 0.0001)") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Wilcoxon test Benjamini-Hochberg-corrected p-values:\n*: p <= 0.05\n**: p <= 0.01\n***: p <= 0.001\n****: p <= 0.0001") %>% scroll_box(width = "900px", height = "450px")
```

## shRNA

### Grouped by gene

```{r, eval=FALSE}
shrna_signif <- compare_means(Score ~ Mutation_Status, group.by = c("Hugo_Symbol"), data = shrna_data, method = "wilcox.test", p.adjust.method = "BH")
shrna_signif <- adj_signif(shrna_signif)
shrna_signif <- shrna_signif[order(shrna_signif$p),]
saveRDS(shrna_signif, "./data_munging/rds/shrna_signif.rds")
```

```{r}
shrna_signif <- readRDS("./data_munging/rds/shrna_signif.rds")

knitr::kable(filter(shrna_signif, p < 0.05)[, c("Hugo_Symbol", "p", "p.adj", "p.format", "p.signif", "p.signif.adj")], caption = "shRNA Screen: Wilcoxon Test Results Comparing Mutant and Other Cell Lines, p < 0.1  (Benjamini-Hochberg-corrected p-values: * p <= 0.05, ** p <= 0.01, *** p <= 0.001, **** p <= 0.0001)") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Wilcoxon test Benjamini-Hochberg-corrected p-values:\n*: p <= 0.05\n**: p <= 0.01\n***: p <= 0.001\n****: p <= 0.0001") %>% scroll_box(width = "900px", height = "450px")
```

### Grouped by gene and lineage

```{r, eval=FALSE}
shrna_signif_lineage <- compare_means(Score ~ Mutation_Status, group.by = c("Hugo_Symbol", "lineage_name"), data = shrna_data, method = "wilcox.test", p.adjust.method = "BH")
shrna_signif_lineage <- adj_signif(shrna_signif_lineage)
shrna_signif_lineage <- mutate(shrna_signif_lineage, lineage_name = reorder(lineage_name, p.adj, mean))
saveRDS(shrna_signif_lineage, "./../crispr_lineages_giant_files/shrna_signif_lineage.rds")
```

```{r, eval=FALSE}
shrna_signif_lineage <- readRDS("./../crispr_lineages_giant_files/shrna_signif_lineage.rds")
```


# Heatmaps

--------------------------------------------------------------------------------

## CRISPR

### Data management

Make and save heatmap data matrices:
```{r, eval=FALSE}
# Set up heatmap data
chm_scores <- t(crispr)
colnames(chm_scores) <- chm_scores[1, ]
chm_scores <- chm_scores[-1, ]
chm_rows <- rownames(chm_scores)
chm_cols <- colnames(chm_scores)
chm_scores <- apply(chm_scores, 2, as.double)
chm_scores <- apply(chm_scores, 2, function(x) (x - mean(x)) / var(x))
colnames(chm_scores) <- chm_cols
rownames(chm_scores) <- chm_rows
saveRDS(chm_scores, "./data_munging/rds/crispr_heatmap_scores.rds")

# Make full grid for genomic features
crispr_grid_ccls <- unique(crispr_data$Broad_ID)
crispr_grid_genes <- unique(crispr_data$Hugo_Symbol)
crispr_grid <- expand.grid("Broad_ID" = crispr_grid_ccls, "Hugo_Symbol" = crispr_grid_genes)

# Gene expression
ge_filt <- filter(ge_melt, Hugo_Symbol %in% unique(crispr_data$Hugo_Symbol))[, c("Hugo_Symbol", "Broad_ID", "RPKM")]
ge_filt$RPKM <- log2(ge_filt$RPKM + 0.0001)
chm_ge_grid <- merge(crispr_grid, ge_filt, by = c("Broad_ID", "Hugo_Symbol"), all.x = TRUE)
chm_ge <- reshape(chm_ge_grid, idvar = "Hugo_Symbol", timevar = "Broad_ID", direction = "wide")
chm_ge_rows <- chm_ge$Hugo_Symbol
chm_ge$Hugo_Symbol <- NULL
chm_ge_cols <- colnames(chm_ge) %>% gsub("RPKM.", "", .)
chm_ge <- apply(chm_ge, 2, as.double)
chm_ge <- apply(chm_ge, 2, function(x) (x - mean(x, na.rm = TRUE)) / var(x, na.rm = TRUE))
rownames(chm_ge) <- chm_ge_rows
colnames(chm_ge) <- chm_ge_cols
saveRDS(chm_ge, "./data_munging/rds/crispr_heatmap_ge.rds")

# Mutation status
chm_mut_grid <- merge(crispr_grid, maf_df[, c("Broad_ID", "Hugo_Symbol", "Mutation_Status")], by = c("Broad_ID", "Hugo_Symbol"), all.x = TRUE)
chm_mut_grid$Mutation_Status <- ifelse(is.na(chm_mut_grid$Mutation_Status), 0, 1)
chm_mut <- reshape(chm_mut_grid, idvar = "Hugo_Symbol", timevar = "Broad_ID", direction = "wide")
chm_mut_rows <- chm_mut$Hugo_Symbol
chm_mut$Hugo_Symbol <- NULL
chm_mut_cols <- colnames(chm_mut) %>% gsub("Mutation_Status.", "", .)
chm_mut <- matrix(as.numeric(unlist(chm_mut)), nrow = nrow(chm_mut))
rownames(chm_mut) <- chm_mut_rows
colnames(chm_mut) <- chm_mut_cols
saveRDS(chm_mut, "./data_munging/rds/crispr_heatmap_mut.rds")

# Copy number
cn_filt <- filter(cn_melt, Hugo_Symbol %in% unique(crispr_data$Hugo_Symbol))
chm_cn_grid <- merge(crispr_grid, cn_melt, by = c("Broad_ID", "Hugo_Symbol"), all.x = TRUE)
chm_cn <- reshape(chm_cn_grid, idvar = "Hugo_Symbol", timevar = "Broad_ID", direction = "wide")
chm_cn_rows <- chm_cn$Hugo_Symbol
chm_cn$Hugo_Symbol <- NULL
chm_cn_cols <- colnames(chm_cn) %>% gsub("Copy_Number.", "", .)
chm_cn <- apply(chm_cn, 2, as.double)
chm_cn <- apply(chm_cn, 2, function(x) (x - mean(x, na.rm = TRUE)) / var(x, na.rm = TRUE))
rownames(chm_cn) <- chm_cn_rows
colnames(chm_cn) <- chm_cn_cols
saveRDS(chm_cn, "./data_munging/rds/crispr_heatmap_cn.rds")
```

Load heatmap matrices:
```{r, eval=FALSE}
chm_scores <- readRDS("./data_munging/rds/crispr_heatmap_scores.rds")
chm_ge <- readRDS("./data_munging/rds/crispr_heatmap_ge.rds")
chm_mut <- readRDS("./data_munging/rds/crispr_heatmap_mut.rds")
chm_cn <- readRDS("./data_munging/rds/crispr_heatmap_cn.rds")

# Metadata anotation dataframe
chm_annot <- merge(merge(data.frame("Broad_ID" = crispr$Broad_ID), crispr_meta[, c("Broad_ID", "cell_line_SSMD", "cas9_activity", "culture_type", "primary_tissue")], by = "Broad_ID", all.x = TRUE), ccl_info[, c("Broad_ID", "Primary.Disease", "Gender", "Source")], by = "Broad_ID", all.x = TRUE)
rownames(chm_annot) <- chm_annot$Broad_ID
chm_annot$Broad_ID <- NULL
colnames(chm_annot) <- c("Cell_Line_SSMD", "Cas9_Activity", "Culture_Type", "Primary_Tissue", "Primary_Disease", "Gender", "Source")
chm_annot$Cell_Line_SSMD <- as.numeric(chm_annot$Cell_Line_SSMD)
chm_annot$Cas9_Activity <- as.numeric(chm_annot$Cas9_Activity)
```

### K-means clustered

#### Euclidean distance

Code for k-means clustered heatmap:
```{r, eval=FALSE}
chm_scores_plot <- Heatmap(chm_scores, name = "CERES Score",
        bottom_annotation = HeatmapAnnotation(df = chm_annot),
        bottom_annotation_height = unit(5, "in"),
        row_title = "Genes", column_title = "Cancer Cell Lines (Broad IDs)",
        col = colorRamp2(c(min(chm_scores), 0, max(chm_scores)), c("purple4", "white", "seagreen4")),
        na_col = "black",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        show_column_names = FALSE,
        row_title_gp = gpar(fontsize = 60, fontface = "bold"),
        show_row_names = FALSE,
        row_dend_reorder = TRUE,
        column_dend_reorder = TRUE,
        clustering_distance_rows = "euclidean",
        clustering_distance_columns = "euclidean",
        clustering_method_rows = "complete",
        clustering_method_columns = "complete",
        column_dend_height = unit(4, "in"),
        row_dend_width = unit(4, "in"),
        width = 3,
        km = 5, gap = unit(0.5, "in"))

chm_scores_draw <- draw(chm_scores_plot, heatmap_legend_side = "right", annotation_legend_side = "right")

pdf("./plots_18Q3/crispr_heatmap_euclidean_split5.pdf", width = 100, height = 100, paper = "special")
chm_scores_draw
seekViewport("annotation_Cell_Line_SSMD")
grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Cas9_Activity")
grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Culture_Type")
grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Primary_Tissue")
grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Primary_Disease")
grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Gender")
grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Source")
grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
dev.off()

chm_scores_c1 <- chm_scores[row_order(chm_scores_draw)[[1]],]
chm_scores_c2 <- chm_scores[row_order(chm_scores_draw)[[2]],]
chm_scores_c3 <- chm_scores[row_order(chm_scores_draw)[[3]],]
chm_scores_c4 <- chm_scores[row_order(chm_scores_draw)[[4]],]
chm_scores_c5 <- chm_scores[row_order(chm_scores_draw)[[5]],]

makeHeatmaps(chm_scores_c1, 1)
makeHeatmaps(chm_scores_c2, 2)
makeHeatmaps(chm_scores_c3, 3)
makeHeatmaps(chm_scores_c4, 4)
makeHeatmaps(chm_scores_c5, 5)
```

### CGC genes

Code for heatmap of CGC-filtered genes only

#### Euclidean distance

```{r}
colnames(chm_annot)
```

```{r, eval=FALSE}
chm_scores_cgc <- subset(chm_scores, rownames(chm_scores) %in% cgc$Hugo_Symbol)
chm_ge_cgc <- subset(chm_ge, rownames(chm_ge) %in% cgc$Hugo_Symbol)
chm_mut_cgc <- subset(chm_mut, rownames(chm_mut) %in% cgc$Hugo_Symbol)
chm_cn_cgc <- subset(chm_cn, rownames(chm_cn) %in% cgc$Hugo_Symbol)

chm_annot_list <- HeatmapAnnotation(df = chm_annot,annotation_legend_param = list(Primary_Disease = list(nrow = 6, title = "Primary Disease", title_position = "topleft"), Primary_Tissue = list(nrow = 6, title = "Primary_Tissue", title_position = "topleft"), Culture_Type = list(nrow = 6, title = "Culture Type", title_position = "topleft"), Source = list(nrow = 6, title = "Source", title_position = "topleft")))

chm_plot_cgc <- Heatmap(chm_scores_cgc, name = "CERES Score",
        bottom_annotation = chm_annot_list,
        bottom_annotation_height = unit(5, "in"),
        row_title = "Genes", column_title = "Cancer Cell Lines",
        col = colorRamp2(c(min(chm_scores_cgc), 0, max(chm_scores_cgc)), c("purple4", "white", "seagreen4")),
        na_col = "black",
        row_title_gp = gpar(fontsize = 60, fontface = "bold"),
        row_names_gp = gpar(fontsize = 10),
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_names_gp = gpar(fontsize = 8),
        row_dend_reorder = TRUE,
        column_dend_reorder = TRUE,
        clustering_distance_rows = "euclidean",
        clustering_distance_columns = "euclidean",
        clustering_method_rows = "complete",
        clustering_method_columns = "complete",
        column_dend_height = unit(4, "in"),
        row_dend_width = unit(4, "in"),
        width = 3)

chm_plot_cgc_cols <- colnames(chm_scores_cgc)[unlist(column_order(chm_plot_cgc))]
chm_plot_cgc_rows <- rownames(chm_scores_cgc)[unlist(row_order(chm_plot_cgc))]

chm_ge_plot_cgc <- Heatmap(chm_ge_cgc, name = "Gene Expression [log2(RPKM)]",
        col = colorRamp2(c(min(chm_ge_cgc[!is.na(chm_ge_cgc)]), 0, max(chm_ge_cgc[!is.na(chm_ge_cgc)])), c("dodgerblue4", "white", "firebrick4")),
        na_col = "black",
        cluster_rows = FALSE, cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 10), show_column_names = FALSE,
        column_title = "Gene Expression",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_order = chm_plot_cgc_cols,
        row_order = chm_plot_cgc_rows,
        width = 1)
chm_cn_plot_cgc <- Heatmap(chm_cn_cgc, name = "Copy Number log2(CN/2)",
        col = colorRamp2(c(min(chm_cn_cgc[!is.na(chm_cn_cgc)]), 0, max(chm_cn_cgc[!is.na(chm_cn_cgc)])), c("white", "thistle2", "mediumorchid4")),
        na_col = "black",
        cluster_rows = FALSE, cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 10), show_column_names = FALSE,
        column_title = "Copy Number",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_order = chm_plot_cgc_cols,
        row_order = chm_plot_cgc_rows,
        width = 1)
chm_mut_plot_cgc <- Heatmap(chm_mut_cgc, name = "Mutation Status",
        na_col = "black",
        col = c("cyan3", "darkorchid"),
        cluster_rows = FALSE, cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 10), show_column_names = FALSE,
        column_title = "Mutation Status",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_order = chm_plot_cgc_cols,
        row_order = chm_plot_cgc_rows,
        width = 1)

chm_all_plot_cgc <- chm_plot_cgc + chm_ge_plot_cgc + chm_cn_plot_cgc + chm_mut_plot_cgc

pdf("./plots_18Q3/crispr_heatmap_euclidean_all_cgc.pdf", width = 100, height = 100, paper = "special")
draw(chm_all_plot_cgc, heatmap_legend_side = "bottom", annotation_legend_side = "bottom")
seekViewport("annotation_Cell_Line_SSMD")
grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Cas9_Activity")
grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Culture_Type")
grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Primary_Tissue")
grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Primary_Disease")
grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Gender")
grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Source")
grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
dev.off()
```


#### Pearson correlation

```{r, eval=FALSE}
chm_scores_cgc <- subset(chm_scores, rownames(chm_scores) %in% cgc$Hugo_Symbol)
chm_ge_cgc <- subset(chm_ge, rownames(chm_ge) %in% cgc$Hugo_Symbol)
chm_mut_cgc <- subset(chm_mut, rownames(chm_mut) %in% cgc$Hugo_Symbol)
chm_cn_cgc <- subset(chm_cn, rownames(chm_cn) %in% cgc$Hugo_Symbol)

chm_plot_cgc <- Heatmap(chm_scores_cgc, name = "CERES Score",
        bottom_annotation = HeatmapAnnotation(df = chm_annot),
        bottom_annotation_height = unit(5, "in"),
        row_title = "Genes", column_title = "Cancer Cell Lines (Broad IDs)",
        col = colorRamp2(c(min(chm_scores_cgc), 0, max(chm_scores_cgc)), c("purple4", "white", "seagreen4")),
        na_col = "black",
        row_title_gp = gpar(fontsize = 60, fontface = "bold"),
        row_names_gp = gpar(fontsize = 10),
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_names_gp = gpar(fontsize = 8),
        row_dend_reorder = TRUE,
        column_dend_reorder = TRUE,
        clustering_distance_rows = "pearson",
        clustering_distance_columns = "pearson",
        clustering_method_rows = "complete",
        clustering_method_columns = "complete",
        column_dend_height = unit(4, "in"),
        row_dend_width = unit(4, "in"),
        width = 3)

chm_plot_cgc_cols <- colnames(chm_scores_cgc)[unlist(column_order(chm_plot_cgc))]
chm_plot_cgc_rows <- rownames(chm_scores_cgc)[unlist(row_order(chm_plot_cgc))]

chm_ge_plot_cgc <- Heatmap(chm_ge_cgc, name = "Gene Expression (RPKM)",
        col = colorRamp2(c(min(chm_ge_cgc[!is.na(chm_ge_cgc)]), 0, max(chm_ge_cgc[!is.na(chm_ge_cgc)])), c("dodgerblue4", "white", "firebrick4")),
        na_col = "black",
        cluster_rows = FALSE, cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 10), show_column_names = FALSE,
        column_title = "Gene Expression",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_order = chm_plot_cgc_cols,
        row_order = chm_plot_cgc_rows,
        width = 1)
chm_cn_plot_cgc <- Heatmap(chm_cn_cgc, name = "Copy Number",
        col = colorRamp2(c(min(chm_cn_cgc[!is.na(chm_cn_cgc)]), 0, max(chm_cn_cgc[!is.na(chm_cn_cgc)])), c("dodgerblue4", "white", "firebrick4")),
        na_col = "black",
        cluster_rows = FALSE, cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 10), show_column_names = FALSE,
        column_title = "Copy Number",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_order = chm_plot_cgc_cols,
        row_order = chm_plot_cgc_rows,
        width = 1)
chm_mut_plot_cgc <- Heatmap(chm_mut_cgc, name = "Mutation Status",
        na_col = "black",
        col = c("cyan3", "darkorchid"),
        cluster_rows = FALSE, cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 10), show_column_names = FALSE,
        column_title = "Mutation Status",
        column_title_gp = gpar(fontsize = 60, fontface = "bold"),
        column_order = chm_plot_cgc_cols,
        row_order = chm_plot_cgc_rows,
        width = 1)

chm_all_plot_cgc <- chm_plot_cgc + chm_ge_plot_cgc + chm_cn_plot_cgc + chm_mut_plot_cgc

pdf("./plots_18Q3/crispr_heatmap_pearson_all_cgc.pdf", width = 100, height = 100, paper = "special")
draw(chm_all_plot_cgc, heatmap_legend_side = "right", annotation_legend_side = "right")
seekViewport("annotation_Cell_Line_SSMD")
grid.text("Cell Line SSMD", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Cas9_Activity")
grid.text("Cas9 Activity", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Culture_Type")
grid.text("Culture Type", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Primary_Tissue")
grid.text("Primary Tissue", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Primary_Disease")
grid.text("Primary Disease", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Gender")
grid.text("Gender", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
seekViewport("annotation_Source")
grid.text("Source", unit(1, "npc") + unit(2, "mm"), 0.5, gp = gpar(fontsize = 30), default.units = "npc", just = "left")
dev.off()
```

# Per-gene plots

--------------------------------------------------------------------------------

## Grouped plots

```{r fig.height=12, fig.width=12, include=FALSE}
makeCRISPRgrob("KRAS")
```

Plot code:
```{r, eval=FALSE}
crispr_data_cgc <- filter(crispr_data, Hugo_Symbol %in% cgc$Hugo_Symbol)
crispr_all_genes <- unique(crispr_data_cgc$Hugo_Symbol)
crispr_all_groups <- lapply(crispr_all_genes, makeCRISPRgrob)
crispr_all_groups_paths <- paste0(crispr_all_genes, "_crispr_grouped.png")
pwalk(list(crispr_all_groups_paths, crispr_all_groups), ggsave, path = "./plots_18Q3/crispr_grouped_plots_cgc", dpi = 300, width = 12, height = 12, units = "in")
```

Data management:
```{r}
crispr_all_bygene <- paste0(list.files("./plots_18Q3/crispr_grouped_plots_cgc", full.names = TRUE))
names(crispr_all_bygene) <- str_replace_all(crispr_all_bygene, c("_crispr_grouped.png" = "", "./plots_18Q3/crispr_grouped_plots_cgc/" = ""))
crispr_bygene_order <- c(intersect(crispr_signif$Hugo_Symbol, names(crispr_all_bygene)), setdiff(names(crispr_all_bygene), crispr_signif$Hugo_Symbol))
crispr_all_bygene <- crispr_all_bygene[match(crispr_bygene_order, names(crispr_all_bygene))]
bsselect(crispr_all_bygene, type = "img", selected = "KRAS", live_search = TRUE, show_tick = TRUE, height = 300, frame_height = 275)
```



## Sorted lineage plots

```{r fig.height=12, fig.width=12, include=FALSE}
makeCRISPRlinplot("KRAS")
```

Plot code:
```{r, eval=FALSE}
crispr_data_cgc <- filter(crispr_data, Hugo_Symbol %in% cgc$Hugo_Symbol)
crispr_all_genes <- unique(crispr_data_cgc$Hugo_Symbol)
crispr_all_lins <- lapply(crispr_all_genes, makeCRISPRlinplot)
crispr_all_lins_paths <- paste0(crispr_all_genes, "_crispr_lineage.png")
pwalk(list(crispr_all_lins_paths, crispr_all_lins), ggsave, path = "./plots_18Q3/crispr_lineage_plots_cgc", dpi = 300, width = 12, height = 12, units = "in")
```

Data management:
```{r}
crispr_all_bygene <- paste0(list.files("./plots_18Q3/crispr_lineage_plots_cgc", full.names = TRUE))
names(crispr_all_bygene) <- str_replace_all(crispr_all_bygene, c("_crispr_lineage.png" = "", "./plots_18Q3/crispr_lineage_plots_cgc/" = ""))
crispr_bygene_order <- c(intersect(crispr_signif$Hugo_Symbol, names(crispr_all_bygene)), setdiff(names(crispr_all_bygene), crispr_signif$Hugo_Symbol))
crispr_all_bygene <- crispr_all_bygene[match(crispr_bygene_order, names(crispr_all_bygene))]
bsselect(crispr_all_bygene, type = "img", selected = "KRAS", live_search = TRUE, show_tick = TRUE, height = 300, frame_height = 275)
```

## Sorted tissue plots

```{r fig.height=12, fig.width=12, include=FALSE}
makeCRISPRtissueplot("KRAS")
```

Plot code:
```{r, eval=FALSE}
crispr_data_cgc <- filter(crispr_data, Hugo_Symbol %in% cgc$Hugo_Symbol)
crispr_all_genes <- unique(crispr_data_cgc$Hugo_Symbol)
crispr_all_lins <- lapply(crispr_all_genes, makeCRISPRtissueplot)
crispr_all_lins_paths <- paste0(crispr_all_genes, "_crispr_tissue.png")
pwalk(list(crispr_all_lins_paths, crispr_all_lins), ggsave, path = "./plots_18Q3/crispr_tissue_plots_cgc", dpi = 300, width = 12, height = 12, units = "in")
```

Data management:
```{r}
crispr_all_bygene <- paste0(list.files("./plots_18Q3/crispr_tissue_plots_cgc", full.names = TRUE))
names(crispr_all_bygene) <- str_replace_all(crispr_all_bygene, c("_crispr_tissue.png" = "", "./plots_18Q3/crispr_tissue_plots_cgc/" = ""))
crispr_bygene_order <- c(intersect(crispr_signif$Hugo_Symbol, names(crispr_all_bygene)), setdiff(names(crispr_all_bygene), crispr_signif$Hugo_Symbol))
crispr_all_bygene <- crispr_all_bygene[match(crispr_bygene_order, names(crispr_all_bygene))]
bsselect(crispr_all_bygene, type = "img", selected = "KRAS", live_search = TRUE, show_tick = TRUE, height = 300, frame_height = 275)
```

# References

--------------------------------------------------------------------------------

Barretina, J., Caponigro, G., Stransky, N., Venkatesan, K., Margolin, A. A., Kim, S.,  Garraway, L. A. (2012). The Cancer Cell Line Encyclopedia enables predictive modelling of anticancer drug sensitivity. Nature, 483(7391), 603607. https://doi.org/10.1038/nature11003

Broad Institute Cancer Dependency Map; Cancer Data Science (2018): Cancer Dependency Map, CRISPR Avana dataset 18Q3 (Avana_public_18Q3). figshare. Fileset. doi:10.6084/m9.figshare.6931364.v1

Consortium, T. C. C. L. E., & Consortium, T. G. of D. S. in C. (2015). Pharmacogenomic agreement between two cancer cell line data sets. Nature, 528(7580), 8487. https://doi.org/10.1038/nature15736

Data Science, Cancer (2018): DEMETER2 data. figshare. Fileset. doi:10.6084/m9.figshare.6025238.v2

Doench, J. G., Fusi, N., Sullender, M., Hegde, M., Vaimberg, E. W., Donovan, K. F.,  Root, D. E. (2016). Optimized sgRNA design to maximize activity and minimize off-target effects of CRISPR-Cas9. Nature Biotechnology, 34(2), 184191. https://doi.org/10.1038/nbt.3437

Meyers, R. M., Bryan, J. G., McFarland, J. M., Weir, B. A., Sizemore, A. E., Xu, H.,  Tsherniak, A. (2017). Computational correction of copy-number effect improves specificity of CRISPR-Cas9 essentiality screens in cancer cells. Nature Genetics, 49(12), 17791784. https://doi.org/10.1038/ng.3984

McFarland, J. M., Ho, Z. V., Kugener, G., Dempster, J. M., Montgomery, P. G., Bryan, J. G.,  Tsherniak, A. (2018). Improved estimation of cancer dependencies from large-scale RNAi screens using model-based normalization and data integration. https://doi.org/10.1101/305656


# Session information

--------------------------------------------------------------------------------

```{r}
print(sessionInfo())
```




