---
title: "19Q2"
author: "Sally Claridge"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: cerulean
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
    code_folding: hide
    pandoc_args: [
      "+RTS", "-K2048m",
      "-RTS"
    ]
---

Analysis of the [Broad's Avana CRISPR](https://depmap.org/portal/download/) (Broad Institute Cancer Dependency Map 2018, Meyers et al. 2017), the [Cancer Therapeutics Response Portal](https://ocg.cancer.gov/programs/ctd2/data-portal) (CTRP) drug screen dataset (v2) (Basu et al., 2013; M. G. Rees et al., 2016; B. Seashore-Ludlow et al., 2015), the [Genomics of Drug Sensitivity in Cancer](https://www.cancerrxgene.org/downloads) (GDSC) drug screen dataset (Garnett et al., 2012; Yang et al., 2012) , and the [Cancer Cell Line Encyclopedia](https://portals.broadinstitute.org/ccle) (CCLE) drug screen dataset (J. Barretina et al., 2012; T. C. C. L. E. Consortium & Consortium, 2015).

The Avana screen produced results using [CERES](https://depmap.org/ceres/) (Meyers et al. 2017) ([GitHub](https://github.com/cancerdatasci/ceres)), which generates gene dependency scores from sgRNA depletion scores from gene essentiality screens and eliminates bias arising from the effect of copy number variation on Cas9 DNA cleavage. The lower the CERES score, the higher the likelihood that the gene is essential in the associated cell line. Scores are scaled per cell line such that a score of 0 is the median effect of nonessential genes and -1 is the median effect of common core essential genes.

Annotation files for mutation status, copy number, and gene expression of the CCLE, GDSC, and CTRP datasets (Consortium and Consortium 2015, Barretina et al. 2012) were downloaded from the [DepMap Data Portal](https://depmap.org/portal/download/). Note that the group that conducted the GDSC screen also collected their own genomic annotation information for mutation status, copy number, and gene expression, but we did not use it.

# SET UP

--------------------------------------------------------------------------------

```{r setup, include=FALSE}
set.seed(1234)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# num_cores <- parallel::detectCores()
options(mc.cores = parallel::detectCores(), expressions = 5e5)
```

```{r libraries}
# install_github("jokergoo/ComplexHeatmap")
library(devtools)
library(circlize)
library(ComplexHeatmap)
library(cowplot)
library(crunch)
library(ggpubr)
library(ggrepel)
library(ggsignif)
library(grid)
library(gridExtra)
library(gtable)
library(jsonlite)
library(kableExtra)
library(magrittr)
library(naniar)
library(openxlsx)
library(plotly)
library(reshape2)
library(scales)
library(see)
library(stringr)
library(tidyverse)
library(VennDiagram)
theme_set(theme_light())
```


```{r general_functions}
unfactorize <- function(df){
  for(i in which(sapply(df, class) == "factor")) {
    df[[i]] <- as.character(df[[i]])
  }
  return(df)
}
```

# DATA

--------------------------------------------------------------------------------

## Cell line metadata

A comprehensive cancer cell line information was curated by both Daniel Charytonowicz and myself.

DepMap 19Q2 update fixed almost all of the inconsistencies of the Primary.Disease column, though there were come capitalization inconsistencies.
```{r}
ccle_meta_test <- read.delim("./data_munging/19Q2/sample_info.csv", sep = ",", header = TRUE, na.strings = c("", NA))
```

```{r depmap_metadata, eval=FALSE}
ccl_converter <- read.delim("./data_munging/cell_line_database_v1_20180911.tsv", row.names = 1, sep = "\t", header = TRUE)
colnames(ccl_converter)[colnames(ccl_converter) == "Broad_ID"] <- "DepMap_ID"
lineage_converter <- unique(ccl_converter[, c("DepMap_ID", "grouped_general_doid", "group_general_lineage_name")])

# OLD CCL_META
ccl_histologies <- read.delim("./data_munging/ccl_histologies_metadata.csv", sep = ",", header = TRUE, row.names = 1)
colnames(ccl_histologies) <- c("Cell_line", "CCLE_histology", "TCGA_classification", "CCLE_name", "DepMap_ID")
ccl_meta_orig <- read.delim("./data_munging/19Q2/sample_info.csv", sep = ",", header = TRUE, na.strings = c("", NA))
ccl_meta_orig_filt <- select(ccl_meta_orig, DepMap_ID, stripped_cell_line_name, CCLE_name, disease)
colnames(ccl_meta_orig_filt) <- c("DepMap_ID", "Cell_line", "CCLE_name", "disease")
ccl_meta <- subset(ccl_meta_orig_filt, !grepl("MERGED", CCLE_name, fixed = TRUE))
ccl_diseases <- as.character(unique(ccl_meta$disease))[as.character(unique(ccl_meta$disease)) != " "]
CCLE_histology <- tolower(gsub("^[a-z0-9]*_", "", ccl_meta$CCLE_name, ignore.case = TRUE))
ccl_meta <- add_column(ccl_meta, CCLE_histology = CCLE_histology, .after = "CCLE_name")
ccl_meta$disease <- with(ccl_meta, ifelse(disease == " ", as.character(CCLE_histology), as.character(disease)))
ccl_meta$disease <- with(ccl_meta, ifelse(disease == " " & CCLE_histology == "vulva", "vulva",
                                   ifelse(disease == " " & CCLE_histology == "upper_aerodigestive_tract", "upper_aerodigestive",
                                   ifelse(disease == " " & CCLE_histology == "large_intestine", "colorectal",
                                   ifelse(disease == " " & CCLE_histology == "biliary_tract", "bile_duct",
                                   ifelse(disease == " " & CCLE_histology == "oesophagus", "esophagus",
                                   ifelse(disease == "other" & CCLE_histology == "haematopoietic_and_lymphoid_tissue", "haematopoietic_and_lymphoid", disease)))))))

ccl_meta <- merge(merge(ccl_meta, ccl_histologies, by = c("Cell_line", "CCLE_histology", "CCLE_name", "DepMap_ID"), all = TRUE), lineage_converter, by = "DepMap_ID", all = TRUE)
ccl_meta$disease <- with(ccl_meta, ifelse(is.na(disease) & !is.na(CCLE_histology), CCLE_histology, disease))
ccl_meta$disease <- with(ccl_meta, ifelse(CCLE_histology == "large_intestine", "colorectal",
                                   ifelse(CCLE_histology == "haematopoietic_and_lymphoid_tissue", "haematopoietic_and_lymphoid",
                                   ifelse(CCLE_histology == "upper_aerodigestive_tract", "upper_aerodigestive",
                                   ifelse(CCLE_histology == "oesophagus", "esophagus",
                                   ifelse(CCLE_histology == "biliary_tract", "bile_duct",
                                   ifelse(Cell_line == "GT3TKB", "lung",
                                   ifelse(disease == "stomach" | CCLE_histology == "stomach", "gastric", disease))))))))
# Drop matched_normal_tissue cell lines
ccl_meta <- filter(ccl_meta, disease != "matched_normal_tissue")
# Filter out cell lines without a DepMap ID or a cell line
ccl_meta <- filter(ccl_meta, !is.na(DepMap_ID) & !is.na(Cell_line))
# Filter out cell lines that have a CCLE_name not present in the original sample info from DepMap
ccl_meta <- filter(ccl_meta, CCLE_name %in% ccl_meta_orig$CCLE_name & Cell_line %in% ccl_meta_orig_filt$Cell_line)
# Remove cell line not used in Pozdeyev
ccl_meta <- filter(ccl_meta, DepMap_ID != "ACH-002397")
write.csv(ccl_meta, "./data_munging/19Q2/sample_info_edit_20191008.csv")
```

ACH-002397 (KMH2_THYROID) was removed to align with Pozdeyev et al (2016) cell line name harmonization. CTRP only screened KMH2_HAEMATOPOIETIC_AND_LYMPHOID_TISSUE, whereas GDSC screend both KMH2_HAEMATOPOIETIC_AND_LYMPHOID_TISSUE (i.e. KM-H2) and KMH2_THYROID (i.e. KMH-2). During their harmonization process, Pozdeyev et al only kept KM-H2 from GDSC. Thus, we removed KMH2_THYROID from further analyses.

```{r}
ccl_meta <- read.delim("./data_munging/19Q2/sample_info_edit_20191008.csv", sep = ",", header = TRUE, row.names = 1)
ccl_meta <- ccl_meta %>% select(DepMap_ID, Cell_line, disease)
ccl_unique <- data.frame(disease = unique(ccl_meta$disease))
```

## G2P

```{r g2p_parsing_functions}
ExtractBiomarkerType <- function(json_string) {
  json_string <- as.character(json_string)
  biomarker_type <- ((str_extract(string = json_string, pattern = "biomarker_type.+") %>% strsplit(split = ","))[[1]][1] %>% str_extract(pattern = "u'.+") %>% str_match("'(.*?)'"))[,2]
  biomarker_type <- ifelse(is.na(biomarker_type), "", biomarker_type)
  return(biomarker_type)
}
```

```{r g2p_parsing, eval=FALSE}
g2p <- read.delim("./data_munging/g2p_full_level_A_dataset_NEW_DEC_2_2018_withGroupedLineages.csv", sep = "\t", header = TRUE)
g2p[, 1:2] <- NULL
g2p <- unfactorize(g2p)
g2p$Drug <- tolower(g2p$Drug)
g2p[g2p == -1] <- ""
g2p$Gene <- ifelse(g2p$Gene == "" & g2p$Drug == "daunorubicin", "MLL", as.character(g2p$Gene))
g2p$Direction <- ifelse(g2p$Direction == 1 | g2p$Direction == "", NA, as.character(g2p$Direction))
g2p$Ref[g2p$Ref == "None" | g2p$Ref == "-" | is.na(g2p$Ref)] <- ""
g2p$Alt[g2p$Alt == "None" | g2p$Alt == "-" | is.na(g2p$Alt)] <- ""
g2p <- g2p[, c("Drug", "DrugID", "Direction", "Gene", "Ref", "Alt", "Start", "End", "Chromosome", "Feature.Names", "Mutation", "JSON", "Evidence.Level", "Phenotype.Description", "Phenotype.Family", "Phenotype.ID", "Sequence.ID", "grouped_general_doid")]
g2p <- add_column(g2p, Ref_Length = nchar(as.character(g2p$Ref)), .after = "Ref")
g2p <- add_column(g2p, Alt_Length = nchar(as.character(g2p$Alt)), .after = "Alt")
g2p <- add_column(g2p, Variant_Length = NA, .after = "Alt_Length")
g2p$Variant_Length <-
  ifelse(g2p$Alt_Length == 1 & g2p$Ref_Length == 1, 1,
  ifelse(g2p$Alt_Length == 2 & g2p$Ref_Length == 2, 2,
  ifelse(g2p$Alt_Length == 3 & g2p$Ref_Length == 3, 3,
  ifelse(g2p$Ref_Length == g2p$Alt_Length & g2p$Ref_Length > 3, g2p$Ref_Length,
  ifelse(g2p$Ref_Length != g2p$Alt_Length, abs(g2p$Ref_Length - g2p$Alt_Length), NA)))))
g2p <- add_column(g2p, Variant_Type = NA, .after = "Alt_Length")
g2p$Variant_Type <-
  ifelse(g2p$Alt_Length == 1 & g2p$Ref_Length == 1, "SNP",
  ifelse(g2p$Alt_Length == 2 & g2p$Ref_Length == 2, "DNP",
  ifelse(g2p$Alt_Length == 3 & g2p$Ref_Length == 3, "TNP",
  ifelse(g2p$Ref_Length == g2p$Alt_Length & g2p$Ref_Length > 3, "ONP",
  ifelse(g2p$Ref_Length > g2p$Alt_Length, "DEL",
  ifelse(g2p$Ref_Length < g2p$Alt_Length, "INS", "None"))))))
g2p <- subset(g2p, !grepl("^SID|^CHEMBL", g2p$DrugID))
g2p <- subset(g2p, !grepl("germline|homozygosity", tolower(g2p$Feature.Names)))
g2p <- add_column(g2p, biomarker_type = tolower(sapply(g2p$JSON, ExtractBiomarkerType, simplify = TRUE)), .after = "Feature.Names")
g2p <- add_column(g2p, biomarker_type_curated = NA, .after = "biomarker_type")

g2p <- data.frame(apply(g2p, MARGIN = 2, function(x) gsub("^$", NA, trimws(x))))

# Manually curate rucaparib-BRCA/BRCA1/BRCA2 entry
g2p$Gene <- ifelse(g2p$Drug == "rucaparib" & is.na(g2p$Gene), "BRCA2;BRCA1;BRCA", as.character(g2p$Gene))
g2p <- separate_rows(g2p, Gene, sep = ";")

# Manually assign biomarker_types based on a combination of biomarker_type derived from the JSON string and patterns in the Feature.Names
biomarker_type_curated <- ifelse(!is.na(str_match(string = tolower(g2p$biomarker_type), pattern = "copy number variant|amplification")[,1]) | !is.na(str_match(string = tolower(g2p$Feature.Names), pattern = "copy number variant|amplification")), "Amplification/CNV", NA)
biomarker_type_curated <- ifelse(!is.na(str_match(string = toupper(g2p$Feature.Names), pattern = "[A-Z0-9|A-Z]+-[A-Z0-9|A-Z]+|FUSION|ALK POSITIVE")[,1]) & is.na(str_match(string = g2p$Feature.Names, pattern = "[0-9]+-[0-9]+")) | g2p$biomarker_type == "fusion" | g2p$biomarker_type == "rearrange", "Fusion", biomarker_type_curated)
biomarker_type_curated <- ifelse(!is.na(str_match(string = g2p$Feature.Names, pattern = "c\\.[0-9]|^KIT$|^BRCA$|[A-Z][0-9]+([A-Z]|[*])|[0-9A-Z]+ [A-Z][0-9]+|[A-Z][0-9]+$")[,1]) | !is.na(str_match(string = g2p$biomarker_type, pattern = "intron|insertion|deletion|mutant")[,1]) | !is.na(str_match(string = tolower(g2p$Feature.Names), pattern = "codon|positive|biallelic inactivation|del|ins|dup|mut|frameshift|missense|variant|[0-9]+fs|>")[,1]), "Mutation", biomarker_type_curated)
biomarker_type_curated <- ifelse(!is.na(str_match(string = tolower(g2p$Feature.Names), pattern = "expression|methylation|erbb2  positive")[,1]), "Expression", biomarker_type_curated)
g2p$biomarker_type_curated <- biomarker_type_curated
g2p$biomarker_type_curated <- ifelse(g2p$Feature.Names == "ESR1 Amplification", "Amplification/CNV", g2p$biomarker_type_curated)

# Manually curate direction column
g2p <- add_column(g2p, Direction_Curated = NA, .after = "Direction")
g2p$Direction_Curated <- with(g2p, ifelse(!is.na(str_match(string = tolower(Direction), pattern = "adverse|unfavorable|^resistant")[,1]), "resistance",
                         ifelse(!is.na(str_match(string = tolower(Direction), pattern = "confers resistance")[,1]), "resistance",
                         ifelse(!is.na(str_match(string = tolower(Direction), pattern = "sensitive|sensitivity|responsive|better")[,1]), "sensitivity", 
                         ifelse(is.na(Direction) & Drug == "gefitinib" & Feature.Names == "L858R" & Gene == "EGFR", "sensitivity",
                         ifelse(is.na(Direction) & Drug == "trametinib" & Feature.Names %in% c("V600E", "V600K") & Gene == "BRAF", "sensitivity",
                         ifelse(is.na(Direction) & Drug == "cabozantinib" & Feature.Names == "RET C634W", "sensitivity", NA)))))))

# Curate protein change column
g2p <- add_column(g2p, Protein_Change = NA, .after = "Mutation")
g2p <- separate_rows(g2p, Mutation, sep = ",")
g2p$Protein_Change <- gsub("u'|'| |,|\\[|\\]", "", g2p$Mutation)
g2p$Protein_Change <- ifelse(is.na(g2p$Protein_Change), str_match(string = g2p$Feature.Names, pattern = "^[A-Z][0-9]+([A-Z]|[*])| [A-Z][0-9]+([A-Z]|[*])|:[A-Z][0-9]+([A-Z]|[*])")[,1], as.character(g2p$Protein_Change))
g2p$Protein_Change <- gsub(":| |c\\..*", "", g2p$Protein_Change)
g2p$Protein_Change <- ifelse(!is.na(str_match(string = tolower(trimws(g2p$Protein_Change)), pattern = "^$|exon|amplification|expression|frameshift|fusion|methylation|mutation|-")[,1]), NA, as.character(g2p$Protein_Change))
g2p$Protein_Change <- ifelse(g2p$Feature.Names == "ALK inframe insertion (1151T)", "1151T",
                      ifelse(g2p$Feature.Names == "MET M995Ifs*19", "M995Ifs*19",
                      ifelse(g2p$Feature.Names == "RET (618,620,634,768,791,891,918,C634W,M918T)", "C634W;M918T",
                      ifelse(g2p$Protein_Change == "V600E/K", "V600E;V600K", as.character(g2p$Protein_Change)))))
g2p <- separate_rows(g2p, Protein_Change, sep = ";")
g2p$Protein_Change <- gsub("^([0-9]+)([A-Z])$|^KRAS ([0-9]+)([A-Z])$", "\\2\\1\\2", g2p$Protein_Change) # Fix synonymous mut formatting, eg 13G
g2p$Protein_Change <- gsub("^([A-Z])([0-9]+)$|^KRAS ([A-Z])([0-9]+)$", "\\1\\2\\1", g2p$Protein_Change) # Fix synonymous mut formatting, eg G13
g2p <- add_column(g2p, Gene_Protein_Change = NA, .after = "Protein_Change")
g2p$Gene_Protein_Change <- ifelse(!is.na(g2p$Gene) & !is.na(g2p$Protein_Change), paste0(as.character(g2p$Gene), ":", as.character(g2p$Protein_Change)), NA)

# Curate lineage column
g2p <- separate_rows(g2p, Phenotype.Description, sep = ";")
g2p_lineages <- cbind(unique(select(g2p, Phenotype.Description, Phenotype.Family)), disease = NA)
g2p_lineages$disease <- with(g2p_lineages, ifelse(!is.na(str_match(string = tolower(Phenotype.Family), pattern = "astrocytoma|central nervous system|glioma")[,1]) | !is.na(str_match(string = tolower(Phenotype.Description), pattern = "astrocytoma|glioblastoma|craniopharyngioma|medulloblastoma")[,1]), "central_nervous_system",
                                           ifelse(Phenotype.Family %in% c("breast cancer") | Phenotype.Description %in% c("breast cancer", "Her2-receptor positive breast cancer", "invasive ductal carcinoma"), "breast",
                                           ifelse(!is.na(str_match(string = tolower(Phenotype.Family), pattern = "lymphoma|bone marrow|hematologic|immune system|leukemia")[,1]) | !is.na(str_match(string = tolower(Phenotype.Description), pattern = "leukemia|lymphoproliferative|myelodisplasic|systemic mastocytosis|hyper eosinophilic|waldenstrÃ¶m macroglobulinemia|langerhans")[,1]), "haematopoietic_and_lymphoid",
                                           ifelse(Phenotype.Family %in% c("kidney cancer", "Nephrotic syndrome") | !is.na(str_match(string = tolower(Phenotype.Description), pattern = "renal|kidney")[,1]), "kidney",
                                           ifelse(Phenotype.Family %in% c("liver cancer"), "liver",
                                           ifelse(Phenotype.Family %in% c("lung cancer", "respiratory system cancer"), "lung",
                                           ifelse(Phenotype.Description %in% c("congenital fibrosarcoma", "synovial sarcoma", "myxoid liposarcoma", "liposarcoma"), "soft_tissue",
                                           ifelse(Phenotype.Family %in% c("integumentary system cancer", "skin cancer") | Phenotype.Description %in% c("basal cell carcinoma", "Basal cell carcinoma", "Dermatofibrosarcoma", "dermatofibrosarcoma protuberans", "melanoma", "skin melanoma", "squamous cell carcinoma"), "skin",
                                           ifelse(Phenotype.Family %in% c("peripheral nervous system neoplasm"), "peripheral_nervous_system",
                                           ifelse(Phenotype.Family %in% c("urinary bladder cancer"), "urinary_tract", 
                                           ifelse(!is.na(str_match(string = tolower(Phenotype.Description), pattern = "thyroid|papillary carcinoma")[,1]), "thyroid", 
                                           ifelse(Phenotype.Description %in% c("ovarian cancer"), "ovary", 
                                           ifelse(Phenotype.Description %in% c("rectal neoplasm"), "colorectal",
                                           ifelse(Phenotype.Description %in% c("oropharynx cancer"), "upper_aerodigestive", 
                                           ifelse(!is.na(str_match(string = tolower(Phenotype.Description), pattern = "gastrointestinal")[,1]), "gastric", NA))))))))))))))))

g2p <- merge(g2p, g2p_lineages, by = c("Phenotype.Description", "Phenotype.Family"), all = TRUE)

g2p <- g2p %>% drop_na(Drug)
# Add association columns
g2p$Drug_Gene <- ifelse(is.na(g2p$Drug) | is.na(g2p$Gene), NA, paste0(g2p$Drug, "_", g2p$Gene))
# g2p <- merge(unique(select(ccl_meta, grouped_general_doid, disease)), g2p, by = "grouped_general_doid", all.y = TRUE)
g2p$Drug_Gene_Lin <- ifelse(is.na(g2p$Drug) | is.na(g2p$Gene) | is.na(g2p$disease), NA, paste0(g2p$Drug, "_", g2p$Gene, "_", g2p$disease))
g2p <- unique(g2p)
write.csv(g2p, "./data_munging/g2p_db_edited_20200109.csv")
```

```{r g2p}
g2p <- read.delim("./data_munging/g2p_db_edited_20200109.csv", sep = ",", header = TRUE, row.names = 1)

g2p_dgl <-  as.character(unique(g2p$Drug_Gene_Lin[!is.na(g2p$Drug_Gene_Lin)]))
g2p_dg <- as.character(unique(g2p$Drug_Gene[!is.na(g2p$Drug_Gene)]))
g2p_drugs <- as.character(unique(g2p$Drug[!is.na(g2p$Drug)]))
g2p_genes <- as.character(unique(g2p$Gene[!is.na(g2p$Gene)]))
g2p_dg_genes <- unique(sapply(strsplit(g2p_dgl, "_", fixed = TRUE), function(x) x[2]))
g2p_lins <- as.character(unique(g2p$disease[!is.na(g2p$disease)]))

g2p$biomarker_type_curated <- ifelse(is.na(g2p$biomarker_type_curated), "None", as.character(g2p$biomarker_type_curated))
g2p <- unfactorize(g2p) %>% drop_na(Drug)
g2p_split <- split(x = g2p, f = g2p$biomarker_type_curated)

g2p_amp <- g2p_split[[1]]
g2p_amp$Gene_Lin <- with(g2p_amp, paste0(Gene, "_", disease))

g2p_expr <- g2p_split[[2]]
g2p_expr$Gene_Lin <- with(g2p_expr, paste0(Gene, "_", disease))

g2p_fus <- g2p_split[[3]]
g2p_fus$FusionPair <- sapply(X = g2p_fus$Feature.Names, function(x) strsplit(as.character(x)," ")[[1]][1])
g2p_fus$FusionPair <- ifelse(g2p_fus$FusionPair == "Fusions", as.character(g2p_fus$Gene), as.character(g2p_fus$FusionPair))
g2p_fus$FusionPair <- ifelse(g2p_fus$FusionPair == "BCR-ABL", "BCR-ABL1", as.character(g2p_fus$FusionPair))
g2p_fus <- g2p_fus[grep("-", g2p_fus$FusionPair), ]
g2p_fus$Drug_FusionPair <- ifelse(is.na(g2p_fus$Drug) | is.na(g2p_fus$FusionPair), NA, paste0(g2p_fus$Drug, "_", g2p_fus$FusionPair))
g2p_fus$Drug_Fusion_Lineage <- ifelse(is.na(g2p_fus$Drug) | is.na(g2p_fus$FusionPair) | is.na(g2p_fus$disease), NA, paste0(g2p_fus$Drug, "_", g2p_fus$FusionPair, "_", g2p_fus$disease))
g2p_fus$Fusion_Lineage <- ifelse(is.na(g2p_fus$FusionPair) | is.na(g2p_fus$disease), NA, paste0(g2p_fus$FusionPair, "_", g2p_fus$disease))

g2p_mut <- g2p_split[[4]] %>% drop_na(Direction_Curated)
g2p_mut$Gene_Lin <- paste0(g2p_mut$Gene, "_", g2p_mut$disease)
g2p_mut_genes <- unique(sapply(strsplit(as.character(g2p_mut$Drug_Gene)[!is.na(g2p_mut$Drug_Gene)], "_", fixed = TRUE), function(x) x[2]))

g2p_prot <- unique(filter(g2p, !is.na(Gene_Protein_Change) & !is.na(Drug)) %>% select(disease, Drug, Direction_Curated, Gene, Protein_Change, Gene_Protein_Change))
g2p_prot$Drug_Gene_Protein_Change <- with(g2p_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change), NA, paste0(Drug, "_", Gene_Protein_Change)))
g2p_prot$Drug_Gene_Protein_Change_Lineage <- with(g2p_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Drug, "_", Gene_Protein_Change, "_", disease)))
g2p_prot$Gene_Protein_Change_Lineage <- with(g2p_prot, ifelse(is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Gene_Protein_Change, "_", disease)))

# Counts
g2p_dg_counts <- g2p %>% count(Drug, Gene) %>% filter(!is.na(Drug), !is.na(Gene))
g2p_dg_counts <- dcast(g2p_dg_counts, Drug ~ Gene, value.var = "n", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Drug)
g2p_dg_counts <- g2p_dg_counts[order(rowSums(-g2p_dg_counts)), order(colSums(-g2p_dg_counts))]
g2p_gene_order <- colnames(g2p_dg_counts)
g2p_drug_order <- rownames(g2p_dg_counts)
```




## Omics

For mutation calling, get paired gene name and cell line fields in a data frame. For this analysis, we don't care about how many mutations there are per gene or what type of mutations there are, so I didn't save more information. I took unique gene-cell line combinations since we only cared about mutation presence/absence. Add a `Mutation_Status` column denoting all entries in MAF files as mutations present in the associated cell lines.

Mutation calls (coding region, germline filtered):
```{r mutation_status, eval=FALSE}
maf_raw <- read.delim("./data_munging/19Q2/CCLE_mutations_20190514.csv.gz", header = TRUE, sep = ",")
maf_raw[, 1:2] <- NULL
colnames(maf_raw)[colnames(maf_raw) == "Hugo_Symbol"] <- "Gene"
maf_raw <- unfactorize(maf_raw)

# Select columns for maf_changes_df
maf_changes <- select(maf_raw, Gene, DepMap_ID, Protein_Change) %>% drop_na(Protein_Change) %>% filter(Protein_Change != "" & Gene %in% g2p_genes)
maf_changes <- unique(maf_changes)
maf_changes$Protein_Change <- gsub(pattern = "^p.", replacement = "", x = maf_changes$Protein_Change)
maf_changes$Gene_Protein_Change <- with(maf_changes, paste0(Gene, ":", Protein_Change))
saveRDS(maf_changes, "./data_munging/19Q2/maf_changes_df_19Q2.rds", compress = "xz")

# Select columns for maf_df
maf_raw_edit <- filter(maf_raw, Variant_Classification != "Silent" & !is.na(Variant_Classification) & Gene %in% g2p_genes)
maf <- subset(maf_raw_edit, select = c("Gene", "DepMap_ID"))
maf$Mutation <- 1
maf_grid <- expand.grid("Gene" = unique(maf$Gene), "DepMap_ID" = unique(maf$DepMap_ID))
maf_df <- merge(maf, maf_grid, by = c("Gene", "DepMap_ID"), all = TRUE)
maf_df[is.na(maf_df)] <- 0
saveRDS(maf_df, "./data_munging/19Q2/maf_df_19Q2_nosilent.rds", compress = "xz")
# saveRDS(maf_df, "./data_munging/19Q2/maf_df_19Q2.rds", compress = "xz")
```

DepMap 19Q2 fusion calls derived using the [STAR-Fusion pipeline](https://github.com/STAR-Fusion/STAR-Fusion/wiki). Column descriptions:

- *JunctionReads*: the number of RNA-Seq fragments containing a read that aligns as a split read at the site of the putative fusion junction
- *SpanningFrags*: the number of RNA-Seq fragments that encompass the fusion junction such that one read of the pair aligns to a different gene than the other paired-end read of that fragment
    - Those predictions that have very few JunctionReads and/or SpanningReads are going to be enriched for false positives. Note, depending on the site of the fusion breakpoint and length of the reads, it may not be possible to have SpanningFragments and all evidence may show up in the form of JunctionReads
- *FFPM (fusion fragments per million total reads)*: normalized measure of the fusion-supporting RNA-seq fragmentS; a filter of 0.1 sum FFPM (meaning at least 1 fusion-supporting RNA-seq fragment per 10M total reads) tends to be effective at excluding fusion artifacts, and is the current default for filtering fusions from the final output
- *LargeAnchorSupport*: whether there are split reads that provide 'long' (set to length of 25 bases) alignments on both sides of the putative breakpoint
    - Those fusions supported only by split reads (no spanning fragments) and lack LargeAnchorSupport are often highly suspicious and tend to be false positives
    - Those with LargeAnchorSupport are labeled as 'YES_LDAS' (where LDAS = long double anchor support)
- *SpliceType*: whether the proposed breakpoint occurs at reference exon junctions as provided by the reference transcript structure annotations (ex. gencode)
- *LeftBreakEntropy* and *RightBreakEntropy*: the Shannon entropy of the 15 exonic bases flanking the breakpoint.
    - The maximum entropy is 2, representing highest complexity, and the lowest would be zero (involving a 15 base mononucleotide run)
    - Low entropy sites should generally be treated as less confident breakpoints.

```{r fusion_calls, eval=FALSE}
fusions <- read.delim("./data_munging/19Q2/CCLE_fusions.csv.gz", header = TRUE, sep = ",")
fusions_bcr_abl1 <- filter(fusions, X.FusionName %in% c("BCR--ABL1", "ABL1--BCR"))
fusions$LeftGene <- gsub(" .*", "", fusions$LeftGene)
fusions$RightGene <- gsub(" .*", "", fusions$RightGene)
fusions$X.FusionName <- gsub("--", "-", fusions$X.FusionName)
fusions <- select(fusions, DepMap_ID, X.FusionName, LeftGene, RightGene)
fusions <- as.data.frame(lapply(fusions, function(x) gsub("IGH@|IGH-@", "IGH", x)))
colnames(fusions) <- c("DepMap_ID", "FusionPair", "LeftGene", "RightGene")
fusions <- merge(fusions, ccl_meta, by = "DepMap_ID", all.x = TRUE)
write.csv.gz(fusions, "./data_munging/19Q2/CCLE_fusions_edit_20191008.csv.gz")
```

```{r}
fusions <- read.delim("./data_munging/19Q2/CCLE_fusions_edit_20191008.csv.gz", header = TRUE, sep = ",")
```

DepMap WES CN Data:

- gene_cn - NumericalMatrix
- Gene level copy number data, log2 transformed with a pseudo count 1. This is generated by mapping genes onto the segment level calls.
- Rows: cell lines (Broad IDs)
- Columns: genes (HGNC symbol and Entrez ID)

```{r copy_number, eval=FALSE}
cn <- read.delim("./data_munging/19Q2/CCLE_gene_cn_20190514.csv.gz", sep = ",", check.names = FALSE, header = TRUE)
# Remove Entrez gene IDs from colnames, format is "Gene (Entrez ID)"
colnames(cn) <- gsub(" .*", "", colnames(cn))
colnames(cn)[1] <- "DepMap_ID"
# Melt
cn_melt <- melt(data = cn, id.vars = "DepMap_ID", measure.vars = colnames(cn[2:ncol(cn)]), variable.name = "Gene", value.name = "CN")
cn_melt <- unfactorize(cn_melt)

saveRDS(cn_melt, "./data_munging/19Q2/cn_melt_19Q2.rds", compress = "xz")
```

19Q2, CCLE RNAseq gene expression data:

- expression - NumericalMatrix
- RNAseq TPM gene expression data for just protein coding genes using RSEM. Log2 transformed, using a pseudo-count of 1.
- Rows: cell lines (Broad IDs)
- Columns: genes (HGNC symbol and Entrez ID)

```{r gene_expression, eval=FALSE}
ge <- read.delim("./data_munging/19Q2/CCLE_expression_20190514.csv.gz", header = TRUE, sep = ",", check.names = FALSE)
# Remove Entrez gene IDs from colnames, format is "Gene (Entrez ID)"
colnames(ge) <- gsub(" .*", "", colnames(ge))
colnames(ge)[1] <- "DepMap_ID"
# Melt
ge_melt <- melt(ge, id.vars = "DepMap_ID", measure.vars = colnames(ge)[2:ncol(ge)], variable.name = "Gene", value.name = "TPM")
# ge_melt$TPM <- log2(ge_melt$TPM + 1)
ge_melt <- unfactorize(ge_melt)

saveRDS(ge_melt, "./data_munging/19Q2/ge_melt_19Q2.rds", compress = "xz")
```

Load Rds:
```{r load_omics_rds, eval=FALSE}
maf_df <- readRDS("./data_munging/19Q2/maf_df_19Q2_nosilent.rds")
maf_changes_df <- readRDS("./data_munging/19Q2/maf_changes_df_19Q2.rds")
cn_melt <- readRDS("./data_munging/19Q2/cn_melt_19Q2.rds")
ge_melt <- readRDS("./data_munging/19Q2/ge_melt_19Q2.rds")
```

# MERGE OMICS

--------------------------------------------------------------------------------

```{r omics_functions}
MergeOmicsG2P <- function(database, dataframe, maf_df, ge_df, cn_df, gene_list, outfile) {
  # Merge mutation status, CN, and GE omics data with drugscreen results and metadata
  if(database %in% c("CCLE", "CTRP", "GDSC")) {
    print(paste0("Processing ", database, " data."))
    grid <- expand.grid("Cell_line" = unique(dataframe$Cell_line), "Gene" = gene_list)
    data <-  merge(dataframe, grid, by = "Cell_line", all.y = TRUE)
    print("Merged grid.")
    # Merge mutation calls
    data <- unfactorize(data)
    data <- merge(data, maf_df, by = c("Gene", "DepMap_ID"), all.x = TRUE)
    data$Mutation <- ifelse(is.na(data$Mutation), 0, data$Mutation)
  }
  if(database == "CRISPR") {
    print(paste0("Processing ", database, " data."))
    # Melt CRISPR dataset for merging
    data <- dataframe[, names(dataframe) %in% c("DepMap_ID", gene_list)]
    data <- melt(dataframe, id.vars = "DepMap_ID", measure.vars = colnames(data)[2:ncol(data)], variable.name = "Gene", value.name = "Score")
    # Merge cell line metadata
    data <- merge(data, ccl_meta, by = "DepMap_ID", all.y = TRUE)
    data$Drug <- "CRISPR"
    print("Merged metadata.")
    # Merge mutation calls
    data <- unfactorize(data)
    data <- merge(data, maf_df, by = c("Gene", "DepMap_ID"), all.x = TRUE)
    data$Mutation <- ifelse(is.na(data$Mutation), 0, data$Mutation)
  }
  print("Merged mutation calls.")
  # Merge GE data
  data <- merge(data, ge_df, by = c("Gene", "DepMap_ID"), all.x = TRUE)
  print("Merged gene expression data.")
  # Merge CN data
  data <- merge(data, cn_df, by = c("Gene", "DepMap_ID"), all.x = TRUE)
  print("Merged copy number data.")
  # Drop cell lines not in DepMap
  data <- filter(data, !is.na(DepMap_ID) & !(DepMap_ID %in% c("ACH-001182", "ACH-001451")))
  # Add grouper columns
  data$Drug_Gene <- with(data, paste0(Drug, "_", Gene))
  data$Drug_Gene_Lin <- with(data, paste0(Drug, "_", Gene, "_", disease))
  # Save and return dataframe
  data <- unfactorize(data)
  saveRDS(data, outfile, compress = "xz")
  return(data)
}
```

## Drug screens

```{r adjust_drugscreen_data, eval=FALSE}
ccle_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/CCLE_drug_response_metrics.csv.gz", sep = ",")
ctrp_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/CTRP_drug_response_metrics.csv.gz", sep = ",")
gdsc_all <- read.delim("./../htscreens_giant_files/pozdeyev_data/GDSC_drug_response_metrics.csv.gz", sep = ",")

auc <- bind_rows(ccle_all, ctrp_all, gdsc_all) %>% drop_na(Drug_name)
auc$Drug <- tolower(auc$Drug_name)
auc$Cell_line <- toupper(gsub("-", "", auc$Cell_line))
auc$Cell_line <- ifelse(auc$Cell_line == "K052", "KO52", auc$Cell_line)
auc$Cell_line <- ifelse(auc$Cell_line == "OVCAR3", "NIHOVCAR3", auc$Cell_line)
auc$Cell_line <- ifelse(auc$Cell_line == "OVCAR3", "NIHOVCAR3", auc$Cell_line)
auc$Cell_line <- ifelse(auc$Cell_line == "TI73", "T173", auc$Cell_line)
auc <- merge(ccl_meta, auc, by = "Cell_line", all.y = TRUE)
colnames(auc)[colnames(auc) == "AUC_IC50"] <- "Score"
saveRDS(auc, "./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_auc_all.rds", compress = "xz")

ccle_all <- auc %>% filter(Database == "CCLE") %>% select(Cell_line, disease, DepMap_ID, Drug, Score)
saveRDS(ccle_all, "./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ccle_all_edited.rds", compress = "xz")
ctrp_all <- auc %>% filter(Database == "CTRP") %>% select(Cell_line, disease, DepMap_ID, Drug, Score)
saveRDS(ctrp_all, "./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ctrp_all_edited.rds", compress = "xz")
gdsc_all <- auc %>% filter(Database == "GDSC") %>% select(Cell_line, disease, DepMap_ID, Drug, Score)
saveRDS(gdsc_all, "./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_gdsc_all_edited.rds", compress = "xz")
```

`r nrow(filter(test, n != 1))`/`r nrow(test)` gene-cell line combinations have more than one mutation in the MAF file. This is corrected in the point mutation filtering done below.
```{r merge_drug_data, eval=FALSE}
ccle_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ccle_all_edited.rds")
ctrp_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ctrp_all_edited.rds")
gdsc_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_gdsc_all_edited.rds")

ccle <- MergeOmicsG2P(database = "CCLE", dataframe = ccle_all, maf_df = maf_df, ge_df = ge_melt, cn_df = cn_melt, gene_list = g2p_genes, outfile = "./data_munging/19Q2/ccle_data_19Q2.rds")
# write.csv.gz(ccle %>% drop_na(Score), "./data_munging/19Q2/ccle_data_19Q2.csv.gz")

ctrp <- MergeOmicsG2P(database = "CTRP", dataframe = ctrp_all, maf_df = maf_df, ge_df = ge_melt, cn_df = cn_melt, gene_list = g2p_genes, outfile = "./../htscreens_giant_files/ctrp_data_19Q2.rds")
# write.csv.gz(ctrp %>% drop_na(Score), "./../htscreens_giant_files/ctrp_data_19Q2.csv.gz")

gdsc <- MergeOmicsG2P(database = "GDSC", dataframe = gdsc_all, maf_df = maf_df, ge_df = ge_melt, cn_df = cn_melt, gene_list = g2p_genes, outfile = "./data_munging/19Q2/gdsc_data_19Q2.rds")
# write.csv.gz(gdsc %>% drop_na(Score), "./../htscreens_giant_files/gdsc_data_19Q2.csv.gz")
```

```{r load_drug_rds}
# ccle_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ccle_all_edited.rds")
# ctrp_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ctrp_all_edited.rds")
# gdsc_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_gdsc_all_edited.rds")

# ccle <- readRDS("./data_munging/19Q2/ccle_data_19Q2_all.rds") %>% drop_na(Drug)
# ctrp <- readRDS("./../htscreens_giant_files/ctrp_data_19Q2_all.rds") %>% drop_na(Drug)
# gdsc <- readRDS("./data_munging/19Q2/gdsc_data_19Q2_all.rds") %>% drop_na(Drug)
# saveRDS(ccle, "./data_munging/19Q2/ccle_data_19Q2.rds", compress = "xz")
# saveRDS(ctrp, "./../htscreens_giant_files/ctrp_data_19Q2.rds", compress = "xz")
# saveRDS(gdsc, "./data_munging/19Q2/gdsc_data_19Q2.rds", compress = "xz")

ccle <- readRDS("./data_munging/19Q2/ccle_data_19Q2_unique.rds") %>% drop_na(Drug)
ctrp <- readRDS("./data_munging/19Q2/ctrp_data_19Q2_g2pdrugs_unique.rds") %>% drop_na(Drug)
gdsc <- readRDS("./data_munging/19Q2/gdsc_data_19Q2_unique.rds") %>% drop_na(Drug)

# ccle_unique <- unique(ccle) # Pre: 1512092
# ctrp_unique <- unique(ctrp) # Pre: 47807047
# gdsc_unique <- unique(gdsc) # Pre: 10143182

# Testing
test_ccle <- ccle %>% count(Drug)
test_ctrp <- ctrp %>% count(Drug)
test_gdsc <- gdsc %>% count(Drug)
```

How many datasets screen each G2P drug?
```{r drug_testing, eval=FALSE}
drug_summ <- data.frame(Drug = character(), Dataset_Count = integer(), stringsAsFactors = FALSE)

for(drug in g2p_drugs) {
  counter = 0
  if(drug %in% as.character(unique(ccle$Drug[!is.na(ccle$Drug)]))) { counter <- counter + 1 }
  if(drug %in% as.character(unique(ctrp$Drug[!is.na(ctrp$Drug)]))) { counter <- counter + 1 }
  if(drug %in% as.character(unique(gdsc$Drug[!is.na(gdsc$Drug)]))) { counter <- counter + 1 }
  drug_summ <- rbind(drug_summ, data.frame(Drug = drug, Dataset_Count = counter))
}
```

Merge fusions:
```{r merge_fusions, eval=FALSE}
ccle_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ccle_all_edited.rds")
ctrp_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ctrp_all_edited.rds")
gdsc_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_gdsc_all_edited.rds")
fusions_filt <- filter(fusions, FusionPair %in% unique(as.character(g2p_fus$FusionPair)))

ccle_fus_grid <- expand.grid("DepMap_ID" = unique(ccle_all$DepMap_ID), "FusionPair" = unique(fusions_filt$FusionPair))
ccle_fus <- merge(merge(ccle_all, ccle_fus_grid, by = "DepMap_ID", all = TRUE), fusions_filt, by = c("DepMap_ID", "Cell_line", "FusionPair", "disease"), all = TRUE)
ccle_fus$Fusion_Status <- ifelse(!is.na(ccle_fus$LeftGene), "Yes", "No")
ccle_fus$Drug_FusionPair <- with(ccle_fus, ifelse(is.na(Drug) | is.na(FusionPair), NA, paste0(Drug, "_", FusionPair)))
ccle_fus$Drug_Fusion_Lineage <- with(ccle_fus, ifelse(is.na(Drug) | is.na(FusionPair) | is.na(disease), NA, paste0(Drug, "_", FusionPair, "_", disease)))
ccle_fus$G2P_Drug_FusionPair <- ifelse(ccle_fus$Drug_FusionPair %in% unique(as.character(g2p_fus$Drug_FusionPair)), "Yes", "No")
ccle_fus$G2P_Fusion <- ifelse(ccle_fus$FusionPair %in% unique(as.character(g2p_fus$FusionPair)), "Yes", "No")
ccle_fus$G2P_Drug_Fusion_Lineage <- ifelse(ccle_fus$Drug_Fusion_Lineage %in% unique(as.character(g2p_fus$Drug_Fusion_Lineage)), "Yes", "No")
ccle_fus$Database <- "CCLE"

ctrp_fus_grid <- expand.grid("DepMap_ID" = unique(ctrp_all$DepMap_ID), "FusionPair" = unique(fusions_filt$FusionPair))
ctrp_fus <- merge(merge(ctrp_all, ctrp_fus_grid, by = "DepMap_ID", all = TRUE), fusions_filt, by = c("DepMap_ID", "Cell_line", "FusionPair", "disease"), all = TRUE)
ctrp_fus$Fusion_Status <- ifelse(!is.na(ctrp_fus$LeftGene), "Yes", "No")     
ctrp_fus$Drug_FusionPair <- with(ctrp_fus, ifelse(is.na(Drug) | is.na(FusionPair), NA, paste0(Drug, "_", FusionPair)))
ctrp_fus$Drug_Fusion_Lineage <- with(ctrp_fus, ifelse(is.na(Drug) | is.na(FusionPair) | is.na(disease), NA, paste0(Drug, "_", FusionPair, "_", disease)))
ctrp_fus$G2P_Drug_FusionPair <- ifelse(ctrp_fus$Drug_FusionPair %in% unique(as.character(g2p_fus$Drug_FusionPair)), "Yes", "No")
ctrp_fus$G2P_Fusion <- ifelse(ctrp_fus$FusionPair %in% unique(as.character(g2p_fus$FusionPair)), "Yes", "No")
ctrp_fus$G2P_Drug_Fusion_Lineage <- ifelse(ctrp_fus$Drug_Fusion_Lineage %in% unique(as.character(g2p_fus$Drug_Fusion_Lineage)), "Yes", "No")
ctrp_fus$Database <- "CTRP"

gdsc_fus_grid <- expand.grid("DepMap_ID" = unique(gdsc_all$DepMap_ID), "FusionPair" = unique(fusions_filt$FusionPair))
gdsc_fus <- merge(merge(gdsc_all, gdsc_fus_grid, by = "DepMap_ID", all = TRUE), fusions_filt, by = c("DepMap_ID", "Cell_line", "FusionPair", "disease"), all = TRUE)
gdsc_fus$Fusion_Status <- ifelse(!is.na(gdsc_fus$LeftGene), "Yes", "No")
gdsc_fus$Drug_FusionPair <- with(gdsc_fus, ifelse(is.na(Drug) | is.na(FusionPair), NA, paste0(Drug, "_", FusionPair)))
gdsc_fus$Drug_Fusion_Lineage <- with(gdsc_fus, ifelse(is.na(Drug) | is.na(FusionPair) | is.na(disease), NA, paste0(Drug, "_", FusionPair, "_", disease)))
gdsc_fus$G2P_Drug_FusionPair <- ifelse(gdsc_fus$Drug_FusionPair %in% unique(as.character(g2p_fus$Drug_FusionPair)), "Yes", "No")
gdsc_fus$G2P_Fusion <- ifelse(gdsc_fus$FusionPair %in% unique(as.character(g2p_fus$FusionPair)), "Yes", "No")
gdsc_fus$G2P_Drug_Fusion_Lineage <- ifelse(gdsc_fus$Drug_Fusion_Lineage %in% unique(as.character(g2p_fus$Drug_Fusion_Lineage)), "Yes", "No")
gdsc_fus$Database <- "GDSC"

fus <- bind_rows(ccle_fus, ctrp_fus, gdsc_fus)
colnames(fus)[colnames(fus) == "AUC_IC50"] <- "Score"
saveRDS(fus, "./data_munging/rds/fusions_merged.rds")
```

```{r load_fusion_data}
fus <- readRDS("./data_munging/rds/fusions_merged.rds") %>% drop_na(Drug)
fus_summary <- fus %>% count(Database, Drug, FusionPair, Fusion_Status)
```

Merge protein changes
```{r merge_protein_changes, eval=FALSE}
ccle_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ccle_all_edited.rds")
ctrp_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_ctrp_all_edited.rds")
gdsc_all <- readRDS("./../htscreens_giant_files/pozdeyev_data/pozdeyev2016_gdsc_all_edited.rds")
maf_changes_df <- readRDS("./data_munging/19Q2/maf_changes_df_19Q2.rds")
maf_changes_filt <- filter(maf_changes_df, Gene_Protein_Change %in% unique(as.character(g2p_prot$Gene_Protein_Change)))

# CCLE
ccle_prot_grid <- expand.grid("DepMap_ID" = unique(ccle_all$DepMap_ID), "Gene_Protein_Change" = unique(maf_changes_filt$Gene_Protein_Change))
ccle_prot <- merge(ccle_all, ccle_prot_grid, by = "DepMap_ID", all = TRUE)
ccle_prot <- merge(ccle_prot, maf_changes_filt, by = c("DepMap_ID", "Gene_Protein_Change"), all = TRUE)
ccle_prot$Change_Status <- ifelse(!is.na(ccle_prot$Protein_Change), "Yes", "No")
ccle_prot$Drug_Gene_Protein_Change <- with(ccle_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change), NA, paste0(Drug, "_", Gene_Protein_Change)))
ccle_prot$Drug_Gene_Protein_Change_Lineage <- with(ccle_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Drug, "_", Gene_Protein_Change, "_", disease)))
ccle_prot$G2P_Drug_Gene_Protein_Change <- ifelse(ccle_prot$Drug_Gene_Protein_Change %in% unique(as.character(g2p_prot$Drug_Gene_Protein_Change)), "Yes", "No")
ccle_prot$G2P_Protein_Change <- ifelse(ccle_prot$Gene_Protein_Change %in% unique(as.character(g2p_prot$Gene_Protein_Change)), "Yes", "No")
ccle_prot$G2P_Drug_Gene_Protein_Change_Lineage <- ifelse(ccle_prot$Drug_Gene_Protein_Change_Lineage %in% unique(as.character(g2p_prot$Drug_Gene_Protein_Change_Lineage)), "Yes", "No")
ccle_prot <- merge(ccle_prot, unique(select(g2p_prot, Drug_Gene_Protein_Change, Direction_Curated)), by = "Drug_Gene_Protein_Change", all.x = TRUE)
ccle_prot$Database <- "CCLE"
ccle_prot <- ccle_prot %>% drop_na(Drug, DepMap_ID)

# CTRP
ctrp_prot_grid <- expand.grid("DepMap_ID" = unique(ctrp_all$DepMap_ID), "Gene_Protein_Change" = unique(maf_changes_filt$Gene_Protein_Change))
ctrp_prot <- merge(ctrp_all, ctrp_prot_grid, by = "DepMap_ID", all = TRUE)
ctrp_prot <- merge(ctrp_prot, maf_changes_filt, by = c("DepMap_ID", "Gene_Protein_Change"), all = TRUE)
ctrp_prot$Change_Status <- ifelse(!is.na(ctrp_prot$Protein_Change), "Yes", "No")
ctrp_prot$Drug_Gene_Protein_Change <- with(ctrp_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change), NA, paste0(Drug, "_", Gene_Protein_Change)))
ctrp_prot$Drug_Gene_Protein_Change_Lineage <- with(ctrp_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Drug, "_", Gene_Protein_Change, "_", disease)))
ctrp_prot$G2P_Drug_Gene_Protein_Change <- ifelse(ctrp_prot$Drug_Gene_Protein_Change %in% unique(as.character(g2p_prot$Drug_Gene_Protein_Change)), "Yes", "No")
ctrp_prot$G2P_Protein_Change <- ifelse(ctrp_prot$Gene_Protein_Change %in% unique(as.character(g2p_prot$Gene_Protein_Change)), "Yes", "No")
ctrp_prot$G2P_Drug_Gene_Protein_Change_Lineage <- ifelse(ctrp_prot$Drug_Gene_Protein_Change_Lineage %in% unique(as.character(g2p_prot$Drug_Gene_Protein_Change_Lineage)), "Yes", "No")
ctrp_prot <- merge(ctrp_prot, unique(select(g2p_prot, Drug_Gene_Protein_Change, Direction_Curated)), by = "Drug_Gene_Protein_Change", all.x = TRUE)
ctrp_prot$Database <- "CTRP"
ctrp_prot <- ctrp_prot %>% drop_na(Drug, DepMap_ID)

# GDSC
gdsc_prot_grid <- expand.grid("DepMap_ID" = unique(gdsc_all$DepMap_ID), "Gene_Protein_Change" = unique(maf_changes_filt$Gene_Protein_Change))
gdsc_prot <- merge(gdsc_all, gdsc_prot_grid, by = "DepMap_ID", all = TRUE)
gdsc_prot <- merge(gdsc_prot, maf_changes_filt, by = c("DepMap_ID", "Gene_Protein_Change"), all = TRUE)
gdsc_prot$Change_Status <- ifelse(!is.na(gdsc_prot$Protein_Change), "Yes", "No")
gdsc_prot$Drug_Gene_Protein_Change <- with(gdsc_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change), NA, paste0(Drug, "_", Gene_Protein_Change)))
gdsc_prot$Drug_Gene_Protein_Change_Lineage <- with(gdsc_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Drug, "_", Gene_Protein_Change, "_", disease)))
gdsc_prot$G2P_Drug_Gene_Protein_Change <- ifelse(gdsc_prot$Drug_Gene_Protein_Change %in% unique(as.character(g2p_prot$Drug_Gene_Protein_Change)), "Yes", "No")
gdsc_prot$G2P_Protein_Change <- ifelse(gdsc_prot$Gene_Protein_Change %in% unique(as.character(g2p_prot$Gene_Protein_Change)), "Yes", "No")
gdsc_prot$G2P_Drug_Gene_Protein_Change_Lineage <- ifelse(gdsc_prot$Drug_Gene_Protein_Change_Lineage %in% unique(as.character(g2p_prot$Drug_Gene_Protein_Change_Lineage)), "Yes", "No")
gdsc_prot <- merge(gdsc_prot, unique(select(g2p_prot, Drug_Gene_Protein_Change, Direction_Curated)), by = "Drug_Gene_Protein_Change", all.x = TRUE)
gdsc_prot$Database <- "GDSC"
gdsc_prot <- gdsc_prot %>% drop_na(Drug, DepMap_ID)

prot <- bind_rows(ccle_prot, ctrp_prot, gdsc_prot)
prot <- separate(data = prot, col = Gene_Protein_Change, into = c("Gene", "Protein_Change"), remove = FALSE, sep = ":")
prot <- add_column(prot, Drug_Gene = paste0(prot$Drug, "_", prot$Gene), .after = "Drug")
prot$Direction_Curated <- ifelse(is.na(prot$Direction_Curated), "none", as.character(prot$Direction_Curated))
prot$Direction_Grouper <- with(prot, paste0(Change_Status, "_", Direction_Curated))
saveRDS(prot, "./data_munging/rds/protein_changes_merged.rds")
```

```{r load_prot_data}
prot <- readRDS("./data_munging/rds/protein_changes_merged.rds")
# prot_summary <- prot %>% count(Database, Drug, Gene_Protein_Change, Change_Status)
```

## CRISPR

```{r merge_crispr_data, eval=FALSE}
crispr_all <- read.delim("./data_munging/19Q2/Achilles_gene_effect_20190514.csv.gz", sep = ",", header = TRUE, check.names = FALSE)
# Remove Entrez gene IDs from colnames
colnames(crispr_all) <- gsub(" .*", "", colnames(crispr_all))
colnames(crispr_all)[1] <- "DepMap_ID"

# crispr_allgenes <- MergeOmicsG2P(database = "CRISPR", dataframe = crispr_all, maf_df = maf_df, ge_df = ge_melt, cn_df = cn_melt, gene_list = colnames(crispr_all)[2:length(colnames(crispr_all))], outfile = "./../htscreens_giant_files/crispr_data_19Q2_allgenes.rds")

crispr <- MergeOmicsG2P(database = "CRISPR", dataframe = crispr_all, maf_df = maf_df, ge_df = ge_melt, cn_df = cn_melt, gene_list = g2p_genes, outfile = "./data_munging/19Q2/crispr_data_19Q2.rds")
# write.csv.gz(crispr %>% drop_na(Score), "./../htscreens_giant_files/crispr_data_19Q2.csv.gz")
```

```{r read_crispr_data}
crispr <- readRDS("./data_munging/19Q2/crispr_data_19Q2.rds") %>% drop_na(Gene)
crispr$Gene_Lin <- with(crispr, paste0(Gene, "_", disease))
```

```{r merge_crispr_fus, eval=FALSE}
# crispr_allgenes <- readRDS("./../htscreens_giant_files/crispr_data_19Q2_allgenes.rds")
# fusions_filt <- unfactorize(unique(filter(fusions, FusionPair %in% unique(as.character(g2p_fus$FusionPair)))) %>% select(-c("Cell_line", "disease")))
# crispr_fus_grid <- unfactorize(expand.grid("DepMap_ID" = unique(crispr_allgenes$DepMap_ID), "FusionPair" = unique(fusions_filt$FusionPair)))
# crispr_fus <- merge(merge(crispr_allgenes, crispr_fus_grid, by = "DepMap_ID", all = TRUE), fusions_filt, by = c("DepMap_ID", "FusionPair"), all.x = TRUE)
# crispr_fus$Fusion_Status <- ifelse(!is.na(crispr_fus$LeftGene), "Yes", "No")
# crispr_fus$Drug_FusionPair <- with(crispr_fus, ifelse(is.na(Drug) | is.na(FusionPair), NA, paste0(Drug, "_", FusionPair)))
# crispr_fus$Drug_Fusion_Lineage <- with(crispr_fus, ifelse(is.na(Drug) | is.na(FusionPair) | is.na(disease), NA, paste0(Drug, "_", FusionPair, "_", disease)))
# crispr_fus$G2P_Drug_FusionPair <- "No"
# crispr_fus$G2P_Fusion <- ifelse(crispr_fus$FusionPair %in% unique(as.character(g2p_fus$FusionPair)), "Yes", "No")
# crispr_fus$G2P_Drug_Fusion_Lineage <- "No"
# crispr_fus$Database <- "CRISPR"
# crispr_fus <- crispr_fus %>% drop_na(Score)
# saveRDS(crispr_fus, "./../htscreens_giant_files/crispr_fusions_allgenes.rds", compress = "xz")

fusions_filt <- unfactorize(unique(filter(fusions, FusionPair %in% unique(as.character(g2p_fus$FusionPair)))) %>% select(-c("Cell_line", "disease")))
crispr_fus_grid <- unfactorize(expand.grid("DepMap_ID" = unique(crispr$DepMap_ID), "FusionPair" = unique(fusions_filt$FusionPair)))
crispr_fus <- merge(merge(crispr, crispr_fus_grid, by = "DepMap_ID", all = TRUE), fusions_filt, by = c("DepMap_ID", "FusionPair"), all.x = TRUE)
crispr_fus$Fusion_Status <- ifelse(!is.na(crispr_fus$LeftGene), "Yes", "No")
crispr_fus$Drug_FusionPair <- with(crispr_fus, ifelse(is.na(Drug) | is.na(FusionPair), NA, paste0(Drug, "_", FusionPair)))
crispr_fus$Drug_Fusion_Lineage <- with(crispr_fus, ifelse(is.na(Drug) | is.na(FusionPair) | is.na(disease), NA, paste0(Drug, "_", FusionPair, "_", disease)))
crispr_fus$G2P_Drug_FusionPair <- "No"
crispr_fus$G2P_Fusion <- ifelse(crispr_fus$FusionPair %in% unique(as.character(g2p_fus$FusionPair)), "Yes", "No")
crispr_fus$G2P_Drug_Fusion_Lineage <- "No"
crispr_fus$Database <- "CRISPR"
crispr_fus <- crispr_fus %>% drop_na(Score)
saveRDS(crispr_fus, "./data_munging/19Q2/crispr_fusions.rds", compress = "xz")
```

```{r merge_crispr_prot, eval=FALSE}
crispr_all <- read.delim("./data_munging/19Q2/Achilles_gene_effect_20190514.csv.gz", sep = ",", header = TRUE, check.names = FALSE)
# Remove Entrez gene IDs from colnames
colnames(crispr_all) <- gsub(" .*", "", colnames(crispr_all))
colnames(crispr_all)[1] <- "DepMap_ID"

crispr_all <- crispr_all[, names(crispr_all) %in% c("DepMap_ID", g2p_genes)]

maf_changes_df <- readRDS("./data_munging/19Q2/maf_changes_df_19Q2.rds")
maf_changes_filt <- filter(maf_changes_df, Gene_Protein_Change %in% unique(as.character(g2p_prot$Gene_Protein_Change))) %>% select(-Protein_Change)
maf_changes_filt$Change_Status <- "Yes"

# Melt CRISPR dataset for merging
crispr_melt <- melt(crispr_all, id.vars = "DepMap_ID", measure.vars = colnames(crispr_all)[2:ncol(crispr_all)], variable.name = "Gene", value.name = "Score")
crispr_melt <- filter(crispr_melt, Gene %in% unique(maf_changes_filt$Gene))

grid <- unfactorize(expand.grid("DepMap_ID" = unique(crispr_melt$DepMap_ID), "Gene_Protein_Change" = unique(g2p_prot$Gene_Protein_Change))) 
grid <- separate(grid, Gene_Protein_Change, c("Gene", "Protein_Change"), sep = ":", remove = FALSE) %>% select(-Protein_Change)

crispr_prot <- merge(crispr_melt, grid, by = c("DepMap_ID", "Gene"), all = TRUE)
crispr_prot <- merge(crispr_prot, maf_changes_filt, by = c("DepMap_ID", "Gene", "Gene_Protein_Change"), all = TRUE)  %>% drop_na(Score)
crispr_prot <- merge(crispr_prot, ccl_meta, by = "DepMap_ID", all.x = TRUE)
crispr_prot$Change_Status <- ifelse(is.na(crispr_prot$Change_Status), "No", crispr_prot$Change_Status)
crispr_prot$Drug <- "CRISPR"
crispr_prot$Gene_Protein_Change_Lineage <- with(crispr_prot, ifelse(is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Gene_Protein_Change, "_", disease)))
crispr_prot$Drug_Gene_Protein_Change <- with(crispr_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change), NA, paste0(Drug, "_", Gene_Protein_Change)))
crispr_prot$Drug_Gene_Protein_Change_Lineage <- with(crispr_prot, ifelse(is.na(Drug) | is.na(Gene_Protein_Change) | is.na(disease), NA, paste0(Drug, "_", Gene_Protein_Change, "_", disease)))

crispr_prot$Database <- "CRISPR"

saveRDS(crispr_prot, "./../htscreens_giant_files/crispr_protein_changes_20200103.rds", compress = "xz")
```

```{r, eval = TRUE}
crispr_fus <- readRDS("./data_munging/19Q2/crispr_fusions.rds")
# crispr_prot <- readRDS("./../htscreens_giant_files/crispr_protein_changes.rds")
crispr_prot <- readRDS("./../htscreens_giant_files/crispr_protein_changes_20200103.rds")
```

```{r, eval = FALSE}
crispr_allgenes <- readRDS("./../htscreens_giant_files/crispr_data_19Q2_allgenes.rds")
crispr_fus_allgenes <- readRDS("./../htscreens_giant_files/crispr_fusions_allgenes.rds")
crispr_prot_allgenes <- readRDS("./../htscreens_giant_files/crispr_protein_changes_allgenes.rds")
```

## DUPLICATES

```{r}
# All nrow = 0
# crispr_prot_dup <- crispr_prot[duplicated(crispr_prot),]
# ccle_prot_dup <- ccle_prot[duplicated(ccle_prot),]
# ctrp_prot_dup <- ctrp_prot[duplicated(ctrp_prot),]
# gdsc_prot_dup <- gdsc_prot[duplicated(gdsc_prot),]


```

# EXPLORATORY FIGURES

--------------------------------------------------------------------------------

## Mutation

## Cell line and drug overlaps

```{r ccl_venn, eval=FALSE}
ccle_ccls <- unique(ccle$DepMap_ID)
ctrp_ccls <- unique(ctrp$DepMap_ID)
gdsc_ccls <- unique(gdsc$DepMap_ID)
crispr_ccls <- unique(crispr$DepMap_ID)

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn.diagram(x = list(ccle_ccls, ctrp_ccls, gdsc_ccls, crispr_ccls),
             filename = "./plots/manuscript/all_venn_ccls.png",
             output = TRUE, imagetype = "png",
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1,
             category.names = c("CCLE", "CTRP", "GDSC", "CRISPR"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             # cat.dist = c(0.06, 0.06, 0.035),
             fill = c("springgreen4", "steelblue4", "turquoise4", "darkorchid"))
futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn.diagram(x = list(ccle_ccls, ctrp_ccls, gdsc_ccls),
             filename = "./plots/manuscript/drug_venn_ccls.png",
             output = TRUE, imagetype = "png",
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1.4,
             category.names = c("CCLE", "CTRP", "GDSC"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             cat.dist = c(0.06, 0.06, 0.035),
             fill = c("springgreen4", "steelblue4", "turquoise4"))
```

```{r drug_venn, eval=FALSE}
ccle_drugs <- unique(ccle$Drug)
ctrp_drugs <- unique(ctrp$Drug)
gdsc_drugs <- unique(gdsc$Drug)

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
venn.diagram(x = list(ccle_drugs, ctrp_drugs, gdsc_drugs),
             filename = "./plots/manuscript/drug_venn_drugs.png",
             output = TRUE, imagetype = "png",
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1.4,
             category.names = c("CCLE", "CTRP", "GDSC"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             cat.dist = c(0.06, 0.06, 0.035),
             fill = c("palegreen3", "slategray3", "paleturquoise3"))
```

## Histology distributions

```{r histology_dists_data, eval=FALSE}
hist_count <- function(df, dataset) {
  hists <- unique(select(df, DepMap_ID, disease)) %>% count(disease)
  hists$Percent <- hists$n / sum(hists$n) * 100
  hists$Dataset <- dataset
  hists$disease <- gsub(" cancer", "", hists$disease)
  hists <- hists[order(hists$n, decreasing = T),]
  return(hists)
}

ccle_hists <- hist_count(ccle, "CCLE")
ctrp_hists <- hist_count(ctrp, "CTRP")
gdsc_hists <- hist_count(gdsc, "GDSC")
crispr_hists <- hist_count(crispr, "CRISPR")

drug_hists <- rbind(ccle_hists, ctrp_hists, gdsc_hists, crispr_hists) %>% drop_na(disease)
drug_hists$Dataset <- factor(drug_hists$Dataset, levels = c("CCLE", "CTRP", "GDSC", "CRISPR"))
# drug_hists$disease <- as.character(drug_hists$disease)
saveRDS(drug_hists, "./data_munging/rds/histology_distributions.rds")
```

```{r histology_dists, fig.height=4.5, fig.width=4, eval=FALSE}
drug_hists <- readRDS("./data_munging/rds/histology_distributions.rds")

png(filename = "./plots/manuscript/all_histology_distributions.png", width = 8, height = 9, units = "in", res = 500)
ggplot(drug_hists, aes(x = Dataset, y = n, fill = disease)) +
  geom_bar(stat = "identity", color = "black") +
  scale_y_continuous(breaks = seq(0, 850, by = 50), labels = seq(0, 850, by = 50)) +
  guides(fill = guide_legend(title = "Histology", ncol = 1)) +
  labs(y = "Count")
dev.off()
```

```{r, eval=FALSE}
ccle_ccls <- unique(ccle$DepMap_ID)
ctrp_ccls <- unique(ctrp$DepMap_ID)
gdsc_ccls <- unique(gdsc$DepMap_ID)
crispr_ccls <- unique(crispr$DepMap_ID)

ccls <- data.frame(DepMap_ID = union(ccle_ccls, union(ctrp_ccls, gdsc_ccls)))
all_ccls <- merge(ccls, ccl_meta, by = "DepMap_ID")
all_ccls$disease <- gsub(" cancer", "", all_ccls$disease)

png(filename = "./plots/manuscript/drug_histology_distributions.png", width = 8, height = 4, units = "in", res = 500)
ggplot(all_ccls, aes(x = fct_infreq(factor(disease)), fill = disease)) +
  geom_bar(color = "black") +
  scale_y_continuous(breaks = seq(0, 220, by = 40), labels = seq(0, 220, by = 40)) +
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(angle = 70, hjust = 1, vjust = 1)) +
  labs(y = "Number of Cell Lines", x = "Histology", caption = paste0(formatC(nrow(all_ccls), format = "d", big.mark = ","), " cell lines represented."))
dev.off()
```

## G2P summary heatmap

```{r dg_heatmap, fig.height=6, fig.width=8, warning=FALSE, eval=FALSE}
# Create annotation layer
hta_data <- data.frame(Drug = rownames(g2p_dg_counts), CCLE = NA, CTRP = NA, GDSC = NA)
hta_data$CCLE <- ifelse(hta_data$Drug %in% unique(ccle$Drug), "Screened", "Not screened")
hta_data$CTRP <- ifelse(hta_data$Drug %in% unique(ctrp$Drug), "Screened", "Not screened")
hta_data$GDSC <- ifelse(hta_data$Drug %in% unique(gdsc$Drug), "Screened", "Not screened")
rownames(hta_data) <- hta_data$Drug
hta_data$Drug <- NULL

hta_annot <- HeatmapAnnotation(text = anno_text(colnames(hta_data), offset = unit(0.4, "in"), gp = gpar(fontsize = 10)))
hta_legend_list <- list(legend_direction = "horizontal", border = "gray70", nrow = 2)
hta <- Heatmap(hta_data,
               name = "Functional screen status           ",
               col = c("Screened" = "purple4", "Not screened" = "gray97"), 
               rect_gp = gpar(col = "gray70"),
               top_annotation = hta_annot,
               heatmap_legend_param = hta_legend_list,
               row_names_side = "left",
               row_names_gp = gpar(fontsize = 10),
               column_names_side = "top",
               column_names_gp = gpar(fontsize = 10),
               show_column_names = FALSE,
               cluster_rows = FALSE, 
               cluster_columns = FALSE,
               row_title = "Drugs",
               row_title_gp = gpar(fontface = "bold", fontsize = 14),
               column_title = "Dataset",
               column_title_gp = gpar(fontface = "bold", fontsize = 14),
               width = unit(1.5, "in"))

# Define color scale
col_fun <- colorRamp2(c(0, 1, 100), c("gray97", "mistyrose", "purple4"))
# Legend properties list
ht_legend_list <- list(legend_direction = "horizontal", legend_width = unit(2.5, "in"), border = "gray70")
ht <- Heatmap(g2p_dg_counts, 
              name = "Number of G2P interpretations",
              col = col_fun,
              na_col = "gray97",
              rect_gp = gpar(col = "gray70"),
              heatmap_legend_param = ht_legend_list,
              cluster_rows = FALSE, 
              cluster_columns = FALSE, 
              show_row_names = FALSE,
              row_names_side = "left",
              row_names_gp = gpar(fontsize = 10),
              column_names_side = "bottom",
              show_column_names = FALSE,
              bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(g2p_dg_counts),
                                   rot = 45,
                                   gp = gpar(fontsize = 8),
                                   offset = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.45, "in")),
              row_title = "Drugs",
              row_title_gp = gpar(fontface = "bold", fontsize = 14),
              column_title = "Genes", 
              column_title_gp = gpar(fontface = "bold", fontsize = 14),
              column_title_side = "bottom")

png(filename = "./plots/manuscript/g2p_summary_heatmap.png", width = 10, height = 9, units = "in", res = 500)
draw(hta + ht, gap = unit(5, "mm"), heatmap_legend_side = "top")
dev.off()
```

# WILCOXON: Mutations

--------------------------------------------------------------------------------

ggpubr's convention for symbols indicating statistical significance:

- ns: p > 0.05
- *: p <= 0.05
- **: p <= 0.01
- ***: p <= 0.001
- ****: p <= 0.0001

```{r wilcoxon_functions}
adj_signif <- function(df, alpha) {
  # Takes df from compare_means and creates a signif code column for FDR-adjusted p-vals
  df$p.signif.adj <- ifelse(df$p.adj <= alpha, "*", NA)
  df$p.signif <- ifelse(df$p.signif == "ns", NA, df$p.signif)
  df$p.short <- formatC(df$p, format = "g", digits =  2)
  df$p.adj.short <- formatC(df$p.adj, format = "g", digits =  2)
  return(df)
}

WilcoxonTestDF <- function(dataframe, grouping, g2p_list, type, outfile) {
  require(ggpubr)
  
  # Mutation status
  if(tolower(type) == "drug_gene") {
    # Filter out DGs with too few samples in at least one mutation status category
    # Require at least 3 samples in each category to run the test, else filter out that DG from testing df
    count_n <- dataframe %>% count(Drug_Gene, Mutation)
    count_n_wide <- dcast(count_n, Drug_Gene ~ Mutation, value.var = "n", fill = 0) %>% separate(Drug_Gene, sep = "_", c("Drug", "Gene"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Gene", "Drug", "Gene", "Mutation_0_count", "Mutation_1_count")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Gene) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Gene, count_category$Drug_Gene)
    dataframe <- filter(dataframe, Drug_Gene %in% dg_keep)
    dataframe$Drug_Gene <- as.character(dataframe$Drug_Gene)
    signif <- compare_means(Score ~ Mutation, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Mutation_0_count, "/", Mutation_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Gene %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Gene %in% g2p_list, "Yes", "No") }
  }
  
  # Mutation status and lineage
  if(tolower(type) == "drug_gene_lineage") {
    # Filter out DGLs with too few samples in at least one mutation status category
    # Require at least 3 samples in each category to run the test, else filter out that DGL from testing df
    count_n <- dataframe %>% count(Drug_Gene_Lin, Mutation)
    count_n_wide <- dcast(count_n, Drug_Gene_Lin ~ Mutation, value.var = "n", fill = 0) %>% separate(Drug_Gene_Lin, sep = "_", c("Drug", "Gene", "disease"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Gene_Lin", "Drug", "Gene", "disease", "Mutation_0_count", "Mutation_1_count")
    count_n_wide <- add_column(count_n_wide, Drug_Gene = paste0(count_n_wide$Drug, "_", count_n_wide$Gene), .after = "Gene")
    count_n_wide <- add_column(count_n_wide, Gene_Lin = paste0(count_n_wide$Gene, "_", count_n_wide$disease), .after = "Drug_Gene")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Gene_Lin) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Gene_Lin, count_category$Drug_Gene_Lin)
    dataframe <- filter(dataframe, Drug_Gene_Lin %in% dg_keep)
    dataframe$Drug_Gene_Lin <- as.character(dataframe$Drug_Gene_Lin)
    signif <- compare_means(Score ~ Mutation, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Mutation_0_count, "/", Mutation_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Gene_Lin %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Gene_Lin %in% g2p_list, "Yes", "No") }
  }
  
  # Protein changes
  if(tolower(type) == "protein_change") {
    # Filter out Gene:Protein_Changes with too few samples in at least one category
    # Require at least 3 samples in each category to run the test, else filter out that Gene_Protein_Change from testing df
    count_n <- dataframe %>% count(Drug_Gene_Protein_Change, Change_Status)
    count_n_wide <- dcast(count_n, Drug_Gene_Protein_Change ~ Change_Status, value.var = "n", fill = 0) %>% separate(Drug_Gene_Protein_Change, sep = "_", c("Drug", "Gene_Protein_Change"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Gene_Protein_Change", "Drug", "Gene_Protein_Change", "Change_Status_0_count", "Change_Status_1_count")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Gene_Protein_Change) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Gene_Protein_Change, count_category$Drug_Gene_Protein_Change)
    dataframe <- filter(dataframe, Drug_Gene_Protein_Change %in% dg_keep)
    dataframe$Drug_Gene_Protein_Change <- as.character(dataframe$Drug_Gene_Protein_Change)
    signif <- compare_means(Score ~ Change_Status, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Change_Status_0_count, "/", Change_Status_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Gene_Protein_Change %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Gene_Protein_Change %in% g2p_list, "Yes", "No")  }
  }
  
  # Protein changes and lineage
  if(tolower(type) == "protein_change_lineage") {
    # Filter out Gene:Protein_Changes with too few samples in at least one category
    # Require at least 3 samples in each category to run the test, else filter out that Drug_Gene_Protein_Change_Lineage from testing df
    count_n <- dataframe %>% count(Drug_Gene_Protein_Change_Lineage, Change_Status)
    count_n_wide <- dcast(count_n, Drug_Gene_Protein_Change_Lineage ~ Change_Status, value.var = "n", fill = 0) %>% separate(Drug_Gene_Protein_Change_Lineage, sep = "_", c("Drug", "Gene_Protein_Change", "disease"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Gene_Protein_Change_Lineage", "Drug", "Gene_Protein_Change", "disease", "Change_Status_0_count", "Change_Status_1_count")
    count_n_wide <- add_column(count_n_wide, Drug_Gene_Protein_Change = paste0(count_n_wide$Drug, "_", count_n_wide$Gene_Protein_Change), .after = "Gene_Protein_Change")
    count_n_wide <- add_column(count_n_wide, Gene_Protein_Change_Lineage = paste0(count_n_wide$Gene_Protein_Change, "_", count_n_wide$disease), .after = "Drug_Gene_Protein_Change")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Gene_Protein_Change_Lineage) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Gene_Protein_Change_Lineage, count_category$Drug_Gene_Protein_Change_Lineage)
    dataframe <- filter(dataframe, Drug_Gene_Protein_Change_Lineage %in% dg_keep)
    dataframe$Drug_Gene_Protein_Change_Lineage <- as.character(dataframe$Drug_Gene_Protein_Change_Lineage)
    signif <- compare_means(Score ~ Change_Status, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Change_Status_0_count, "/", Change_Status_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Gene_Protein_Change_Lineage %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Gene_Protein_Change_Lineage %in% g2p_list, "Yes", "No") }
  }
  
  # Fusions
  if(tolower(type) == "fusion") {
    # Filter out fusions with too few samples in at least one category
    # Require at least 3 samples in each category to run the test, else filter out that Drug_FusionPair from testing df
    count_n <- dataframe %>% count(Drug_FusionPair, Fusion_Status)
    count_n_wide <- dcast(count_n, Drug_FusionPair ~ Fusion_Status, value.var = "n", fill = 0) %>% separate(Drug_FusionPair, sep = "_", c("Drug", "FusionPair"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_FusionPair", "Drug", "FusionPair", "Fusion_Status_0_count", "Fusion_Status_1_count")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_FusionPair) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_FusionPair, count_category$Drug_FusionPair)
    dataframe <- filter(dataframe, Drug_FusionPair %in% dg_keep)
    dataframe$Drug_FusionPair <- as.character(dataframe$Drug_FusionPair)
    signif <- compare_means(Score ~ Fusion_Status, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Fusion_Status_0_count, "/", Fusion_Status_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_FusionPair %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$FusionPair %in% g2p_list, "Yes", "No")  }
  }
  
  # Fusions and lineage
  if(tolower(type) == "fusion_lineage") {
    # Filter out fusions with too few samples in at least one category
    # Require at least 3 samples in each category to run the test, else filter out that Drug_Fusion_Lineage from testing df
    count_n <- dataframe %>% count(Drug_Fusion_Lineage, Fusion_Status)
    count_n_wide <- dcast(count_n, Drug_Fusion_Lineage ~ Fusion_Status, value.var = "n", fill = 0) %>% separate(Drug_Fusion_Lineage, sep = "_", c("Drug", "FusionPair", "disease"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Fusion_Lineage", "Drug", "FusionPair", "disease", "Fusion_Status_0_count", "Fusion_Status_1_count")
    count_n_wide <- add_column(count_n_wide, Drug_FusionPair = paste0(count_n_wide$Drug, "_", count_n_wide$FusionPair), .after = "FusionPair")
    count_n_wide <- add_column(count_n_wide, Fusion_Lineage = paste0(count_n_wide$FusionPair, "_", count_n_wide$disease), .after = "Drug_FusionPair")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Fusion_Lineage) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Fusion_Lineage, count_category$Drug_Fusion_Lineage)
    dataframe <- filter(dataframe, Drug_Fusion_Lineage %in% dg_keep)
    dataframe$Drug_Fusion_Lineage <- as.character(dataframe$Drug_Fusion_Lineage)
    signif <- compare_means(Score ~ Fusion_Status, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Fusion_Status_0_count, "/", Fusion_Status_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Fusion_Lineage %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Fusion_Lineage %in% g2p_list, "Yes", "No") }
  }
  
  # Direction (old)
  if(tolower(type) == "direction") {
    signif <- compare_means(Score ~ Direction_Grouper, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
  }
  
  signif$p_log10 <- as.numeric(formatC(-log10(signif$p), digits = 3, format = "f"))
  saveRDS(signif, outfile)
  return(signif)
}
```


## Mutation status

NOTE: `tidyr` is now in version 1.0.0 and `unnest()` is deprecated. `unnest()` is used in `ggpubr` function `compare_means()`, so will get following error when running my custom `WilcoxonTestDF()` function. Output is still the same, but will want to update code/testing when `ggpubr` fixes `unnest()` usage.

Error message: `cols` is now required. Please use `cols = c(p)`

```{r testing, eval=FALSE}
dataframe <- ccle_filt
grouping = c("Drug", "Gene", "Drug_Gene")
g2p_list = unique(as.character(g2p_mut$Drug_Gene[!is.na(g2p_mut$Drug_Gene)]))
outfile = "./data_munging/rds/ccle_signif_g2p_dg.rds"

count_n <- dataframe %>% count(Drug_Gene, Mutation)
    count_n_wide <- dcast(count_n, Drug_Gene ~ Mutation, value.var = "n", fill = 0) %>% separate(Drug_Gene, sep = "_", c("Drug", "Gene"), remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Gene", "Drug", "Gene", "Mutation_0_count", "Mutation_1_count")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Gene) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Gene, count_category$Drug_Gene)
    dataframe <- filter(dataframe, Drug_Gene %in% dg_keep)
    dataframe$Drug_Gene <- as.character(dataframe$Drug_Gene)
    signif <- compare_means(Score ~ Mutation, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Mutation_0_count, "/", Mutation_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Gene %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- "No" }

    
dataframe = ccle_filt
grouping = c("Drug", "Gene", "Drug_Gene", "disease", "Drug_Gene_Lin")
g2p_list = unique(as.character(g2p_mut$Drug_Gene_Lin[!is.na(g2p_mut$Drug_Gene_Lin)]))
outfile = "./data_munging/rds/ccle_signif_g2p_dgl.rds"    
    count_n <- dataframe %>% count(Drug_Gene_Lin, Mutation)
    count_n_wide <- dcast(count_n, Drug_Gene_Lin ~ Mutation, value.var = "n", fill = 0) %>% separate(Drug_Gene_Lin, sep = "_", c("Drug", "Gene", "disease"), extra = "merge", remove = FALSE)
    colnames(count_n_wide) <- c("Drug_Gene_Lin", "Drug", "Gene", "disease", "Mutation_0_count", "Mutation_1_count")
    count_n_wide <- add_column(count_n_wide, Drug_Gene = paste0(count_n_wide$Drug, "_", count_n_wide$Gene), .after = "Gene")
    count_n_filt <- filter(count_n, n >= 3)
    count_category <- count_n_filt %>% count(Drug_Gene_Lin) %>% filter(n == 2)
    dg_keep <- intersect(count_n_filt$Drug_Gene_Lin, count_category$Drug_Gene_Lin)
    dataframe <- filter(dataframe, Drug_Gene_Lin %in% dg_keep)
    dataframe$Drug_Gene_Lin <- as.character(dataframe$Drug_Gene_Lin)
    signif <- compare_means(Score ~ Mutation, group.by = grouping, data = dataframe, paired = FALSE, method = "wilcox.test", p.adjust.method = "BH")
    signif <- adj_signif(signif, alpha = 0.05)
    signif <- signif[order(signif$p),]
    signif <- merge(signif, count_n_wide, by = grouping, all = TRUE)
    signif$`n WT/mut` <- with(signif, paste0(Mutation_0_count, "/", Mutation_1_count))
    if(is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- ifelse(signif$Drug_Gene_Lin %in% g2p_list, "Yes", "No") }
    if(!is.na(str_match(pattern = "crispr", string = outfile))) { signif$InG2P <- "No" }
```

```{r mut_wilcoxon_tests, eval=FALSE}
# ccle$Drug_Gene <- with(ccle, paste0(Drug, "_", Gene))
# ccle$Drug_Gene_Lin <- with(ccle, paste0(Drug, "_", Gene, "_", disease))
# 
# ctrp$Drug_Gene <- with(ctrp, paste0(Drug, "_", Gene))
# ctrp$Drug_Gene_Lin <- with(ctrp, paste0(Drug, "_", Gene, "_", disease))
#   
# gdsc$Drug_Gene <- with(gdsc, paste0(Drug, "_", Gene))
# gdsc$Drug_Gene_Lin <- with(gdsc, paste0(Drug, "_", Gene, "_", disease))

# CCLE
ccle_filt <- filter(ccle, Drug %in% g2p_drugs & Gene %in% g2p_dg_genes)
ccle_filt$Gene <- factor(ccle_filt$Gene, ordered = FALSE)
ccle_filt <- unfactorize(ccle_filt)
ccle_signif_g2p_dg <- WilcoxonTestDF(dataframe = ccle_filt, grouping = c("Drug", "Gene", "Drug_Gene"), type = "drug_gene", g2p_list = unique(as.character(g2p_mut$Drug_Gene[!is.na(g2p_mut$Drug_Gene)])), outfile = "./data_munging/rds/ccle_signif_g2p_dg.rds")
ccle_signif_g2p_dgl <- WilcoxonTestDF(dataframe = ccle_filt, grouping = c("Drug", "Gene", "Drug_Gene", "disease", "Drug_Gene_Lin"), type = "drug_gene_lineage", g2p_list = unique(as.character(g2p_mut$Drug_Gene_Lin[!is.na(g2p_mut$Drug_Gene_Lin)])), outfile = "./data_munging/rds/ccle_signif_g2p_dgl.rds")

# CTRP
ctrp_filt <- filter(ctrp, Drug %in% g2p_drugs & Gene %in% g2p_dg_genes)
ctrp_filt$Gene <- factor(ctrp_filt$Gene, ordered = FALSE)
ctrp_filt <- unfactorize(ctrp_filt)
ctrp_signif_g2p_dg <- WilcoxonTestDF(dataframe = ctrp_filt, grouping = c("Drug", "Gene", "Drug_Gene"), type = "drug_gene", g2p_list = unique(as.character(g2p_mut$Drug_Gene[!is.na(g2p_mut$Drug_Gene)])), outfile = "./data_munging/rds/ctrp_signif_g2p_dg.rds")
ctrp_signif_g2p_dgl <- WilcoxonTestDF(dataframe = ctrp_filt, grouping = c("Drug", "Gene", "Drug_Gene", "disease", "Drug_Gene_Lin"), type = "drug_gene_lineage", g2p_list = unique(as.character(g2p_mut$Drug_Gene_Lin[!is.na(g2p_mut$Drug_Gene_Lin)])), outfile = "./data_munging/rds/ctrp_signif_g2p_dgl.rds")

# GDSC
gdsc_filt <- filter(gdsc, Drug %in% g2p_drugs & Gene %in% g2p_dg_genes)
gdsc_filt$Gene <- factor(gdsc_filt$Gene, ordered = FALSE)
gdsc_filt <- unfactorize(gdsc_filt)
gdsc_signif_g2p_dg <- WilcoxonTestDF(dataframe = gdsc_filt, grouping = c("Drug", "Gene", "Drug_Gene"), type = "drug_gene", g2p_list = unique(as.character(g2p_mut$Drug_Gene[!is.na(g2p_mut$Drug_Gene)])), outfile = "./data_munging/rds/gdsc_signif_g2p_dg.rds")
gdsc_signif_g2p_dgl <- WilcoxonTestDF(dataframe = gdsc_filt, grouping = c("Drug", "Gene", "Drug_Gene", "disease", "Drug_Gene_Lin"), type = "drug_gene_lineage", g2p_list = unique(as.character(g2p_mut$Drug_Gene_Lin[!is.na(g2p_mut$Drug_Gene_Lin)])), outfile = "./data_munging/rds/gdsc_signif_g2p_dgl.rds")
```

## Protein changes

```{r protein_change_data}
ccle_prot <- filter(prot, Database == "CCLE" & Drug %in% g2p_drugs)
ccle_prot <- unfactorize(ccle_prot)
# ccle_prot_count <- ccle_prot %>% count(Gene_Protein_Change, Drug, Change_Status)

ctrp_prot <- filter(prot, Database == "CTRP" & Drug %in% g2p_drugs)
ctrp_prot <- unfactorize(ctrp_prot)
# ctrp_prot_count <- ctrp_prot %>% count(Gene_Protein_Change, Drug, Change_Status)

gdsc_prot <- filter(prot, Database == "GDSC" & Drug %in% g2p_drugs)
gdsc_prot <- unfactorize(gdsc_prot)
# gdsc_prot_count <- gdsc_prot %>% count(Gene_Protein_Change, Drug, Change_Status)
```

```{r prot_wilcoxon_tests, eval=FALSE}
# CCLE
ccle_signif_prot <- WilcoxonTestDF(dataframe = ccle_prot, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change"), g2p_list = unique(as.character(g2p_prot$Drug_Gene_Protein_Change[!is.na(g2p_prot$Drug_Gene_Protein_Change)])), type = "protein_change", outfile = "./data_munging/rds/ccle_signif_protein_changes.rds")
ccle_signif_prot_lin <- WilcoxonTestDF(dataframe = ccle_prot, grouping = c("Gene_Protein_Change", "Drug", "disease", "Drug_Gene_Protein_Change", "Drug_Gene_Protein_Change_Lineage"), g2p_list = unique(as.character(g2p_prot$Drug_Gene_Protein_Change_Lineage[!is.na(g2p_prot$Drug_Gene_Protein_Change_Lineage)])), type = "protein_change_lineage", outfile = "./data_munging/rds/ccle_signif_protein_changes_lineage.rds")

# CTRP
ctrp_signif_prot <- WilcoxonTestDF(dataframe = ctrp_prot, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change"), g2p_list = unique(as.character(g2p_prot$Drug_Gene_Protein_Change[!is.na(g2p_prot$Drug_Gene_Protein_Change)])), type = "protein_change", outfile = "./data_munging/rds/ctrp_signif_protein_changes.rds")
ctrp_signif_prot_lin <- WilcoxonTestDF(dataframe = ctrp_prot, grouping = c("Gene_Protein_Change", "Drug", "disease", "Drug_Gene_Protein_Change", "Drug_Gene_Protein_Change_Lineage"), g2p_list = unique(as.character(g2p_prot$Drug_Gene_Protein_Change_Lineage[!is.na(g2p_prot$Drug_Gene_Protein_Change_Lineage)])), type = "protein_change_lineage", outfile = "./data_munging/rds/ctrp_signif_protein_changes_lineage.rds")

# GDSC
gdsc_signif_prot <- WilcoxonTestDF(dataframe = gdsc_prot, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change"), g2p_list = unique(as.character(g2p_prot$Drug_Gene_Protein_Change[!is.na(g2p_prot$Drug_Gene_Protein_Change)])), type = "protein_change", outfile = "./data_munging/rds/gdsc_signif_protein_changes.rds")
gdsc_signif_prot_lin <- WilcoxonTestDF(dataframe = gdsc_prot, grouping = c("Gene_Protein_Change", "Drug", "disease", "Drug_Gene_Protein_Change", "Drug_Gene_Protein_Change_Lineage"), g2p_list = unique(as.character(g2p_prot$Drug_Gene_Protein_Change_Lineage[!is.na(g2p_prot$Drug_Gene_Protein_Change_Lineage)])), type = "protein_change_lineage", outfile = "./data_munging/rds/gdsc_signif_protein_changes_lineage.rds")
```

## Fusions

```{r fusion_data}
ccle_fus <- filter(fus, Database == "CCLE")
ccle_fus <- unfactorize(ccle_fus)
# ccle_fus_summ <- unique(select(ccle_fus, DepMap_ID, FusionPair, Fusion_Status)) %>% count(FusionPair, Fusion_Status)

ctrp_fus <- filter(fus, Database == "CTRP")
ctrp_fus <- unfactorize(ctrp_fus)
# ctrp_fus_summ <- unique(select(ctrp_fus, DepMap_ID, FusionPair, Fusion_Status)) %>% count(FusionPair, Fusion_Status)

gdsc_fus <- filter(fus, Drug %in% g2p_drugs & Database == "GDSC")
gdsc_fus <- unfactorize(gdsc_fus)
# gdsc_fus_summ <- unique(select(gdsc_fus, DepMap_ID, FusionPair, Fusion_Status)) %>% count(FusionPair, Fusion_Status)
```

```{r fus_wilcoxon_tests, eval=FALSE}
ccle_signif_fus <- WilcoxonTestDF(dataframe = filter(ccle_fus, Drug %in% g2p_drugs), grouping = c("FusionPair", "Drug", "Drug_FusionPair"), g2p_list = unique(as.character(g2p_fus$Drug_FusionPair[!is.na(g2p_fus$Drug_FusionPair)])), type = "fusion", outfile = "./data_munging/rds/ccle_signif_fusions.rds")
ccle_signif_fus_lin <- WilcoxonTestDF(dataframe = filter(ccle_fus, Drug %in% g2p_drugs), grouping = c("FusionPair", "Drug", "disease", "Drug_FusionPair", "Drug_Fusion_Lineage"), g2p_list = unique(as.character(g2p_fus$Drug_Fusion_Lineage[!is.na(g2p_fus$Drug_Fusion_Lineage)])), type = "fusion_lineage", outfile = "./data_munging/rds/ccle_signif_fusions_lineage.rds")

ctrp_signif_fus <- WilcoxonTestDF(dataframe = filter(ctrp_fus, Drug %in% g2p_drugs), grouping = c("FusionPair", "Drug", "Drug_FusionPair"), g2p_list = unique(as.character(g2p_fus$Drug_FusionPair[!is.na(g2p_fus$Drug_FusionPair)])), type = "fusion", outfile = "./data_munging/rds/ctrp_signif_fusions.rds")
ctrp_signif_fus_lin<- WilcoxonTestDF(dataframe = filter(ctrp_fus, Drug %in% g2p_drugs), grouping = c("FusionPair", "Drug", "disease", "Drug_FusionPair", "Drug_Fusion_Lineage"), g2p_list = unique(as.character(g2p_fus$Drug_Fusion_Lineage[!is.na(g2p_fus$Drug_Fusion_Lineage)])), type = "fusion_lineage", outfile = "./data_munging/rds/ctrp_signif_fusions_lineage.rds")

gdsc_signif_fus <- WilcoxonTestDF(dataframe = filter(gdsc_fus, Drug %in% g2p_drugs), grouping = c("FusionPair", "Drug", "Drug_FusionPair"), g2p_list = unique(as.character(g2p_fus$Drug_FusionPair[!is.na(g2p_fus$Drug_FusionPair)])), type = "fusion", outfile = "./data_munging/rds/gdsc_signif_fusions.rds")
gdsc_signif_fus_lin <- WilcoxonTestDF(dataframe = filter(gdsc_fus, Drug %in% g2p_drugs), grouping = c("FusionPair", "Drug", "disease", "Drug_FusionPair", "Drug_Fusion_Lineage"), g2p_list = unique(as.character(g2p_fus$Drug_Fusion_Lineage[!is.na(g2p_fus$Drug_Fusion_Lineage)])), type = "fusion_lineage", outfile = "./data_munging/rds/gdsc_signif_fusions_lineage.rds")
```

```{r}
ccle_fus_means_df <- select(ccle_fus, FusionPair, Drug, Score) %>% group_by(FusionPair, Drug) %>% summarize(Agnostic_Mean_Score = mean(Score))
ccle_fus_means_lin_df <- select(ccle_fus, FusionPair, disease, Drug, Score) %>% drop_na(disease) %>% group_by(FusionPair, disease, Drug) %>% summarize(Mean_Score = mean(Score))
ccle_fus_means <- merge(ccle_fus_means_df, ccle_fus_means_lin_df, by = c("FusionPair", "Drug"), all = TRUE)
```

```{r}
# ggplot(ccle_fus_means_df) +
#   geom_histogram(aes(x = disease, y = Mean_Score)) +
#   facet_wrap(~ Drug)
```


## CRISPR

```{r, eval=FALSE}
# Mutation status
## All genes
# crispr_allgenes <- unfactorize(crispr_allgenes)
# crispr_signif_gene_allgenes <- WilcoxonTestDF(dataframe = crispr_allgenes, grouping = c("Drug", "Gene", "Drug_Gene"), type = "drug_gene", outfile = "./data_munging/rds/crispr_signif_g_allgenes.rds")
# crispr_signif_lineage_allgenes <- WilcoxonTestDF(dataframe = crispr_allgenes, grouping =  c("Drug", "Gene", "disease", "Drug_Gene_Lin"), type = "drug_gene_lineage", outfile = "./data_munging/rds/crispr_signif_gl_allgenes.rds")
## G2P genes
crispr <- unfactorize(crispr)
crispr_signif_gene <- WilcoxonTestDF(dataframe = crispr, grouping = c("Drug", "Gene", "Drug_Gene"), type = "drug_gene", g2p_list = unique(as.character(g2p_mut$Gene[!is.na(g2p_mut$Gene)])), outfile = "./data_munging/rds/crispr_signif_g2p_g.rds")
crispr_signif_lineage <- WilcoxonTestDF(dataframe = crispr, grouping =  c("Drug", "Gene", "disease", "Drug_Gene", "Drug_Gene_Lin"), type = "drug_gene_lineage", g2p_list = unique(as.character(g2p_mut$Gene_Lin[!is.na(g2p_mut$Gene_Lin)])), outfile = "./data_munging/rds/crispr_signif_g2p_gl.rds")

# Protein changes
## CRISPR: All genes
# crispr_prot_allgenes <- unfactorize(crispr_prot_allgenes)
# crispr_signif_prot_allgenes <- WilcoxonTestDF(dataframe = crispr_prot_allgenes, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change"), type = "protein_change", outfile = "./data_munging/rds/crispr_signif_protein_changes_allgenes.rds")
# crispr_signif_prot_lin_allgenes <- WilcoxonTestDF(dataframe = crispr_prot_allgenes, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change", "Drug_Gene_Protein_Change_Lineage", "disease"), type = "protein_change_lineage", outfile = "./data_munging/rds/crispr_signif_protein_changes_lineage_allgenes.rds")
## CRISPR: G2P genes
crispr_prot <- unfactorize(crispr_prot)
crispr_signif_prot <- WilcoxonTestDF(dataframe = crispr_prot, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change"), type = "protein_change", g2p_list = unique(as.character(g2p_prot$Gene_Protein_Change[!is.na(g2p_prot$Gene_Protein_Change)])), outfile = "./data_munging/rds/crispr_signif_protein_changes.rds")
crispr_signif_prot_lin <- WilcoxonTestDF(dataframe = crispr_prot, grouping = c("Gene_Protein_Change", "Drug", "Drug_Gene_Protein_Change", "Drug_Gene_Protein_Change_Lineage", "disease"), type = "protein_change_lineage", g2p_list = unique(as.character(g2p_prot$Gene_Protein_Change_Lineage[!is.na(g2p_prot$Gene_Protein_Change_Lineage)])), outfile = "./data_munging/rds/crispr_signif_protein_changes_lineage.rds")

# Fusions
## CRISPR: All genes
# crispr_fus_allgenes <- unfactorize(crispr_fus_allgenes)
# crispr_signif_fus_allgenes <- WilcoxonTestDF(dataframe = crispr_fus_allgenes, grouping = c("FusionPair", "Drug", "Drug_FusionPair", "Drug_Gene"), type = "fusion", outfile = "./data_munging/rds/crispr_signif_fusions_allgenes.rds")
# crispr_signif_fus_lin_allgenes <- WilcoxonTestDF(dataframe = crispr_fus_allgenes, grouping = c("Drug_Gene", "FusionPair", "Drug", "Drug_FusionPair", "Drug_Fusion_Lineage"), type = "fusion_lineage", outfile = "./data_munging/rds/crispr_signif_fusions_lineage_allgenes.rds")
## CRISPR: G2P genes\
crispr_fus <- unfactorize(crispr_fus)
crispr_signif_fus <- WilcoxonTestDF(dataframe = crispr_fus, grouping = c("FusionPair", "Drug", "Drug_FusionPair"), type = "fusion", g2p_list = unique(as.character(g2p_fus$FusionPair[!is.na(g2p_fus$FusionPair)])), outfile = "./data_munging/rds/crispr_signif_fusions.rds")
crispr_signif_fus_lin <- WilcoxonTestDF(dataframe = crispr_fus, grouping = c("FusionPair", "Drug", "Drug_FusionPair", "disease", "Drug_Fusion_Lineage"), type = "fusion_lineage", g2p_list = unique(as.character(g2p_fus$Fusion_Lineage[!is.na(g2p_fus$Fusion_Lineage)])), outfile = "./data_munging/rds/crispr_signif_fusions_lineage.rds")
```

## Load and munge

```{r crispr_mut}
g2p_mut_summ_crispr <- g2p_mut %>% count(Gene, Direction_Curated) %>% select(-n)
g2p_mut_summ_crispr_n <- g2p_mut_summ_crispr %>% count(Gene)
g2p_mut_summ_crispr <- merge(g2p_mut_summ_crispr, g2p_mut_summ_crispr_n, by = c("Gene"))
g2p_mut_summ_crispr$Direction_Heatmap <- with(g2p_mut_summ_crispr, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
g2p_mut_summ_crispr <- unique(select(g2p_mut_summ_crispr, Gene, Direction_Heatmap))

g2p_mut_summ_lin_crispr <- g2p_mut %>% count(Gene, disease, Direction_Curated) %>% drop_na(disease) %>% select(-n)
g2p_mut_summ_lin_crispr_n <- g2p_mut_summ_lin_crispr %>% count(Gene, disease)
g2p_mut_summ_lin_crispr <- merge(g2p_mut_summ_lin_crispr, g2p_mut_summ_lin_crispr_n, by = c("Gene", "disease"))
g2p_mut_summ_lin_crispr$Direction_Heatmap <- with(g2p_mut_summ_lin_crispr, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
g2p_mut_summ_lin_crispr <- unique(select(g2p_mut_summ_lin_crispr, Gene, disease, Direction_Heatmap))

crispr_signif_g2p_g <- readRDS("./data_munging/rds/crispr_signif_g2p_g.rds")
crispr_signif_g2p_g <- merge(crispr_signif_g2p_g, g2p_mut_summ_crispr, by = "Gene", all.x = TRUE)
crispr_signif_lin <- readRDS("./data_munging/rds/crispr_signif_g2p_gl.rds")
crispr_signif_lin <- merge(crispr_signif_lin, g2p_mut_summ_lin_crispr, by = c("Gene", "disease"), all.x = TRUE)

# crispr_signif_allgenes <- readRDS("./data_munging/rds/crispr_signif_g_allgenes.rds")
# crispr_signif_lin_allgenes <- readRDS("./data_munging/rds/crispr_signif_gl_allgenes.rds")
```

```{r load_mut_wilcoxon_rds}
g2p_mut_summ <- g2p_mut %>% count(Drug, Gene, Direction_Curated) %>% select(-n)
g2p_mut_summ_n <- g2p_mut_summ %>% count(Drug, Gene)
g2p_mut_summ <- merge(g2p_mut_summ, g2p_mut_summ_n, by = c("Drug", "Gene"))
g2p_mut_summ$Direction_Heatmap <- with(g2p_mut_summ, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
g2p_mut_summ <- unique(select(g2p_mut_summ, Drug, Gene, Direction_Heatmap))

g2p_mut_summ_lin <- g2p_mut %>% count(Drug, Gene, disease, Direction_Curated) %>% select(-n)
g2p_mut_summ_lin_n <- g2p_mut_summ_lin %>% count(Drug, Gene, disease)
g2p_mut_summ_lin <- merge(g2p_mut_summ_lin, g2p_mut_summ_lin_n, by = c("Drug", "Gene", "disease"))
g2p_mut_summ_lin$Direction_Heatmap <- with(g2p_mut_summ_lin, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
g2p_mut_summ_lin <- unique(select(g2p_mut_summ_lin, Drug, Gene, disease, Direction_Heatmap))

ccle_signif_g2p_dg <- readRDS("./data_munging/rds/ccle_signif_g2p_dg.rds")
ccle_signif_g2p_dg <- merge(ccle_signif_g2p_dg, g2p_mut_summ, by = c("Drug", "Gene"), all.x = TRUE)
ccle_signif_dgl <- readRDS("./data_munging/rds/ccle_signif_g2p_dgl.rds")
ccle_signif_dgl <- merge(ccle_signif_dgl, g2p_mut_summ_lin, by = c("Drug", "Gene", "disease"), all.x = TRUE)

ctrp_signif_g2p_dg <- readRDS("./data_munging/rds/ctrp_signif_g2p_dg.rds")
ctrp_signif_g2p_dg <- merge(ctrp_signif_g2p_dg, g2p_mut_summ, by = c("Drug", "Gene"), all.x = TRUE)
ctrp_signif_dgl <- readRDS("./data_munging/rds/ctrp_signif_g2p_dgl.rds")
ctrp_signif_dgl <- merge(ctrp_signif_dgl, g2p_mut_summ_lin, by = c("Drug", "Gene", "disease"), all.x = TRUE)

gdsc_signif_g2p_dg <- readRDS("./data_munging/rds/gdsc_signif_g2p_dg.rds")
gdsc_signif_g2p_dg <- merge(gdsc_signif_g2p_dg, g2p_mut_summ, by = c("Drug", "Gene"), all.x = TRUE)
gdsc_signif_dgl <- readRDS("./data_munging/rds/gdsc_signif_g2p_dgl.rds")
gdsc_signif_dgl <- merge(gdsc_signif_dgl, g2p_mut_summ_lin, by = c("Drug", "Gene", "disease"), all.x = TRUE)

# ccle_signif_dgl %>% count(InG2P)
# filter(ccle_signif_dgl, InG2P == "Yes" & p < 0.05) %>% select(Drug, Gene, disease, p.short, Direction_Heatmap)
# ctrp_signif_dgl %>% count(InG2P)
# filter(ctrp_signif_dgl, InG2P == "Yes" & p < 0.05) %>% select(Drug, Gene, disease, p.short, Direction_Heatmap)
# gdsc_signif_dgl %>% count(InG2P)
# filter(gdsc_signif_dgl, InG2P == "Yes" & p < 0.05) %>% select(Drug, Gene, disease, p.short, Direction_Heatmap)
# library(spatstat)
```

```{r load_prot_wilcoxon_rds, eval=TRUE}
crispr_signif_prot <- readRDS("./data_munging/rds/crispr_signif_protein_changes.rds") %>% filter(Change_Status_1_count >= 3)
ccle_signif_prot <- readRDS("./data_munging/rds/ccle_signif_protein_changes.rds") %>% filter(Change_Status_1_count >= 3)
ctrp_signif_prot <- readRDS("./data_munging/rds/ctrp_signif_protein_changes.rds") %>% filter(Change_Status_1_count >= 3)
gdsc_signif_prot <- readRDS("./data_munging/rds/gdsc_signif_protein_changes.rds") %>% filter(Change_Status_1_count >= 3)

gene_prots <- union(union(union(unique(ccle_signif_prot$Gene_Protein_Change), unique(ctrp_signif_prot$Gene_Protein_Change)), unique(gdsc_signif_prot$Gene_Protein_Change)), unique(crispr_signif_prot$Gene_Protein_Change))

crispr_directions <- unique(select(g2p_prot, Gene_Protein_Change, Direction_Curated) %>% drop_na(Direction_Curated))
crispr_directions_n <- crispr_directions %>% count(Gene_Protein_Change)
crispr_directions <- merge(crispr_directions, crispr_directions_n, by = "Gene_Protein_Change", all = TRUE)
crispr_directions$Direction_Curated <- with(crispr_directions, ifelse(n == 2, "both", Direction_Curated))
crispr_directions <- unique(crispr_directions %>% select(-n))

crispr_signif_prot_4plot <- merge(merge(merge(crispr_signif_prot, unique(select(crispr_prot, Drug, Gene_Protein_Change)), by = c("Drug", "Gene_Protein_Change"), all.x = TRUE), expand.grid("Drug" = unique(crispr_signif_prot$Drug), "Gene_Protein_Change" = gene_prots), by = c("Drug", "Gene_Protein_Change"), all = TRUE), crispr_directions, by = "Gene_Protein_Change", all.x = TRUE)
ccle_signif_prot_4plot <- merge(merge(merge(ccle_signif_prot, unique(select(ccle_prot, Drug, Gene_Protein_Change)), by = c("Drug", "Gene_Protein_Change"), all.x = TRUE), expand.grid("Drug" = unique(ccle_signif_prot$Drug), "Gene_Protein_Change" = gene_prots), by = c("Drug", "Gene_Protein_Change"), all = TRUE), unique(select(g2p_prot, Drug, Gene_Protein_Change, Direction_Curated)),  by = c("Drug", "Gene_Protein_Change"), all.x = TRUE)
ctrp_signif_prot_4plot <- merge(merge(merge(ctrp_signif_prot, unique(select(ctrp_prot, Drug, Gene_Protein_Change)), by = c("Drug", "Gene_Protein_Change"), all.x = TRUE), expand.grid("Drug" = unique(ctrp_signif_prot$Drug), "Gene_Protein_Change" = gene_prots), by = c("Drug", "Gene_Protein_Change"), all = TRUE), unique(select(g2p_prot, Drug, Gene_Protein_Change, Direction_Curated)),  by = c("Drug", "Gene_Protein_Change"), all.x = TRUE)
gdsc_signif_prot_4plot <- merge(merge(merge(gdsc_signif_prot, unique(select(gdsc_prot, Drug, Gene_Protein_Change)), by = c("Drug", "Gene_Protein_Change"), all.x = TRUE), expand.grid("Drug" = unique(gdsc_signif_prot$Drug), "Gene_Protein_Change" = gene_prots), by = c("Drug", "Gene_Protein_Change"), all = TRUE), unique(select(g2p_prot, Drug, Gene_Protein_Change, Direction_Curated)),  by = c("Drug", "Gene_Protein_Change"), all.x = TRUE)

saveRDS(crispr_signif_prot_4plot, "./data_munging/rds/crispr_signif_protein_changes_4plot.rds")
saveRDS(ccle_signif_prot_4plot, "./data_munging/rds/ccle_signif_protein_changes_4plot.rds")
saveRDS(ctrp_signif_prot_4plot, "./data_munging/rds/ctrp_signif_protein_changes_4plot.rds")
saveRDS(gdsc_signif_prot_4plot, "./data_munging/rds/gdsc_signif_protein_changes_4plot.rds")
```


```{r prot_munging}
crispr_signif_prot <- readRDS("./data_munging/rds/crispr_signif_protein_changes.rds")
ccle_signif_prot <- readRDS("./data_munging/rds/ccle_signif_protein_changes.rds")
ctrp_signif_prot <- readRDS("./data_munging/rds/ctrp_signif_protein_changes.rds")
gdsc_signif_prot <- readRDS("./data_munging/rds/gdsc_signif_protein_changes.rds")

crispr_signif_prot_4plot <- readRDS("./data_munging/rds/crispr_signif_protein_changes_4plot.rds")
ccle_signif_prot_4plot <- readRDS("./data_munging/rds/ccle_signif_protein_changes_4plot.rds")
ctrp_signif_prot_4plot <- readRDS("./data_munging/rds/ctrp_signif_protein_changes_4plot.rds")
gdsc_signif_prot_4plot <- readRDS("./data_munging/rds/gdsc_signif_protein_changes_4plot.rds")

crispr_directions <- unique(select(g2p_prot, Gene_Protein_Change_Lineage, Direction_Curated) %>% drop_na(Direction_Curated))
crispr_directions_n <- crispr_directions %>% count(Gene_Protein_Change_Lineage)
crispr_directions <- merge(crispr_directions, crispr_directions_n, by = "Gene_Protein_Change_Lineage", all = TRUE)
crispr_directions$Direction_Curated <- with(crispr_directions, ifelse(n == 2, "both", Direction_Curated))
crispr_directions <- unique(crispr_directions %>% select(-n))
crispr_signif_prot_lin <- readRDS("./data_munging/rds/crispr_signif_protein_changes_lineage.rds")
crispr_signif_prot_lin <- merge(crispr_signif_prot_lin, crispr_directions, by = "Gene_Protein_Change_Lineage", all.x = TRUE)

ccle_signif_prot_lin <- readRDS("./data_munging/rds/ccle_signif_protein_changes_lineage.rds")
ccle_signif_prot_lin <- merge(ccle_signif_prot_lin, unique(select(g2p_prot, Drug, Gene_Protein_Change, Drug_Gene_Protein_Change_Lineage, Direction_Curated)), by = c("Drug_Gene_Protein_Change_Lineage", "Gene_Protein_Change", "Drug"), all.x = TRUE)

ctrp_signif_prot_lin <- readRDS("./data_munging/rds/ctrp_signif_protein_changes_lineage.rds")
ctrp_signif_prot_lin <- merge(ctrp_signif_prot_lin, unique(select(g2p_prot, Drug, Gene_Protein_Change, Drug_Gene_Protein_Change_Lineage, Direction_Curated)), by = c("Drug_Gene_Protein_Change_Lineage", "Gene_Protein_Change", "Drug"), all.x = TRUE)

gdsc_signif_prot_lin <- readRDS("./data_munging/rds/gdsc_signif_protein_changes_lineage.rds")
gdsc_signif_prot_lin <- merge(gdsc_signif_prot_lin, unique(select(g2p_prot, Drug, Gene_Protein_Change, Drug_Gene_Protein_Change_Lineage, Direction_Curated)), by = c("Drug_Gene_Protein_Change_Lineage", "Gene_Protein_Change", "Drug"), all.x = TRUE)
```

```{r load_fus_wilcoxon_rds}
# crispr_signif_fus_allgenes <- readRDS("./data_munging/rds/crispr_signif_fusions_allgenes.rds")
# crispr_signif_fus_lin_allgenes <- readRDS("./data_munging/rds/crispr_signif_fusions_lineage_allgenes.rds")
crispr_signif_fus <- readRDS("./data_munging/rds/crispr_signif_fusions.rds")
crispr_signif_fus_lin <- readRDS("./data_munging/rds/crispr_signif_fusions_lineage.rds")

ccle_signif_fus <- readRDS("./data_munging/rds/ccle_signif_fusions.rds")
ctrp_signif_fus <- readRDS("./data_munging/rds/ctrp_signif_fusions.rds")
gdsc_signif_fus <- readRDS("./data_munging/rds/gdsc_signif_fusions.rds")

ccle_signif_fus_lin <- readRDS("./data_munging/rds/ccle_signif_fusions_lineage.rds")
ctrp_signif_fus_lin <- readRDS("./data_munging/rds/ctrp_signif_fusions_lineage.rds")
gdsc_signif_fus_lin <- readRDS("./data_munging/rds/gdsc_signif_fusions_lineage.rds")
```


## Heatmaps

```{r wilcoxon_heatmap_function}
MakeWilcoxonHeatmap <- function(signif_df, feature, row_names, col_title, color, legend_title, legend_breaks, row_title_txt, na_color, radius) {
  if(missing(na_color)) {
    na_color <- "white"
  }
  
  if(!is.na(str_match(string = tolower(feature), pattern = "crispr")) & is.na(str_match(string = tolower(feature), pattern = "prot|fus"))) {
    print("Making CRISPR mutation status grid and annotation dataframes.")
    signif_df <- filter(crispr_signif_g2p_g, Gene %in% unique(g2p_mut$Gene))
    signif_grid <- dcast(signif_df, Gene ~ Drug, value.var = "p_log10", fun.aggregate = mean, fill = 0)
    signif_grid <- signif_grid[match(g2p_gene_order, signif_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    
    signif_grid_annot1 <- signif_grid
    signif_grid_annot1[signif_grid_annot1 <= -log10(0.05) | is.na(signif_grid_annot1)] <- ""
    signif_grid_annot1[signif_grid_annot1 > -log10(0.05)] <- "*"
    
    signif_grid_annot <- dcast(signif_df, Gene ~ Drug, value.var = "Direction_Heatmap", fill = 0)
    signif_grid_annot <- signif_grid_annot[match(g2p_gene_order, signif_grid_annot$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    signif_grid_annot[signif_grid_annot == "sensitivity"] <- "O"
    print("Done.")
  }
  if(!is.na(str_match(string = tolower(feature), pattern = "mut"))) {
    print("Making mutation status grid and annotation dataframes.")
    signif_grid <- dcast(signif_df, Gene ~ Drug, value.var = "p_log10", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    signif_grid <- signif_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(signif_grid))]
    
    signif_grid_annot1 <- signif_grid
    signif_grid_annot1[signif_grid_annot1 <= -log10(0.05) | is.na(signif_grid_annot1)] <- ""
    signif_grid_annot1[signif_grid_annot1 > -log10(0.05)] <- "*"
    
    signif_grid_annot <- dcast(signif_df, Gene ~ Drug, value.var = "Direction_Heatmap", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    signif_grid_annot <- signif_grid_annot[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(signif_grid))]
    signif_grid_annot <- signif_grid_annot[complete.cases(signif_grid_annot), ]
    signif_grid_annot[signif_grid_annot == "sensitivity"] <- "O"
    print("Done.")
  }
  if(!is.na(str_match(string = tolower(feature), pattern = "prot"))) {
    if(is.na(str_match(string = tolower(feature), pattern = "crispr"))) {
      print("Making protein changes grid and annotation dataframes.")
      signif_grid <- dcast(signif_df, Gene_Protein_Change ~ Drug, value.var = "p_log10", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene_Protein_Change)
      signif_grid <- signif_grid[, intersect(g2p_drug_order, colnames(signif_grid))]
      
      signif_grid_annot1 <- signif_grid
      signif_grid_annot1[signif_grid_annot1 <= -log10(0.05) | is.na(signif_grid_annot1)] <- ""
      signif_grid_annot1[signif_grid_annot1 > -log10(0.05)] <- "*"
      
      signif_grid_annot <- dcast(signif_df, Gene_Protein_Change ~ Drug, value.var = "Direction_Curated", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene_Protein_Change)
      signif_grid_annot <- signif_grid_annot[, intersect(g2p_drug_order, colnames(signif_grid))]
      signif_grid_annot[signif_grid_annot == "resistance"] <- "X"
      signif_grid_annot[signif_grid_annot == "sensitivity"] <- "O"
      print("Done.")
    }
    if(!is.na(str_match(string = tolower(feature), pattern = "crispr"))) {
      print("Making CRISPR protein changes grid and annotation dataframes.")
      signif_grid <- dcast(signif_df, Gene_Protein_Change ~ Drug, value.var = "p_log10", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene_Protein_Change)
      
      signif_grid_annot1 <- signif_grid
      signif_grid_annot1[signif_grid_annot1 <= -log10(0.05) | is.na(signif_grid_annot1)] <- ""
      signif_grid_annot1[signif_grid_annot1 > -log10(0.05)] <- "*"
      
      signif_grid_annot <- dcast(signif_df, Gene_Protein_Change ~ Drug, value.var = "Direction_Curated", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene_Protein_Change)
      signif_grid_annot[signif_grid_annot == "resistance"] <- "X"
      signif_grid_annot[signif_grid_annot == "sensitivity"] <- "O"
      print("Done.")
    }
  }
  if(!is.na(str_match(string = tolower(feature), pattern = "fus"))) {
    if(is.na(str_match(string = tolower(feature), pattern = "crispr"))) {
      print("Making fusions grid and annotation dataframes.")
      signif_grid <- dcast(signif_df, FusionPair ~ Drug, value.var = "p_log10", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-FusionPair)
      signif_grid <- signif_grid[, intersect(g2p_drug_order, colnames(signif_grid))]
      
      signif_grid_annot1 <- signif_grid
      signif_grid_annot1[signif_grid_annot1 <= -log10(0.05) | is.na(signif_grid_annot1)] <- ""
      signif_grid_annot1[signif_grid_annot1 > -log10(0.05)] <- "*"
      
      signif_grid_annot <- dcast(signif_df, FusionPair ~ Drug, value.var = "InG2P", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-FusionPair)
      signif_grid_annot <- signif_grid_annot[, intersect(g2p_drug_order, colnames(signif_grid))]
      signif_grid_annot <- signif_grid_annot[complete.cases(signif_grid_annot), ]
      signif_grid_annot[signif_grid_annot == "No"] <- ""
      signif_grid_annot[signif_grid_annot == "Yes"] <- "O"
      print("Done.")
    }
    if(!is.na(str_match(string = tolower(feature), pattern = "crispr"))) {
      print("Making CRISPR fusions grid and annotation dataframes.")
      signif_grid <- dcast(signif_df, FusionPair ~ Drug, value.var = "p_log10", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-FusionPair)
      
      signif_grid_annot1 <- signif_grid
      signif_grid_annot1[signif_grid_annot1 <= -log10(0.05) | is.na(signif_grid_annot1)] <- ""
      signif_grid_annot1[signif_grid_annot1 > -log10(0.05)] <- "*"
      
      signif_grid_annot <- dcast(signif_df, FusionPair ~ Drug, value.var = "InG2P", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-FusionPair)
      signif_grid_annot[signif_grid_annot == "No"] <- ""
      signif_grid_annot[signif_grid_annot == "Yes"] <- "O"
      print("Done.")
    }
  }
  
  signif_grid <- as.matrix(signif_grid)
  col_fun <- colorRamp2(c(legend_breaks[1], legend_breaks[length(legend_breaks)]), c("gray97", color))
  # Legend properties list
  ht_legend_list <- list(title = legend_title, title_position = "topleft", legend_direction = "horizontal", legend_width = unit(1.5, "in"), border = "gray70", at = legend_breaks, labels = legend_breaks)
  
  print("Making heatmap object.")
  ht <- Heatmap(signif_grid,
                col = col_fun,
                na_col = na_color,
                rect_gp = gpar(col = "gray70"),
                heatmap_legend_param = ht_legend_list,
                cluster_rows = FALSE, 
                cluster_columns = FALSE, 
                show_row_names = as.logical(row_names),
                row_names_side = "left",
                row_names_gp = gpar(fontsize = 10),
                column_names_side = "bottom",
                column_names_gp = gpar(fontsize = 10),
                show_column_names = FALSE,
                bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(signif_grid),
                                   rot = 45,
                                   gp = gpar(fontsize = 11),
                                   location = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.85, "in")),
                row_title = row_title_txt,
                row_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title = col_title, 
                column_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title_side = "bottom",
                cell_fun = function(j, i, x, y, width, height, fill) {
                  grid.text(signif_grid_annot1[i, j], x = x + width*0.25, y = y + height*0.065, gp = gpar(fontsize = 17))
                  
                  if(signif_grid_annot[i, j] == "O") {
                    grid.circle(x = x - width*0.20, y = y - height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "white", col = "black"))
                  }
                  if(signif_grid_annot[i, j] == "X") {
                    grid.circle(x = x - width*0.20, y = y + height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "red", col = "black"))
                  }
                  if(signif_grid_annot[i, j] == "resistance") {
                    grid.circle(x = x - width*0.20, y = y + height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "red", col = "black"))
                  }
                  if(signif_grid_annot[i, j] == "both") {
                    grid.circle(x = x - width*0.20, y = y + height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "red", col = "black"))
                    grid.circle(x = x - width*0.20, y = y - height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "white", col = "black"))
                  }
                }
                )
                
  print("Done.")
  return(ht)
}
```

### Pancan

```{r mut_heatmaps, eval=FALSE, fig.height=10, fig.width=3}
ht_crispr <- MakeWilcoxonHeatmap(signif_df = filter(crispr_signif_g2p_g, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "crispr", legend_title = "-log10(p-value)", legend_breaks = seq(0, 45, by = 9), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Genes", radius = 0.05)
png(filename = "./plots/manuscript/crispr_mut_heatmap.png", width = 3, height = 10, units = "in", res = 500)
draw(ht_crispr, heatmap_legend_side = "top")
dev.off()

ht_ccle <- MakeWilcoxonHeatmap(signif_df = filter(ccle_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "-log10(p-value)", legend_breaks = seq(0, 12, by = 3), row_names = TRUE, color = "darkgreen", col_title = "Drugs", row_title_txt = "Genes", radius = 0.04)
png(filename = "./plots/manuscript/ccle_mut_heatmap.png", width = 3, height = 10, units = "in", res = 500)
draw(ht_ccle, heatmap_legend_side = "top")
dev.off()

ht_ctrp <- MakeWilcoxonHeatmap(signif_df = filter(ctrp_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "-log10(p-value)", legend_breaks = seq(0, 18, by = 3), row_names = TRUE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Genes", radius = 0.0075)
png(filename = "./plots/manuscript/ctrp_mut_heatmap.png", width = 9.5, height = 10, units = "in", res = 500)
draw(ht_ctrp, heatmap_legend_side = "top")
dev.off()

ht_gdsc <- MakeWilcoxonHeatmap(signif_df = filter(gdsc_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene)), feature = "mutation", legend_title = "-log10(p-value)", legend_breaks = seq(0, 5, by = 1), row_names = TRUE, color = "turquoise4", col_title = "Drugs", row_title_txt = "Genes", radius = 0.01)
png(filename = "./plots/manuscript/gdsc_mut_heatmap.png", width = 5, height = 10, units = "in", res = 500)
draw(ht_gdsc, heatmap_legend_side = "top")
dev.off()

ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = filter(ccle_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "CCLE -log10(p-value)          ", legend_breaks = seq(0, 12, by = 3), row_names = FALSE, color = "darkgreen", col_title = "", row_title_txt = "Genes", radius = 0.023)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = filter(ctrp_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "CTRP -log10(p-value)          ", legend_breaks = seq(0, 18, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Genes", radius = 0.007)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = filter(gdsc_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "GDSC -log10(p-value)          ", legend_breaks = seq(0, 5, by = 1), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Genes", radius = 0.011)
ht_crispr2 <- MakeWilcoxonHeatmap(signif_df = filter(crispr_signif_g2p_g, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "crispr", legend_title = "CRISPR -log10(p-value)", legend_breaks = seq(0, 45, by = 9), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Genes", radius = 0.15)

png(filename = "./plots/manuscript/all_mut_heatmap.png", width = 14, height = 7.5, units = "in", res = 500)
draw(ht_crispr2 + ht_ccle2 + ht_ctrp2 + ht_gdsc2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```

```{r prot_heatmaps, eval=FALSE, fig.height=10, fig.width=3}
ht_crispr <- MakeWilcoxonHeatmap(signif_df = crispr_signif_prot_4plot, feature = "protein changes CRISPR", legend_title = "-log10(p-value)", legend_breaks = seq(0, 25, by = 5), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Gene:Protein Change", radius = 0.03)
png(filename = "./plots/manuscript/crispr_prot_heatmap.png", width = 3, height = 5.5, units = "in", res = 500)
draw(ht_crispr, heatmap_legend_side = "top")
dev.off()

ht_ccle <- MakeWilcoxonHeatmap(signif_df = ccle_signif_prot_4plot, feature = "protein changes", legend_title = "-log10(p-value)", legend_breaks = seq(0, 15, by = 3), row_names = TRUE, color = "darkgreen", col_title = "Drugs", row_title_txt = "Gene:Protein Change", radius = 0.03)
png(filename = "./plots/manuscript/ccle_prot_heatmap.png", width = 3, height = 5.5, units = "in", res = 500)
draw(ht_ccle, heatmap_legend_side = "top")
dev.off()

ht_ctrp <- MakeWilcoxonHeatmap(signif_df = ctrp_signif_prot_4plot, feature = "protein changes", legend_title = "-log10(p-value)", legend_breaks = seq(0, 15, by = 3), row_names = TRUE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", radius = 0.01)
png(filename = "./plots/manuscript/ctrp_prot_heatmap.png", width = 9.5, height = 5.5, units = "in", res = 500)
draw(ht_ctrp, heatmap_legend_side = "top")
dev.off()

ht_gdsc <- MakeWilcoxonHeatmap(signif_df = gdsc_signif_prot_4plot, feature = "protein changes", legend_title = "-log10(p-value)", legend_breaks = seq(0, 8, by = 2), row_names = TRUE, color = "turquoise4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", radius = 0.01)
png(filename = "./plots/manuscript/gdsc_prot_heatmap.png", width = 5, height = 5.5, units = "in", res = 500)
draw(ht_gdsc, heatmap_legend_side = "top")
dev.off()

ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = ccle_signif_prot_4plot, feature = "protein changes", legend_title = "CCLE -log10(p-value)          ", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "darkgreen", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.021)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = ctrp_signif_prot_4plot, feature = "protein changes", legend_title = "CTRP -log10(p-value)          ", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.0125)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = gdsc_signif_prot_4plot, feature = "protein changes", legend_title = "GDSC -log10(p-value)          ", legend_breaks = seq(0, 8, by = 2), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.0125)
ht_crispr2 <- MakeWilcoxonHeatmap(signif_df = crispr_signif_prot_4plot, feature = "protein changes CRISPR", legend_title = "CRISPR -log10(p-value)", legend_breaks = seq(0, 25, by = 5), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.135)

png(filename = "./plots/manuscript/all_prot_heatmap.png", width = 14, height = 5, units = "in", res = 500)
draw(ht_crispr2 + ht_ccle2 + ht_ctrp2 + ht_gdsc2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```

```{r fus_heatmaps, eval=FALSE}
ht_crispr <- MakeWilcoxonHeatmap(signif_df = filter(crispr_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR")), feature = "fusion crispr", legend_title = "-log10(p-value)",  legend_breaks = seq(0, 2, by = 0.5), row_names = TRUE, color = "darkorchid4", col_title = "Drugs", row_title_txt = "Fusion Pairs", radius = 0.5)
png(filename = "./plots/manuscript/crispr_fus_heatmap.png", width = 3, height = 3, units = "in", res = 500)
draw(ht_crispr, heatmap_legend_side = "top")
dev.off()

ht_ccle <- MakeWilcoxonHeatmap(signif_df = filter(ccle_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR") & Drug %in% g2p_drugs), feature = "fusion", legend_title = "-log10(p-value)",  legend_breaks = seq(0, 4, by = 1), row_names = TRUE, color = "darkgreen", col_title = "Drugs", row_title_txt = "Fusion Pairs", radius = 0.01)
png(filename = "./plots/manuscript/ccle_fus_heatmap.png", width = 5, height = 3, units = "in", res = 500)
draw(ht_ccle, heatmap_legend_side = "top")
dev.off()

ht_ctrp <- MakeWilcoxonHeatmap(signif_df = filter(ctrp_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR") & Drug %in% g2p_drugs), feature = "fusion", legend_title = "-log10(p-value)", legend_breaks = seq(0, 10, by = 2), row_names = TRUE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Fusion Pairs", radius = 0.01)
png(filename = "./plots/manuscript/ctrp_fus_heatmap.png", width = 13, height = 3, units = "in", res = 500)
draw(ht_ctrp, heatmap_legend_side = "top")
dev.off()

ht_gdsc <- MakeWilcoxonHeatmap(signif_df = filter(gdsc_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR") & Drug %in% g2p_drugs), feature = "fusion", legend_title = "-log10(p-value)", legend_breaks = seq(0, 5, by = 1), row_names = TRUE, color = "turquoise4", col_title = "Drugs", row_title_txt = "Fusion Pairs", radius = 0.01)
png(filename = "./plots/manuscript/gdsc_fus_heatmap.png", width = 9, height = 3, units = "in", res = 500)
draw(ht_gdsc, heatmap_legend_side = "top")
dev.off()

ht_crispr2 <- MakeWilcoxonHeatmap(signif_df = filter(crispr_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR")), feature = "fusion crispr", legend_title = "CRISPR -log10(p-value)          ",  legend_breaks = seq(0, 2, by = 0.5), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Fusion Pairs", radius = 0.15)
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = filter(ccle_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR") & Drug %in% g2p_drugs), feature = "fusion", legend_title = "CCLE -log10(p-value)          ", legend_breaks = seq(0, 4, by = 1), row_names = FALSE, color = "darkgreen", col_title = "", row_title_txt = "Fusion Pairs", radius = 0.15)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = filter(ctrp_signif_fus, FusionPair %in% c("BCR-ABL1", "ABL1-BCR") & Drug %in% g2p_drugs), feature = "fusion", legend_title = "CTRP -log10(p-value)          ", legend_breaks = seq(0, 10, by = 2), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Fusion Pairs", radius = 0.08)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = filter(gdsc_signif_fus,FusionPair %in% c("BCR-ABL1", "ABL1-BCR") & Drug %in% g2p_drugs), feature = "fusion", legend_title = "GDSC -log10(p-value)", legend_breaks = seq(0, 5, by = 1), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Fusion Pairs", radius = 0.08)

png(filename = "./plots/manuscript/all_fus_heatmap.png", width = 15, height = 2.4, units = "in", res = 500)
draw(ht_crispr2 + ht_ccle2 + ht_ctrp2 + ht_gdsc2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```

# Correlations: GE and CN

--------------------------------------------------------------------------------

```{r}
MakeSpearmanCorrDF <- function(dataset, df, metric, lineage, g2p_list) {
  df$Gene <- factor(df$Gene, ordered = FALSE)
  df <- unfactorize(df)

  if(metric == "GE") {
    if(lineage) {
      df_count <- df %>% drop_na(TPM) %>% count(Drug, Gene, disease, Drug_Gene_Lin)
      df_count_filt <- filter(df_count, n >= 3)
      df_filt <- filter(df, Drug_Gene_Lin %in% df_count_filt$Drug_Gene_Lin)
      res <- df_filt %>% group_by(Drug, Gene, disease, Drug_Gene_Lin) %>%
        summarize(GE_r = cor.test(y = Score, x = TPM, method = "pearson", use = "complete.obs", exact = FALSE)$estimate,
                  GE_p = cor.test(y = Score, x = TPM, method = "pearson", use = "complete.obs", exact = FALSE)$p.value, 
                  GE_p_log10 = -log10(GE_p))
      res$Gene_Lin <- with(res, paste0(Gene, "_", disease))
      if(dataset != "CRISPR") { res$InG2P <- ifelse(res$Drug_Gene_Lin %in% g2p_list, "Yes", "No") }
      if(dataset == "CRISPR") { res$InG2P <- ifelse(res$Gene_Lin %in% g2p_list, "Yes", "No") }
      res <- merge(res, df_count, by = c("Drug", "Gene", "disease", "Drug_Gene_Lin"), all = TRUE)
    }
    if(!lineage) {
      df_count <- df %>% drop_na(TPM) %>% count(Drug, Gene, Drug_Gene)
      res <- df %>% group_by(Drug, Gene, Drug_Gene) %>% drop_na(TPM) %>%
        summarize(GE_r = cor.test(y = Score, x = TPM, method = "pearson", use = "complete.obs", exact = FALSE)$estimate,
                  GE_p = cor.test(y = Score, x = TPM, method = "pearson", use = "complete.obs", exact = FALSE)$p.value, 
                  GE_p_log10 = -log10(GE_p))
      if(dataset != "CRISPR") { res$InG2P <- ifelse(res$Drug_Gene %in% g2p_list, "Yes", "No") }
      if(dataset == "CRISPR") { res$InG2P <- ifelse(res$Gene %in% g2p_list, "Yes", "No") }
      res <- merge(res, df_count, by = c("Drug", "Gene", "Drug_Gene"), all = TRUE)
    }
  }
  if(metric == "CN") {
    if(lineage) {
      df_count <- df %>% drop_na(CN) %>% count(Drug, Gene, disease, Drug_Gene_Lin)
      df_count_filt <- filter(df_count, n >= 3)
      df_filt <- filter(df, Drug_Gene_Lin %in% df_count_filt$Drug_Gene_Lin)
      res <- df_filt %>% group_by(Drug, Gene, disease, Drug_Gene_Lin) %>%
        summarize(CN_r = cor.test(y = Score, x = CN, method = "pearson", use = "complete.obs", exact = FALSE)$estimate,
                  CN_p = cor.test(y = Score, x = CN, method = "pearson", use = "complete.obs", exact = FALSE)$p.value,
                  CN_p_log10 = -log10(CN_p))
      res$Gene_Lin <- with(res, paste0(Gene, "_", disease))
      if(dataset != "CRISPR") { res$InG2P <- ifelse(res$Drug_Gene_Lin %in% g2p_list, "Yes", "No") }
      if(dataset == "CRISPR") { res$InG2P <- ifelse(res$Gene_Lin %in% g2p_list, "Yes", "No") }
      res <- merge(res, df_count, by = c("Drug", "Gene", "disease", "Drug_Gene_Lin"), all = TRUE)
    }
    if(!lineage) {
      df_count <- df %>% drop_na(CN) %>% count(Drug, Gene, Drug_Gene)
      res <- df %>% group_by(Drug, Gene, Drug_Gene) %>% drop_na(CN) %>%
        summarize(CN_r = cor.test(y = Score, x = CN, method = "pearson", use = "complete.obs", exact = FALSE)$estimate,
                  CN_p = cor.test(y = Score, x = CN, method = "pearson", use = "complete.obs", exact = FALSE)$p.value, 
                  CN_p_log10 = -log10(CN_p))
      if(dataset != "CRISPR") { res$InG2P <- ifelse(res$Drug_Gene %in% g2p_list, "Yes", "No") }
      if(dataset == "CRISPR") { res$InG2P <- ifelse(res$Gene %in% g2p_list, "Yes", "No") }
      res <- merge(res, df_count, by = c("Drug", "Gene", "Drug_Gene"), all = TRUE)
    }
  }
  res$Metric <- metric
  res$Dataset <- dataset
  return(res)
}
```


```{r spear_calc, warning=FALSE, eval=FALSE}
# Agnostic
## CN
crispr_cn_res <- MakeSpearmanCorrDF(dataset = "CRISPR", df = crispr, metric = "CN", lineage = FALSE, g2p_list = unique(as.character(g2p_amp$Gene[!is.na(g2p_amp$Gene)])))
ccle_cn_res <- MakeSpearmanCorrDF(dataset = "CCLE", df = filter(ccle, Drug %in% g2p_drugs), metric = "CN", lineage = FALSE, g2p_list = unique(as.character(g2p_amp$Drug_Gene[!is.na(g2p_amp$Drug_Gene)])))
ctrp_cn_res <- MakeSpearmanCorrDF(dataset = "CTRP", df = filter(ctrp, Drug %in% g2p_drugs), metric = "CN", lineage = FALSE, g2p_list = unique(as.character(g2p_amp$Drug_Gene[!is.na(g2p_amp$Drug_Gene)])))
gdsc_cn_res <- MakeSpearmanCorrDF(dataset = "GDSC", df = filter(gdsc, Drug %in% g2p_drugs), metric = "CN", lineage = FALSE, g2p_list = unique(as.character(g2p_amp$Drug_Gene[!is.na(g2p_amp$Drug_Gene)])))
cn_cor <- rbind(crispr_cn_res, ccle_cn_res, ctrp_cn_res, gdsc_cn_res)
saveRDS(cn_cor, "./data_munging/rds/cn_cor.rds", compress = "xz")
## GE
crispr_ge_res <- MakeSpearmanCorrDF(dataset = "CRISPR", df = crispr, metric = "GE", lineage = FALSE, g2p_list = unique(as.character(g2p_expr$Gene[!is.na(g2p_expr$Gene)])))
ccle_ge_res <- MakeSpearmanCorrDF(dataset = "CCLE", df = filter(ccle, Drug %in% g2p_drugs), metric = "GE", lineage = FALSE, g2p_list = unique(as.character(g2p_expr$Drug_Gene[!is.na(g2p_expr$Drug_Gene)])))
ctrp_ge_res <- MakeSpearmanCorrDF(dataset = "CTRP", df = filter(ctrp, Drug %in% g2p_drugs), metric = "GE", lineage = FALSE, g2p_list = unique(as.character(g2p_expr$Drug_Gene[!is.na(g2p_expr$Drug_Gene)])))
gdsc_ge_res <- MakeSpearmanCorrDF(dataset = "GDSC", df = filter(gdsc, Drug %in% g2p_drugs), metric = "GE", lineage = FALSE, g2p_list = unique(as.character(g2p_expr$Drug_Gene[!is.na(g2p_expr$Drug_Gene)])))
ge_cor <- rbind(crispr_ge_res, ccle_ge_res, ctrp_ge_res, gdsc_ge_res)
saveRDS(ge_cor, "./data_munging/rds/ge_cor.rds", compress = "xz")

# Lineage
## CN
crispr_cn_res_lin <- MakeSpearmanCorrDF(dataset = "CRISPR", df = crispr, metric = "CN", lineage = TRUE, g2p_list = unique(as.character(g2p_amp$Gene_Lin[!is.na(g2p_amp$Gene_Lin)])))
ccle_cn_res_lin <- MakeSpearmanCorrDF(dataset = "CCLE", df = filter(ccle, Drug %in% g2p_drugs), metric = "CN", lineage = TRUE, g2p_list = unique(as.character(g2p_amp$Drug_Gene_Lin[!is.na(g2p_amp$Drug_Gene_Lin)])))
ctrp_cn_res_lin <- MakeSpearmanCorrDF(dataset = "CTRP", df = filter(ctrp, Drug %in% g2p_drugs), metric = "CN", lineage = TRUE, g2p_list = unique(as.character(g2p_amp$Drug_Gene_Lin[!is.na(g2p_amp$Drug_Gene_Lin)])))
gdsc_cn_res_lin <- MakeSpearmanCorrDF(dataset = "GDSC", df = filter(gdsc, Drug %in% g2p_drugs), metric = "CN", lineage = TRUE, g2p_list = unique(as.character(g2p_amp$Drug_Gene_Lin[!is.na(g2p_amp$Drug_Gene_Lin)])))
cn_cor_lin <- rbind(crispr_cn_res_lin, ccle_cn_res_lin, ctrp_cn_res_lin, gdsc_cn_res_lin) %>% filter(CN_p_log10 != Inf)
saveRDS(cn_cor_lin, "./data_munging/rds/cn_cor_lineage.rds")
## GE
crispr_ge_res <- MakeSpearmanCorrDF(dataset = "CRISPR", df = crispr, metric = "GE", lineage = TRUE, g2p_list = unique(as.character(g2p_expr$Gene_Lin[!is.na(g2p_expr$Gene_Lin)])))
ccle_ge_res_lin <- MakeSpearmanCorrDF(dataset = "CCLE", df = filter(ccle, Drug %in% g2p_drugs), metric = "GE", lineage = TRUE, g2p_list = unique(as.character(g2p_expr$Drug_Gene_Lin[!is.na(g2p_expr$Drug_Gene_Lin)])))
ctrp_ge_res_lin <- MakeSpearmanCorrDF(dataset = "CTRP", df = filter(ctrp, Drug %in% g2p_drugs), metric = "GE", lineage = TRUE, g2p_list = unique(as.character(g2p_expr$Drug_Gene_Lin[!is.na(g2p_expr$Drug_Gene_Lin)])))
gdsc_ge_res_lin <- MakeSpearmanCorrDF(dataset = "GDSC", df = filter(gdsc, Drug %in% g2p_drugs), metric = "GE", lineage = TRUE, g2p_list = unique(as.character(g2p_expr$Drug_Gene_Lin[!is.na(g2p_expr$Drug_Gene_Lin)])))
ge_cor_lin <- rbind(crispr_ge_res, ccle_ge_res_lin, ctrp_ge_res_lin, gdsc_ge_res_lin) %>% filter(GE_p_log10 != Inf)
saveRDS(ge_cor_lin, "./data_munging/rds/ge_cor_lineage.rds")
```

```{r load_spear}
# CN
g2p_amp_crispr_4merge <- unique(select(g2p_amp, Gene, Direction_Curated))
crispr_amp_summ <- g2p_amp_crispr_4merge %>% count(Gene)
crispr_amp_summ <- merge(crispr_amp_summ, g2p_amp_crispr_4merge, by = "Gene")
crispr_amp_summ$Drug_Gene <- paste0("CRISPR_", crispr_amp_summ$Gene)
crispr_amp_summ$Direction_Heatmap <- with(crispr_amp_summ, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
crispr_amp_summ <- unique(select(crispr_amp_summ, Drug_Gene, Direction_Heatmap))

g2p_amp_4merge <- select(g2p_amp, Drug_Gene, Direction_Curated)
amp_summ <- g2p_amp_4merge %>% count(Drug_Gene)
amp_summ <- merge(amp_summ, g2p_amp_4merge, by = "Drug_Gene")
amp_summ$Direction_Heatmap <- with(amp_summ, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
amp_summ <- unique(select(amp_summ, Drug_Gene, Direction_Heatmap))

amp_summ <- rbind(amp_summ, crispr_amp_summ)
cn_cor <- readRDS("./data_munging/rds/cn_cor.rds")
cn_cor <- merge(cn_cor, amp_summ, by = "Drug_Gene", all.x = TRUE)

# GE
g2p_expr_crispr_4merge <- unique(select(g2p_expr, Gene, Direction_Curated))
crispr_expr_summ <- g2p_expr_crispr_4merge %>% count(Gene)
crispr_expr_summ <- merge(crispr_expr_summ, g2p_expr_crispr_4merge, by = "Gene")
crispr_expr_summ$Drug_Gene <- paste0("CRISPR_", crispr_expr_summ$Gene)
crispr_expr_summ$Direction_Heatmap <- with(crispr_expr_summ, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
crispr_expr_summ <- unique(select(crispr_expr_summ, Drug_Gene, Direction_Heatmap))

g2p_expr_4merge <- select(g2p_expr, Drug_Gene, Direction_Curated)
expr_summ <- g2p_expr_4merge %>% count(Drug_Gene)
expr_summ <- merge(expr_summ, g2p_expr_4merge, by = "Drug_Gene")
expr_summ$Direction_Heatmap <- with(expr_summ, ifelse(n == 2, "both", ifelse(n == 1 & Direction_Curated == "resistance", "resistance", "sensitivity")))
expr_summ <- unique(select(expr_summ, Drug_Gene, Direction_Heatmap))

expr_summ <- rbind(expr_summ, crispr_expr_summ)
ge_cor <- readRDS("./data_munging/rds/ge_cor.rds")
ge_cor <- merge(ge_cor, expr_summ, by = "Drug_Gene", all.x = TRUE)
```

```{r}
cn_cor_lin <- readRDS("./data_munging/rds/cn_cor_lineage.rds")
cn_cor_lin_g2p <- filter(cn_cor_lin, InG2P == "Yes")
ge_cor_lin <- readRDS("./data_munging/rds/ge_cor_lineage.rds")
ge_cor_lin_g2p <- filter(ge_cor_lin, InG2P == "Yes")
```

## Plots

```{r crispr_spear_eda, warning=TRUE}
crispr_spear_cn <- filter(cn_cor, Dataset == "CRISPR" & Gene %in% g2p_dg_genes)
crispr_spear_cn$Gene <- with(crispr_spear_cn, reorder(Gene, CN_r, function(x) x))
crispr_spear_cn_plot <- ggplot(data = crispr_spear_cn) +
  geom_point(aes(x = Gene, y = CN_r, fill = CN_p_log10), pch = 21, size = 5) +
  theme(legend.position = "bottom") +
  scale_fill_gradientn(colours = c("white", "green4"),
                       breaks = seq(0, 14, by = 2),
                       labels = seq(0, 14, by = 2),
                       limits = c(0, 14)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10), legend.key.width = unit(0.5, "in")) +
  labs(title = "Copy Number",
       fill = expression(-log[10](p)),
       x = "Gene",
       y = expression("Spearman Correlation Coefficient"~(r[s])))

crispr_spear_ge <- filter(ge_cor, Dataset == "CRISPR" & Gene %in% g2p_dg_genes)
crispr_spear_ge$Gene <- with(crispr_spear_ge, reorder(Gene, GE_r, function(x) x))
crispr_spear_ge_plot <- ggplot(data = crispr_spear_ge) +
  geom_point(aes(x = Gene, y = GE_r, fill = GE_p_log10), pch = 21, size = 5) +
  theme(legend.position = "bottom") +
  scale_fill_gradientn(colours = c("white", "deepskyblue4"),
                       breaks = seq(0, 14, by = 2),
                       labels = seq(0, 14, by = 2),
                       limits = c(0, 14)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10), legend.key.width = unit(0.5 , "in")) +
  labs(title = "Gene Expression",
       fill = expression(-log[10](p)),
       x = "Gene",
       y = expression("Spearman Correlation Coefficient"~(r[s])))

crispr_spearman_corr_plot <- plot_grid(crispr_spear_cn_plot, crispr_spear_ge_plot, align = "h")
crispr_spearman_corr_plot

ggsave("./plots/manuscript/crispr_spearman_corr_plot.png", crispr_spearman_corr_plot, device = "png", dpi = 450, width = 20, height = 10, units = "in")
```

```{r corr_heatmap_function}
MakeCorrHeatmap <- function(cor_res, row_names, heatmap_legend, col_title, color_range, legend_title, metric, radius) {
  if(toupper(metric) == "CN" | toupper(metric) == "COPY NUMBER") {
    if(col_title == "CRISPR") {
      signif_grid <- dcast(cor_res, Gene ~ Drug, value.var = "CN_p", fun.aggregate = mean, fill = 0)
      signif_grid <- signif_grid[match(g2p_gene_order, signif_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      signif_grid[signif_grid >= 0.05] <- ""
      signif_grid[signif_grid != ""] <- "*"
      
      corr_grid <- dcast(cor_res, Gene ~ Drug, value.var = "CN_r", fun.aggregate = mean, fill = 0)
      corr_grid <- corr_grid[match(g2p_gene_order, corr_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      
      annot_grid <- dcast(cor_res, Gene ~ Drug, value.var = "Direction_Heatmap", fill = 0)
      annot_grid <- annot_grid[match(g2p_gene_order, annot_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    }
    if(col_title != "CRISPR") {
      signif_grid <- dcast(cor_res, Gene ~ Drug, value.var = "CN_p", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      signif_grid <- signif_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(signif_grid))]
      signif_grid <- signif_grid[complete.cases(signif_grid), ]
      signif_grid[signif_grid >= 0.05] <- ""
      signif_grid[signif_grid != ""] <- "*"
      
      corr_grid <- dcast(cor_res, Gene ~ Drug, value.var = "CN_r", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      corr_grid <- corr_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(corr_grid))]
      corr_grid <- corr_grid[complete.cases(corr_grid), ]
      
      annot_grid <- dcast(cor_res, Gene ~ Drug, value.var = "Direction_Heatmap", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      annot_grid <- annot_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(signif_grid))]
      annot_grid <- annot_grid[complete.cases(annot_grid), ]
    }
  }
  
  if(toupper(metric) == "GE" | toupper(metric) == "GENE EXPRESSION") {
    if(col_title == "CRISPR") {
      signif_grid <- dcast(cor_res, Gene ~ Drug, value.var = "GE_p", fun.aggregate = mean, fill = 0)
      signif_grid <- signif_grid[match(g2p_gene_order, signif_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      signif_grid[signif_grid >= 0.05] <- ""
      signif_grid[signif_grid != ""] <- "*"
      
      corr_grid <- dcast(cor_res, Gene ~ Drug, value.var = "GE_r", fun.aggregate = mean, fill = 0)
      corr_grid <- corr_grid[match(g2p_gene_order, corr_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      
      annot_grid <- dcast(cor_res, Gene ~ Drug, value.var = "Direction_Heatmap", fill = 0)
      annot_grid <- annot_grid[match(g2p_gene_order, annot_grid$Gene),] %>% drop_na(Gene) %>% `rownames<-`(.[,1]) %>% select(-Gene)
    }
    if(col_title != "CRISPR") {
      signif_grid <- dcast(cor_res, Gene ~ Drug, value.var = "GE_p", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      signif_grid <- signif_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(signif_grid))]
      signif_grid[signif_grid >= 0.05] <- ""
      signif_grid[signif_grid != ""] <- "*"
      
      corr_grid <- dcast(cor_res, Gene ~ Drug, value.var = "GE_r", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      corr_grid <- corr_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(corr_grid))]
      corr_grid <- corr_grid[complete.cases(corr_grid), ]
      
      annot_grid <- dcast(cor_res, Gene ~ Drug, value.var = "Direction_Heatmap", fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
      annot_grid <- annot_grid[intersect(g2p_gene_order, rownames(signif_grid)), intersect(g2p_drug_order, colnames(signif_grid))]
      annot_grid <- annot_grid[complete.cases(annot_grid), ]
    }
  }
  
  corr_grid <- as.matrix(corr_grid)
  
  col_fun <- colorRamp2(color_range, c("forestgreen", "white", "blue3"))
  
  # Legend properties list
  if(metric == "CN") { legend_sep <- 0.1 }
  if(metric == "GE") { legend_sep <- 0.2 }
  ht_legend_list <- list(title_position = "topleft",
                         legend_direction = "horizontal",
                         legend_width = unit(2, "in"),
                         title = legend_title,
                         border = "gray70",
                         at = seq(color_range[1], color_range[3], by = legend_sep),
                         labels = seq(color_range[1], color_range[3], by = legend_sep))
  
  ht <- Heatmap(corr_grid,
                col = col_fun,
                na_col = "gray97",
                rect_gp = gpar(col = "gray70"),
                heatmap_legend_param = ht_legend_list,
                cluster_rows = FALSE, 
                cluster_columns = FALSE, 
                show_heatmap_legend = as.logical(heatmap_legend),
                show_row_names = as.logical(row_names),
                row_names_side = "left",
                row_names_gp = gpar(fontsize = 10),
                column_names_side = "bottom",
                column_names_gp = gpar(fontsize = 10),
                column_names_max_height = unit(2, "in"),
                show_column_names = FALSE,
                bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(signif_grid),
                                   rot = 45,
                                   gp = gpar(fontsize = 11),
                                   location = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.85, "in")),
                row_title = "Genes",
                row_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title = col_title, 
                column_title_gp = gpar(fontface = "bold", fontsize = 14),
                column_title_side = "top",
                cell_fun = function(j, i, x, y, width, height, fill) {
                  grid.text(signif_grid[i, j], x = x + width*0.20, y = y + height*0.025, gp = gpar(fontsize = 18))
                  if(annot_grid[i, j] == "sensitivity") {
                    grid.circle(x = x - width*0.20, y = y - height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "white", col = "black"))
                  }
                  if(annot_grid[i, j] == "resistance") {
                    grid.circle(x = x - width*0.20, y = y + height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "red", col = "black"))
                  }
                  if(annot_grid[i, j] == "both") {
                    grid.circle(x = x - width*0.20, y = y + height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "red", col = "black"))
                    grid.circle(x = x - width*0.20, y = y - height*0.20, r = radius, default.units = "npc", gp = gpar(fill = "white", col = "black"))
                  }
                }
                )
  return(ht)
}
```

```{r spear_plots, eval=FALSE}
# Copy number
crispr_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CRISPR" & Gene %in% unique(g2p_amp$Gene)))
crispr_cn_ht <- MakeCorrHeatmap(cor_res = crispr_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CRISPR", color_range = c(-0.25, 0, 0.25), radius = 0.03, legend_title = "CRISPR Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/crispr_cn_heatmap.png", width = 3, height = 3, units = "in", res = 500)
draw(crispr_cn_ht, heatmap_legend_side = "top")
dev.off()

ccle_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CCLE" & Gene %in% unique(g2p_amp$Gene)))
ccle_cn_ht <- MakeCorrHeatmap(cor_res = ccle_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CCLE", color_range = c(-0.25, 0, 0.25), radius = 0.02, legend_title = "CCLE Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/ccle_cn_heatmap.png", width = 3, height = 4, units = "in", res = 500)
draw(ccle_cn_ht, heatmap_legend_side = "top")
dev.off()

ctrp_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CTRP" & Gene %in% unique(g2p_amp$Gene)))
ctrp_cn_ht <- MakeCorrHeatmap(cor_res = ctrp_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CTRP", color_range = c(-0.25, 0, 0.25), radius = 0.02, legend_title = "CTRP Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/ctrp_cn_heatmap.png", width = 8, height = 3, units = "in", res = 500)
draw(ctrp_cn_ht, heatmap_legend_side = "top")
dev.off()

gdsc_cn_cor <- unfactorize(filter(cn_cor, Dataset == "GDSC" & Gene %in% unique(g2p_amp$Gene)))
gdsc_cn_ht <- MakeCorrHeatmap(cor_res = gdsc_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "GDSC", color_range = c(-0.25, 0, 0.25), radius = 0.02, legend_title = "GDSC Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/gdsc_cn_heatmap.png", width = 5, height = 3, units = "in", res = 500)
draw(gdsc_cn_ht, heatmap_legend_side = "top")
dev.off()

crispr_cn_ht2 <- MakeCorrHeatmap(cor_res = crispr_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CRISPR", color_range = c(-0.25, 0, 0.25), radius = 0.15, legend_title = "Copy num. Spearman correlation", metric = "CN")
ccle_cn_ht2 <- MakeCorrHeatmap(cor_res = ccle_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CCLE", color_range = c(-0.25, 0, 0.25), radius = 0.0215, legend_title = "Copy num. Spearman correlation", metric = "CN")
ctrp_cn_ht2 <- MakeCorrHeatmap(cor_res = ctrp_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.25, 0, 0.25), radius = 0.0215, legend_title = "Copy num. Spearman correlation", metric = "CN")
gdsc_cn_ht2 <- MakeCorrHeatmap(cor_res = gdsc_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.25, 0, 0.25), radius = 0.0215, legend_title = "Copy num. Spearman correlation", metric = "CN")
png(filename = "./plots/manuscript/all_cn_heatmap.png", width = 13, height = 3.5, units = "in", res = 500)
draw(crispr_cn_ht2 + ccle_cn_ht2 + ctrp_cn_ht2 + gdsc_cn_ht2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()

# Gene expression
crispr_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CRISPR" & Gene %in% unique(g2p_expr$Gene)))
crispr_ge_ht <- MakeCorrHeatmap(cor_res = crispr_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CRISPR", color_range = c(-0.5, 0, 0.5), radius = 0.1, legend_title = "CRISPR Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/crispr_ge_heatmap.png", width = 3, height = 3, units = "in", res = 500)
draw(crispr_ge_ht, heatmap_legend_side = "top")
dev.off()

ccle_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CCLE" & Gene %in% unique(g2p_expr$Gene)))
ccle_ge_ht <- MakeCorrHeatmap(cor_res = ccle_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), radius = 0.2, legend_title = "CCLE Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/ccle_ge_heatmap.png", width = 3, height = 2.5, units = "in", res = 500)
draw(ccle_ge_ht, heatmap_legend_side = "top")
dev.off()

ctrp_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CTRP" & Gene %in% unique(g2p_expr$Gene)))
ctrp_ge_ht <- MakeCorrHeatmap(cor_res = ctrp_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), radius = 0.2, legend_title = "CTRP Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/ctrp_ge_heatmap.png", width = 8, height = 2.5, units = "in", res = 500)
draw(ctrp_ge_ht, heatmap_legend_side = "top")
dev.off()

gdsc_ge_cor <- unfactorize(filter(ge_cor, Dataset == "GDSC" & Gene %in% unique(g2p_expr$Gene)))
gdsc_ge_ht <- MakeCorrHeatmap(cor_res = gdsc_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), radius = 0.2, legend_title = "GDSC Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/gdsc_ge_heatmap.png", width = 5, height = 2.5, units = "in", res = 500)
draw(gdsc_ge_ht, heatmap_legend_side = "top")
dev.off()

crispr_ge_ht2 <- MakeCorrHeatmap(cor_res = crispr_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CRISPR", color_range = c(-0.5, 0, 0.5), radius = 0.155, legend_title = "Gene expr. Spearman correlation", metric = "GE")
ccle_ge_ht2 <- MakeCorrHeatmap(cor_res = ccle_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), radius = 0.035, legend_title = "Gene expr. Spearman correlation", metric = "GE")
ctrp_ge_ht2 <- MakeCorrHeatmap(cor_res = ctrp_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), radius = 0.035, legend_title = "Gene expr. Spearman correlation", metric = "GE")
gdsc_ge_ht2 <- MakeCorrHeatmap(cor_res = gdsc_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), radius = 0.035, legend_title = "Gene expr. Spearman correlation", metric = "GE")
png(filename = "./plots/manuscript/all_ge_heatmap.png", width = 13, height = 2.9, units = "in", res = 500)
draw(crispr_ge_ht2 + ccle_ge_ht2 + ctrp_ge_ht2 + gdsc_ge_ht2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```


# MANUSCRIPT

--------------------------------------------------------------------------------

## Data summaries/Supp

```{r}
g2p_diseases <- unique(g2p$disease[!is.na(g2p$disease)])

ccle$disease_g2p <- ifelse(ccle$disease %in% g2p_diseases, ccle$disease, "other")
ctrp$disease_g2p <- ifelse(ctrp$disease %in% g2p_diseases, ctrp$disease, "other")
gdsc$disease_g2p <- ifelse(gdsc$disease %in% g2p_diseases, gdsc$disease, "other")

g2p_disease_colors <- c("breast"                      = "deeppink",
                        "central_nervous_system"      = "purple4",
                        "colorectal"                  = "palegreen",
                        "gastric"                     = "antiquewhite3",
                        "haematopoietic_and_lymphoid" = "springgreen4",
                        "kidney"                      = "cyan3",
                        "lung"                        = "dodgerblue",
                        "other"                       = "azure3",
                        "ovary"                       = "palevioletred1",
                        "skin"                        = "orange1",
                        "thyroid"                     = "lightgoldenrod1")
g2p_disease_colors1 <- c("breast"                      ,
                        "central_nervous_system"      ,
                        "colorectal"                  ,
                        "gastric"                     ,
                        "haematopoietic_and_lymphoid" ,
                        "kidney"                      ,
                        "lung"                        ,
                        "other"                       ,
                        "ovary"                       ,
                        "skin"                        ,
                        "thyroid"                     )
g2p_disease_colors2 <- c("deeppink",
                        "purple4",
                        "palegreen",
                        "antiquewhite3",
                        "springgreen4",
                        "cyan3",
                        "dodgerblue",
                        "azure3",
                        "palevioletred1",
                        "orange1",
                        "lightgoldenrod1")

g2p_disease_colors_df <- data.frame(disease = g2p_disease_colors1, disease_g2p = g2p_disease_colors1, color = g2p_disease_colors2)
```

```{r Supp2}
# How many datasets each drug was screened in
hta_data <- data.frame(Drug = rownames(g2p_dg_counts), CCLE = NA, CTRP = NA, GDSC = NA)
hta_data$CCLE <- ifelse(hta_data$Drug %in% unique(ccle$Drug), 1, 0)
hta_data$CTRP <- ifelse(hta_data$Drug %in% unique(ctrp$Drug), 1, 0)
hta_data$GDSC <- ifelse(hta_data$Drug %in% unique(gdsc$Drug), 1, 0)
rownames(hta_data) <- hta_data$Drug
hta_data$Drug <- NULL
hta_data$NumDatasetsScreened <- rowSums(hta_data)

# How many G2P indications are for each disease
g2p_disease_n <- g2p %>% count(disease) %>% mutate(percent = n / sum(n) * 100) %>% drop_na(disease)
g2p_disease_n <- rbind(g2p_disease_n, c("other", 0, 0))
g2p_disease_n <- g2p_disease_n[order(g2p_disease_n$percent),]
g2p_disease_n <- merge(g2p_disease_n, g2p_disease_colors_df, by = "disease")
# ggplot(g2p_disease_n, aes(x = "", y = n, fill = disease))+
#   geom_bar(width = 1, stat = "identity") +
#   coord_polar("y", start = 0)


ccle$disease_g2p <- ifelse(ccle$disease %in% g2p_diseases, ccle$disease, "other")
ccle_disease_n <- unique(select(ccle, DepMap_ID, disease_g2p)) %>% count(disease_g2p) %>% mutate(percent = n / sum(n) * 100)
ccle_disease_n <- ccle_disease_n[order(ccle_disease_n$percent),]
ccle_disease_n <- merge(ccle_disease_n, g2p_disease_colors_df, by = "disease_g2p")

ctrp$disease_g2p <- ifelse(ctrp$disease %in% g2p_diseases, ctrp$disease, "other")
ctrp_disease_n <- unique(select(ctrp, DepMap_ID, disease_g2p)) %>% count(disease_g2p) %>% mutate(percent = n / sum(n) * 100)
ctrp_disease_n <- ctrp_disease_n[order(ctrp_disease_n$percent),]

gdsc$disease_g2p <- ifelse(gdsc$disease %in% g2p_diseases, gdsc$disease, "other")
gdsc_disease_n <- unique(select(gdsc, DepMap_ID, disease_g2p)) %>% count(disease_g2p) %>% mutate(percent = n / sum(n) * 100)
gdsc_disease_n <- gdsc_disease_n[order(gdsc_disease_n$percent),]

disease_n <- data.frame("Lineage" = g2p_disease_n$disease,
                        "G2P" = g2p_disease_n$n,
                        "CCLE" = ccle_disease_n$n,
                        "CTRP" = ctrp_disease_n$n,
                        "GDSC" = gdsc_disease_n$n)
disease_n <- melt(data = disease_n, id.vars = "Lineage", measure.vars = c("G2P", "CCLE", "CTRP", "GDSC"), variable.name = "Dataset", value.name = "n")
disease_n$n <- as.numeric(disease_n$n)
disease_n$Lineage <- factor(disease_n$Lineage)

```

```{r fig.height=3, fig.width=3}
slices <- ccle_disease_n$n
lbls <- paste0(ccle_disease_n$disease_g2p, " (", round(ccle_disease_n$percent, digits = 2), "%)")
pie(slices,labels = lbls, col = ccle_disease_n$color, radius = 0.5)
```

```{r, eval=FALSE}
plot_ly() %>%
  add_pie(data = g2p_munge, labels = ~ disease, values = ~ n, textposition = "inside" ,textinfo = "label+percent") %>%
  layout(title = "Lineages", showlegend = FALSE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```


```{r eval=FALSE}
ccle_ccls <- unique(ccle$DepMap_ID)
ctrp_ccls <- unique(ctrp$DepMap_ID)
gdsc_ccls <- unique(gdsc$DepMap_ID)
crispr_ccls <- unique(crispr$DepMap_ID)
# overlap <- calculate.overlap(x = list("CCLE" = ccle_ccls, "CTRP" = ctrp_ccls, "GDSC" = gdsc_ccls, "CRISPR" = crispr_ccls))

ccl_filter <- filter(ccl_meta, DepMap_ID %in% Reduce(intersect, list(ccle_ccls, ctrp_ccls, gdsc_ccls, crispr_ccls)))

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
ccl_venn <- venn.diagram(x = list(ccle_ccls, ctrp_ccls, gdsc_ccls, crispr_ccls),
             filename = NULL,
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1,
             category.names = c("CCLE", "CTRP", "GDSC", "CRISPR"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             # cat.dist = c(0.06, 0.06, 0.035),
             fill = c("springgreen4", "steelblue4", "turquoise4", "darkorchid"))

ccle_drugs <- unique(ccle$Drug)
ctrp_drugs <- unique(ctrp$Drug)
gdsc_drugs <- unique(gdsc$Drug)

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
drug_venn <- venn.diagram(x = list(ccle_drugs, ctrp_drugs, gdsc_drugs),
             filename = NULL,
             height = 2000, width = 2000, resolution = 500,
             lwd = 1, cex = 1.4,
             category.names = c("CCLE", "CTRP", "GDSC"),
             cat.cex = 1.4, cat.fontface = "bold", cat.default.pos = "outer",
             cat.dist = c(0.06, 0.06, 0.035),
             fill = c("palegreen3", "slategray3", "paleturquoise3"))
```

```{r Supp1_summary, fig.height=7, fig.width=20, warning=FALSE, eval=FALSE}
maf_g2p <- filter(maf_df, Gene %in% g2p_gene_order) %>% merge(ccl_meta, by = "DepMap_ID")
maf_g2p <- with(maf_g2p, maf_g2p[order(disease),])
maf_g2p_wide <- dcast(data = maf_g2p, formula = Gene ~ DepMap_ID, value.var = "Mutation", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Gene)
maf_g2p_wide <- ifelse(maf_g2p_wide == 1, "Mutant", "Wildtype")
maf_g2p_annot_df <- unique(select(maf_g2p, DepMap_ID, disease)) %>% `rownames<-`(.[,1]) %>% select(-DepMap_ID) %>% `colnames<-`("Lineage")

# Cell line/mutation heatmap
maf_g2p_annot <- HeatmapAnnotation(df = maf_g2p_annot_df, annotation_name_side = "left", annotation_legend_param = list(Lineage = list(title_gp = gpar(fontsize = 20), labels_gp = gpar(fontsize = 12), title_position = "topleft", nrow = 5)))

maf_g2p_legend_list <- list(title = "Mutation status", legend_direction = "horizontal", border = "gray70", nrow = 1, title_gp = gpar(fontsize = 20), labels_gp = gpar(fontsize = 12))

maf_g2p_ht <- Heatmap(maf_g2p_wide,
                      col = c("Mutant" = "black", "Wildtype" = "white"),
                      rect_gp = gpar(col = "white"),
                      heatmap_legend_param = maf_g2p_legend_list,
                      cluster_rows = FALSE, 
                      cluster_columns = TRUE, 
                      row_names_side = "left",
                      row_names_gp = gpar(fontsize = 10),
                      show_column_names = FALSE,
                      row_title = "Genes",
                      row_title_gp = gpar(fontface = "bold", fontsize = 20),
                      column_title = "Cell lines", 
                      column_title_gp = gpar(fontface = "bold", fontsize = 20),
                      column_title_side = "top",
                      top_annotation = maf_g2p_annot)

draw(maf_g2p_ht, gap = unit(0.25, "in"), heatmap_legend_side = "top", annotation_legend_side = "top")
```

Of the top 10 most cited genes in G2P (Figure 1), 50% were also found in the top 10 most frequently mutated across all 1588 tested cell lines
```{r supp_stats, eval=FALSE}
ccls <- union(union(unique(ccle$DepMap_ID), unique(ctrp$DepMap_ID)), unique(gdsc$DepMap_ID))

maf_g2p_summ_gene <- filter(maf_df, DepMap_ID %in% ccls & Gene %in% unique(g2p_mut$Gene)) %>% group_by(Gene) %>% count(Mutation) %>% filter (Mutation == 1) %>% mutate(percent = n / length(ccls) * 100)
g2p_summ_gene <- g2p_mut %>% count(Gene) %>% mutate(percent = n / nrow(g2p_mut) * 100)

maf_g2p_summ_lin <- merge(filter(maf_df, DepMap_ID %in% ccls & Gene %in% unique(g2p_mut$Gene)), ccl_meta, by = "DepMap_ID", all.x = TRUE) %>% group_by(disease) %>% count(Mutation) %>% filter (Mutation == 1)
maf_g2p_summ_lin$percent <- with(maf_g2p_summ_lin, n / sum(n) * 100)

g2p_summ_lin <- g2p %>% count(disease) %>% mutate(percent = n / nrow(g2p) * 100)

ccl_summ_lin <- filter(ccl_meta, DepMap_ID %in% ccls) %>% count(disease)
ccl_summ_lin$percent <- with(ccl_summ_lin, n / sum(n) * 100)
```


## G2P summary heatmap

```{r Figure2_g2p_summary_heatmap, fig.height=6, fig.width=8, warning=FALSE, eval=FALSE}
# Create annotation layer
hta_data <- data.frame(Drug = rownames(g2p_dg_counts), CCLE = NA, CTRP = NA, GDSC = NA)
hta_data$CCLE <- ifelse(hta_data$Drug %in% unique(ccle$Drug), "Screened", "Not screened")
hta_data$CTRP <- ifelse(hta_data$Drug %in% unique(ctrp$Drug), "Screened", "Not screened")
hta_data$GDSC <- ifelse(hta_data$Drug %in% unique(gdsc$Drug), "Screened", "Not screened")
rownames(hta_data) <- hta_data$Drug
hta_data$Drug <- NULL

hta_annot <- HeatmapAnnotation(text = anno_text(colnames(hta_data), offset = unit(0.4, "in"), gp = gpar(fontsize = 10)))
hta_legend_list <- list(legend_direction = "horizontal", border = "gray70", nrow = 2)
hta <- Heatmap(hta_data,
               name = "Functional screen status           ",
               col = c("Screened" = "purple4", "Not screened" = "gray97"), 
               rect_gp = gpar(col = "gray70"),
               top_annotation = hta_annot,
               heatmap_legend_param = hta_legend_list,
               row_names_side = "left",
               row_names_gp = gpar(fontsize = 10),
               column_names_side = "top",
               column_names_gp = gpar(fontsize = 10),
               show_column_names = FALSE,
               cluster_rows = FALSE, 
               cluster_columns = FALSE,
               row_title = "Drugs",
               row_title_gp = gpar(fontface = "bold", fontsize = 14),
               column_title = "Dataset",
               column_title_gp = gpar(fontface = "bold", fontsize = 14),
               width = unit(1.5, "in"))

# Define color scale
col_fun <- colorRamp2(c(0, 1, 100), c("gray97", "mistyrose", "purple4"))
# Legend properties list
ht_legend_list <- list(legend_direction = "horizontal", legend_width = unit(2.5, "in"), border = "gray70")
ht <- Heatmap(g2p_dg_counts, 
              name = "Number of G2P interpretations",
              col = col_fun,
              na_col = "gray97",
              rect_gp = gpar(col = "gray70"),
              heatmap_legend_param = ht_legend_list,
              cluster_rows = FALSE, 
              cluster_columns = FALSE, 
              show_row_names = FALSE,
              row_names_side = "left",
              row_names_gp = gpar(fontsize = 10),
              column_names_side = "bottom",
              show_column_names = FALSE,
              bottom_annotation = HeatmapAnnotation(
                  text = anno_text(colnames(g2p_dg_counts),
                                   rot = 45,
                                   gp = gpar(fontsize = 8),
                                   offset = unit(1, "npc"),
                                   just = "right"),
                  annotation_height = unit(0.45, "in")),
              row_title = "Drugs",
              row_title_gp = gpar(fontface = "bold", fontsize = 14),
              column_title = "Genes", 
              column_title_gp = gpar(fontface = "bold", fontsize = 14),
              column_title_side = "bottom")

png(filename = "./plots/manuscript_final/g2p_summary_heatmap.png", width = 10, height = 9, units = "in", res = 500)
draw(hta + ht, gap = unit(5, "mm"), heatmap_legend_side = "top")
dev.off()
```

## Mutation status figure

```{r mutation_figure, eval=FALSE}
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = ccle_mut_ht_dat, feature = "mutation", legend_title = "CCLE -log10(p-value)", legend_breaks = seq(0, 12, by = 3), row_names = TRUE, color = "darkgreen", col_title = "", row_title_txt = "Genes", radius = 0.023)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = ctrp_mut_ht_dat, feature = "mutation", legend_title = "CTRP -log10(p-value)", legend_breaks = seq(0, 18, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Genes", radius = 0.008)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = , feature = "mutation", legend_title = "GDSC -log10(p-value)", legend_breaks = seq(0, 5, by = 1), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Genes", radius = 0.011)
ht_mut_list <- ht_ccle2 + ht_ctrp2 + ht_gdsc2
lgd <- list(Legend(labels = c("Resistance", "Sensitivity", "p < 0.05"), type = "points", pch = c(21, 21, 8), nrow = 1, background = "white", legend_gp = gpar(col = "black", fill = c("red", "white"))))
ht_mut_grob <- grid.grabExpr(draw(ht_mut_list, gap = unit(0.25, "in"), heatmap_legend_side = "top", annotation_legend_list = lgd, annotation_legend_side = "top", merge_legend = TRUE))

ccle_signif_g2p_dg_summ <- filter(ccle_signif_g2p_dg, InG2P == "Yes") 
ctrp_signif_g2p_dg_summ <- filter(ctrp_signif_g2p_dg, InG2P == "Yes") 
gdsc_signif_g2p_dg_summ <- filter(gdsc_signif_g2p_dg, InG2P == "Yes")

ccle_mut_filt <- filter(ccle, Drug_Gene %in% filter(ccle_signif_g2p_dg_summ, p < 0.05)$Drug_Gene)
ccle_mut_filt_plot <- ggplot(data = ccle_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene, nrow = 1) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  scale_color_manual(values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CCLE", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_mut_filt <- filter(ctrp, Drug_Gene %in% filter(ctrp_signif_g2p_dg_summ, p < 0.05)$Drug_Gene)
ctrp_mut_filt_plot <- ggplot(data = ctrp_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene, ncol = 4) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "steelblue4", "0" = "slategray3")) +
  scale_color_manual(name = "Lineage", values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_mut_filt <- filter(gdsc, Drug_Gene %in% filter(gdsc_signif_g2p_dg_summ, p < 0.05)$Drug_Gene)
gdsc_mut_filt_plot <- ggplot(data = gdsc_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene, ncol = 4) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "turquoise4", "0" = "paleturquoise3")) +
  scale_color_manual(name = "Lineages", values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "GDSC", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

lay <- rbind(c(1, 1, 1, 1),
             c(1, 1, 1, 1),
             c(1, 1, 1, 1),
             c(2, 2, 3, 3),
             c(4, 4, 4, 4),
             c(4, 4, 4, 4))

gs_mut <- gList(arrangeGrob(ht_mut_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ccle_mut_filt_plot), left = textGrob("B", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(gdsc_mut_filt_plot), left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_mut_filt_plot), left = textGrob("D", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))

png(filename = "./plots/manuscript_final/drug_mutation_pancancer_small.png", width = 13, height = 14, units = "in", res = 100)
grid.arrange(layout_matrix = lay, grobs = gs_mut)
dev.off()

png(filename = "./plots/manuscript_final/drug_mutation_pancancer.png", width = 13, height = 14, units = "in", res = 500)
grid.arrange(layout_matrix = lay, grobs = gs_mut)
dev.off()
```

## Protein changes figure


```{r, eval=FALSE}
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = , feature = "protein changes", legend_title = "CCLE -log10(p-value)", legend_breaks = seq(0, 5, by = 1), row_names = TRUE, color = "darkgreen", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.021)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = , feature = "protein changes", legend_title = "CTRP -log10(p-value)", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.012)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = , feature = "protein changes", legend_title = "GDSC -log10(p-value)", legend_breaks = seq(0, 3, by = 1), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.0125)
ht_prot_list <- ht_ccle2 + ht_ctrp2 + ht_gdsc2
lgd <- list(Legend(labels = c("Resistance", "Sensitivity", "p < 0.05"), type = "points", pch = c(21, 21, 8), nrow = 1, background = "white", legend_gp = gpar(col = "black", fill = c("red", "white"))))
ht_prot_grob <- grid.grabExpr(draw(ht_prot_list, gap = unit(0.25, "in"), heatmap_legend_side = "top", annotation_legend_list = lgd, annotation_legend_side = "top", merge_legend = TRUE))


ccle_prot_filt <- filter(ccle_prot, Drug_Gene_Protein_Change %in% filter(ccle_signif_prot_summ, p < 0.05)$Drug_Gene_Protein_Change)
# ccle_mut_filt_plot <- ggplot(data = ccle_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
#   facet_wrap(~ Drug_Gene, nrow = 1) +
#   geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
#   geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
#   geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
#   scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
#   scale_color_manual(values = g2p_disease_colors) +
#   scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
#   scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
#   coord_cartesian(ylim = c(0, 1.10)) +
#   stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
#   labs(title = "CCLE", x = "Mutation Status", y = "AUC") +
#   guides(color = guide_legend(override.aes = list(size = 3))) +
#   theme(legend.position = "none", axis.title.x = element_blank(),
#         panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
#         panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
#         panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_prot_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change %in% filter(ctrp_signif_prot_summ, p < 0.05)$Drug_Gene_Protein_Change)
ctrp_prot_filt_plot <- ggplot(data = ctrp_prot_filt, mapping = aes(x = Change_Status, y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.7) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_color_manual(name = "Lineage", values = g2p_disease_colors) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP", x = "Change Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_prot_filt <- filter(gdsc_prot, Drug_Gene_Protein_Change %in% filter(gdsc_signif_prot_summ, p < 0.05)$Drug_Gene_Protein_Change)
gdsc_prot_filt_plot <- ggplot(data = gdsc_prot_filt, mapping = aes(x = Change_Status, y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.7) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "turquoise4", "No" = "paleturquoise3")) +
  scale_color_manual(name = "Lineage", values = g2p_disease_colors) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "GDSC", x = "CHange Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(axis.title.x = element_blank(),
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))


ccle_signif_prot_lin$disease_g2p <- ifelse(ccle_signif_prot_lin$disease %in% g2p_diseases, ccle_signif_prot_lin$disease, "other")
ctrp_signif_prot_lin$disease_g2p <- ifelse(ctrp_signif_prot_lin$disease %in% g2p_diseases, ctrp_signif_prot_lin$disease, "other")
gdsc_signif_prot_lin$disease_g2p <- ifelse(gdsc_signif_prot_lin$disease %in% g2p_diseases, gdsc_signif_prot_lin$disease, "other")

ccle_signif_prot_lin_filt <- filter(ccle_signif_prot_lin, InG2P == "Yes")
ctrp_signif_prot_lin_filt <- filter(ctrp_signif_prot_lin, InG2P == "Yes")
gdsc_signif_prot_lin_filt <- filter(gdsc_signif_prot_lin, InG2P == "Yes")

ctrp_prot_lin_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change_Lineage %in% filter(ctrp_signif_prot_lin_filt, p < 0.05)$Drug_Gene_Protein_Change_Lineage)
ctrp_prot_lin_filt_plot <- ggplot(data = ctrp_prot_lin_filt, mapping = aes(x = Change_Status, y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change_Lineage, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = Change_Status), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.4) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP", x = "Change Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))



lay <- rbind(c(1, 1, 1, 1, 2, 2),
             c(3, 3, 3, 3, 3, 4))

gs_prot <- gList(arrangeGrob(ht_prot_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(gdsc_prot_filt_plot), left = textGrob("B", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_prot_filt_plot), left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_prot_lin_filt_plot), left = textGrob("D", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))

png(filename = "./plots/manuscript_final/drug_protein_pancancer_small.png", width = 13, height = 10, units = "in", res = 100)
grid.arrange(layout_matrix = lay, grobs = gs_prot)
dev.off()

png(filename = "./plots/manuscript_final/drug_protein_pancancer.png", width = 13, height = 10, units = "in", res = 500)
grid.arrange(layout_matrix = lay, grobs = gs_prot)
dev.off()
```


```{r}
test2 <- select(g2p_prot, Direction_Curated, Gene,Gene_Protein_Change) %>% drop_na(Direction_Curated) %>% unique()
unique(test2$Gene)

crispr_g2p_prot<- filter(crispr_signif_prot, Gene_Protein_Change %in% unique(g2p_prot$Gene_Protein_Change), InG2P == "Yes")
ccle_g2p_prot <- filter(ccle_signif_prot, Drug_Gene_Protein_Change %in% unique(g2p_prot$Drug_Gene_Protein_Change), InG2P == "Yes")
sum(!is.na(ccle_g2p_prot$p))
ctrp_g2p_prot <- filter(ctrp_signif_prot, Drug_Gene_Protein_Change %in% unique(g2p_prot$Drug_Gene_Protein_Change), InG2P == "Yes")
sum(!is.na(ctrp_g2p_prot$p))
gdsc_g2p_prot <- filter(gdsc_signif_prot, Drug_Gene_Protein_Change %in% unique(g2p_prot$Drug_Gene_Protein_Change), InG2P == "Yes")
sum(!is.na(gdsc_g2p_prot$p))
```

```{r prot_changes_fig, eval=FALSE, fig.height=15, fig.width=15}
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = ccle_signif_prot_4plot, feature = "protein changes", legend_title = "CCLE -log10(p-value)", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "darkgreen", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.021)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = ctrp_signif_prot_4plot, feature = "protein changes", legend_title = "CTRP -log10(p-value)", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.012)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = gdsc_signif_prot_4plot, feature = "protein changes", legend_title = "GDSC -log10(p-value)", legend_breaks = seq(0, 8, by = 2), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.0125)
ht_crispr2 <- MakeWilcoxonHeatmap(signif_df = crispr_signif_prot_4plot, feature = "protein changes CRISPR", legend_title = "CRISPR -log10(p-value)", legend_breaks = seq(0, 25, by = 5), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.135)
ht_prot_list <- ht_crispr2 + ht_ccle2 + ht_ctrp2 + ht_gdsc2
lgd <- list(Legend(labels = c("Resistance", "Sensitivity", "p < 0.05"), type = "points", pch = c(21, 21, 8), nrow = 1, background = "white", legend_gp = gpar(col = "black", fill = c("red", "white"))))
ht_prot_grob <- grid.grabExpr(draw(ht_prot_list, gap = unit(0.25, "in"), heatmap_legend_side = "top", annotation_legend_list = lgd, annotation_legend_side = "top", merge_legend = TRUE))

crispr_signif_prot_summ <- filter(crispr_signif_prot, InG2P == "Yes") 
ccle_signif_prot_summ <- filter(ccle_signif_prot, InG2P == "Yes") 
ctrp_signif_prot_summ <- filter(ctrp_signif_prot, InG2P == "Yes") 
gdsc_signif_prot_summ <- filter(gdsc_signif_prot, InG2P == "Yes") 

crispr_prot_filt <- filter(crispr_prot, Gene_Protein_Change %in% filter(crispr_signif_prot_summ, p < 0.05)$Gene_Protein_Change)
crispr_prot_filt_plot <- ggplot(data = crispr_prot_filt, aes(x = as.character(Change_Status), y = Score) )+
  facet_wrap(~ Gene_Protein_Change, nrow = 2) +
  geom_violin(aes(fill = as.character(Change_Status))) +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_y_continuous(breaks = seq(-3, 1, by = 0.5), labels = c("-3.0", "-2.5", "-2.0", "-1.5", "-1.0", "-0.5", "0.0", "0.5", "1.0")) +
  scale_fill_manual(name = "Protein Change Status", labels = c("Wildtype", "Mutant"), values = c("Yes" = "darkorchid", "No" = "thistle")) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CRISPR", x = "Protein Change Status", y = "CERES Score") +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "snow1", colour = "snow1", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_prot_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change %in% filter(ctrp_signif_prot_summ, p < 0.05)$Drug_Gene_Protein_Change)
ctrp_prot_filt_plot <- ggplot(data = ctrp_prot_filt, mapping = aes(x = as.character(Change_Status), y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change, nrow = 2) +
  geom_violin(aes(fill = as.character(Change_Status))) +
  geom_boxplot(outlier.shape = NA, width = 0.07,) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  scale_fill_manual(name = "Protein Change Status", labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP", x = "Protein Change Status", y = "AUC") +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_prot_filt <- filter(gdsc_prot, Drug_Gene_Protein_Change %in% filter(gdsc_signif_prot_summ, p < 0.05)$Drug_Gene_Protein_Change)
gdsc_prot_filt_plot <- ggplot(data = gdsc_prot_filt, mapping = aes(x = as.character(Change_Status), y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change, nrow = 2) +
  geom_violin(aes(fill = as.character(Change_Status))) +
  geom_boxplot(outlier.shape = NA, width = 0.07, ) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  scale_fill_manual(name = "Protein Change Status", labels = c("Wildtype", "Mutant"), values = c("Yes" = "turquoise4", "No" = "paleturquoise3")) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "GDSC", x = "Protein Change Status", y = "AUC") +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

lay <- rbind(c(1, 1, 1, 1, 1),
             c(2, 2, 2, 2, 4),
             c(3, 3, 3, 3, 3))

gs_prot <- gList(arrangeGrob(ht_prot_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_prot_filt_plot), left = textGrob("B", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_prot_filt_plot), left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(gdsc_prot_filt_plot), left = textGrob("D", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))

png(filename = "./plots/manuscript_final/protein_change_pancancer_small.png", width = 15, height = 15, units = "in", res = 100)
grid.arrange(layout_matrix = lay, grobs = gs_prot)
dev.off()

png(filename = "./plots/manuscript_final/protein_change_pancancer.png", width = 15, height = 15, units = "in", res = 500)
grid.arrange(layout_matrix = lay, grobs = gs_prot)
dev.off()
```

## CN/GE figure


```{r CN_GE_fig, eval=FALSE, fig.height=10, fig.width=15}
# Copy number

ccle_cn_ht2 <- MakeCorrHeatmap(cor_res = filter(cn_cor, Dataset == "CCLE" & Drug %in% cn_drugs & Gene %in% cn_genes), row_names = TRUE, heatmap_legend = TRUE, col_title = "CCLE", color_range = c(-0.2, 0, 0.2), radius = 0.025, legend_title = "Copy num. Spearman correlation", metric = "CN")
ctrp_cn_ht2 <- MakeCorrHeatmap(cor_res = filter(cn_cor, Dataset == "CTRP" & Drug %in% cn_drugs & Gene %in% cn_genes), row_names = TRUE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.2, 0, 0.2), radius = 0.025, legend_title = "Copy num. Spearman correlation", metric = "CN")
gdsc_cn_ht2 <- MakeCorrHeatmap(cor_res = filter(cn_cor, Dataset == "GDSC" & Drug %in% cn_drugs & Gene %in% cn_genes), row_names = TRUE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.2, 0, 0.2), radius = 0.025, legend_title = "Copy num. Spearman correlation", metric = "CN")
ht_cn_list <- ccle_cn_ht2 + ctrp_cn_ht2 + gdsc_cn_ht2
lgd <- list(Legend(labels = c("Resistance", "Sensitivity", "p < 0.05"), type = "points", pch = c(21, 21, 8), nrow = 3, background = "white", legend_gp = gpar(col = "black", fill = c("red", "white"))))
ht_cn_grob <- grid.grabExpr(draw(ht_cn_list, gap = unit(0.25, "in"), heatmap_legend_side = "bottom", annotation_legend_list = lgd, annotation_legend_side = "bottom", merge_legend = TRUE))

cn_cor$p.format <- with(cn_cor, ifelse(CN_p < 0.001, "p < 0.001", paste0("p = ", round(CN_p, digits = 3))))
ccle_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CCLE" & InG2P == "Yes"))
ctrp_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CTRP" & InG2P == "Yes"))
gdsc_cn_cor <- unfactorize(filter(cn_cor, Dataset == "GDSC" & InG2P == "Yes"))

ccle_cn_cor_filt <- filter(ccle_cn_cor, CN_p < 0.05)
ccle_cn_filt <- filter(ccle, Drug_Gene %in% ccle_cn_cor_filt$Drug_Gene)
ccle_text <- data.frame(label = paste0("r = ", round(ccle_cn_cor_filt$CN_r, digits = 3), ", ", ccle_cn_cor_filt$p.format), Drug_Gene = ccle_cn_cor_filt$Drug_Gene)
ccle_cn_filt_plot <- ggplot(data = ccle_cn_filt, aes(x = CN, y = Score)) +
  facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ccle_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.05, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "CCLE", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_cn_cor_filt <- filter(ctrp_cn_cor, CN_p < 0.05)
ctrp_cn_filt <- filter(ctrp, Drug_Gene %in% ctrp_cn_cor_filt$Drug_Gene)
ctrp_text <- data.frame(label = paste0("r = ", round(ctrp_cn_cor_filt$CN_r, digits = 3), ",\n", ctrp_cn_cor_filt$p.format), Drug_Gene = ctrp_cn_cor_filt$Drug_Gene)
ctrp_cn_filt_plot <- ggplot(data = ctrp_cn_filt, aes(x = CN, y = Score)) +
  facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ctrp_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.3, vjust = 1.2)) +
  labs(title = "CTRP", x = "Copy number (log2)", y = "AUC") +
  scale_color_manual(values = g2p_disease_colors) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_cn_cor_filt <- filter(gdsc_cn_cor, CN_p < 0.05)

# Gene expression

# ccle_ge_ht2 <- MakeCorrHeatmap(cor_res = filter(ge_cor, Dataset == "CCLE" & Drug %in% ge_drugs & Gene %in% ge_genes), row_names = FALSE, heatmap_legend = FALSE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), radius = 0.07, legend_title = "Gene expr. Spearman correlation", metric = "GE")
# ctrp_ge_ht2 <- MakeCorrHeatmap(cor_res = filter(ge_cor, Dataset == "CTRP" & Drug %in% ge_drugs & Gene %in% ge_genes), row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), radius = 0.07, legend_title = "Gene expr. Spearman correlation", metric = "GE")
# gdsc_ge_ht2 <- MakeCorrHeatmap(cor_res = filter(ge_cor, Dataset == "GDSC" & Drug %in% ge_drugs & Gene %in% ge_genes), row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), radius = 0.07, legend_title = "Gene expr. Spearman correlation", metric = "GE")
# ht_ge_list <- ccle_ge_ht2 + ctrp_ge_ht2 + gdsc_ge_ht2
# ht_ge_grob <- grid.grabExpr(draw(ht_ge_list, gap = unit(0.25, "in"), heatmap_legend_side = "top", annotation_legend_list = lgd, annotation_legend_side = "top", merge_legend = TRUE))

ge_cor$p.format <- with(ge_cor, ifelse(GE_p < 0.001, "p < 0.001", paste0("p = ", round(GE_p, digits = 3))))
ccle_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CCLE" & InG2P == "Yes"))
ctrp_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CTRP" & InG2P == "Yes"))
gdsc_ge_cor <- unfactorize(filter(ge_cor, Dataset == "GDSC" & InG2P == "Yes"))

ccle_ge_cor_filt <- filter(ccle_ge_cor, GE_p < 0.05)
ccle_ge_filt <- filter(ccle, Drug_Gene %in% ccle_ge_cor_filt$Drug_Gene)
ccle_text <- data.frame(label = paste0("r = ", round(ccle_ge_cor_filt$GE_r, digits = 3), ", ", ccle_ge_cor_filt$p.format), Drug_Gene = ccle_ge_cor_filt$Drug_Gene)
ccle_ge_filt_plot <- ggplot(data = ccle_ge_filt, aes(x = TPM, y = Score) )+
  facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ccle_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.37, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "CCLE", x = "Gene expression [log2(TPM)]", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_ge_cor_filt <- filter(ctrp_ge_cor, GE_p < 0.05)
ctrp_ge_filt <- filter(ctrp, Drug_Gene %in% ctrp_ge_cor_filt$Drug_Gene)
ctrp_text <- data.frame(label = paste0("r = ", round(ctrp_ge_cor_filt$GE_r, digits = 3), ",\n", ctrp_ge_cor_filt$p.format), Drug_Gene = ctrp_ge_cor_filt$Drug_Gene)
ctrp_ge_filt_plot <- ggplot(data = ctrp_ge_filt, aes(x = TPM, y = Score) )+
  facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ctrp_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_color_manual(name = "Lineages", values = g2p_disease_colors) +
  labs(title = "CTRP", x = "Gene expression [log2(TPM)]", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_ge_cor_filt <- filter(gdsc_ge_cor, GE_p < 0.05)
gdsc_ge_filt <- filter(gdsc, Drug_Gene %in% gdsc_ge_cor_filt$Drug_Gene)
gdsc_text <- data.frame(label = paste0("r = ", round(gdsc_ge_cor_filt$GE_r, digits = 3), ",\n", gdsc_ge_cor_filt$p.format), Drug_Gene = gdsc_ge_cor_filt$Drug_Gene)
gdsc_ge_filt_plot <- ggplot(data = gdsc_ge_filt, aes(x = TPM, y = Score) )+
  facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = gdsc_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.00)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "GDSC", x = "Gene expression [log2(TPM)]", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))


# Arrange figure

lay <- rbind(c(1, 2, 3),
             c(4, 6, 6),
             c(5, 5, 5))

gs_cn_ge <- gList(arrangeGrob(ht_cn_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ccle_cn_filt_plot), left = textGrob("B", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_cn_filt_plot), left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             # arrangeGrob(ht_ge_grob, left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ccle_ge_filt_plot), left = textGrob("D", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_ge_filt_plot), left = textGrob("F", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(gdsc_ge_filt_plot), left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))

png(filename = "./plots/manuscript_final/drug_cn_ge_pancancer_small.png", width = 15, height = 11, units = "in", res = 100)
grid.arrange(layout_matrix = lay, grobs = gs_cn_ge)
dev.off()

png(filename = "./plots/manuscript_final/drug_cn_ge_pancancer.png", width = 15, height = 11, units = "in", res = 500)
grid.arrange(layout_matrix = lay, grobs = gs_cn_ge)
dev.off()
```

## Fusions

Fusions are completely driven by HL lineage: HL cell lines are the only cell lines that contain ABL1-BCR, BCR-ABL1, and PML-PARA fusions.
```{r}
test <- unique(select(fus, disease, FusionPair, Fusion_Status)) %>% filter(Fusion_Status == "Yes")
test
```

```{r pancan_ks_res}
pancan_ks_results <- data.frame("Dataset" = c(rep(c("CCLE", "CTRP", "GDSC"), 4)),
           "Data type" = c(rep("Mutation", 3), rep("Protein change", 3), rep("Copy number", 3), rep("Gene expression", 3)),
  "p.value" = c(ks.test(filter(ccle_mut_ht_dat, InG2P == "Yes")$p, filter(ccle_mut_ht_dat, InG2P == "No")$p)$p.value,
  ks.test(filter(ctrp_mut_ht_dat, InG2P == "Yes")$p, filter(ctrp_mut_ht_dat, InG2P == "No")$p)$p.value,
  ks.test(filter(gdsc_mut_ht_dat, InG2P == "Yes")$p, filter(gdsc_mut_ht_dat, InG2P == "No")$p)$p.value,
  ks.test(filter(ccle_prot_ht_data, InG2P == "Yes")$p, filter(ccle_prot_ht_data, InG2P == "No")$p)$p.value,
  ks.test(filter(ctrp_prot_ht_data, InG2P == "Yes")$p, filter(ctrp_prot_ht_data, InG2P == "No")$p)$p.value,
  ks.test(filter(gdsc_prot_ht_data, InG2P == "Yes")$p, filter(gdsc_prot_ht_data, InG2P == "No")$p)$p.value,
  ks.test(filter(ccle_cn_ht_data, InG2P == "Yes")$CN_p, filter(ccle_cn_ht_data, InG2P == "No")$CN_p)$p.value,
  ks.test(filter(ctrp_cn_ht_data, InG2P == "Yes")$CN_p, filter(ctrp_cn_ht_data, InG2P == "No")$CN_p)$p.value,
  ks.test(filter(gdsc_cn_ht_data, InG2P == "Yes")$CN_p, filter(gdsc_cn_ht_data, InG2P == "No")$CN_p)$p.value,
  ks.test(filter(ccle_ge_ht_data, InG2P == "Yes")$GE_p, filter(ccle_ge_ht_data, InG2P == "No")$GE_p)$p.value,
  ks.test(filter(ctrp_ge_ht_data, InG2P == "Yes")$GE_p, filter(ctrp_ge_ht_data, InG2P == "No")$GE_p)$p.value,
  ks.test(filter(gdsc_ge_ht_data, InG2P == "Yes")$GE_p, filter(gdsc_ge_ht_data, InG2P == "No")$GE_p)$p.value))
```

## Lineages

```{r, eval=FALSE}
ccle_mut_lin <- filter(ccle_signif_dgl, InG2P == "Yes")
ctrp_mut_lin <- filter(ctrp_signif_dgl, InG2P == "Yes")
gdsc_mut_lin <- filter(gdsc_signif_dgl, InG2P == "Yes")

ccle_mut_lin_filt <- filter(ccle, Drug_Gene_Lin %in% filter(ccle_mut_lin, p < 0.05)$Drug_Gene_Lin)
ccle_mut_lin_filt_plot <- ggplot(data = ccle_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene_Lin, nrow = 1) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color =  as.character(Mutation)), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CCLE", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none",axis.title.x = element_blank(),
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_mut_lin_filt <- filter(ctrp, Drug_Gene_Lin %in% filter(ctrp_mut_lin, p < 0.05)$Drug_Gene_Lin)
ctrp_mut_lin_filt_plot <- ggplot(data = ctrp_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene_Lin, ncol = 4) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color =  as.character(Mutation)), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "steelblue4", "0" = "slategray3")) +
  scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "steelblue4", "0" = "slategray3")) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_mut_lin_filt <- filter(gdsc, Drug_Gene_Lin %in% filter(gdsc_mut_lin, p < 0.05)$Drug_Gene_Lin)
gdsc_mut_lin_filt_plot <- ggplot(data = gdsc_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene_Lin, nrow = 1) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = as.character(Mutation)), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "turquoise4", "0" = "paleturquoise3")) +
  scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "turquoise4", "0" = "paleturquoise3")) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 0.6)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 0.6) +
  labs(title = "GDSC", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))







cn_cor_lin$p.format <- with(cn_cor_lin, ifelse(CN_p < 0.001, "p < 0.001", paste0("p = ", round(CN_p, digits = 3))))
ccle_cn_lin_cor <- unfactorize(filter(cn_cor_lin, Dataset == "CCLE" & InG2P == "Yes"))
ctrp_cn_lin_cor <- unfactorize(filter(cn_cor_lin, Dataset == "CTRP" & InG2P == "Yes"))
gdsc_cn_lin_cor <- unfactorize(filter(cn_cor_lin, Dataset == "GDSC" & InG2P == "Yes"))

ccle_cn_lin_cor_filt <- filter(ccle_cn_lin_cor, CN_p < 0.05)
ccle_cn_lin_filt <- filter(ccle, Drug_Gene_Lin %in% ccle_cn_lin_cor_filt$Drug_Gene_Lin)
ccle_lin_text <- data.frame(label = paste0("r = ", round(ccle_cn_lin_cor_filt$CN_r, digits = 3), ", ", ccle_cn_lin_cor_filt$p.format), Drug_Gene_Lin = ccle_cn_lin_cor_filt$Drug_Gene_Lin)
ccle_cn_lin_filt_plot <- ggplot(data = ccle_cn_lin_filt, aes(x = CN, y = Score)) +
  facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ccle_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  scale_color_manual(values = g2p_disease_colors) +
  coord_cartesian(ylim = c(0, 1)) +
  labs(title = "CCLE", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_cn_lin_cor_filt <- filter(ctrp_cn_lin_cor, CN_p < 0.05)
ctrp_cn_lin_filt <- filter(ctrp, Drug_Gene_Lin %in% ctrp_cn_lin_cor_filt$Drug_Gene_Lin)
ctrp_lin_text <- data.frame(label = paste0("r = ", round(ctrp_cn_lin_cor_filt$CN_r, digits = 3), ", ", ctrp_cn_lin_cor_filt$p.format), Drug_Gene_Lin = ctrp_cn_lin_cor_filt$Drug_Gene_Lin)
ctrp_cn_lin_filt_plot <- ggplot(data = ctrp_cn_lin_filt, aes(x = CN, y = Score)) +
  facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ctrp_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  labs(title = "CTRP", x = "Copy number (log2)", y = "AUC") +
  scale_color_manual(values = g2p_disease_colors) +
  coord_cartesian(ylim = c(0, 1)) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_cn_lin_cor_filt <- filter(gdsc_cn_lin_cor, CN_p < 0.05)
gdsc_cn_lin_filt <- filter(gdsc, Drug_Gene_Lin %in% gdsc_cn_lin_cor_filt$Drug_Gene_Lin)
gdsc_lin_text <- data.frame(label = paste0("r = ", round(gdsc_cn_lin_cor_filt$CN_r, digits = 3), ", ", gdsc_cn_lin_cor_filt$p.format), Drug_Gene_Lin = gdsc_cn_lin_cor_filt$Drug_Gene_Lin)
gdsc_cn_lin_filt_plot <- ggplot(data = gdsc_cn_lin_filt, aes(x = TPM, y = Score) )+
  facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = gdsc_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.00)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "GDSC", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))





ge_cor_lin$p.format <- with(ge_cor_lin, ifelse(GE_p < 0.001, "p < 0.001", paste0("p = ", round(GE_p, digits = 3))))
ccle_ge_lin_cor <- unfactorize(filter(ge_cor_lin, Dataset == "CCLE" & InG2P == "Yes"))
ctrp_ge_lin_cor <- unfactorize(filter(ge_cor_lin, Dataset == "CTRP" & InG2P == "Yes"))
gdsc_ge_lin_cor <- unfactorize(filter(ge_cor_lin, Dataset == "GDSC" & InG2P == "Yes"))

ccle_ge_lin_cor_filt <- filter(ccle_ge_lin_cor, GE_p < 0.05)
ccle_ge_lin_filt <- filter(ccle, Drug_Gene_Lin %in% ccle_ge_lin_cor_filt$Drug_Gene_Lin)
ccle_text <- data.frame(label = paste0("r = ", round(ccle_ge_lin_cor_filt$GE_r, digits = 3), ", ", ccle_ge_lin_cor_filt$p.format), Drug_Gene = ccle_ge_lin_cor_filt$Drug_Gene_Lin)
ccle_ge_lin_filt_plot <- ggplot(data = ccle_ge_lin_filt, aes(x = TPM, y = Score))+
  facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ccle_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  coord_cartesian(ylim = c(0, 1)) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "CCLE", x = "Gene expression [log2(TPM)]", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

ctrp_ge_lin_cor_filt <- filter(ctrp_ge_lin_cor, GE_p < 0.05)
# ctrp_ge_lin_filt <- filter(ctrp, Drug_Gene_Lin %in% ctrp_ge_lin_cor_filt$Drug_Gene_Lin)
# ctrp_text <- data.frame(label = paste0("r = ", round(ctrp_ge_lin_cor_filt$GE_r, digits = 3), ",\n", ctrp_ge_lin_cor_filt$p.format), Drug_Gene_Lin = ctrp_ge_lin_cor_filt$Drug_Gene_Lin)
# ctrp_ge_lin_filt_plot <- ggplot(data = ctrp_ge_lin_filt, aes(x = TPM, y = Score) )+
#   facet_wrap(~ Drug_Gene_Lin) +
#   geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
#   geom_text(data = ctrp_text,
#             mapping = aes(x = +Inf, y = +Inf, label = label,
#             hjust = 1.1, vjust = 1.2)) +
#   scale_color_manual(name = "Lineages", values = g2p_disease_colors) +
#   labs(title = "CTRP", x = "Gene expression [log2(TPM)]", y = "AUC") +
#   guides(color = guide_legend(override.aes = list(size = 3))) +
#   theme(panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
#         panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
#         panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))

gdsc_ge_lin_cor_filt <- filter(gdsc_ge_lin_cor, GE_p < 0.05)
# gdsc_ge_lin_filt <- filter(gdsc, Drug_Gene_Lin %in% gdsc_ge_lin_cor_filt$Drug_Gene_Lin)
# gdsc_text <- data.frame(label = paste0("r = ", round(gdsc_ge_lin_cor_filt$GE_r, digits = 3), ",\n", gdsc_ge_lin_cor_filt$p.format), Drug_Gene_Lin = gdsc_ge_lin_cor_filt$Drug_Gene_Lin)
# gdsc_ge_lin_filt_plot <- ggplot(data = gdsc_ge_lin_filt, aes(x = TPM, y = Score) )+
#   facet_wrap(~ Drug_Gene_Lin) +
#   geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
#   geom_text(data = gdsc_text,
#             mapping = aes(x = +Inf, y = +Inf, label = label,
#             hjust = 1.1, vjust = 1.2)) +
#   scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
#   coord_cartesian(ylim = c(0, 1.00)) +
#   scale_color_manual(values = g2p_disease_colors) +
#   labs(title = "GDSC", x = "Gene expression [log2(TPM)]", y = "AUC") +
#   theme(legend.position = "none",
#         panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
#         panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
#         panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))


lay <- rbind(c(1, 2, 2, 2, 2, 3, 3, 3),
             c(4, 4, 5, 5, 6, 6, 7, 7),
             c(4, 4, 5, 5, 6, 6, 7, 7))

gs_cn_ge <- gList(arrangeGrob(ggplotGrob(ccle_mut_lin_filt_plot), left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_mut_lin_filt_plot), left = textGrob("B", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(gdsc_mut_lin_filt_plot), left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ccle_cn_lin_filt_plot), left = textGrob("D", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ctrp_cn_lin_filt_plot), left = textGrob("", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(gdsc_cn_lin_filt_plot), left = textGrob("", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(ccle_ge_lin_filt_plot), left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))

png(filename = "./plots/manuscript_final/drug_lin_pancancer_small.png", width = 18, height = 8, units = "in", res = 100)
grid.arrange(layout_matrix = lay, grobs = gs_cn_ge)
dev.off()

png(filename = "./plots/manuscript_final/drug_lin_pancancer.png", width = 18, height = 8, units = "in", res = 500)
grid.arrange(layout_matrix = lay, grobs = gs_cn_ge)
dev.off()
```


# SCCB

--------------------------------------------------------------------------------

```{r}
ccle_prot_lin <- filter(ccle_signif_prot_lin, InG2P == "Yes")
ctrp_prot_lin <- filter(ctrp_signif_prot_lin, InG2P == "Yes")
gdsc_prot_lin <- filter(gdsc_signif_prot_lin, InG2P == "Yes")
```

```{r histology_dists_data, eval=FALSE}
hist_count <- function(df, dataset) {
  hists <- unique(select(df, DepMap_ID, disease_g2p)) %>% count(disease_g2p)
  hists$Percent <- hists$n / sum(hists$n) * 100
  hists$Dataset <- dataset
  hists <- hists[order(hists$n, decreasing = T),]
  return(hists)
}

ccle_hists <- hist_count(ccle, "CCLE")
ctrp_hists <- hist_count(ctrp, "CTRP")
gdsc_hists <- hist_count(gdsc, "GDSC")

drug_hists <- rbind(ccle_hists, ctrp_hists, gdsc_hists) %>% drop_na(disease_g2p)
drug_hists$Dataset <- factor(drug_hists$Dataset, levels = c("CCLE", "CTRP", "GDSC"))

png(filename = "./plots/manuscript/all_histology_distributions.png", width = 6, height = 4.5, units = "in", res = 500)
ggplot(drug_hists, aes(x = Dataset, y = n, fill = disease_g2p)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = g2p_disease_colors) +
  scale_y_continuous(breaks = seq(0, 900, by = 100), labels = seq(0, 900, by = 100)) +
  guides(fill = guide_legend(title = "Lineage", ncol = 1)) +
  labs(y = "Count") +
  theme(axis.title.x = element_blank())
dev.off()
```

```{r}
length(unique(g2p_mut$Drug_Gene))
length(unique(g2p_mut$Drug_Gene_Lin))
length(unique(g2p_amp$Drug_Gene_Lin))

g2p_mut_egfr <- filter(g2p_mut, Gene == "EGFR") %>% select(Drug_Gene_Lin, Protein_Change, Direction_Curated)

test2 <- filter(cn_cor_lin, Drug != "CRISPR" & InG2P == "Yes")
test <- filter(ge_cor_lin, Drug != "CRISPR" & InG2P == "Yes")
test3 <- filter(cn_cor, Gene == "MET" & InG2P == "Yes")
```

## Specific plots


```{r, eval=FALSE}
ccle_prot$disease_g2p <- ifelse(ccle_prot$disease %in% g2p_diseases, ccle_prot$disease, "other")
ctrp_prot$disease_g2p <- ifelse(ctrp_prot$disease %in% g2p_diseases, ctrp_prot$disease, "other")
gdsc_prot$disease_g2p <- ifelse(gdsc_prot$disease %in% g2p_diseases, gdsc_prot$disease, "other")
ccle_signif_prot_summ <- filter(ccle_signif_prot, InG2P == "Yes") 
ctrp_signif_prot_summ <- filter(ctrp_signif_prot, InG2P == "Yes") 
gdsc_signif_prot_summ <- filter(gdsc_signif_prot, InG2P == "Yes") 
prot_drugs <- union(union(ccle_signif_prot_summ$Drug, ctrp_signif_prot_summ$Drug), gdsc_signif_prot_summ$Drug)
prot_drugs <- prot_drugs[!(prot_drugs %in% c("cabozantinib", "vandetanib"))]
                                
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = filter(ccle_signif_prot_4plot, Drug %in% prot_drugs), feature = "protein changes", legend_title = "CCLE -log10(p-value)", legend_breaks = seq(0, 5, by = 1), row_names = TRUE, color = "darkgreen", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.04)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = filter(ctrp_signif_prot_4plot, Drug %in% prot_drugs), feature = "protein changes", legend_title = "CTRP -log10(p-value)", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.012)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = filter(gdsc_signif_prot_4plot, Drug %in% prot_drugs), feature = "protein changes", legend_title = "GDSC -log10(p-value)", legend_breaks = seq(0, 3, by = 1), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.02)
ht_prot_list <- ht_ccle2 + ht_ctrp2 + ht_gdsc2
lgd <- list(Legend(labels = c("Resistance", "Sensitivity", "p < 0.05"), type = "points", pch = c(21, 21, 8), nrow = 1, background = "white", legend_gp = gpar(col = "black", fill = c("red", "white"))))

png(filename = "./plots/prot_ht.png", width = 7, height = 6, units = "in", res = 500)
draw(ht_prot_list, gap = unit(0.25, "in"), heatmap_legend_side = "top", annotation_legend_list = lgd, annotation_legend_side = "top", merge_legend = TRUE)
dev.off()
```

```{r, eval=FALSE}
ccle_signif_g2p_dg_summ <- filter(ccle_signif_g2p_dg, InG2P == "Yes") 
ctrp_signif_g2p_dg_summ <- filter(ctrp_signif_g2p_dg, InG2P == "Yes") 
gdsc_signif_g2p_dg_summ <- filter(gdsc_signif_g2p_dg, InG2P == "Yes") 

ccle_signif_g2p_dgl <- filter(ccle_signif_dgl, InG2P == "Yes") 
ctrp_signif_g2p_dgl <- filter(ctrp_signif_dgl, InG2P == "Yes") 
gdsc_signif_g2p_dgl <- filter(gdsc_signif_dgl, InG2P == "Yes") 


signif_g2p_dg_summ <- rbind(ccle_signif_g2p_dg_summ, ctrp_signif_g2p_dg_summ, gdsc_signif_g2p_dg_summ)
signif_g2p_dg_summ <- unique(select(signif_g2p_dg_summ, Drug_Gene, p))
test <- filter(signif_g2p_dg_summ, p < 0.05)
length(unique(signif_g2p_dg_summ$Drug_Gene))

ccle_mut_filt <- filter(ccle, Drug_Gene == "crizotinib_ROS1")
ccle_mut_filt_plot <- ggplot(data = ccle_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  # facet_wrap(~ Drug_Gene, nrow = 1) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  geom_point(aes(color = as.character(Mutation)), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  # scale_color_manual(values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  # stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  annotate(geom = "text", label = "p = 0.0020", x = 1.5, y = 1.1) +
  labs(title = "CCLE: Crizotinib, ROS1", x = "Mutation Status", y = "AUC") +
  # guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ccle_mut_filt_plot, filename = "./plots/crizotinib_ROS1_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")


ccle_mut_filt <- filter(ccle, Drug_Gene == "erlotinib_EGFR")
ccle_mut_filt_plot <- ggplot(data = ccle_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  # facet_wrap(~ Drug_Gene, nrow = 1) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  scale_color_manual(values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  # stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  annotate(geom = "text", label = "p = 0.0385", x = 1.5, y = 1.1) +
  labs(title = "CCLE: Erlotinib, EGFR", x = "Mutation Status", y = "AUC") +
  # guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ccle_mut_filt_plot, filename = "./plots/erlotinib_EGFR_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")
 
ctrp_mut_filt <- filter(ctrp, Drug_Gene == "vemurafenib_BRAF")
ctrp_mut_filt_plot <- ggplot(data = ctrp_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  # facet_wrap(~ Drug_Gene, ncol = 4) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "steelblue4", "0" = "slategray3")) +
  scale_color_manual(name = "Lineage", values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  # stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP: Vemurafenib, BRAF", x = "Mutation Status", y = "AUC") +
  annotate(geom = "text", label = "p = 0.00045", x = 1.5, y = 1.1) +
  # guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_mut_filt_plot, filename = "./plots/vemurafenib_BRAF_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

cn_cor$p.format <- with(cn_cor, ifelse(CN_p < 0.001, "p < 0.001", paste0("p = ", round(CN_p, digits = 3))))
ccle_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CCLE" & InG2P == "Yes"))
ccle_cn_cor_filt <- filter(ccle_cn_cor, Drug_Gene == "lapatinib_ERBB2")
ccle_cn_filt <- filter(ccle, Drug_Gene == "lapatinib_ERBB2")
ccle_text <- data.frame(label = paste0("r = ", round(ccle_cn_cor_filt$CN_r, digits = 3), ", ", ccle_cn_cor_filt$p.format), Drug_Gene = ccle_cn_cor_filt$Drug_Gene)
ccle_cn_filt_plot <- ggplot(data = ccle_cn_filt, aes(x = CN, y = Score)) +
  # facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ccle_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "CCLE: Lapatinib, ERBB2", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ccle_cn_filt_plot, filename = "./plots/lapatinib_ERBB2_cn_ccle.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

ctrp_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CTRP" & InG2P == "Yes"))
ctrp_cn_cor_filt <- filter(ctrp_cn_cor, Drug_Gene == "lapatinib_ERBB2")
ctrp_cn_filt <- filter(ctrp, Drug_Gene == "lapatinib_ERBB2")
ctrp_text <- data.frame(label = paste0("r = ", round(ctrp_cn_cor_filt$CN_r, digits = 3), ", ", ctrp_cn_cor_filt$p.format), Drug_Gene = ctrp_cn_cor_filt$Drug_Gene)
ctrp_cn_filt_plot <- ggplot(data = ctrp_cn_filt, aes(x = CN, y = Score)) +
  # facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = ctrp_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "CTRP: Lapatinib, ERBB2", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_cn_filt_plot, filename = "./plots/lapatinib_ERBB2_cn_ctrp.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

gdsc_cn_cor <- unfactorize(filter(cn_cor, Dataset == "GDSC" & InG2P == "Yes"))
gdsc_cn_cor_filt <- filter(gdsc_cn_cor, Drug_Gene == "lapatinib_ERBB2")
gdsc_cn_filt <- filter(gdsc, Drug_Gene == "lapatinib_ERBB2")
gdsc_text <- data.frame(label = paste0("r = ", round(gdsc_cn_cor_filt$CN_r, digits = 3), ", ", gdsc_cn_cor_filt$p.format), Drug_Gene = gdsc_cn_cor_filt$Drug_Gene)
gdsc_cn_filt_plot <- ggplot(data = gdsc_cn_filt, aes(x = CN, y = Score)) +
  # facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = gdsc_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "GDSC: Lapatinib, ERBB2", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = gdsc_cn_filt_plot, filename = "./plots/lapatinib_ERBB2_cn_gdsc.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")













ge_cor$p.format <- with(ge_cor, ifelse(GE_p < 0.001, "p < 0.001", paste0("p = ", round(GE_p, digits = 3))))
gdsc_ge_cor <- unfactorize(filter(ge_cor, Dataset == "GDSC" & InG2P == "Yes"))
gdsc_ge_cor_filt <- filter(gdsc_ge_cor, Drug_Gene  == "lapatinib_ERBB2")
gdsc_ge_filt <- filter(gdsc, Drug_Gene  == "lapatinib_ERBB2")
gdsc_text <- data.frame(label = paste0("r = ", round(gdsc_ge_cor_filt$GE_r, digits = 3), ", ", gdsc_ge_cor_filt$p.format), Drug_Gene = gdsc_ge_cor_filt$Drug_Gene)
gdsc_ge_filt_plot <- ggplot(data = gdsc_ge_filt, aes(x = TPM, y = Score) )+
  # facet_wrap(~ Drug_Gene) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_text(data = gdsc_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.00)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "GDSC: Lapatinib, ERBB2", x = "Gene expression [log2(TPM)]", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = gdsc_ge_filt_plot, filename = "./plots/lapatinib_ERBB2_ge.png", width = 5, height = 3, units = "in", dpi = "retina", device = "png")
```

## Lineage plots

```{r}
ccle_mut_lin_filt <- filter(ccle, Drug_Gene_Lin == "erlotinib_EGFR_lung")
ccle_mut_lin_filt_plot <- ggplot(data = ccle_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  # facet_wrap(~ Drug_Gene_Lin, nrow = 1) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  # scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "springgreen4", "0" = "palegreen3")) +
  scale_color_manual(values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CCLE: Erlotinib, EGFR, lung", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none",axis.title.x = element_blank(),
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ccle_mut_lin_filt_plot, filename = "./plots/erlotinib_EGFR_lung_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

ctrp_mut_lin_filt <- filter(ctrp, Drug_Gene_Lin == "vemurafenib_BRAF_skin")
ctrp_mut_lin_filt_plot <- ggplot(data = ctrp_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  # facet_wrap(~ Drug_Gene_Lin, ncol = 4) +
  geom_violinhalf(aes(fill = as.character(Mutation)), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color =  disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.8) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "steelblue4", "0" = "slategray3")) +
  # scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("1" = "steelblue4", "0" = "slategray3")) +
  scale_color_manual(values = g2p_disease_colors) +
  scale_x_discrete(labels = c("0" = "Wildtype", "1" = "Mutant")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP: Vemurafenib, BRAF, skin", x = "Mutation Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_mut_lin_filt_plot, filename = "./plots/vemurafenib_BRAF_skin_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")





ctrp_prot_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change == "vemurafenib_BRAF:V600E")
ctrp_prot_filt_plot <- ggplot(data = ctrp_prot_filt, mapping = aes(x = Change_Status, y = Score)) +
  # facet_wrap(~ Drug_Gene_Protein_Change, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.7) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_color_manual(name = "Lineage", values = g2p_disease_colors) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP: Vemurafenib, BRAF:V600E", x = "Change Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_prot_filt_plot, filename = "./plots/vemurafenib_BRAF_V600E_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

ctrp_prot_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change == "dabrafenib_BRAF:V600E")
ctrp_prot_filt_plot <- ggplot(data = ctrp_prot_filt, mapping = aes(x = Change_Status, y = Score)) +
  # facet_wrap(~ Drug_Gene_Protein_Change, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.7) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_color_manual(name = "Lineage", values = g2p_disease_colors) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP: Dabrafenib, BRAF:V600E", x = "Change Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_prot_filt_plot, filename = "./plots/dabrafenib_BRAF_V600E_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")



ctrp_signif_prot_lin$disease_g2p <- ifelse(ctrp_signif_prot_lin$disease %in% g2p_diseases, ctrp_signif_prot_lin$disease, "other")
ctrp_signif_prot_lin_filt <- filter(ctrp_signif_prot_lin, InG2P == "Yes")
ctrp_prot_lin_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change_Lineage == "vemurafenib_BRAF:V600E_skin")
ctrp_prot_lin_filt_plot <- ggplot(data = ctrp_prot_lin_filt, mapping = aes(x = Change_Status, y = Score)) +
  # facet_wrap(~ Drug_Gene_Protein_Change_Lineage, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.4) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_color_manual(values = g2p_disease_colors) +
  # scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP: Vemurafenib, BRAF:V600E, skin", x = "Change Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_prot_lin_filt_plot, filename = "./plots/vemuerafenib_BRAF_V600E_skin_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

ctrp_signif_prot_lin$disease_g2p <- ifelse(ctrp_signif_prot_lin$disease %in% g2p_diseases, ctrp_signif_prot_lin$disease, "other")
ctrp_signif_prot_lin_filt <- filter(ctrp_signif_prot_lin, InG2P == "Yes")
ctrp_prot_lin_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change_Lineage == "dabrafenib_BRAF:V600E_skin")
ctrp_prot_lin_filt_plot <- ggplot(data = ctrp_prot_lin_filt, mapping = aes(x = Change_Status, y = Score)) +
  # facet_wrap(~ Drug_Gene_Protein_Change_Lineage, nrow = 2) +
  geom_violinhalf(aes(fill = Change_Status), position = position_nudge(x = 0.2, y = 0), alpha = 0.8, show.legend = FALSE) +
  geom_boxplot(width = 0.1, guides = FALSE, outlier.shape = NA, alpha = 0.4) +
  geom_point(aes(color = disease_g2p), position = position_jitter(width = 0.15), size = 0.5, alpha = 0.6) +
  scale_x_discrete(labels = c("No" = "Wildtype", "Yes" = "Mutant")) +
  scale_fill_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_color_manual(values = g2p_disease_colors) +
  # scale_color_manual(labels = c("Wildtype", "Mutant"), values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.10)) +
  stat_compare_means(method = "wilcox", aes(label = paste0("p = ", ..p.format..)), label.x = 1.35, label.y = 1.1) +
  labs(title = "CTRP: Dabrafenib, BRAF:V600E, skin", x = "Change Status", y = "AUC") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.position = "none", axis.title.x = element_blank(),
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_prot_lin_filt_plot, filename = "./plots/daberafenib_BRAF_V600E_skin_mut.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")





cn_cor_lin$p.format <- with(cn_cor_lin, ifelse(CN_p < 0.001, "p < 0.001", paste0("p = ", round(CN_p, digits = 3))))
ccle_cn_lin_cor <- unfactorize(filter(cn_cor_lin, Dataset == "CCLE" & InG2P == "Yes"))
ctrp_cn_lin_cor <- unfactorize(filter(cn_cor_lin, Dataset == "CTRP" & InG2P == "Yes"))
gdsc_cn_lin_cor <- unfactorize(filter(cn_cor_lin, Dataset == "GDSC" & InG2P == "Yes"))

ccle_cn_lin_cor_filt <- filter(ccle_cn_lin_cor, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ccle_cn_lin_filt <- filter(ccle, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ccle_lin_text <- data.frame(label = paste0("r = ", round(ccle_cn_lin_cor_filt$CN_r, digits = 3), ", ", ccle_cn_lin_cor_filt$p.format), Drug_Gene_Lin = ccle_cn_lin_cor_filt$Drug_Gene_Lin)
ccle_cn_lin_filt_plot <- ggplot(data = ccle_cn_lin_filt, aes(x = CN, y = Score)) +
  # facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  geom_text(data = ccle_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  coord_cartesian(ylim = c(0, 1)) +
  labs(title = "CCLE: Lapatinib, ERBB2, breast", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ccle_cn_lin_filt_plot, filename = "./plots/lapatinib_ERBB2_breast_cn_ccle.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

ctrp_cn_lin_cor_filt <- filter(ctrp_cn_lin_cor, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ctrp_cn_lin_filt <- filter(ctrp, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ctrp_lin_text <- data.frame(label = paste0("r = ", round(ctrp_cn_lin_cor_filt$CN_r, digits = 3), ", ", ctrp_cn_lin_cor_filt$p.format), Drug_Gene_Lin = ctrp_cn_lin_cor_filt$Drug_Gene_Lin)
ctrp_cn_lin_filt_plot <- ggplot(data = ctrp_cn_lin_filt, aes(x = CN, y = Score)) +
  # facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  geom_text(data = ctrp_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  labs(title = "CTRP: Lapatinib, ERBB2, breast", x = "Copy number (log2)", y = "AUC") +
  scale_color_manual(values = g2p_disease_colors) +
  coord_cartesian(ylim = c(0, 1)) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_cn_lin_filt_plot, filename = "./plots/lapatinib_ERBB2_breast_cn_ctrp.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")

gdsc_cn_lin_cor_filt <- filter(gdsc_cn_lin_cor, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
gdsc_cn_lin_filt <- filter(gdsc, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
gdsc_lin_text <- data.frame(label = paste0("r = ", round(gdsc_cn_lin_cor_filt$CN_r, digits = 3), ", ", gdsc_cn_lin_cor_filt$p.format), Drug_Gene_Lin = gdsc_cn_lin_cor_filt$Drug_Gene_Lin)
gdsc_cn_lin_filt_plot <- ggplot(data = gdsc_cn_lin_filt, aes(x = CN, y = Score) )+
  # facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  geom_text(data = gdsc_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.00)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "GDSC: Lapatinib, ERBB2, breast", x = "Copy number (log2)", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = gdsc_cn_lin_filt_plot, filename = "./plots/lapatinib_ERBB2_breast_cn_gdsc.png", width = 4, height = 3, units = "in", dpi = "retina", device = "png")









ge_cor_lin$p.format <- with(ge_cor_lin, ifelse(GE_p < 0.001, "p < 0.001", paste0("p = ", round(GE_p, digits = 3))))
ccle_ge_lin_cor <- unfactorize(filter(ge_cor_lin, Dataset == "CCLE" & InG2P == "Yes"))
ctrp_ge_lin_cor <- unfactorize(filter(ge_cor_lin, Dataset == "CTRP" & InG2P == "Yes"))
gdsc_ge_lin_cor <- unfactorize(filter(ge_cor_lin, Dataset == "GDSC" & InG2P == "Yes"))

ccle_ge_lin_cor_filt <- filter(ccle_ge_lin_cor, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ccle_ge_lin_filt <- filter(ccle, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ccle_lin_text <- data.frame(label = paste0("r = ", round(ccle_ge_lin_cor_filt$GE_r, digits = 3), ", ", ccle_ge_lin_cor_filt$p.format), Drug_Gene_Lin = ccle_ge_lin_cor_filt$Drug_Gene_Lin)
ccle_ge_lin_filt_plot <- ggplot(data = ccle_ge_lin_filt, aes(x = TPM, y = Score)) +
  # facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  geom_text(data = ccle_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_color_manual(values = g2p_disease_colors) +
  coord_cartesian(ylim = c(0, 1)) +
  labs(title = "CCLE: Lapatinib, ERBB2, breast", x = "Gene expression [log2(TPM)]", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "mintcream", colour = "mintcream", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ccle_ge_lin_filt_plot, filename = "./plots/lapatinib_ERBB2_breast_ge_ccle.png", width = 5, height = 3, units = "in", dpi = "retina", device = "png")

ctrp_ge_lin_cor_filt <- filter(ctrp_ge_lin_cor, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ctrp_ge_lin_filt <- filter(ctrp, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
ctrp_lin_text <- data.frame(label = paste0("r = ", round(ctrp_ge_lin_cor_filt$GE_r, digits = 3), ", ", ctrp_ge_lin_cor_filt$p.format), Drug_Gene_Lin = ctrp_ge_lin_cor_filt$Drug_Gene_Lin)
ctrp_ge_lin_filt_plot <- ggplot(data = ctrp_ge_lin_filt, aes(x = TPM, y = Score)) +
  # facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  geom_text(data = ctrp_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  labs(title = "CTRP: Lapatinib, ERBB2, breast", x = "Gene expression [log2(TPM)]", y = "AUC") +
  scale_color_manual(values = g2p_disease_colors) +
  coord_cartesian(ylim = c(0, 1)) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "whitesmoke", colour = "whitesmoke", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = ctrp_ge_lin_filt_plot, filename = "./plots/lapatinib_ERBB2_breast_ge_ctrp.png", width = 5, height = 3, units = "in", dpi = "retina", device = "png")

gdsc_ge_lin_cor_filt <- filter(gdsc_ge_lin_cor, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
gdsc_ge_lin_filt <- filter(gdsc, Drug_Gene_Lin == "lapatinib_ERBB2_breast")
gdsc_lin_text <- data.frame(label = paste0("r = ", round(gdsc_ge_lin_cor_filt$GE_r, digits = 3), ", ", gdsc_ge_lin_cor_filt$p.format), Drug_Gene_Lin = gdsc_ge_lin_cor_filt$Drug_Gene_Lin)
gdsc_ge_lin_filt_plot <- ggplot(data = gdsc_ge_lin_filt, aes(x = TPM, y = Score) )+
  # facet_wrap(~ Drug_Gene_Lin) +
  geom_point(aes(color = disease_g2p), pch = 20, size = 1, alpha = 0.7) +
  geom_smooth(stat = "smooth", method = "lm", color = "gray70", fill = "gray88", lwd = 1) +
  geom_text(data = gdsc_lin_text,
            mapping = aes(x = +Inf, y = +Inf, label = label,
            hjust = 1.1, vjust = 1.2)) +
  scale_y_continuous(breaks = seq(0, 1.00, by = 0.25), labels = c("0.00", "0.25", "0.50", "0.75", "1.00")) +
  coord_cartesian(ylim = c(0, 1.00)) +
  scale_color_manual(values = g2p_disease_colors) +
  labs(title = "GDSC: Lapatinib, ERBB2, breast", x = "Gene expression [log2(TPM)]", y = "AUC") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "azure", colour = "azure", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"), 
        panel.grid.minor = element_line(size = 0.25, linetype = 'solid', colour = "white"))
ggsave(plot = gdsc_ge_lin_filt_plot, filename = "./plots/lapatinib_ERBB2_breast_ge_gdsc.png", width = 5, height = 3, units = "in", dpi = "retina", device = "png")
```


## CN/GE heatmaps

```{r, eval=FALSE}
ccle_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CCLE" & Gene %in% unique(g2p_amp$Gene)))
ctrp_cn_cor <- unfactorize(filter(cn_cor, Dataset == "CTRP" & Gene %in% unique(g2p_amp$Gene)))
gdsc_cn_cor <- unfactorize(filter(cn_cor, Dataset == "GDSC" & Gene %in% unique(g2p_amp$Gene)))

ccle_cn_ht2 <- MakeCorrHeatmap(cor_res = ccle_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CCLE", color_range = c(-0.25, 0, 0.25), radius = 0.05, legend_title = "Copy num. Pearson correlation", metric = "CN")
ctrp_cn_ht2 <- MakeCorrHeatmap(cor_res = ctrp_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.25, 0, 0.25), radius = 0.05, legend_title = "Copy num. Pearson correlation", metric = "CN")
gdsc_cn_ht2 <- MakeCorrHeatmap(cor_res = gdsc_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.25, 0, 0.25), radius = 0.05, legend_title = "Copy num. Pearson correlation", metric = "CN")
png(filename = "./plots/sccb_cn_heatmap.png", width = 13, height = 2.7, units = "in", res = 500)
draw(ccle_cn_ht2 + ctrp_cn_ht2 + gdsc_cn_ht2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()

ccle_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CCLE" & Gene %in% unique(g2p_expr$Gene)))
ctrp_ge_cor <- unfactorize(filter(ge_cor, Dataset == "CTRP" & Gene %in% unique(g2p_expr$Gene)))
gdsc_ge_cor <- unfactorize(filter(ge_cor, Dataset == "GDSC" & Gene %in% unique(g2p_expr$Gene)))

ccle_ge_ht2 <- MakeCorrHeatmap(cor_res = ccle_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), radius = 0.08, legend_title = "Gene expr. Pearson correlation", metric = "GE")
ctrp_ge_ht2 <- MakeCorrHeatmap(cor_res = ctrp_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), radius = 0.08, legend_title = "Gene expr. Pearson correlation", metric = "GE")
gdsc_ge_ht2 <- MakeCorrHeatmap(cor_res = gdsc_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), radius = 0.08, legend_title = "Gene expr. Pearson correlation", metric = "GE")
png(filename = "./plots/sccb_ge_heatmap.png", width = 13, height = 2.4, units = "in", res = 500)
draw(ccle_ge_ht2 + ctrp_ge_ht2 + gdsc_ge_ht2, gap = unit(0.25, "in"), heatmap_legend_side = "top")
dev.off()
```

## KS test results

```{r fig.height=3, fig.width=4}
KSResultPlot <- function(dataframe, color_values, title_text, outfile, p_value, show) {
  if(p_value == "p") {
    sample1 <- filter(dataframe, InG2P == "Yes")$p
    sample2 <- filter(dataframe, InG2P == "No")$p
  }
  if(p_value == "CN_p") {
    sample1 <- filter(dataframe, InG2P == "Yes")$CN_p
    sample2 <- filter(dataframe, InG2P == "No")$CN_p
  }
  if(p_value == "GE_p") {
    sample1 <- filter(dataframe, InG2P == "Yes")$GE_p
    sample2 <- filter(dataframe, InG2P == "No")$GE_p
  }
  pval <- ks.test(sample1, sample2, alternative = "greater")$p.value
  
  cdf1 <- ecdf(sample1) 
  cdf2 <- ecdf(sample2) 
  
  # find min and max statistics to draw line between points of greatest distance
  minMax <- seq(min(sample1, sample2), max(sample1, sample2), length.out = length(sample1)) 
  x0 <- minMax[which(abs(cdf1(minMax) - cdf2(minMax)) == max(abs(cdf1(minMax) - cdf2(minMax))))] 
  y0 <- cdf1(x0) 
  y1 <- cdf2(x0) 
  
  if(p_value == "p") {
    ecdf_plot <- ggplot(dataframe, aes(x = p, group = InG2P, color = InG2P))+
      scale_color_manual(values = color_values) +
      stat_ecdf(size = 1) +
      theme_bw(base_size = 18) +
      theme(legend.position = "top",
            plot.title = element_text(size = 40)) +
      geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray", lwd = 0.5) +
      # annotate(geom = "text", label = paste0("KS test, p = ", round(p_value, digits = 3)), x = 0.18, y = 0.95) +
      labs(y = "ECDF", x = "P-value", title = paste0(title_text, ", KS test (p = ", round(pval, digits = 3), ")"), color = "In VICC?") +
      geom_segment(aes(x = x0[1], y = y0[1], xend = x0[1], yend = y1[1]), linetype = "dashed", color = "black") +
      geom_point(aes(x = x0[1] , y = y0[1]), color = "black", size = 2) +
      geom_point(aes(x = x0[1] , y = y1[1]), color = "black", size = 2) +
      coord_cartesian(xlim = c(0, 1))) +
      theme(legend.position = c(0.95, 0.30), legend.justification = c("right", "top"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6))
  }
  if(p_value == "CN_p") {
    ecdf_plot <- ggplot(dataframe, aes(x = CN_p, group = InG2P, color = InG2P))+
      scale_color_manual(values = color_values) +
      stat_ecdf(size = 1) +
      theme_bw(base_size = 18) +
      theme(legend.position = "top",
            plot.title = element_text(size = 40)) +
      geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray", lwd = 0.5) +
      # annotate(geom = "text", label = paste0("KS test, p = ", round(p_value, digits = 3)), x = 0.18, y = 0.95) +
      labs(y = "ECDF", x = "P-value", title = paste0(title_text, ", KS test (p = ", round(pval, digits = 3), ")"), color = "In VICC?") +
      geom_segment(aes(x = x0[1], y = y0[1], xend = x0[1], yend = y1[1]), linetype = "dashed", color = "black") +
      geom_point(aes(x = x0[1] , y = y0[1]), color = "black", size = 2) +
      geom_point(aes(x = x0[1] , y = y1[1]), color = "black", size = 2) +
      coord_cartesian(xlim = c(0, 1))) +
      theme(legend.position = c(0.95, 0.30), legend.justification = c("right", "top"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6))
  }
  if(p_value == "GE_p") {
    ecdf_plot <- ggplot(dataframe, aes(x = GE_p, group = InG2P, color = InG2P))+
      scale_color_manual(values = color_values) +
      stat_ecdf(size = 1) +
      theme_bw(base_size = 18) +
      theme(legend.position = "top",
            plot.title = element_text(size = 40)) +
      geom_vline(xintercept = 0.05, linetype = "dashed", color = "gray", lwd = 0.5) +
      # annotate(geom = "text", label = paste0("KS test, p = ", round(p_value, digits = 3)), x = 0.18, y = 0.95) +
      labs(y = "ECDF", x = "P-value", title = paste0(title_text, ", KS test (p = ", round(pval, digits = 3), ")"), color = "In VICC?") +
      geom_segment(aes(x = x0[1], y = y0[1], xend = x0[1], yend = y1[1]), linetype = "dashed", color = "black") +
      geom_point(aes(x = x0[1] , y = y0[1]), color = "black", size = 2) +
      geom_point(aes(x = x0[1] , y = y1[1]), color = "black", size = 2) +
      coord_cartesian(xlim = c(0, 1))) +
      theme(legend.position = c(0.95, 0.30), legend.justification = c("right", "top"), legend.box.just = "right", legend.margin = margin(6, 6, 6, 6))
  }
  
  if(!missing(outfile)) {
    ggsave(plot = ecdf_plot, filename = outfile, width = 8, height = 5, units = "in", dpi = "retina", device = "png")
  }
  
  if(show) {
    return(ecdf_plot)
  }
}
```

Mutation:
```{r, eval=FALSE}
ccle_mut_ht_dat <- filter(ccle_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3)
ctrp_mut_ht_dat <-filter(ctrp_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3)
gdsc_mut_ht_dat <- filter(gdsc_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3)

# ks.test(filter(ccle_mut_ht_dat, InG2P == "Yes")$p, filter(ccle_mut_ht_dat, InG2P == "No")$p, alternative = "greater")
# ks.test(filter(ctrp_mut_ht_dat, InG2P == "Yes")$p, filter(ctrp_mut_ht_dat, InG2P == "No")$p, alternative = "greater")
# ks.test(filter(gdsc_mut_ht_dat, InG2P == "Yes")$p, filter(gdsc_mut_ht_dat, InG2P == "No")$p, alternative = "greater")

KSResultPlot(dataframe = ccle_mut_ht_dat, color_values = c("Yes" = "springgreen4" , "No" = "palegreen3"), title_text = "CCLE", p_value = "p", outfile = "./plots/ks_test_results/ccle_mutation.png", show = TRUE)
KSResultPlot(dataframe = ctrp_mut_ht_dat, color_values = c("Yes" = "steelblue4" , "No" = "slategray3"), title_text = "CTRP", p_value = "p", outfile = "./plots/ks_test_results/ctrp_mutation.png", show = TRUE)
KSResultPlot(dataframe = gdsc_mut_ht_dat, color_values = c("Yes" = "turquoise4", "No" = "paleturquoise3"), title_text = "GDSC", p_value = "p", outfile = "./plots/ks_test_results/gdsc_mutation.png", show = TRUE)
```

Protein:
```{r, eval=FALSE}
# ks.test(filter(ccle_signif_prot_4plot, InG2P == "Yes")$p, filter(ccle_signif_prot_4plot, InG2P == "No")$p, alternative = "less")
# ks.test(filter(ctrp_signif_prot_4plot, InG2P == "Yes")$p, filter(ctrp_signif_prot_4plot, InG2P == "No")$p, alternative = "less")
# ks.test(filter(gdsc_signif_prot_4plot, InG2P == "Yes")$p, filter(gdsc_signif_prot_4plot, InG2P == "No")$p, alternative = "less")

KSResultPlot(dataframe = ccle_mut_ht_dat, color_values = c("Yes" = "springgreen4" , "No" = "palegreen3"), title_text = "CCLE", p_value = "p", outfile = "./plots/ks_test_results/ccle_protein.png", show = TRUE)
KSResultPlot(dataframe = ctrp_mut_ht_dat, color_values = c("Yes" = "steelblue4" , "No" = "slategray3"), title_text = "CTRP", p_value = "p", outfile = "./plots/ks_test_results/ctrp_protein.png", show = TRUE)
KSResultPlot(dataframe = gdsc_mut_ht_dat, color_values = c("Yes" = "turquoise4", "No" = "paleturquoise3"), title_text = "GDSC", p_value = "p", outfile = "./plots/ks_test_results/gdsc_protein.png", show = TRUE)
```

CN/GE:
```{r, eval=FALSE}
# cn_genes <- unique(filter(cn_cor, Dataset != "CRISPR" & InG2P == "Yes")$Gene)
ccle_cn_ht_data <- filter(cn_cor, Dataset == "CCLE" & Gene %in% g2p_amp$Gene)
ctrp_cn_ht_data <- filter(cn_cor, Dataset == "CTRP" & Gene %in% g2p_amp$Gene)
gdsc_cn_ht_data <- filter(cn_cor, Dataset == "GDSC" & Gene %in% g2p_amp$Gene)

# ks.test(filter(ccle_cn_ht_data, InG2P == "Yes")$CN_p, filter(ccle_cn_ht_data, InG2P == "No")$CN_p, alternative = "greater")
# ks.test(filter(ctrp_cn_ht_data, InG2P == "Yes")$CN_p, filter(ctrp_cn_ht_data, InG2P == "No")$CN_p, alternative = "greater")
# ks.test(filter(gdsc_cn_ht_data, InG2P == "Yes")$CN_p, filter(gdsc_cn_ht_data, InG2P == "No")$CN_p, alternative = "greater")

KSResultPlot(dataframe = ccle_cn_ht_data, color_values = c("Yes" = "springgreen4" , "No" = "palegreen3"), title_text = "CCLE", p_value = "CN_p", outfile = "./plots/ks_test_results/ccle_copynumber.png", show = TRUE)
KSResultPlot(dataframe = ctrp_cn_ht_data, color_values = c("Yes" = "steelblue4" , "No" = "slategray3"), title_text = "CTRP", p_value = "CN_p", outfile = "./plots/ks_test_results/ctrp_copynumber.png", show = TRUE)
KSResultPlot(dataframe = gdsc_cn_ht_data, color_values = c("Yes" = "turquoise4", "No" = "paleturquoise3"), title_text = "GDSC", p_value = "CN_p", outfile = "./plots/ks_test_results/gdsc_copynumber.png", show = TRUE)

# ge_genes <- unique(filter(ge_cor, Dataset != "CRISPR" & InG2P == "Yes")$Gene)
ccle_ge_ht_data <- filter(ge_cor, Dataset == "CCLE" & Gene %in% g2p_expr$Gene)
ctrp_ge_ht_data <- filter(ge_cor, Dataset == "CTRP" & Gene %in% g2p_expr$Gene)
gdsc_ge_ht_data <- filter(ge_cor, Dataset == "GDSC" & Gene %in% g2p_expr$Gene)

# ks.test(filter(ccle_ge_ht_data, InG2P == "Yes")$GE_p, filter(ccle_ge_ht_data, InG2P == "No")$GE_p, alternative = "greater")
# ks.test(filter(ctrp_ge_ht_data, InG2P == "Yes")$GE_p, filter(ctrp_ge_ht_data, InG2P == "No")$GE_p, alternative = "greater")
# ks.test(filter(gdsc_ge_ht_data, InG2P == "Yes")$GE_p, filter(gdsc_ge_ht_data, InG2P == "No")$GE_p, alternative = "greater")

KSResultPlot(dataframe = ccle_ge_ht_data, color_values = c("Yes" = "springgreen4" , "No" = "palegreen3"), title_text = "CCLE", p_value = "GE_p", outfile = "./plots/ks_test_results/ccle_geneexpression.png", show = TRUE)
KSResultPlot(dataframe = ctrp_ge_ht_data, color_values = c("Yes" = "steelblue4" , "No" = "slategray3"), title_text = "CTRP", p_value = "GE_p", outfile = "./plots/ks_test_results/ctrp_geneexpression.png", show = TRUE)
KSResultPlot(dataframe = gdsc_ge_ht_data, color_values = c("Yes" = "turquoise4", "No" = "paleturquoise3"), title_text = "GDSC", p_value = "GE_p", outfile = "./plots/ks_test_results/gdsc_geneexpression.png", show = TRUE)

# cn_genes <- unique(filter(cn_cor, Dataset != "CRISPR" & InG2P == "Yes")$Gene)
# cn_drugs <- unique(filter(cn_cor, Dataset != "CRISPR" & InG2P == "Yes")$Drug)
# 
# ccle_cn_ht_data <- filter(cn_cor, Dataset == "CCLE" & Drug %in% cn_drugs & Gene %in% cn_genes)
# ks.test(filter(ccle_cn_ht_data, InG2P == "Yes")$CN_p, filter(ccle_cn_ht_data, InG2P == "No")$CN_p)
# ctrp_cn_ht_data <- filter(cn_cor, Dataset == "CTRP" & Drug %in% cn_drugs & Gene %in% cn_genes)
# ks.test(filter(ctrp_cn_ht_data, InG2P == "Yes")$CN_p, filter(ctrp_cn_ht_data, InG2P == "No")$CN_p)
# gdsc_cn_ht_data <- filter(cn_cor, Dataset == "GDSC" & Drug %in% cn_drugs & Gene %in% cn_genes)
# ks.test(filter(gdsc_cn_ht_data, InG2P == "Yes")$CN_p, filter(gdsc_cn_ht_data, InG2P == "No")$CN_p)
# 
# ge_genes <- unique(filter(ge_cor, Dataset != "CRISPR" & InG2P == "Yes")$Gene)
# ge_drugs <- unique(filter(ge_cor, Dataset != "CRISPR" & InG2P == "Yes")$Drug)
# 
# ccle_ge_ht_data <- filter(ge_cor, Dataset == "CCLE" & Drug %in% ge_drugs & Gene %in% ge_genes)
# ks.test(filter(ccle_ge_ht_data, InG2P == "Yes")$GE_p, filter(ccle_ge_ht_data, InG2P == "No")$GE_p)
# ctrp_ge_ht_data <- filter(ge_cor, Dataset == "CTRP" & Drug %in% ge_drugs & Gene %in% ge_genes)
# ks.test(filter(ctrp_ge_ht_data, InG2P == "Yes")$GE_p, filter(ctrp_ge_ht_data, InG2P == "No")$GE_p)
# gdsc_ge_ht_data <- filter(ge_cor, Dataset == "GDSC" & Drug %in% ge_drugs & Gene %in% ge_genes)
# ks.test(filter(gdsc_ge_ht_data, InG2P == "Yes")$GE_p, filter(gdsc_ge_ht_data, InG2P == "No")$GE_p)
```

Lineage:
```{r lineages_ks_tests, warning=FALSE}
ks.test(filter(ccle_signif_dgl, disease %in% g2p_diseases & InG2P == "Yes")$p, filter(ccle_signif_dgl, disease %in% g2p_diseases & InG2P == "No")$p, alternative = "greater")$p.value
ks.test(filter(ctrp_signif_dgl, disease %in% g2p_diseases & InG2P == "Yes")$p, filter(ctrp_signif_dgl, disease %in% g2p_diseases & InG2P == "No")$p, alternative = "greater")$p.value
ks.test(filter(gdsc_signif_dgl, disease %in% g2p_diseases & InG2P == "Yes")$p, filter(gdsc_signif_dgl, disease %in% g2p_diseases & InG2P == "No")$p, alternative = "greater")$p.value

# ccle_signif_dgl_filt <- filter(ccle_signif_dgl, disease %in% g2p_diseases)
# KSResultPlot(dataframe = ,ccle_signif_dgl_filt, color_values = c("Yes" = "springgreen4" , "No" = "palegreen3"), title_text = "CCLE", p_value = "p", outfile = "./plots/ks_test_results/ccle_mut_lin.png", show = TRUE)
# KSResultPlot(dataframe = filter(ctrp_signif_dgl, disease %in% g2p_diseases), color_values = c("Yes" = "steelblue4" , "No" = "slategray3"), title_text = "CTRP", p_value = "p", outfile = "./plots/ks_test_results/ctrp_mut_lin.png", show = TRUE)
# KSResultPlot(dataframe = filter(gdsc_signif_dgl, disease %in% g2p_diseases), color_values = c("Yes" = "turquoise4", "No" = "paleturquoise3"), title_text = "GDSC", p_value = "p", outfile = "./plots/ks_test_results/gdsc_mut_lin.png", show = TRUE)
# 

ks.test(filter(ccle_signif_prot_lin, disease %in% g2p_diseases & InG2P == "Yes")$p, filter(ccle_signif_prot_lin, disease %in% g2p_diseases & InG2P == "No")$p, alternative = "greater")$p.value
ks.test(filter(ctrp_signif_prot_lin, disease %in% g2p_diseases & InG2P == "Yes")$p, filter(ctrp_signif_prot_lin, disease %in% g2p_diseases & InG2P == "No")$p, alternative = "greater")$p.value
ks.test(filter(gdsc_signif_prot_lin, disease %in% g2p_diseases & InG2P == "Yes")$p, filter(gdsc_signif_prot_lin, disease %in% g2p_diseases & InG2P == "No")$p, alternative = "greater")$p.value

ks.test(filter(cn_cor_lin, Dataset == "CCLE" & disease %in% g2p_diseases & InG2P == "Yes")$CN_p, filter(cn_cor_lin, Dataset == "CCLE" & disease %in% g2p_diseases & InG2P == "No")$CN_p, alternative = "greater")$p.value
ks.test(filter(cn_cor_lin, Dataset == "CTRP" & disease %in% g2p_diseases & InG2P == "Yes")$CN_p, filter(cn_cor_lin, Dataset == "CTRP" & disease %in% g2p_diseases & InG2P == "No")$CN_p, alternative = "greater")$p.value
ks.test(filter(cn_cor_lin, Dataset == "GDSC" & disease %in% g2p_diseases & InG2P == "Yes")$CN_p, filter(cn_cor_lin, Dataset == "GDSC" & disease %in% g2p_diseases & InG2P == "No")$CN_p, alternative = "greater")$p.value

ks.test(filter(ge_cor_lin, Dataset == "CCLE" & disease %in% g2p_diseases & InG2P == "Yes")$GE_p, filter(ge_cor_lin, Dataset == "CCLE" & disease %in% g2p_diseases & InG2P == "No")$GE_p, alternative = "greater")$p.value
ks.test(filter(ge_cor_lin, Dataset == "CTRP" & disease %in% g2p_diseases & InG2P == "Yes")$GE_p, filter(ge_cor_lin, Dataset == "CTRP" & disease %in% g2p_diseases & InG2P == "No")$GE_p, alternative = "greater")$p.value
ks.test(filter(ge_cor_lin, Dataset == "GDSC" & disease %in% g2p_diseases & InG2P == "Yes")$GE_p, filter(ge_cor_lin, Dataset == "GDSC" & disease %in% g2p_diseases & InG2P == "No")$GE_p, alternative = "greater")$p.value


lineage_ks_results <- data.frame("Dataset" = c(rep(c("CCLE", "CTRP", "GDSC"), 4)),
           "Data type" = c(rep("Mutation", 3), rep("Protein change", 3), rep("Copy number", 3), rep("Gene expression", 3)),
  "p.value" = c(ks.test(filter(ccle_signif_dgl, InG2P == "Yes")$p, filter(ccle_signif_dgl, InG2P == "No")$p)$p.value,
  ks.test(filter(ctrp_signif_dgl, InG2P == "Yes")$p, filter(ctrp_signif_dgl, InG2P == "No")$p)$p.value,
  ks.test(filter(gdsc_signif_dgl, InG2P == "Yes")$p, filter(gdsc_signif_dgl, InG2P == "No")$p)$p.value,
  ks.test(filter(ccle_signif_prot_lin, InG2P == "Yes")$p, filter(ccle_signif_prot_lin, InG2P == "No")$p)$p.value,
  ks.test(filter(ctrp_signif_prot_lin, InG2P == "Yes")$p, filter(ctrp_signif_prot_lin, InG2P == "No")$p)$p.value,
  ks.test(filter(gdsc_signif_prot_lin, InG2P == "Yes")$p, filter(gdsc_signif_prot_lin, InG2P == "No")$p)$p.value,
  ks.test(filter(cn_cor_lin, Dataset == "CCLE" & InG2P == "Yes")$CN_p, filter(cn_cor_lin, Dataset == "CCLE" & InG2P == "No")$CN_p)$p.value,
  ks.test(filter(cn_cor_lin, Dataset == "CTRP" & InG2P == "Yes")$CN_p, filter(cn_cor_lin, Dataset == "CTRP" & InG2P == "No")$CN_p)$p.value,
  ks.test(filter(cn_cor_lin, Dataset == "GDSC" & InG2P == "Yes")$CN_p, filter(cn_cor_lin, Dataset == "GDSC" & InG2P == "No")$CN_p)$p.value,
  ks.test(filter(ge_cor_lin, Dataset == "CCLE" & InG2P == "Yes")$GE_p, filter(ge_cor_lin, Dataset == "CCLE" & InG2P == "No")$GE_p)$p.value,
  ks.test(filter(ge_cor_lin, Dataset == "CTRP" & InG2P == "Yes")$GE_p, filter(ge_cor_lin, Dataset == "CTRP" & InG2P == "No")$GE_p)$p.value,
  ks.test(filter(ge_cor_lin, Dataset == "GDSC" & InG2P == "Yes")$GE_p, filter(ge_cor_lin, Dataset == "GDSC" & InG2P == "No")$GE_p)$p.value))
```


# OLD CODE

--------------------------------------------------------------------------------

## OLD: First draft figures

```{r Figure3_mutation, fig.height=12, fig.width=12, eval=FALSE}
# A: Heatmap
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = filter(ccle_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "CCLE -log10(p-value)          ", legend_breaks = seq(0, 12, by = 3), row_names = FALSE, color = "darkgreen", col_title = "", row_title_txt = "Genes", radius = 0.023)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = filter(ctrp_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "CTRP -log10(p-value)          ", legend_breaks = seq(0, 18, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Genes", radius = 0.006)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = filter(gdsc_signif_g2p_dg, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "mutation", legend_title = "GDSC -log10(p-value)          ", legend_breaks = seq(0, 5, by = 1), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Genes", radius = 0.011)
ht_crispr2 <- MakeWilcoxonHeatmap(signif_df = filter(crispr_signif_g2p_g, Gene %in% unique(g2p_mut$Gene) & Mutation_1_count >= 3), feature = "crispr", legend_title = "CRISPR -log10(p-value)", legend_breaks = seq(0, 45, by = 9), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Genes", radius = 0.15)
ht_mut_list <- ht_crispr2 + ht_ccle2 + ht_ctrp2 + ht_gdsc2
ht_mut_grob <- grid.grabExpr(draw(ht_mut_list, gap = unit(0.25, "in"), heatmap_legend_side = "right"))

# B: Mutation status
crispr_mut_df <- crispr_signif_g2p_g %>% filter(Gene %in% unique(g2p_mut$Gene), p < 0.05) %>% select(Drug, Gene, p.format, `n WT/mut`)
crispr_mut_df <- add_column(crispr_mut_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_mut_df) - 1)))
crispr_mut_df$Drug <- NA
ccle_mut_df <- ccle_signif_g2p_dg %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene, p.format, `n WT/mut`)
ccle_mut_df <- add_column(ccle_mut_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_mut_df) - 1)))
ctrp_mut_df <- ctrp_signif_g2p_dg %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene, p.format, `n WT/mut`)
ctrp_mut_df <- add_column(ctrp_mut_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_mut_df) - 1)))
gdsc_mut_df <- gdsc_signif_g2p_dg %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene, p.format, `n WT/mut`)
gdsc_mut_df <- add_column(gdsc_mut_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_mut_df) - 1)))
mut_signif_tb <- tableGrob(rbind(crispr_mut_df, ccle_mut_df, ctrp_mut_df, gdsc_mut_df), rows = NULL)
# drug_mut_signif_title <- textGrob("Drug screens", gp = gpar(fontsize = 20))
# padding <- unit(0.5, "line")
# mut_signif_tb <- gtable_add_rows(mut_signif_tb, heights = grobHeight(drug_mut_signif_title) + padding, pos = 0)
# mut_signif_tb <- gtable_add_grob(mut_signif_tb, list(drug_mut_signif_title), t = 1, l = 1, r = ncol(mut_signif_tb))

# D: Mutation status (lineage)
crispr_mut_lin_df <- crispr_signif_lin %>% filter(Gene_Lin %in% unique(g2p_mut$Gene_Lin), p < 0.05) %>% select(Drug, Gene, disease, p.format, `n WT/mut`)
crispr_mut_lin_df <- add_column(crispr_mut_lin_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_mut_lin_df) - 1)))
crispr_mut_lin_df$Drug <- NA
ccle_mut_lin_df <- ccle_signif_dgl %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene, disease, p.format, `n WT/mut`)
ccle_mut_lin_df <- add_column(ccle_mut_lin_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_mut_lin_df) - 1)))
ctrp_mut_lin_df <- ctrp_signif_dgl %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene, disease, p.format, `n WT/mut`)
ctrp_mut_lin_df <- add_column(ctrp_mut_lin_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_mut_lin_df) - 1)))
gdsc_mut_lin_df <- gdsc_signif_dgl %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene, disease, p.format, `n WT/mut`)
gdsc_mut_lin_df <- add_column(gdsc_mut_lin_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_mut_lin_df) - 1)))
mut_lin_signif_tb <- tableGrob(rbind(crispr_mut_lin_df, ccle_mut_lin_df, ctrp_mut_lin_df, gdsc_mut_lin_df), rows = NULL)
# mut_lin_signif_tb <- gtable_add_rows(mut_lin_signif_tb, heights = grobHeight(drug_mut_signif_title) + padding, pos = 0)
# mut_lin_signif_tb <- gtable_add_grob(mut_lin_signif_tb, list(drug_mut_signif_title), t = 1, l = 1, r = ncol(mut_lin_signif_tb))

# C and E: Boxplots
crispr_mut_filt <- filter(crispr, Gene %in% c("BRAF", "KRAS"))
crispr_mut_filt_plot <- ggplot(data = crispr_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Gene) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("0", "1"))) +
  labs(title = "CRISPR, lineage agnostic", x = "Mutation Status")

crispr_mut_lin_filt <- filter(crispr, Drug_Gene_Lin %in% c("CRISPR_KRAS_lung", "CRISPR_BRAF_skin"))
crispr_mut_lin_filt_plot <- ggplot(data = crispr_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene_Lin) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("0", "1"))) +
  labs(title = "CRISPR, lung and skin", x = "Mutation Status")

ctrp_mut_filt <- filter(ctrp, Drug_Gene %in% c("afatinib_KRAS", "dabrafenib_BRAF"))
ctrp_mut_filt_plot <- ggplot(data = ctrp_mut_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("0", "1"))) +
  labs(title = "CTRP, lineage agnostic", x = "Mutation Status")

ctrp_mut_lin_filt <- filter(ctrp, Drug_Gene_Lin %in% c("afatinib_KRAS_lung", "dabrafenib_BRAF_skin"))
ctrp_mut_lin_filt_plot <- ggplot(data = ctrp_mut_lin_filt, mapping = aes(x = as.character(Mutation), y = Score)) +
  facet_wrap(~ Drug_Gene_Lin) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("0", "1"))) +
  labs(title = "CTRP, lung and skin", x = "Mutation Status")

# Make figure
lay <- rbind(c(1, 1, 1, 1),
             c(1, 1, 1, 1),
             c(2, 3, 3, 3),
             c(4, 5, 5, 5))

png(filename = "./plots/manuscript/figure3_mutation_status.png", width = 25, height = 25, units = "in", res = 500)
grid.arrange(layout_matrix = lay,
             arrangeGrob(ht_mut_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(mut_signif_tb, left = textGrob("B", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_mut_filt_plot), ggplotGrob(ctrp_mut_filt_plot), nrow = 1, left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(mut_lin_signif_tb, left = textGrob("D", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_mut_lin_filt_plot), ggplotGrob(ctrp_mut_lin_filt_plot), nrow = 1, left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))
dev.off()
```



```{r Figure4_protein_change, fig.height=12, fig.width=12, eval=FALSE}
# A: Heatmap
ht_ccle2 <- MakeWilcoxonHeatmap(signif_df = ccle_signif_prot_4plot, feature = "protein changes", legend_title = "CCLE -log10(p-value)          ", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "darkgreen", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.021)
ht_ctrp2 <- MakeWilcoxonHeatmap(signif_df = ctrp_signif_prot_4plot, feature = "protein changes", legend_title = "CTRP -log10(p-value)          ", legend_breaks = seq(0, 15, by = 3), row_names = FALSE, color = "steelblue4", col_title = "Drugs", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.009)
ht_gdsc2 <- MakeWilcoxonHeatmap(signif_df = gdsc_signif_prot_4plot, feature = "protein changes", legend_title = "GDSC -log10(p-value)          ", legend_breaks = seq(0, 8, by = 2), row_names = FALSE, color = "turquoise4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.0125)
ht_crispr2 <- MakeWilcoxonHeatmap(signif_df = crispr_signif_prot_4plot, feature = "protein changes CRISPR", legend_title = "CRISPR -log10(p-value)", legend_breaks = seq(0, 25, by = 5), row_names = TRUE, color = "darkorchid4", col_title = "", row_title_txt = "Gene:Protein Change", na_color = "black", radius = 0.135)
ht_prot_list <- ht_crispr2 + ht_ccle2 + ht_ctrp2 + ht_gdsc2
ht_prot_grob <- grid.grabExpr(draw(ht_prot_list, gap = unit(0.25, "in"), heatmap_legend_side = "right"))

# B: Protein chnages (agnostic)
crispr_prot_df <- crispr_signif_prot %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, p.format, `n WT/mut`)
crispr_prot_df <- add_column(crispr_prot_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_prot_df) - 1)))
crispr_prot_df$Drug <- NA
ccle_prot_df <- ccle_signif_prot %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, p.format, `n WT/mut`)
# ccle_prot_df <- add_column(ccle_prot_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_prot_df) - 1)))
ctrp_prot_df <- ctrp_signif_prot %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, p.format, `n WT/mut`)
ctrp_prot_df <- add_column(ctrp_prot_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_prot_df) - 1)))
gdsc_prot_df <- gdsc_signif_prot %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, p.format, `n WT/mut`)
gdsc_prot_df <- add_column(gdsc_prot_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_prot_df) - 1)))
prot_signif_tb <- tableGrob(rbind(crispr_prot_df, ccle_prot_df, ctrp_prot_df, gdsc_prot_df), rows = NULL)

# D: Protein chnages (lineage)
crispr_prot_lin_df <- crispr_signif_prot_lin %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, disease, p.format, `n WT/mut`)
crispr_prot_lin_df <- add_column(crispr_prot_lin_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_prot_lin_df) - 1)))
crispr_prot_lin_df$Drug <- NA
ccle_prot_lin_df <- ccle_signif_prot_lin %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, disease, p.format, `n WT/mut`)
# ccle_prot_lin_df <- add_column(ccle_prot_lin_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_prot_lin_df) - 1)))
ctrp_prot_lin_df <- ctrp_signif_prot_lin %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, disease, p.format, `n WT/mut`)
ctrp_prot_lin_df <- add_column(ctrp_prot_lin_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_prot_lin_df) - 1)))
gdsc_prot_lin_df <- gdsc_signif_prot_lin %>% filter(InG2P == "Yes", p < 0.05) %>% select(Drug, Gene_Protein_Change, disease, p.format, `n WT/mut`)
# gdsc_prot_lin_df <- add_column(gdsc_prot_lin_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_prot_lin_df) - 1)))
prot_lin_signif_tb <- tableGrob(rbind(crispr_prot_lin_df, ccle_prot_lin_df, ctrp_prot_lin_df, gdsc_prot_lin_df), rows = NULL)

# C and E: Boxplots
crispr_prot_filt <- filter(crispr_prot, Gene_Protein_Change %in% c("BRAF:V600E", "KRAS:G12C", "KRAS:G12D", "KRAS:G12V"))
crispr_prot_filt_plot <- ggplot(data = crispr_prot_filt, mapping = aes(x = as.character(Change_Status), y = Score)) +
  facet_wrap(~ Gene_Protein_Change, nrow = 1) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("No", "Yes"))) +
  labs(title = "CRISPR, lineage agnostic", x = "Protein Change Status")

crispr_prot_lin_filt <- filter(crispr_prot, Gene_Protein_Change_Lineage %in% c("BRAF:V600E_skin", "KRAS:G12C_lung"))
crispr_prot_lin_filt_plot <- ggplot(data = crispr_prot_lin_filt, mapping = aes(x = as.character(Change_Status), y = Score)) +
  facet_wrap(~ Gene_Protein_Change_Lineage, nrow = 1) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("No", "Yes"))) +
  labs(title = "CRISPR, lung and skin", x = "Protein Change Status")

ctrp_prot_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change %in% c("dabrafenib_BRAF:V600E", "trametinib_BRAF:V600E", "vemurafenib_BRAF:V600E", "afatinib_KRAS:G12D"))
ctrp_prot_filt_plot <- ggplot(data = ctrp_prot_filt, mapping = aes(x = as.character(Change_Status), y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change, nrow = 1) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("No", "Yes"))) +
  labs(title = "CTRP, lineage agnostic", x = "Protein Change Status")

ctrp_prot_lin_filt <- filter(ctrp_prot, Drug_Gene_Protein_Change_Lineage %in% c("dabrafenib_BRAF:V600E_skin", "vemurafenib_BRAF:V600E_skin"))
ctrp_prot_lin_filt_plot <- ggplot(data = ctrp_prot_lin_filt, mapping = aes(x = as.character(Change_Status), y = Score)) +
  facet_wrap(~ Drug_Gene_Protein_Change_Lineage, nrow = 1) +
  geom_violin() +
  geom_boxplot(outlier.shape = NA, width = 0.07) +
  stat_compare_means(method = "wilcox", comparisons = list(c("No", "Yes"))) +
  labs(title = "CTRP, skin", x = "Protein Change Status")

# Make figure
lay <- rbind(c(1, 1, 1, 1),
             c(1, 1, 1, 1),
             c(2, 3, 3, 3),
             c(2, 3, 3, 3),
             c(4, 5, 5, 5))

png(filename = "./plots/manuscript/figure4_protein_changes.png", width = 25, height = 25, units = "in", res = 500)
grid.arrange(layout_matrix = lay,
             arrangeGrob(ht_prot_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(prot_signif_tb, left = textGrob("B", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_prot_filt_plot), ggplotGrob(ctrp_prot_filt_plot), nrow = 2, left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(prot_lin_signif_tb, left = textGrob("D", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_prot_lin_filt_plot), ggplotGrob(ctrp_prot_lin_filt_plot), nrow = 1, left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))
dev.off()
```


```{r Figure5_cn, fig.height=8, fig.width=12, eval=FALSE}
# A: Heatmap
crispr_cn_ht2 <- MakeCorrHeatmap(cor_res = crispr_cn_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CRISPR", color_range = c(-0.25, 0, 0.25), radius = 0.15, legend_title = "Copy num. Spearman correlation", metric = "CN")
ccle_cn_ht2 <- MakeCorrHeatmap(cor_res = ccle_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CCLE", color_range = c(-0.25, 0, 0.25), radius = 0.0215, legend_title = "Copy num. Spearman correlation", metric = "CN")
ctrp_cn_ht2 <- MakeCorrHeatmap(cor_res = ctrp_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.25, 0, 0.25), radius = 0.0215, legend_title = "Copy num. Spearman correlation", metric = "CN")
gdsc_cn_ht2 <- MakeCorrHeatmap(cor_res = gdsc_cn_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.25, 0, 0.25), radius = 0.0215, legend_title = "Copy num. Spearman correlation", metric = "CN")
ht_cn_list <- crispr_cn_ht2 + ccle_cn_ht2 + ctrp_cn_ht2 + gdsc_cn_ht2
ht_cn_grob <- grid.grabExpr(draw(ht_cn_list, gap = unit(0.25, "in"), heatmap_legend_side = "top"))

# B: Copy number (agnostic)
crispr_cn_df <- crispr_cn_cor %>% filter(InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene, CN_r, CN_p, n)
crispr_cn_df <- add_column(crispr_cn_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_cn_df) - 1)))
crispr_cn_df$Drug <- NA
ccle_cn_df <- ccle_cn_cor %>% filter(InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene, CN_r, CN_p, n)
ccle_cn_df <- add_column(ccle_cn_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_cn_df) - 1)))
ctrp_cn_df <- ctrp_cn_cor %>% filter(InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene, CN_r, CN_p, n)
ctrp_cn_df <- add_column(ctrp_cn_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_cn_df) - 1)))
gdsc_cn_df <- gdsc_cn_cor %>% filter(InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene,CN_r,  CN_p, n)
# gdsc_cn_df <- add_column(gdsc_cn_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_cn_df) - 1)))
cn_signif_tb <- tableGrob(rbind(crispr_cn_df, ccle_cn_df, ctrp_cn_df, gdsc_cn_df), rows = NULL)

# D: Copy number (lineage)
crispr_cn_lin_df <- cn_cor_lin %>% filter(Dataset == "CRISPR", InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene, disease, CN_r, CN_p, n)
crispr_cn_lin_df <- add_column(crispr_cn_lin_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_cn_lin_df) - 1)))
crispr_cn_lin_df$Drug <- NA
ccle_cn_lin_df <- cn_cor_lin %>% filter(Dataset == "CCLE", InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene,disease,  CN_r, CN_p, n)
ccle_cn_lin_df <- add_column(ccle_cn_lin_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_cn_lin_df) - 1)))
ctrp_cn_lin_df <- cn_cor_lin %>% filter(Dataset == "CTRP", InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene, disease, CN_r, CN_p, n)
ctrp_cn_lin_df <- add_column(ctrp_cn_lin_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_cn_lin_df) - 1)))
gdsc_cn_lin_df <- cn_cor_lin %>% filter(Dataset == "GDSC", InG2P == "Yes", CN_p < 0.05) %>% select(Drug, Gene, disease, CN_r,  CN_p, n)
gdsc_cn_lin_df <- add_column(gdsc_cn_lin_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_cn_lin_df) - 1)))
cn_lin_signif_tb <- tableGrob(rbind(crispr_cn_lin_df, ccle_cn_lin_df, ctrp_cn_lin_df, gdsc_cn_lin_df), rows = NULL)

# C and E: Scatterplots
crispr_cn_filt <- filter(crispr, Gene %in% c("ERBB2"))
crispr_cn_filt_plot <- ggplot(data = crispr_cn_filt, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CRISPR: ERBB2", x = "Copy Number")

ccle_cn_filt1 <- filter(ccle, Drug_Gene %in% c("erlotinib_MET"))
ccle_cn_filt_plot1 <- ggplot(data = ccle_cn_filt1, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CCLE: erlotinib, MET", x = "Copy Number")

ccle_cn_filt2 <- filter(ccle, Drug_Gene %in% c("lapatinib_ERBB2"))
ccle_cn_filt_plot2 <- ggplot(data = ccle_cn_filt2, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CCLE: lapatinib, ERBB2", x = "Copy Number")

ctrp_cn_filt <- filter(ccle, Drug_Gene %in% c("erlotinib_MET"))
ctrp_cn_filt_plot <- ggplot(data = ctrp_cn_filt, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CTRP: erlotinib, MET", x = "Copy Number")

crispr_cn_lin_filt <- filter(crispr, Gene_Lin %in% c("ERBB2_breast"))
crispr_cn_lin_filt_plot <- ggplot(data = crispr_cn_lin_filt, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CRISPR: ERBB2, breast", x = "Copy Number")

ccle_cn_lin_filt <- filter(ccle, Drug_Gene_Lin %in% c("lapatinib_ERBB2_breast"))
ccle_cn_lin_filt_plot <- ggplot(data = ccle_cn_lin_filt, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CCLE: lapatinib, ERBB2, breast", x = "Copy Number")

ctrp_cn_lin_filt <- filter(ccle, Drug_Gene_Lin %in% c("lapatinib_ERBB2_breast"))
ctrp_cn_lin_filt_plot <- ggplot(data = ctrp_cn_lin_filt, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "CTRP: lapatinib, ERBB2, breast", x = "Copy Number")

gdsc_cn_lin_filt <- filter(ccle, Drug_Gene_Lin %in% c("lapatinib_ERBB2_breast"))
gdsc_cn_lin_filt_plot <- ggplot(data = gdsc_cn_lin_filt, mapping = aes(x = CN, y = Score)) +
  geom_point() +
  labs(title = "GDSC: lapatinib, ERBB2, breast", x = "Copy Number")

# Make figure
lay <- rbind(c(1, 1, 1, 1),
             c(2, 3, 3, 3),
             c(4, 5, 5, 5))

png(filename = "./plots/manuscript/figure5_copy_number.png", width = 25, height = 16, units = "in", res = 500)
grid.arrange(layout_matrix = lay,
             arrangeGrob(ht_cn_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(cn_signif_tb, left = textGrob("B", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_cn_filt_plot), ggplotGrob(ccle_cn_filt_plot1), ggplotGrob(ccle_cn_filt_plot2), ggplotGrob(ctrp_cn_filt_plot), nrow = 1, left = textGrob("C", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(cn_lin_signif_tb, left = textGrob("D", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_cn_lin_filt_plot), ggplotGrob(ccle_cn_lin_filt_plot), ggplotGrob(ctrp_cn_lin_filt_plot), ggplotGrob(gdsc_cn_lin_filt_plot), nrow = 1, left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))
dev.off()
```


```{r Figure6_ge, fig.height=8, fig.width=12, eval=FALSE}
# A: Heatmap
crispr_ge_ht2 <- MakeCorrHeatmap(cor_res = crispr_ge_cor, row_names = TRUE, heatmap_legend = TRUE, col_title = "CRISPR", color_range = c(-0.5, 0, 0.5), radius = 0.155, legend_title = "Gene expr. Spearman correlation", metric = "GE")
ccle_ge_ht2 <- MakeCorrHeatmap(cor_res = ccle_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CCLE", color_range = c(-0.5, 0, 0.5), radius = 0.035, legend_title = "Gene expr. Spearman correlation", metric = "GE")
ctrp_ge_ht2 <- MakeCorrHeatmap(cor_res = ctrp_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "CTRP", color_range = c(-0.5, 0, 0.5), radius = 0.035, legend_title = "Gene expr. Spearman correlation", metric = "GE")
gdsc_ge_ht2 <- MakeCorrHeatmap(cor_res = gdsc_ge_cor, row_names = FALSE, heatmap_legend = FALSE, col_title = "GDSC", color_range = c(-0.5, 0, 0.5), radius = 0.035, legend_title = "Gene expr. Spearman correlation", metric = "GE")
ht_ge_list <- crispr_ge_ht2 + ccle_ge_ht2 + ctrp_ge_ht2 + gdsc_ge_ht2
ht_ge_grob <- grid.grabExpr(draw(ht_ge_list, gap = unit(0.25, "in"), heatmap_legend_side = "top"))

# B: Copy number (agnostic)
crispr_ge_df <- crispr_ge_cor %>% filter(InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene, GE_r, GE_p, n)
crispr_ge_df <- add_column(crispr_ge_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_ge_df) - 1)))
crispr_ge_df$Drug <- NA
ccle_ge_df <- ccle_ge_cor %>% filter(InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene, GE_r, GE_p, n)
ccle_ge_df <- add_column(ccle_ge_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_ge_df) - 1)))
ctrp_ge_df <- ctrp_ge_cor %>% filter(InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene, GE_r, GE_p, n)
ctrp_ge_df <- add_column(ctrp_ge_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_ge_df) - 1)))
gdsc_ge_df <- gdsc_ge_cor %>% filter(InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene,GE_r,  GE_p, n)
gdsc_ge_df <- add_column(gdsc_ge_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_ge_df) - 1)))
ge_signif_tb <- tableGrob(rbind(crispr_ge_df, ccle_ge_df, ctrp_ge_df, gdsc_ge_df), rows = NULL)

# D: Copy number (lineage)
crispr_ge_lin_df <- ge_cor_lin %>% filter(Dataset == "CRISPR", InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene, disease, GE_r, GE_p, n)
crispr_ge_lin_df <- add_column(crispr_ge_lin_df, .before = "Drug", Dataset = c("CRISPR", rep("", nrow(crispr_ge_lin_df) - 1)))
crispr_ge_lin_df$Drug <- NA
ccle_ge_lin_df <- ge_cor_lin %>% filter(Dataset == "CCLE", InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene,disease,  GE_r, GE_p, n)
ccle_ge_lin_df <- add_column(ccle_ge_lin_df, .before = "Drug", Dataset = c("CCLE", rep("", nrow(ccle_ge_lin_df) - 1)))
ctrp_ge_lin_df <- ge_cor_lin %>% filter(Dataset == "CTRP", InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene, disease, GE_r, GE_p, n)
# ctrp_ge_lin_df <- add_column(ctrp_ge_lin_df, .before = "Drug", Dataset = c("CTRP", rep("", nrow(ctrp_ge_lin_df) - 1)))
gdsc_ge_lin_df <- ge_cor_lin %>% filter(Dataset == "GDSC", InG2P == "Yes", GE_p < 0.05) %>% select(Drug, Gene, disease, GE_r,  GE_p, n)
# gdsc_ge_lin_df <- add_column(gdsc_ge_lin_df, .before = "Drug", Dataset = c("GDSC", rep("", nrow(gdsc_ge_lin_df) - 1)))
ge_lin_signif_tb <- tableGrob(rbind(crispr_ge_lin_df, ccle_ge_lin_df, ctrp_ge_lin_df, gdsc_ge_lin_df), rows = NULL)

# C and E: Scatterplots
crispr_ge_filt <- filter(crispr, Gene %in% c("ERBB2"))
crispr_ge_filt_plot <- ggplot(data = crispr_ge_filt, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "CRISPR: ERBB2", x = "Gene Expression (TPM)")

ccle_ge_filt <- filter(ccle, Drug_Gene %in% c("lapatinib_ERBB2"))
ccle_ge_filt_plot <- ggplot(data = ccle_ge_filt, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "CCLE: lapatinib, ERBB2", x = "Gene Expression (TPM)")

ctrp_ge_filt <- filter(ctrp, Drug_Gene %in% c("docetaxel_ERBB2"))
ctrp_ge_filt_plot <- ggplot(data = ctrp_ge_filt, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "CTRP: docetaxel, ERBB2", x = "Gene Expression (TPM)")

gdsc_ge_filt1 <- filter(gdsc, Drug_Gene %in% c("docetaxel_ERBB2"))
gdsc_ge_filt_plot1 <- ggplot(data = gdsc_ge_filt1, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "GDSC: docetaxel, ERBB2", x = "Gene Expression (TPM)")

gdsc_ge_filt2 <- filter(gdsc, Drug_Gene %in% c("lapatinib_ERBB2"))
gdsc_ge_filt_plot2 <- ggplot(data = gdsc_ge_filt2, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "GDSC: lapatinib, ERBB2", x = "Gene Expression (TPM)")

crispr_ge_lin_filt <- filter(crispr, Gene_Lin %in% c("ERBB2_breast"))
crispr_ge_lin_filt_plot <- ggplot(data = crispr_ge_lin_filt, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "CRISPR: ERBB2, breast", x = "Gene Expression (TPM)")

ccle_ge_lin_filt <- filter(ccle, Drug_Gene_Lin %in% c("lapatinib_ERBB2_breast"))
ccle_ge_lin_filt_plot <- ggplot(data = ccle_ge_lin_filt, mapping = aes(x = TPM, y = Score)) +
  geom_point() +
  labs(title = "CCLE: lapatinib, ERBB2, breast", x = "Gene Expression (TPM)")

# Make figure
lay <- rbind(c(1, 1, 1, 1),
             c(2, 3, 4, 4),
             c(5, 5, 5, 5))

png(filename = "./plots/manuscript/figure6_gene_expression.png", width = 25, height = 16, units = "in", res = 500)
grid.arrange(layout_matrix = lay,
             arrangeGrob(ht_cn_grob, left = textGrob("A", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ge_signif_tb, left = textGrob("B", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ge_lin_signif_tb, left = textGrob("D", x = unit(1, "npc"), y = unit(.95, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_ge_lin_filt_plot), ggplotGrob(ccle_ge_lin_filt_plot), nrow = 1, left = textGrob("E", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))),
             arrangeGrob(ggplotGrob(crispr_ge_filt_plot), ggplotGrob(ccle_ge_filt_plot), ggplotGrob(ctrp_ge_filt_plot), ggplotGrob(gdsc_ge_filt_plot1), ggplotGrob(gdsc_ge_filt_plot2), nrow = 1, left = textGrob("F", x = unit(1, "npc"), y = unit(.97, "npc"), gp = gpar(fontsize = 20, fontface = "bold"))))
dev.off()
```

## Clustered AUC heatmap

```{r auc_clustered_ht, eval=FALSE}
ccle_auc_grid <- dcast(ccle, Drug ~ DepMap_ID, value.var = "Score", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Drug)
ctrp_auc_grid <- dcast(ctrp, Drug ~ DepMap_ID, value.var = "Score", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Drug)
gdsc_auc_grid <- dcast(gdsc, Drug ~ DepMap_ID, value.var = "Score", fun.aggregate = mean, fill = 0) %>% `rownames<-`(.[,1]) %>% select(-Drug)

ccle_lineages_ha <- merge(data.frame("DepMap_ID" = colnames(ccle_auc_grid)), ccl_meta, by = "DepMap_ID", all.x = TRUE) %>% `rownames<-`(.[,1]) %>% select(-DepMap_ID)
ctrp_lineages_ha <- merge(data.frame("DepMap_ID" = colnames(ctrp_auc_grid)), ccl_meta, by = "DepMap_ID", all.x = TRUE) %>% `rownames<-`(.[,1]) %>% select(-DepMap_ID)
gdsc_lineages_ha <- merge(data.frame("DepMap_ID" = colnames(gdsc_auc_grid)), ccl_meta, by = "DepMap_ID", all.x = TRUE) %>% `rownames<-`(.[,1]) %>% select(-DepMap_ID)

ht_legend_list <- list(direction = "horizontal")

ccle_col_fun <- colorRamp2(c(0, 1), c("gray97", "darkgreen"))
ccle_auc_ha <- HeatmapAnnotation(Lineage = ccle_lineages_ha$disease, annotation_legend_param = list(Lineage = list(direction = "horizontal", nrow = 5)))
ccle_auc_ht <- Heatmap(ccle_auc_grid,
                       na_col = "black",
                       col = ccle_col_fun,
                       top_annotation = ccle_auc_ha,
                       heatmap_legend_param = ht_legend_list,
                       name = "AUC",
                       show_column_names = FALSE, 
                       row_title = "Drugs and Small Molecules",
                       column_title = "Cancer Cell Lines",
                       column_title_side = "top")

ctrp_col_fun <- colorRamp2(c(0, 1), c("gray97", "steelblue4"))
ctrp_auc_ha <- HeatmapAnnotation(Lineage = ctrp_lineages_ha$disease, annotation_legend_param = list(Lineage = list(direction = "horizontal", nrow = 3)))
ctrp_auc_ht <- Heatmap(ctrp_auc_grid,
                       na_col = "black",
                       col = ctrp_col_fun,
                       top_annotation = ctrp_auc_ha,
                       heatmap_legend_param = ht_legend_list,
                       name = "AUC",
                       show_column_names = FALSE, 
                       row_title = "Drugs and Small Molecules",
                       column_title = "Cancer Cell Lines",
                       column_title_side = "top")

gdsc_col_fun <- colorRamp2(c(0, 1), c("gray97", "turquoise4"))
gdsc_auc_ha <- HeatmapAnnotation(Lineage = gdsc_lineages_ha$disease, annotation_legend_param = list(Lineage = list(direction = "horizontal", nrow = 3)))
gdsc_auc_ht <- Heatmap(gdsc_auc_grid,
                       na_col = "black",
                       col = gdsc_col_fun,
                       top_annotation = gdsc_auc_ha,
                       heatmap_legend_param = ht_legend_list,
                       name = "AUC",
                       show_column_names = FALSE, 
                       row_title = "Drugs and Small Molecules",
                       column_title = "Cancer Cell Lines",
                       column_title_side = "top")

png(filename = "./plots/manuscript/ccle_clustered_heatmap.png", width = 10, height = 8, units = "in", res = 500)
draw(ccle_auc_ht, merge_legend = TRUE, heatmap_legend_side = "top", annotation_legend_side = "top")
dev.off()

png(filename = "./plots/manuscript/ctrp_clustered_heatmap.png", width = 22, height = 40, units = "in", res = 500)
draw(ctrp_auc_ht, merge_legend = TRUE, heatmap_legend_side = "top", annotation_legend_side = "top")
dev.off()

png(filename = "./plots/manuscript/gdsc_clustered_heatmap.png", width = 18, height = 20, units = "in", res = 500)
draw(gdsc_auc_ht, merge_legend = TRUE, heatmap_legend_side = "top", annotation_legend_side = "top")
dev.off()
```

## Boxplots: Mut and fus

```{r crispr_mut_boxplots, fig.height=5, fig.width=10, eval=FALSE}
crispr_filt <- filter(crispr, Gene %in% g2p_mut_genes)
crispr_filt$Gene <- factor(crispr_filt$Gene, levels = g2p_mut_genes)
crispr_filt$Mutation <- as.character(crispr_filt$Mutation)
crispr_signif_filt <- filter(crispr_signif_g2p_g, Gene %in% g2p_mut_genes)
crispr_signif_filt$Gene <- factor(crispr_signif_filt$Gene, levels = g2p_mut_genes)

crispr_gene_mut_plot <- ggplot(data = crispr_filt) +
  facet_wrap(~ Gene, nrow = 2, drop = FALSE) +
  scale_color_manual(name = "Mutation Status", labels = c("Wildtype", "Mutant"), values = c("1" = "darkorchid", "0" = "thistle")) +
  scale_x_discrete(name = "Mutation Status", labels = c("0" = "WT", "1" = "Mut")) +
  geom_jitter(aes(x = Mutation, y = Score, color = Mutation), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_boxplot(aes(x = Mutation, y = Score), fill = "transparent", outlier.shape = NA, lwd = 0.3) +
  geom_text(data = crispr_signif_filt, aes(x = 1.5, y = 2, label = p.signif)) +
  geom_hline(yintercept = 0, lty = 2, color = "darkgray") +
  theme(legend.position = "top", legend.direction = "horizontal") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y = "CERES Score")
crispr_gene_mut_plot

ggsave("./plots/manuscript/crispr_gene_mut_plot.png", crispr_gene_mut_plot, width = 12, height = 6, units = "in")
```

```{r fusion_boxplots, fig.height=5, fig.width=12, eval=FALSE}
# CRISPR
crispr_fus_filt <- filter(crispr_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1", "PML-PARA") & Drug_Gene %in% c("CRISPR_ABL1"))
crispr_signif_fus_filt <- filter(crispr_signif_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1", "PML-PARA"))

crispr_fus_boxplot <- ggplot(data = crispr_fus_filt) +
  facet_grid(FusionPair ~ Drug_Gene) +
  scale_color_manual(name = "Fusion Status", values = c("Yes" = "darkorchid4", "No" = "thistle")) +
  geom_jitter(aes(x = Fusion_Status, y = Score, color = Fusion_Status), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_boxplot(aes(x = Fusion_Status, y = Score), fill = "transparent", outlier.shape = NA, lwd = 0.3) +
  # coord_cartesian(ylim = c(0, 1.2)) +
  # scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  geom_text(data = crispr_signif_fus_filt, aes(x = 1.5, y = 1, label = p.signif)) +
  theme(legend.position = "top", legend.direction = "horizontal", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y = "Score", x = "Fusion Status")
crispr_fus_boxplot
ggsave("./plots/manuscript/crispr_fus_boxplots.png", crispr_fus_boxplot, width = 8, height = 5, units = "in")

# CCLE
ccle_fus_filt <- filter(ccle_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1") & Drug %in% g2p_drugs)
ccle_fus_filt$Drug_f <- factor(ccle_fus_filt$Drug, levels = intersect(g2p_drug_order, unique(ccle_fus$Drug)))
ccle_signif_fus_filt <- filter(ccle_signif_fus, Drug %in% g2p_drugs)
ccle_signif_fus_filt$Drug_f <- factor(ccle_signif_fus_filt$Drug, levels = intersect(g2p_drug_order, unique(ccle_signif_fus$Drug)))

ccle_fus_boxplot <- ggplot(data = ccle_fus_filt) +
  facet_grid(FusionPair ~ Drug_f) +
  scale_color_manual(name = "Fusion Status", values = c("Yes" = "springgreen4", "No" = "palegreen3")) +
  geom_jitter(aes(x = Fusion_Status, y = Score, color = Fusion_Status), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_boxplot(aes(x = Fusion_Status, y = Score), fill = "transparent", outlier.shape = NA, lwd = 0.3) +
  coord_cartesian(ylim = c(0, 1.2)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  geom_text(data = ccle_signif_fus_filt, aes(x = 1.5, y = 1.1, label = p.signif)) +
  theme(legend.position = "top", legend.direction = "horizontal", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y = "AUC", x = "Fusion Status")
ccle_fus_boxplot
ggsave("./plots/manuscript/ccle_fus_boxplots.png", ccle_fus_boxplot, width = 8, height = 5, units = "in")

# CTRP
ctrp_fus_filt <- filter(ctrp_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1") & Drug %in% g2p_drugs)
ctrp_fus_filt$Drug_f <- factor(ctrp_fus_filt$Drug, levels = intersect(g2p_drug_order, unique(ctrp_fus$Drug)))
ctrp_signif_fus_filt <- filter(ctrp_signif_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1") & Drug %in% g2p_drugs)
ctrp_signif_fus_filt$Drug_f <- factor(ctrp_signif_fus_filt$Drug, levels = intersect(g2p_drug_order, unique(ctrp_signif_fus$Drug)))

ctrp_fus_boxplot <- ggplot(data = ctrp_fus_filt) +
  facet_grid(FusionPair ~ Drug_f) +
  scale_color_manual(name = "Fusion Status", values = c("Yes" = "steelblue4", "No" = "slategray3")) +
  geom_jitter(aes(x = Fusion_Status, y = Score, color = Fusion_Status), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_boxplot(aes(x = Fusion_Status, y = Score), fill = "transparent", outlier.shape = NA, lwd = 0.3) +
  coord_cartesian(ylim = c(0, 1.2)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  geom_text(data = ctrp_signif_fus_filt, aes(x = 1.5, y = 1.1, label = p.signif)) +
  theme(legend.position = "top", legend.direction = "horizontal", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y = "AUC", x = "Fusion Status")
ctrp_fus_boxplot
ggsave("./plots/manuscript/ctrp_fus_boxplots.png", ctrp_fus_boxplot, width = 19, height = 5, units = "in")

# GDSC
gdsc_fus_filt <- filter(gdsc_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1") & Drug %in% g2p_drugs)
gdsc_fus_filt$Drug_f <- factor(gdsc_fus_filt$Drug, levels = intersect(g2p_drug_order, unique(gdsc_fus$Drug)))
gdsc_signif_fus_filt <- filter(gdsc_signif_fus, FusionPair %in% c("ABL1-BCR", "BCR-ABL1") & Drug %in% g2p_drugs)
gdsc_signif_fus_filt$Drug_f <- factor(gdsc_signif_fus_filt$Drug, levels = intersect(g2p_drug_order, unique(gdsc_signif_fus$Drug)))

gdsc_fus_boxplot <- ggplot(data = gdsc_fus_filt) +
  facet_grid(FusionPair ~ Drug_f) +
  scale_color_manual(name = "Fusion Status", values = c("Yes" = "turquoise4", "No" = "paleturquoise3")) +
  geom_jitter(aes(x = Fusion_Status, y = Score, color = Fusion_Status), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_boxplot(aes(x = Fusion_Status, y = Score), fill = "transparent", outlier.shape = NA, lwd = 0.3) +
  coord_cartesian(ylim = c(0, 1.2)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  geom_text(data = gdsc_signif_fus_filt, aes(x = 1.5, y = 1.1, label = p.signif)) +
  theme(legend.position = "top", legend.direction = "horizontal", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y = "AUC", x = "Fusion Status")
gdsc_fus_boxplot
ggsave("./plots/manuscript/gdsc_fus_boxplots.png", gdsc_fus_boxplot, width = 12, height = 5, units = "in")
```

### Lineage DGL heatmaps

```{r lineage_mut_heatmap_functions}
MakeWilcoxonLineageHeatmap <- function(df, database, lineage) {
  plot_colors <- c("CCLE" = "darkgreen", "CTRP" = "steelblue4", "GDSC" = "turquoise4")
  plot_breaks <- list("CCLE" = seq(0, 5, by = 1), "CTRP" = seq(0, 12, by = 2), "GDSC" = seq(0, 8, by = 2))
  
  df <- filter(df, disease == lineage)
  
  ht <- MakeWilcoxonHeatmap(signif_df = df, feature = "mutation", legend_title = paste0(database, "\n", lineage, "\n-log10(p-value)"), legend_breaks = plot_breaks[[database]], row_names = TRUE, color = plot_colors[[database]], col_title = "Drugs", row_title_txt = "Genes")
  
  return(ht)
}

SaveWilcoxonLineageHeatmap <- function(database, ht_list, lineage) {
  ht <- ht_list[[lineage]]
  out_height <- floor((nrow(ht@matrix) + 1) / 2) + 2
  out_width <- ncol(ht@matrix) / 2 + 1
  
  png(filename = paste0("./plots/manuscript/lineage_heatmaps/", tolower(database), "_", lineage, "_mut_heatmap.png"), width = out_width, height = out_height, units = "in", res = 500)
  draw(ht, heatmap_legend_side = "top")
  invisible(dev.off())
}
```

```{r lineage_mut_heatmaps, eval=FALSE, message=FALSE}
ccle_hts <- lapply(unique(ccle_signif_dgl$disease), MakeWilcoxonLineageHeatmap, df = ccle_signif_dgl, database = "CCLE")
names(ccle_hts) <- unique(ccle_signif_dgl$disease)
lapply(unique(ccle_signif_dgl$disease), SaveWilcoxonLineageHeatmap, ht_list = ccle_hts, database = "CCLE")

ctrp_hts <- lapply(unique(ctrp_signif_dgl$disease), MakeWilcoxonLineageHeatmap, df = ctrp_signif_dgl, database = "CTRP")
names(ctrp_hts) <- unique(ctrp_signif_dgl$disease)
lapply(unique(ctrp_signif_dgl$disease), SaveWilcoxonLineageHeatmap, ht_list = ctrp_hts, database = "CTRP")

gdsc_hts <- lapply(unique(gdsc_signif_dgl$disease), MakeWilcoxonLineageHeatmap, df = gdsc_signif_dgl, database = "GDSC")
names(gdsc_hts) <- unique(gdsc_signif_dgl$disease)
lapply(unique(gdsc_signif_dgl$disease), SaveWilcoxonLineageHeatmap, ht_list = gdsc_hts, database = "GDSC")
```

## Mut: Sen vs. Res tests

```{r SvR_direction_datasets, eval=FALSE}
# CCLE
ccle_prot_dir <- unique(select(ccle_prot, DepMap_ID, Gene, Cell_line, CCLE_histology, TCGA_classification, CCLE_name, Drug, Drug_Gene, Score, Change_Status, Direction_Curated, Direction_Grouper))
## Resistance
ccle_prot_res <- filter(ccle_prot_dir, Direction_Grouper %in% c("No_none", "Yes_none", "No_resistance", "Yes_resistance"))
ccle_prot_res$Direction_Grouper <- with(ccle_prot_res, ifelse(Direction_Grouper == "Yes_resistance", "Mutated", "Not mutated"))
## Sensitivity
ccle_prot_sen <- filter(ccle_prot_dir, Direction_Grouper %in% c("No_none", "Yes_none", "No_sensitivity", "Yes_sensitivity"))
ccle_prot_sen$Direction_Grouper <- with(ccle_prot_sen, ifelse(Direction_Grouper == "Yes_sensitivity", "Mutated", "Not mutated"))
saveRDS(ccle_prot_res, "./data_munging/rds/ccle_protein_changes_resistance.rds")
saveRDS(ccle_prot_sen, "./data_munging/rds/ccle_protein_changes_sensitivity.rds")

# CTRP
ctrp_prot_dir <- unique(select(ctrp_prot, DepMap_ID, Gene, Cell_line, CCLE_histology, TCGA_classification, CCLE_name, Drug, Drug_Gene, Score, Change_Status, Direction_Curated, Direction_Grouper))
## Resistance
ctrp_prot_res <- filter(ctrp_prot_dir, Direction_Grouper %in% c("No_none", "Yes_none", "No_resistance", "Yes_resistance"))
ctrp_prot_res$Direction_Grouper <- with(ctrp_prot_res, ifelse(Direction_Grouper == "Yes_resistance", "Mutated", "Not mutated"))
## Sensitivity
ctrp_prot_sen <- filter(ctrp_prot_dir, Direction_Grouper %in% c("No_none", "Yes_none", "No_sensitivity", "Yes_sensitivity"))
ctrp_prot_sen$Direction_Grouper <- with(ctrp_prot_sen, ifelse(Direction_Grouper == "Yes_sensitivity", "Mutated", "Not mutated"))
saveRDS(ctrp_prot_res, "./data_munging/rds/ctrp_protein_changes_resistance.rds")
saveRDS(ctrp_prot_sen, "./data_munging/rds/ctrp_protein_changes_sensitivity.rds")

# GDSC
gdsc_prot_dir <- unique(select(gdsc_prot, DepMap_ID, Gene, Cell_line, CCLE_histology, TCGA_classification, CCLE_name, Drug, Drug_Gene, Score, Change_Status, Direction_Curated, Direction_Grouper))
## Resistance
gdsc_prot_res <- filter(gdsc_prot_dir, Direction_Grouper %in% c("No_none", "Yes_none", "No_resistance", "Yes_resistance"))
gdsc_prot_res$Direction_Grouper <- with(gdsc_prot_res, ifelse(Direction_Grouper == "Yes_resistance", "Mutated", "Not mutated"))
## Sensitivity
gdsc_prot_sen <- filter(gdsc_prot_dir, Direction_Grouper %in% c("No_none", "Yes_none", "No_sensitivity", "Yes_sensitivity"))
gdsc_prot_sen$Direction_Grouper <- with(gdsc_prot_sen, ifelse(Direction_Grouper == "Yes_sensitivity", "Mutated", "Not mutated"))
saveRDS(gdsc_prot_res, "./data_munging/rds/gdsc_protein_changes_resistance.rds")
saveRDS(gdsc_prot_sen, "./data_munging/rds/gdsc_protein_changes_sensitivity.rds")
```

```{r prot_SvR_wilcoxon_tests, eval=FALSE}
# CCLE
ccle_signif_prot_res <- WilcoxonTestDF(dataframe = ccle_prot_res, grouping = c("Drug", "Gene", "Drug_Gene"), type = "direction", outfile = "./data_munging/rds/ccle_signif_protein_changes_resistance.rds")
ccle_signif_prot_sen <- WilcoxonTestDF(dataframe = ccle_prot_sen, grouping = c("Drug", "Gene", "Drug_Gene"), type = "direction", outfile = "./data_munging/rds/ccle_signif_protein_changes_sensitivity.rds")

# CTRP
ctrp_signif_prot_res <- WilcoxonTestDF(dataframe = ctrp_prot_res, grouping = c("Drug", "Gene", "Drug_Gene"), type = "direction", outfile = "./data_munging/rds/ctrp_signif_protein_changes_resistance.rds")
ctrp_signif_prot_sen <- WilcoxonTestDF(dataframe = ctrp_prot_sen, grouping = c("Drug", "Gene", "Drug_Gene"), type = "direction", outfile = "./data_munging/rds/ctrp_signif_protein_changes_sensitivity.rds")

# GDSC
gdsc_signif_prot_res <- WilcoxonTestDF(dataframe = gdsc_prot_res, grouping = c("Drug", "Gene", "Drug_Gene"), type = "direction", outfile = "./data_munging/rds/gdsc_signif_protein_changes_resistance.rds")
gdsc_signif_prot_sen <- WilcoxonTestDF(dataframe = gdsc_prot_sen, grouping = c("Drug", "Gene", "Drug_Gene"), type = "direction", outfile = "./data_munging/rds/gdsc_signif_protein_changes_sensitivity.rds")
```

```{r load_prot_SvR_wilcoxon_tests}
ccle_signif_prot_res <- readRDS("./data_munging/rds/ccle_signif_protein_changes_resistance.rds")
ccle_signif_prot_res$Direction_Test <- "Resistance"
ccle_signif_prot_sen <- readRDS("./data_munging/rds/ccle_signif_protein_changes_sensitivity.rds")
ccle_signif_prot_sen$Direction_Test <- "Sensitivity"
ccle_signif_prot_dir <- bind_rows(ccle_signif_prot_res, ccle_signif_prot_sen)

ctrp_signif_prot_res <- readRDS("./data_munging/rds/ctrp_signif_protein_changes_resistance.rds")
ctrp_signif_prot_res$Direction_Test <- "Resistance"
ctrp_signif_prot_sen <- readRDS("./data_munging/rds/ctrp_signif_protein_changes_sensitivity.rds")
ctrp_signif_prot_sen$Direction_Test <- "Sensitivity"
ctrp_signif_prot_dir <- bind_rows(ctrp_signif_prot_res, ctrp_signif_prot_sen)

gdsc_signif_prot_res <- readRDS("./data_munging/rds/gdsc_signif_protein_changes_resistance.rds")
gdsc_signif_prot_res$Direction_Test <- "Resistance"
gdsc_signif_prot_sen <- readRDS("./data_munging/rds/gdsc_signif_protein_changes_sensitivity.rds")
gdsc_signif_prot_sen$Direction_Test <- "Sensitivity"
gdsc_signif_prot_dir <- bind_rows(gdsc_signif_prot_res, gdsc_signif_prot_sen)

ccle_prot_res <- readRDS("./data_munging/rds/ccle_protein_changes_resistance.rds")
ccle_prot_sen <- readRDS("./data_munging/rds/ccle_protein_changes_sensitivity.rds")
ctrp_prot_res <- readRDS("./data_munging/rds/ctrp_protein_changes_resistance.rds")
ctrp_prot_sen <- readRDS("./data_munging/rds/ctrp_protein_changes_sensitivity.rds")
gdsc_prot_res <- readRDS("./data_munging/rds/gdsc_protein_changes_resistance.rds")
gdsc_prot_sen <- readRDS("./data_munging/rds/gdsc_protein_changes_sensitivity.rds")
```

```{r direction_boxplots, eval=FALSE}
# CCLE
ccle_res_box <- ggplot(data = filter(ccle_prot_res, Drug_Gene %in% ccle_signif_prot_res$Drug_Gene)) +
  facet_wrap(~ Drug * Gene, nrow = 1) +
  scale_color_manual(values = c("Mutated" = "springgreen4", "Not mutated" = "palegreen3")) +
  geom_boxplot(mapping = aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), outlier.shape = NA) +
  geom_jitter(aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_text(data = ccle_signif_prot_res, aes(x = 1.5, y = 1.05, label = p.signif), size = 7) +
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  labs(y = "AUC", x = "Resistance mutation?")

ccle_sen_box <- ggplot(data = filter(ccle_prot_sen, Drug_Gene %in% ccle_signif_prot_sen$Drug_Gene)) +
  facet_wrap(~ Drug * Gene, nrow = 1) +
  scale_color_manual(values = c("Mutated" = "springgreen4", "Not mutated" = "palegreen3")) +
  geom_boxplot(mapping = aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), outlier.shape = NA) +
  geom_jitter(aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_text(data = ccle_signif_prot_sen, aes(x = 1.5, y = 1.05, label = p.signif), size = 7) +
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  theme(legend.position = "none", axis.title.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  labs(y = "AUC", x = "Sensitivity mutation?")
ccle_dir_boxes <- plot_grid(ccle_res_box, ccle_sen_box, labels = c("A", "B"), rel_widths = c(3, 1.1))
ggsave("./plots/manuscript/ccle_direction_boxplots.png", ccle_dir_boxes, device = "png", dpi = 450, width = 12, height = 5, units = "in")

# CTRP
ctrp_res_box <- ggplot(data = filter(ctrp_prot_res, Drug_Gene %in% ctrp_signif_prot_res$Drug_Gene)) +
  facet_wrap(~ Drug * Gene, nrow = 1) +
  scale_color_manual(values = c("Mutated" = "steelblue4", "Not mutated" = "slategray3")) +
  geom_boxplot(mapping = aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), outlier.shape = NA) +
  geom_jitter(aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_text(data = ctrp_signif_prot_res, aes(x = 1.5, y = 1.05, label = p.signif), size = 7) +
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  labs(y = "AUC", x = "Resistance mutation?")

ctrp_sen_box <- ggplot(data = filter(ctrp_prot_sen, Drug_Gene %in% ctrp_signif_prot_sen$Drug_Gene)) +
  facet_wrap(~ Drug * Gene, nrow = 1) +
  scale_color_manual(values = c("Mutated" = "steelblue4", "Not mutated" = "slategray3")) +
  geom_boxplot(mapping = aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), outlier.shape = NA) +
  geom_jitter(aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_text(data = ctrp_signif_prot_sen, aes(x = 1.5, y = 1.05, label = p.signif), size = 7) +
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  labs(y = "AUC", x = "Sensitivity mutation?")
ctrp_dir_boxes <- plot_grid(ctrp_res_box, ctrp_sen_box, labels = c("A", "B"), ncol = 1)
ggsave("./plots/manuscript/ctrp_direction_boxplots.png", ctrp_dir_boxes, device = "png", dpi = 450, width = 12, height = 8, units = "in")

# GDSC
gdsc_res_box <- ggplot(data = filter(gdsc_prot_res, Drug_Gene %in% gdsc_signif_prot_res$Drug_Gene)) +
  facet_wrap(~ Drug * Gene, nrow = 1) +
  scale_color_manual(values = c("Mutated" = "turquoise4", "Not mutated" = "paleturquoise3")) +
  geom_boxplot(mapping = aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), outlier.shape = NA) +
  geom_jitter(aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_text(data = gdsc_signif_prot_res, aes(x = 1.5, y = 1.05, label = p.signif), size = 7) +
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  labs(y = "AUC", x = "Resistance mutation?")

gdsc_sen_box <- ggplot(data = filter(gdsc_prot_sen, Drug_Gene %in% gdsc_signif_prot_sen$Drug_Gene)) +
  facet_wrap(~ Drug * Gene, nrow = 1) +
  scale_color_manual(values = c("Mutated" = "turquoise4", "Not mutated" = "paleturquoise3")) +
  geom_boxplot(mapping = aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), outlier.shape = NA) +
  geom_jitter(aes(x = Direction_Grouper, y = Score, color = Direction_Grouper), width = 0.2, alpha = 0.5, size = 0.6) +
  geom_text(data = gdsc_signif_prot_sen, aes(x = 1.5, y = 1.05, label = p.signif), size = 7) +
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = seq(0, 1, by = 0.2)) +
  theme(legend.position = "none", axis.title.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 0.8, vjust = 1)) +
  labs(y = "AUC", x = "Sensitivity mutation?")
gdsc_dir_boxes <- plot_grid(gdsc_res_box, gdsc_sen_box, labels = c("A", "B"), rel_widths = c(2, 1.1))
ggsave("./plots/manuscript/gdsc_direction_boxplots.png", gdsc_dir_boxes, device = "png", dpi = 450, width = 12, height = 5, units = "in")
```

# SESSION INFORMATION

--------------------------------------------------------------------------------

```{r session_info}
print(sessionInfo())
```